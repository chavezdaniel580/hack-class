########## M6 L1 ############
######### Harvesting Credentials ###########

Introduction to Credential Harvesting
﻿
Credentials are used to access devices and systems on a given network. Credentials include user account names and passwords. According to MITRE ATT&CK Tactic Credential Access (TA0006), harvesting credentials consists of techniques for accessing, identifying, and stealing user account names and/or passwords. Techniques used to obtain credentials include keylogging, Man-in-the-Middle (MITM) attacks, phishing, and credential dumping. Specific techniques are detailed later in this lesson. The use of legitimate credentials gives adversaries access to systems, making them harder to detect, and provides the opportunity to create more accounts to help achieve their goals. 


Credential harvesting is a tactic in the Enterprise Framework from MITRE ATT&CK, as shown in Figure 6.1-1:

﻿![image](https://github.com/user-attachments/assets/138c5875-3617-47c0-8217-fe69b7edbcbf)

Credential harvesting is also included in the reconnaissance phase of the MITRE ATT&CK Framework. According to MITRE ATT&CK, "the reconnaissance phase consists of techniques used and data that adversaries gather that can be leveraged to aid or help coordinate future campaigns or attacks, which likely occur later within the MITRE ATT&CK Framework. The data collected during the reconnaissance phase can be collected in an active or passive manner and information may include data points related to target systems, users, architecture, devices, or infrastructure."


Active data collection occurs when the adversary has infiltrated the target network in an attempt to identify and leverage any vulnerabilities and collect information available. Comparatively, passive data collection is not as infiltrated in the target network. Passive data collection occurs when the adversary is not actively manipulating or searching on the target network, rather, the adversary may be listening or watching traffic.

---------------------------------------------------------------------------------------

Credential Harvesting Techniques 
Brute Force Attacks and Credential Harvesting
﻿

Credential harvesting is categorized under the MITRE ATT&CK technique for brute force attacks (T1110). Brute force attacks include techniques that can be used when the password portion of credential information is not known. Brute force includes the following sub-techniques:

![image](https://github.com/user-attachments/assets/2a0637e8-8856-4aa1-bd8f-70f785b0ef33)

Additional Credential Harvesting Techniques


Multiple credential harvesting techniques exist that do not fall under the brute force attack techniques. Below are the techniques:

![image](https://github.com/user-attachments/assets/d609ad4a-f817-4586-a590-12711c951842)

--------------------------------------------------------------------------

Defenses Against Credential Harvesting
The primary defense against credential harvesting is strong password management. Enforcing all password settings ensures that passwords are complex, changed frequently, and require two-factor authentication. Below are three strategies that should be implemented to prevent credential harvesting:

![image](https://github.com/user-attachments/assets/7a4890a9-c2e7-4cd7-bdb8-0517eae55e8a)

--------------------------------------------------------------------

Harvesting Credentials by Password Spraying | Part 1
﻿

Walk through the MITRE ATT&CK technique of password spraying, as seen from an adversarial perspective. A small dump of credentials was obtained through a successful phishing attack. Using the information from the dump, a small password spraying attack is conducted in an attempt to access the network. 

------------------------------------------------------------------

rotecting Credential Data from Harvesting
Walk through accessing the network's primary Domain Controller (DC) to configure and enforce strict password settings in an effort to prevent credential harvesting. 

﻿

Workflow

﻿

1. Log in to the ch-dc1 VM using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. The domain's password policy can be easily reviewed using PowerShell. To do so, select the Windows icon > Administrative Tools.

﻿

3. In the Administrative Tools window, select Windows PowerShell.

![image](https://github.com/user-attachments/assets/2a52cd98-5aa7-454c-8225-5ad721b8bad5)

. In the Windows PowerShell window, enter the following cmdlet:
PS C:\Users\trainee.vcch> Get-ADDefaultDomainPasswordPolicy



The following results are returned:

![image](https://github.com/user-attachments/assets/f8a6de3d-61ec-402d-997f-582a4aca35cf)

Below are relevant fields to the domain's password policy from the Windows PowerShell output:

![image](https://github.com/user-attachments/assets/287f05dd-26db-498d-8d85-ffa896149f62)

The current domain password policy is not secure to prevent brute force attacks. Currently, passwords are only required to be one character long, changed once every 365 days, and can be changed to a password that was previously used. These three fields create an environment that is extremely vulnerable. The next steps identify how to modify and harden the domain's password policy.


5.  Select the Windows icon > Administrative Tools. Select Group Policy Management:

![image](https://github.com/user-attachments/assets/d6024e91-5e9d-48fb-aae4-55918006a8e4)

The Group Policy Management window opens:

![image](https://github.com/user-attachments/assets/4b32d344-08ba-4d96-a1b8-238281f1f77e)

Navigate to Group Policy Management > Forest: vcch.lan > Domains > vcch.lan > Default Domain Policy:

![image](https://github.com/user-attachments/assets/82130082-96ad-4be3-b030-9d5f790fdc7b)

Right-click Default Domain Policy and select Edit... The Group Policy Management Editor appears:

![image](https://github.com/user-attachments/assets/f3c8f960-91fe-4395-aded-4c5bc2163b4f)

8. Navigate to Computer Configuration > Policies > Windows Settings > Security Settings > Account Policies > Password Policy:

![image](https://github.com/user-attachments/assets/f918aaab-df80-4555-b492-caecf49fb730)

The password policy for the Default Domain Policy is located here. 


Notice that the output from the cmdlet executed in step 4 reflects the Policy Settings located in the Group Policy Management Editor:

![image](https://github.com/user-attachments/assets/b78fce0a-44bd-453b-b067-a2311af53866)


The current password policy settings are not strong:
Only require one character long.
Changed once every 365 days.
Changed to a previously used password.

9. Right-click Enforce password history and select Properties.

![image](https://github.com/user-attachments/assets/cdf0cce1-cd75-40dd-829f-71f98ea5d8a4)

he Enforce password history Properties window appears:

![image](https://github.com/user-attachments/assets/2e627f4e-3462-48b0-b0d6-88c84dcc6f0c)


10. Ensure Define this policy setting is checked. Set the passwords remembered to 24: 

![image](https://github.com/user-attachments/assets/915150c7-7ab8-4852-961b-6510092a9787)

NOTE: The maximum number of passwords Windows can remember is 24. 


11. Select Apply > OK.


12. Right-click Maximum password age, select Properties, and repeat the instructions from step 9. Set the password expiration to 60 days. 


13. In the Suggested Value Changes dialog box, select OK. 

![image](https://github.com/user-attachments/assets/cace6aa6-7434-453c-8d3c-3b8696764c3c)

14.  Select Minimum password age and repeat the instructions from step 9; set the password expiration to 1 days. 


15.  Select Password must meet complexity requirements, enable Define this policy setting, and select Enabled. Select Apply > OK.


16.  Select Store password using reversible encryption, and ensure Define this policy setting is unchecked. Select Apply > OK.


The Group Policy Management Editor should look like the following:


![image](https://github.com/user-attachments/assets/15f982c6-fd8b-4b12-aa9f-0f422fb57a53)


he Password Policy for the Default Domain Policy has been modified to enforce password settings that harden the domain. The password settings create an environment that is more difficult for the adversary to perform an attack using a brute force tactic.


NOTE: When creating a new GPO, the final step is to link the GPO to AD containing the desired groups and machines.

-------------------------------------------------------------------------------

Configure a GPO

The Virtual City City Hall (VCCH) network is taking on some new roles to support the monitoring of security in the network. The new roles require some machines on the network to contain highly sensitive information. Access to the machines and the data is highly controlled and requires a secure policy regarding credentials. Configure a GPO titled Security Control to support new security roles.

﻿

Workflow

﻿

1. Log in to the VCCH's primary DC — ch-dc1 — using the following credentials:

Username: trainee
Password: CyberTraining1!

----------------------------------------------------------------

GPO Access and Configuration
﻿
![image](https://github.com/user-attachments/assets/3bd3831f-ddf1-4eba-add1-6da91846fbc3)

Figure 6.1-20

﻿

The Group Policy Management provides access to view and manage GPOs within a given domain. 
![image](https://github.com/user-attachments/assets/6f1e8904-d83f-4c61-9497-0cb656d82eab)

-----------------------------------------------------------------

GPOs in VCCH
﻿

Figure 6.1-21

﻿

The Group Policy Objects folder contains all the domain's current GPOs.

﻿

NOTE: The following steps continue from the previous task.

﻿

2. Create a new group policy object titled Security Control, and access the GPO's password policy settings.

![image](https://github.com/user-attachments/assets/3b5a90f5-2837-4818-a3af-7738ec133162)

-----------------------------------------------------

Password Policy Settings
The following path leads to the GPO's password policy setting: 

﻿

﻿![image](https://github.com/user-attachments/assets/4c2c444f-89a2-450d-8ec6-78fee39c128c)


Figure 6.1-22

﻿

NOTE: The following steps continue from the previous task.

﻿

3. Edit the newly created GPO to enforce the password settings provided below.

Enforce password history: 24

Maximum password age: 30

Minimum password age: 1

Minimum password length: 12

Password must meet complexity requirements: Enabled

![image](https://github.com/user-attachments/assets/5452a657-cf31-497b-b64e-0425f7e02dbe)


---------------------------------------------------------------------------------------------------

Configured GPO
The required changes are made to the GPO:

﻿![image](https://github.com/user-attachments/assets/ecd93a97-3e60-4ea7-a2f9-fdac74604334)

The final step to enforce the new GPO is to link it to AD.


NOTE: The following steps continue from the previous task.


4. Once Link an Existing GPO... and Security Control are selected, the newly created GPO is added to the group policy objects found under vcch.lan:

![image](https://github.com/user-attachments/assets/070b7be2-9847-4d0d-bfc9-64c1a9ac1033)

![image](https://github.com/user-attachments/assets/148e3d54-3d03-46d4-b8ad-57f29ac4ea71)

From this point, the domain administrator from within the security group manages the GPO. They add users and computers as needed to handle and view sensitive information. The established policies put the domain in a secure posture to defend against credential harvesting through password mismanagement. 

----------------------------------------


########## M6 L2 ############
######### Identifying Hosts and Services ###########

Host Identification and Scanning Refresher


![image](https://github.com/user-attachments/assets/2c81955e-17fd-4557-b42c-9e2d6aea67ca)

Host identification and scanning typically occur early on in the MITRE ATT&CK lifecycle and occur continuously during an attack campaign as the adversary continues to expand access. The purpose of host discovery is to figure out which hosts are accessible over the network. Some protocols a Cyber Defense Analyst (CDA) might encounter during host discovery are Address Resolution Protocol (ARP), Internet Control Message Protocol (ICMP), Domain Name System (DNS), and Transmission Control Protocol (TCP)/User Datagram Protocol (UDP) pings.


After the host is verified as accessible, the adversary proceeds to port scan the host(s). Port scanning is done to check which services are up and running. Upon receiving port scan results, the adversary can determine the host's purpose in the network (e.g., is it a web server, mail server). Recall that this is because port numbers typically correspond to specific services.


After the adversary gathers a list of open ports, and thus a list of services running on the host, they would proceed to conduct vulnerability scanning. Vulnerability scanning probes a service — or many services — and attempts to discover any weaknesses in configuration. Once the adversary discovers a vulnerability they can leverage, they launch an exploit, gaining access into their target system.


These are not hard and fast rules, and these actions do not have to occur sequentially or together at all. However, this sequence provides a logical progression on the avenues an adversary may take to gaining the requisite information in selecting the appropriate exploit. Knowing how the adversary functions enables a CDA to take opposing mitigating actions.

----------------------------------------------------------------------

Port Scanning



![image](https://github.com/user-attachments/assets/aa03cc0f-028a-4125-9f86-baad27e1d65a)

Port scanning is the technique of scanning hosts on a network for running services. The MITRE ATT&CK technique identifier for port scanning, known as network service scanning to MITRE, is T1049. Port scanning may or may not be preceded by host discovery.


Port scanning leverages two transport layer protocols:
Transmission Control Protocol (TCP)
User Datagram Protocol (UDP)

You should be familiar with these protocols from previous courses. It is more common to rely on TCP to conduct a port scan as UDP scans do not always return definitive results detailing if a port is open.


TCP Port Scan
TCP is a connection-orientated protocol — it relies on a three-way handshake to establish a connection. Recall that the client initiating the connection sends a packet with the Synchronize (SYN) flag set. The receiving server replies with a packet including the SYN/Acknowledge (ACK) flags, to which the client responds with a packet including the ACK flag set. This sequence establishes the connection. There are a few exceptions to this rule, such as Hypertext Transfer Protocol (HTTP) FAST GET, which sends data with the SYN packet, but these instances are outside the scope of this lesson. Port scanners exploit the requirement of the three-way handshake to determine if a port is open. If the client receives a SYN/ACK from the server, then this is all the information needed to surmise that the port is open. If a packet with a Reset (RST) flag is received, then the port is closed. If there is no response from the server, then port filtering is likely occurring somewhere in the network or on the server host, and the client is unable to determine if the port is open.


![image](https://github.com/user-attachments/assets/e60a8b26-d163-4dad-809b-e64b16f515b7)


UDP Port Scan
UDP is not connection-orientated. Packets are simply assigned an Internet Protocol (IP) and a port number and shipped off. There is no built-in mechanism in UDP that determines if the packet made it. The simplicity in UDP serves as a disadvantage while port scanning. If a response is received from the server, then you can definitively say that the UDP port is open. However, sending UDP packets at a host often returns no data if the port is open. This response would be no different if the port was filtered. If the port is closed, then an ICMP Port Unreachable message may be received, which can be generated by the server host or gateway. Other ICMP messages mean that the port is filtered.


![image](https://github.com/user-attachments/assets/03266c56-af2b-43fe-8060-678ae2fbb78d)

------------------------------------------------------------------------------------------------------------------------

Port Scanning Utilities
Netcat
﻿

Often called the TCP/IP Swiss Army knife, Netcat is a versatile tool that can be used for purposes such as a chat/messaging server, file transferrer, and, of course, port scanner. Netcat has a very small footprint and comes pre-installed on most Linux distributions and is easily installed on Windows. The preinstalled version of Netcat on several Linux versions is often different from the one you can build from source code. A common modification is the removal of the ability to execute programs due to the security implications; namely being able to remotely gain a shell. Figure 6.2-3 shows the help menu presented by Netcat.


![image](https://github.com/user-attachments/assets/6eddfeab-d379-4fa6-93b0-e24045da9598)


Telnet


Telnet is a protocol that allows remote logins to another system running a Telnet server. You should already be familiar with the security implications of using Telnet for remote administration; however, the Telnet client is still useful for port scanning and banner grabbing. The client comes preinstalled on several versions of Cisco Internetwork Operating System (IOS) and other routing Operating Systems (OS). Figure 6.2-4 shows usage options for Telnet.


![image](https://github.com/user-attachments/assets/3dc87a97-6c22-4a53-b80b-a5143fd1a50a)

--------------------------------------------------

Port Scanning and Banner Grabbing with Netcat
The resulting output from the previous command is shown below:

![image](https://github.com/user-attachments/assets/c7df9017-a6b2-4eff-9807-09e513442acf)

As detailed, SSH is open on this device. Now that the open port is verified, perform a banner grab to get more information on the service.


NOTE: The following steps continue from the previous task.


7. Run the nc command without the -z option on the open port to perform a banner grab:
(trainee@dmss-kali)-[~] $ nc -nvw 10 172.35.1.21 22



Depending on the service running or how the service is configured, the server may not always return a banner or data. This was seen in the first port scan against HTTP; even with the socket left open, the server sent no data. 

---------------------------------------------------------------

Port Scanning and Banner Grabbing with Telnet
From the output, it is evident that the version of SSH on the host is OpenSSH 5.5.

![image](https://github.com/user-attachments/assets/2a196057-02ac-44c4-95eb-7ca0b23ddda9)

Recall seeing a -u option for UDP mode with Netcat. This functionality does not work as expected and is not recommended for use as a port scanner. Netcat looks for an ICMP UDP port unreachable to determine if a port is closed. If the port is filtered or open, then the program states the port is open. As it stands, the messages returned from UDP scans are often unreliable and may confuse analysts. If nc must be used to port scan UDP ports, the most surefire way to assess if a port is open is if data is received from the server. This means the -z option is not possible.


Table 6.2-3 details the UDP Port States and the message received from Netcat:

![image](https://github.com/user-attachments/assets/92e6a1c8-33f7-4895-b473-178947acf074)

Telnet is a less versatile tool than Netcat, but the choice of tools is not always available in the environment. For example, many Cisco IOS devices may not have Netcat, but may have Telnet installed.

--------------------------------------------------

Nmap
Nmap is a popular free and open-source utility for network discovery and security auditing. It is a powerful tool that does much more than port scanning; many network and systems administrators use it for vulnerability scanning, network inventory, managing upgrading schedules, and more. Due to its popularity, Nmap is a well-documented utility. There are versions that support Windows, Linux, and macOS. Unlike Netcat however, Nmap does not come preinstalled on most OSs. Nmap also has a few sub-projects such as Ndiff and Zenmap. Ndiff compares two different Nmap scan results and reports differences. Zenmap is a Graphical User Interface (GUI)-based tool that allows the user to create and save scanning profiles.

﻿

There are six NMAP port states according to Nmap.org documentation:

﻿

Open
﻿

An application is actively accepting TCP connections or UDP packets on this port. Finding these is often the primary goal of port scanning. Security-minded people know that each open port is an avenue for attack. Attackers and pen-testers want to exploit the open ports, while administrators try to close or protect them with firewalls without thwarting legitimate users. Open ports are also interesting for non-security scans because they show services available for use on the network. Before getting too excited about an open port, note that it is possible that the application is protected with a TCP Daemon Wrapper (TCPD) or that the application itself is configured to only service approved client IP addresses. Such cases still leave more attack surface than a closed port.

﻿

Closed
﻿

A closed port is accessible (it receives and responds to Nmap probe packets), but there is no application listening on it. They can be helpful in showing that a host is online and using an IP address — host discovery or ping scanning — and as part of OS detection. Because closed ports are reachable, they may be worth scanning later in case some open up. Administrators may want to consider blocking such ports with a firewall so they appear in the filtered state.

﻿

Filtered
﻿

Nmap cannot determine whether the port is open because packet filtering prevents its probes from reaching the port. The filtering could be from a dedicated firewall device, router rules, or host-based firewall software. These ports frustrate attackers because they provide so little information. Sometimes they respond with ICMP error messages such as type 3 code 13 — destination unreachable: communication administratively prohibited — however, filters that simply drop probes without responding are far more common. This forces Nmap to retry several times in case the probe was dropped due to network congestion rather than filtering. This sort of filtering slows scans down dramatically.

﻿

Unfiltered
﻿

The unfiltered state means that a port is accessible, but Nmap is unable to determine whether it is open or closed. Only the ACK scan, which is used to map firewall rulesets, classifies ports into this state. Scanning unfiltered ports with other scan types such as Window scan, SYN scan, or FIN scan, may help resolve whether the port is open.

﻿

Open|Filtered
﻿

Nmap places ports in this state when it is unable to determine whether a port is open or filtered. This occurs for scan types in which open ports give no response. The lack of response could also mean that a packet filter dropped the probe or any response it elicited. So Nmap does not know for sure whether the port is open or being filtered. The UDP, IP protocol, FIN, NULL, and Xmas scans classify ports this way.

﻿

Closed|Filtered
﻿

This state is used when Nmap is unable to determine whether a port is closed or filtered. It is only used for the IP Identification (ID) Idle scan discussed in the TCP Idle Scan (-sI) section.

---------------------------------------------------------------------------------------

Service and OS Versioning
Nmap has a few options that allow for service, version, and OS identification. They are as follows:

-sV: Enables service and version detection. This is done by sending out a series of probes that elicit information.

-O: Enables OS detection. Nmap provides a best guess of what the underlying OS is based on TCP/IP Stack fingerprinting. Different OSs generally have different options set in their TCP/IP options which enables OS detection.

-------------------------------------------------------------

UDP Scan
Nmap has UDP scanning capabilities as well and requires superuser privileges to run. The -sU option denotes a UDP scan, and can be done in conjunction with other TCP scans.

---------------------------------------------------------------------

Nmap Operational Security
Port scanning involves hundreds, if not thousands, of packets depending on the scan options. IDSs and Intrusion Prevention Systems (IPS) easily pick up on this activity. Nmap comes with timing templates, which enable the penetration tester to reduce the odds of being caught. These range from the T0 option, which is the least likely to set off alerts, to T5, which is an extremely loud packet blaster. The TCP options set for each template can be seen in Table 6.2-4. Do not memorize this table, it simply gives some insight on what is done differently from T0 to T5.

![image](https://github.com/user-attachments/assets/ecb36fef-f078-45e9-a86d-280a9c59f708)

NOTE: Timing parameters in Table 6.2-4 are shown in milliseconds.


The author of the documentation states that if you have a decent broadband connection and are not worried about setting off an IDS/IPS, then T4 is a good template to use. Keep in mind that the templates on the lower end take more time to complete as they wait more time before sending out more packets, as seen by the scan delay. For example, the T2 template can take more than ten times longer than the T4 template.


-----------------------------------------------------------------------------

Port Scanning Recap
The takeaway is that there are a few different port scanning utilities available to CDAs. The three covered are Netcat, Telnet, and Nmap. Some options that may come in handy for a CDA are as follows:

﻿

Netcat
-n: Disable port and name resolution
-v: Verbose
-w: Wait timeout
-z: Zero data
Nmap
-p: Port specification
-Pn: Do not conduct host discovery
-sS: SYN Stealth
-sT: Connect
-sA: ACK scan
-sW: Window scan
-sF: FIN scan
-sN: Null scan
-sX: Xmas scan
-sM: Maimon scan
-sU: UDP scan
-T[0-5]: Timing template
-sV: Attempt service and version detection
-O: Detect the OS
From the defensive perspective, hosting services leave open ports on a system. These open ports increase the attack surface within the network and may enable adversaries to gain footholds within their targeted network. Disabling an unneeded service reduces the attack surface. Firewall devices may also protect against scanning attempts if a service is needed, though it may be possible to circumvent them. Test and validate firewall rules for the best mitigative results.

-----------------------------------------------------------------------------------------

Vulnerability Scanning
Vulnerability scans oftentimes follow port scans. For example, when a host is scanned and port 80 is determined to be up, the CDA might run Nikto, an open-source vulnerability scanner for assessing web servers. However, this is not always the case. Vulnerability scanners have become much more robust and may even incorporate port scanners. Vulnerability scanners — such as Assured Compliance Assessment Solution (ACAS) — are made to be more comprehensive. Vulnerability scanners fall underneath the reconnaissance tactic of MITRE ATT&CK under the technique ID T1595.002. The results of a vulnerability scanner may include the following:

Unwanted services running.
Default credentials in use.
Out-of-date software in need of hotfixes, patches, or updates.
Weak algorithm usage.
Insecure configurations.
Existing exploits for software.
Adversaries may use vulnerability scanners to delve into a host's weaknesses and find room for exploitation. Network defenders use vulnerability scanners to assess their network and locate mitigations that should be applied. Some services, such as web, are incredibly complex with a seemingly infinite number of configurations, software backends, etc. Vulnerability scanners dedicated to just scanning web services exist.

﻿

Vulnerability scans can be unauthenticated or authenticated. Unauthenticated scans pass no additional information to the scanner for a provided service. Authenticated scans provide information needed to log into services to gather configuration settings and assess a service more in-depth — past just the login page. Both have their uses; unauthenticated scans allow a CDA to see results as adversaries would see them, while authenticated scans enable the defender to gather more vulnerability information about a service. Both authenticated and unauthenticated scans should be evaluated for a complete picture.

﻿

Vulnerability scanners include the following:

ACAS: Also known as Nessus. ACAS is frequently used by CPTs and likely encountered as a CDA.
Nmap: Mentioned as a port scanner; however, it can function as a vulnerability scanner, especially with the Network Scripting Engine (NSE).
OpenVAS: Another full-featured vulnerability scanner.
Nikto: An open-source web vulnerability scanner. It specializes in finding web-based attacks such as Structured Query Language (SQL) injection and Cross-Site Scripting (XSS) vulnerabilities.
Burp Suite: Another web vulnerability scanner.
ACAS, Nmap NSE, and Nikto are covered more deeply in the following lab.

-----------------------------------------------------------------

Nmap Network Scripting Engine
Nmap NSE comes installed with several scripts designed to perform more in-depth vulnerability scanning. You can also write your own. Third-party scripts exist as well, but be cautious when running scripts downloaded off the internet as they could contain malicious code.

---------------------------------------------------------------------

Nikto
Nikto is a one-trick pony, but it does its one trick well. Nikto only scans web services, but it is a fantastic tool to use when encountering a web server. It is easy to install, easy to use, and capable of a fairly comprehensive scan in a relatively short amount of time. It is capable of identifying several vulnerabilities in the Open Web Application Security Project (OWASP) Top 10 such as security misconfiguration, cross site scripting, and injection.

﻿------------------------------------------------------------

 
ACAS Continued
By now, the ACAS scans should be done or close to done. As a brief refresher, recall that you ran a Basic Network Scan against the 172.35.2.0/24 subnet, which contains core services for this network. The results are shown in Figure 6.2-42:

![image](https://github.com/user-attachments/assets/4f990872-0893-4a7e-a9f9-ca2e2e197305)

There are three hosts in the subnet from the output, and most of the vulnerabilities are informational.

---------------------------------------------------------------

Detecting Scanners
Luckily for network defenders, port and vulnerability scanners are generally noisy. Depending on the scanning software and options selected while running, it can be easy to spot these scanning tools in traffic. Use Zeek logs to identify scanning activities in Kibana.

﻿----------------------------------------------------

 Detecting Adversaries Using Timing Templates
The trainee can tell it was a SYN Stealth because the maximum client packets was 2. This is indicative of a SYN and a RST. Figure 6.2-51 details one of the entries expanded, which alludes to this:

﻿
![image](https://github.com/user-attachments/assets/41546997-4cac-40d3-ae23-b09153baa91a)

﻿

Figure 6.2-51

﻿

Recall that Nmap has built-in timing templates that try to mask scanning attempts. In the following steps, observe a timing template of 0, also known as the paranoid timing template.

﻿--------------------------------------------------------------------------------------

Detecting Adversaries Using Vulnerability Scanners
Vulnerability scans are often preceded by port scans, depending on the tool. This is certainly the case for ACAS. In the next set of steps, observe an ACAS scan in traffic.

--------------------------------------------------------------------------------

Detecting ACAS
The scanning host is 199.63.64.104 as seen in the source.ip column. Notice that in this case, the connections have more packets than during a port scan. The last entry in this screenshot has 24 client packets and 42 server packets. This is because the scanning host actually connects to the server AND sends and receives data to attempt to identify services and vulnerabilities.

![image](https://github.com/user-attachments/assets/49d8cd2f-45c4-40a2-ab03-f0bcdf7fc65c)


A bonus is that ACAS also employs the user agent string Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0) when scanning web-based ports.


To summarize, a vulnerability scanner is generally preceded by a port scan but also has longer sessions due to actually sending and receiving data to the server to identify vulnerabilities.


ACAS does not necessarily have IDS evasion built in. ACAS does, however, have a low-bandwidth mode, which enables slower scans and makes them less detectable. This function is meant to be used over links with less throughput and reduces the number of hosts scanned at a time. Also, low-bandwidth mode slows down the scan if network congestion is detected. However, scans using low-bandwidth mode are still fairly obvious, though this may vary depending on the amount of network traffic. 

-----------------------------------------------------------------------------

Detecting Nikto Scans
Examine what Nikto scans look like in traffic.


-----------------------------------------------------

Detecting Scanners Recap
This lab showed what scanners may look like in traffic. The following was examined:

NMAP scans
ACAS scans
Nikto scans
A few potential IDS evasion techniques

-------------------------------------------------------

Source IP Address Solution
There were two datasets examined in this lesson to visualize abnormal traffic patterns. The first was viewing the Zeek connection log. However, this does not provide a useful picture.

![image](https://github.com/user-attachments/assets/04d14ef7-bc7d-4125-8ed5-b35f8e32b0eb)

This does not rule out Nmap scans with slower timing templates. Check the other dataset discussed in this lesson — the Zeek HTTP logs — before going down that rabbit hole.

![image](https://github.com/user-attachments/assets/d59156b8-a96f-41c1-9354-e08fcbaeaa23)

There is an abnormal number of web requests toward the end. Select the first spike. It seems evident that one host is responsible for most of this traffic.

![image](https://github.com/user-attachments/assets/3e754a03-a4b8-497a-a0a5-2a59f4af9702)

![image](https://github.com/user-attachments/assets/f1ba539b-e1b5-4328-bfe7-46ba439e4ec0)

During the spike, the one IP address is responsible for 92% of the traffic! The malicious actor in this case is 128.0.7.23.


---------------------------------------------------

Scan Type Solution
Both ACAS and Nikto have built-in web scanners. However, ACAS is more comprehensive as a scanner, and is usually preceded by a port scan.

![image](https://github.com/user-attachments/assets/81585003-881b-482d-aec2-681d26d738eb)


There does not seem to be evidence of port scanning based on the query for short sessions. However, the requested URIs do point toward Nikto's known behavior, which uses a dictionary to request several webpages.

![image](https://github.com/user-attachments/assets/3930f0b7-2993-446e-90a9-bcc63239b734)

Of the possible answers, Nikto is the best answer.

--------------------------------------

Evasion Techniques Solution
Upon examining the requested URIs in greater detail, it seems like the case of several letters is mixed.


![image](https://github.com/user-attachments/assets/7d71d142-9f43-4c55-ba85-074a567a9fe6)

Recall that Nikto may mangle the URLs slightly in an attempt to circumvent some IDS settings. This can be confirmed by viewing the Nikto help page.

![image](https://github.com/user-attachments/assets/1953e085-848c-4e48-b921-65d731a7eaad)

Congratulations! You have completed the practical exercise.

------------------------------------------------------------------

########## M6 L3 ############
######### Wireless Sniffing ###########

Wireless Networking Overview
Overview
﻿

The 802.11 family of radio protocols is commonly referred to as Wireless Fidelity (Wi-Fi). Wireless network traffic is sent over the 802.11 radio protocol, which spans Layer 1 (Physical Layer) and Layer 2 (Data Link Layer) of the Open Systems Interconnection (OSI) model. In Layer 1, the 802.11 defines the frequency (e.g., 2.4GHz and 5.0Ghz) and modulation, and in Layer 2, the protocol defines the device addressing. This family is subdivided into smaller protocols based on the frequency and rate of the data being transmitted. 

![image](https://github.com/user-attachments/assets/c7901432-5cb1-446d-9300-3538979b2b7b)

Wireless Access Points


Wireless Access Points (WAP) are wireless devices operating at layer 1 and layer 2, with some implementations providing additional layer 3 support, such as routing. They provide clients mobile access to network resources, point-to-point connectivity for Metropolitan Area Networks (MAN), and administrator connections to client devices over the 802.11 protocol. Each access point is located by its Service Set Identifier (SSID), though it is called an Extended SSID (ESSID) when multiple access points use the same SSID. The Media Access Control (MAC) address of the radio interface serving the network identified by a specified SSID is the Basic Service Set Identifier (BSSID) of that network. When a named network is administered by multiple access points, the ESSID consists of all BSSIDs serving the network. In such a case, it is possible to move from one room to another, change from one BSSID to another, but never change the ESSID of the network a device is connected to.


Channels


Channels are specific, narrower bands of the Radio Frequency (RF) spectrum over which a WAP operates. The numbers — 1 through 14 — in Figure 6.3-1 show the associated channels and 22 megahertz (MHz) overlapping RF bands used in 802.11 protocols.

![image](https://github.com/user-attachments/assets/71c9aa8d-919f-416d-99e4-36572b084202)


Types of Frames


In the 802.11 wireless protocol, a number of management frames are used for announcing, creating, and removing connections to the network. 


Beacon


Beacon frames are periodic announcements of wireless network information, sent over the RF channel on which the WAP operates. The WAP broadcasts information such as the SSID, device capability (e.g., encryption details), supported data rates, interval between beacon transmissions, and miscellaneous details used for establishing RF communication with the WAP.


Deauthentication Frame


The deauthentication frame is sent when one party in the connection wishes to terminate the connection. This disassociates a device from the access point, so any reassociation requires new authentication when encryption is employed. When sent, this frame includes a reason code for the termination, which may be Deauthenticated because sending station is leaving BSS or Disassociated due to Inactivity; there are more than 60 such codes. Most importantly, in certain types of wireless attacks, these deauthentication frames are spoofed by an attacker to force a client device off a network to either assume its place or to force reauthentication. Figure 6.3-2 shows the structure of an 802.11 management frame where the reason code is sent. See the additional resources for more information on the various types of deauthentication reasons.

![image](https://github.com/user-attachments/assets/85d4fa21-7c9d-4d48-8e4c-4f23e8877114)


--------------------------------------------------------------------------------

Wireless Sniffing | Overview
Overview
﻿

Wireless sniffing is a form of reconnaissance, potentially leading to host or even credential discovery in mission partner networks employing wireless technology.

﻿

MITRE defines this technique — both wired and wireless —  as the use of a network interface on a system to monitor or capture information sent over a wired or wireless connection and identifies it with the code T1040. This information may include authentication handshakes, name service resolution queries, service requests (revealing which services are active in a network), and a variety of metadata allowing the potential identification and fingerprinting of active hosts in the environment. 

﻿

This type of attack accomplishes information gathering for the threat adversary. There are a number of ways for this information to be gathered. 

﻿

Types
﻿

Wireless sniffing can be conducted either actively or passively. While the capture itself is always a passive action — it requires no interaction with other devices or services to capture — the amount and quality of the data can vary. 

﻿

Passive Sniffing
﻿

When an adversary's priorities are stealth and maintaining target network access, passive sniffing is the ideal route to follow. In this, the attacker does not interact with any targets, but simply takes advantage of wireless signals sent through a network and captures the packets that are being transmitted over the air.

﻿

Active Sniffing
﻿

When an adversary's priorities are information gathering, and stealth is an acceptable quality to risk, active sniffing allows for more potential data to be gathered. This type of sniffing is a combination of passive sniffing on one attacker machine and, on the same machine or, ideally — a separate one that is expendable. The injection of traffic leads to a breakdown in secure switching mechanisms or reliable authorities for name resolution or network access, leading to Man-in-the-Middle (MitM) access to data. This can allow the collection of traffic that would otherwise be encrypted.

﻿

Tradeoffs
﻿

The advantage of active sniffing is that the adversary gathers more valuable information. The cost is stealth, leading to potential discovery from network defenders. The advantage of passive sniffing is security of position, in that an attacker can quietly listen and remain undiscovered. The cost of passive sniffing is time. 

﻿

Goals
﻿

Threat adversaries employing wireless sniffing are attempting to acquire various types of information for use in follow-on exploitation, lateral movement, and privilege escalation. The following types of data can be obtained through analysis of raw Packet Captures (PCAP):

﻿

Host Information
﻿

The number, type, and names of various host and networking devices on the network are likely to be extracted from sniffing. The network communication contains various signatures such as Time to Live (TTL) numbers, Maximum Segment Size (MSS) values, or Transmission Control Protocol (TCP) window size, which contribute to an attacker's ability to passively identify the OSs of various hosts. If an attacker is able to capture traffic containing authentication traffic (e.g., Server Message Block (SMB) share access), then the available information includes hostnames, usernames, and service names on both ends of the exchange. If unencrypted, this collection can even include credentials.

﻿

Addressing
﻿

Sniffing also yields the IP addresses and MAC addresses of devices communicating on the same wireless network as the sniffing device. Only the MAC addresses of devices on the same Virtual Local Area Network (VLAN) are visible, but even this amount of segmentation is valuable knowledge to the attacker. Capturing and observing Address Resolution Protocol (ARP) requests and replies also aids in revealing this local VLAN architecture. 

﻿

Services
﻿

Even without running an active scan, a savvy threat adversary can determine which services are available in a wireless network by observing other devices accessing those service on common ports and over known protocols. This reveals not only whether services such as web, File Transfer Protocol (FTP), e-mail, network data storage, or others are running, but also on which specific devices and ports.

![image](https://github.com/user-attachments/assets/75dacd55-63d9-4f31-a98a-55c7b2c5cb46)

----------------------------------------------------------

Wireless Sniffing | Active Sniffing Techniques
Evil Twin Attack
﻿
Also known as the Rogue Access Point attack, this type of active technique augments wireless sniffing reconnaissance by capturing all sides of a conversation and proxying the traffic. This attack occurs when the threat adversary stands up an alternative WAP with the same SSID as the original legitimate access point. When an unwitting user believes that they are connecting to a known wireless network with the familiar SSID, all their requests are first sniffed and captured by the malicious device. This technique can be combined with DNS Cache Poisoning to direct users to malicious web domains where additional valuable data is sniffed. 

﻿

MAC Spoofing
﻿
MAC Spoofing is a useful technique for gaining access to a wireless network that is protected by a captive portal or some other form of network authentication that whitelists clients by MAC address. The attacker first alters their own machine's MAC address to emulate a known whitelisted device, then sends a stream of deauthentication packets to the target device so as to break the connection between that device and the access point on the client's end, thus stealing that network connection. Having achieved access to the network, the attacker can then continue in further reconnaissance, additional active sniffing measures, or continue passively sniffing traffic.

![image](https://github.com/user-attachments/assets/c1a06d22-7852-47d1-8e3d-32e3361aba2e)


-----------------------------------------------------------

Defenses Against Wireless Sniffing
The strongest defense against a Malicious Cyber Actor (MCA) eavesdropping on a mission partner's wireless communications is secure network implementation and administration. There are several key principles to consider when administering wireless networks.

﻿

Signal Strength
﻿
Since any device attempting to sniff a mission partner's wireless traffic must be able to receive the signals as they are transmitted from the WAP, reducing the coverage of the wireless network to only the necessary physical footprint of users that should access it is ideal. In this way, the wireless signals do not travel further than required. This signal strength is modulated by adjusting the power used by the transmitting WAP. A wireless signal that is too strong can lead to extended range that attacker may be able to access, for example from a coffee shop across the street.

﻿

Encryption
﻿
Encrypted communications is the bedrock on which the assurance of security is based. There have been several technologies developed since the advent of wireless networking to employ encryption to radio communications. These technologies have employed either stream ciphers, which encode plaintext messages bit-by-bit, or block ciphers, which encode data in fixed-size blocks to secure wireless traffic.

﻿

Wireless Encryption Protocol
﻿

Wireless Encryption Protocol (WEP) was the first attempt at securing wireless networks. Users realized that using a WAP in the clear caused gratuitous data loss to even non-savvy attackers. These attackers could connect to a network, turn on promiscuous mode, and steal login credentials, credit card numbers, and other private information. WEP was the first specification developed to encrypt wireless data and employs Rivest Cipher 4 (RC4) stream cipher encryption, though its use of the same key for all traffic has proven to be as insecure as transmitting in plaintext — an attacker needs fewer than 10 minutes of traffic monitoring to break the WEP key and read all captured traffic. This is largely due to the small Initialization Vector (IV) size of 24 bits. This random value serves as the starting point for the encryption of each individual frame and can easily be reused after a few hundred web requests in a crowded network. Once the adversary has two different frames with the same IV encrypted by the same static key, breaking the key is simple and the entirety of sniffed traffic is available to them. 

﻿

Wi-Fi Protected Access
﻿

When WEP was identified to be such a flawed standard, the wireless industry developed Wi-Fi Protected Access (WPA), which continues to employ the RC4 method for encryption, but instead applies that encryption in the stronger Temporal Key Integrity Protocol (TKIP). TKIP uses a larger keysize than WEP, a larger IV size, and employs a simple Message Integrity Check (MIC) to improve confidence in secure communication. Additionally, the key is dynamic — it changes for each packet, which solves another problem that WEP presented. The only way to potentially break WPA from sniffing the traffic is to capture the original authentication handshake and hope that the master key is small.

﻿

WPA2
﻿

In the second iteration of the WPA standard, the TKIP method was replaced with the Advanced Encryption Standard (AES)-based Counter Mode Cipher Block Chaining Message Authentication Code Protocol (CCMP). This encryption method employs the strongest accepted block cipher rather than the RC4 stream cipher and includes improved message integrity checking both encrypted and unencrypted data in communications.

﻿

When WPA2 is configured with a Pre-Shared Key (PSK), a single American Standard Code for Information Interchange (ASCII) password or passphrase is provided to the WAP and to any client devices that need to connect to it. This shared secret is only as strong as the trust in the users employing it. For this reason, this form of authentication is more commonly used in residential or public Wi-Fi environments, while 802.1x is preferred for enterprise networks.

﻿

Authentication
﻿

802.1x with Extensible Authentication Protocol – Transport Layer Security (EAP-TLS)
﻿

802.1x is a form of centralized network authentication in which a supplicant (client device) requests access to the network itself, then follows an authentication process that occurs at a dedicated authentication server, usually a Remote Authentication Dial-In User Service (RADIUS) server. In this model, the WAP is the authenticator device. This form of network authentication vastly increases the security of a wireless network obscuring all traffic behind encryption after the initial authentication handshake.

﻿

Authentication Handshake
﻿

When 802.1x authentication is not employed, authenticating to an access point utilizing WPA to communicate over the network is a four-step process. This process assumes the use of a master PSK. 

﻿

The master PSK can be used to create several derivative keys that are used in subsequent communications. It is important to understand these definitions of those subsequent keys:

Pairwise Master Key (PMK): The master key derived from the PSK for connections between a WAP and client device.
Pairwise Transit Key (PTK): The connection-specific key for all unicast communication between a WAP and client device.
Group Master Key (GMK): The master key derived from the PSK for broadcasts between a WAP and any client device.
Group Temporal Key (GTK): The connection-specific key for all multicast communication from a WAP.
ANonce: A connection-specific random value created by the WAP (authenticator).
SNonce: A connection-specific random value created by the client (supplicant).
Using these values, the temporal keys are created through a pseudorandom function that uses the PMK or GMK, ANonce, SNonce, client MAC address, and WAP MAC address. 

﻿

When the client initiates an authentication request, the following four-way handshake allows the exchange of the necessary keys.

﻿

1. The WAP provides the client with the ANonce used to create the PTK.

2. The client provides the WAP with the SNonce, encrypted with the PTK.

3. The WAP provides the client with the GTK, encrypted with the PTK.

4. The client confirms receipt of the GTK, encrypted with the PTK.

﻿

At this point, the client can encrypt and decrypt all unicast traffic with the PTK and encrypt and decrypt all multicast traffic with the GTK.

﻿

Virtual Private Networks
﻿

Virtual Private Networks (VPN) are a secure tunneling solution that allow encrypted access to trusted mission partner networks even when not physically connected to it. These solutions are essential for remote workers that may be using publicly available or even private wireless networks to access mission partner resources, because even if the rest of the infrastructure is secure, if a remote worker accesses sensitive material insecurely, then that material may be sniffed over the insecure wireless network.

![image](https://github.com/user-attachments/assets/1f829cf6-cefb-4443-b9a1-290072c93a84)

![image](https://github.com/user-attachments/assets/f06cb074-5582-46a9-b1a8-f8a044724e10)


-------------------------------------------------------------

Practical Defenses | Detecting Rogue Access Points

-------------------------------------------------------------

Practical Defenses | Detecting Rogue Access Points
Workflow

﻿

NOTE: The following steps continue from the previous task.

﻿

5. Observe that the device with BSSID 00:0f:66:05:a9:11 is transmitting wireless management packets with the same SSID PublicLibrary as the legitimate access point. 

﻿![image](https://github.com/user-attachments/assets/cf49eef3-b2ec-4da5-ab16-386575d45f3d)

This device is successfully emulating the legitimate PublicLibrary access point. Any device that connects to this rogue access point — even though they may experience uninterrupted service — are likely to have their entire communication captured by the attacker.

-----------------------------------------------

########## M6 L4 ############
######### SNMP Enumeration ###########

SNMP Overview
SNMP is a management protocol used to monitor and manage network devices. Most networking devices and components — including routers, switches, printers, servers, and workstations — support getting and setting various values associated with the configuration of the device. End-user devices and workstations are less likely to have SNMP turned on by default but may have it enabled through various methods, like group policy for Windows. SNMP is widely used by network administrators to monitor networking devices for items like bandwidth, uptime, temperature, errors, network connections, processes, routing tables, Address Resolution Protocol (ARP) tables, and additional values. A system that is configured to use SNMP is called a managed device. Managed devices use a service or software application — an agent — running on the device to interface with the device's internals and interact with a Network Management Station (NMS). An NMS consists of a terminal that uses SNMP to query and set various settings on managed devices, as well as receive device-originated push notifications. The various values that a device using SNMP provides to an NMS are contained in a Management Information Base (MIB), which describes the configuration and status of the local system. The agent translates the MIB values for use with SNMP.

﻿

Figure 6.4-1 shows a generalized concept of how an NMS and agent interact. Notice there are two main types of communication. Interactions that use the GET and SET SNMP commands can be uni-directional for setting values or bi-directional for queries. This communication occurs over User Datagram Protocol (UDP) port 161. Agents may also be configured to send unsolicited responses — using the TRAP command — to the NMS on UDP port 162 when certain thresholds are exceeded or on a periodic basis. This allows monitoring systems to get consistent updates on key variables and limits the amount of network traffic since the NMS does not send an explicit GET request.

﻿
![image](https://github.com/user-attachments/assets/6c5f62bb-5753-4574-9432-0bf839ab4ef9)

SNMP versions 1 and 2 use a community string — a text-based password — to separate read-only operations (typically indicated in configurations as ro) and set/write operations (typically rw or w). SNMP version 3 uses a user ID/password model for authentication instead of a community string. For decades, the default community strings have been the words public for read-only access and private for write access. Many networking devices still use these community strings by default. Network administrators often fail to change these community strings to something more secure, opening up these devices to provide sensitive information to anyone able to communicate with them using SNMP.


SNMP Versions


SNMP has three major versions of the protocol in use with various security and authentication implications relevant to defenders and system administrators. 


![image](https://github.com/user-attachments/assets/ef9b64fe-cd6a-4678-baed-7bc9dba05364)

Table 6.4-2 describes the types of SNMP command — or protocol data units — that are available for each version of the protocol. Commands that are in the SNMPv1 version are available for all versions.

![image](https://github.com/user-attachments/assets/95eb08d2-9a83-4f4d-babc-a9b60cf4bfdd)

SNMP Enumeration


Enumeration is the process of systematically counting or retrieving something. The MIB used for SNMP consists of Object Identifiers (OID) that identify each item in the MIB. OIDs are hierarchical in nature and follow a tree that is based on standards established by various international standards organizations, including the International Organization for Standardization (ISO), the National Institute of Standards and Technology (NIST), and the Internet Engineering Task Force (IETF). SNMP OIDs are typically displayed in a dot notation to indicate the specific node in the tree. For example, the dot notation 1.3.6.1.2.1 may also be described as:
{iso(1) identified-organization(3) dod(6) internet(1) mgmt(2) mib-2(1)}


![image](https://github.com/user-attachments/assets/0a9663ec-d54c-4f31-8973-995c12d85757)

This OID example refers to the branch in the tree that deals with the management of internet devices. The bulk of the MIB-2 specification (also sometimes seen as MIB-II) is based on the internet standards defined in Request for Comments (RFC) 1213 and RFC 3418 and defines the MIB for network management of Transmission Control Protocol (TCP)/Internet Protocol (IP)-based internets. SNMP enumeration is systematically requesting — or following — the subordinate OIDs in the agent's MIB to retrieve all available data. The further down — or deeper — into the tree, the more specific the information contained in the referenced node. A small excerpt of OIDs associated with a router is shown in Figure 6.4-3. 


![image](https://github.com/user-attachments/assets/d1b49e32-6c01-4c9b-9640-ce627c9121b7)


Notice that several OIDs were not decoded into a human-readable format. MIB repositories exist to assist in identifying the specific data held in an OID as vendors can define OIDs to hold a particular variable. Websites like oid-info.com compile the various standards-based and vendor-based MIBs and allow users to search for specific OIDs. Recall from Figure 6.4-2 that iso is the top-level node and can also be referenced with the number one. The OID repository at oid-info.com shows that the OID 1.3.6.1.2.1.10.131 is derived from RFC 4087 and is used to describe tunnel details.

![image](https://github.com/user-attachments/assets/b277a7e0-1c18-4f8e-a82e-72a623c8a7cb)


![image](https://github.com/user-attachments/assets/4b6899d1-63b8-4287-904a-af1a81021a2e)


------------------------------------------------------------------


SNMP Enumeration | Techniques
There are many tools that network and system administrators use to interact with agents/devices. Attackers often use the same tools as a mechanism to blend in with legitimate activity. Both open-source and commercial network monitoring suites exist with varying levels of automation and ease of use. Both snmpwalk and snmp-check are common Linux command-line utilities that use SNMP GETNEXT requests to query an agent for a tree of MIB values. snmpwalk can request only a portion of the MIB by specifying an OID space to start using GETNEXT requests — essentially a sub-tree. In the following lab, trainees use two CLIs to review examples of the data that networking devices may expose through SNMP.

---------------------------------------------------

Automated Tools

![image](https://github.com/user-attachments/assets/323e97fe-f7d8-467b-b883-cc163ec04637)

Figure 6.4-6 shows the output of snmp-check from ch-core-rtr and the interfaces assigned to a device are shown in the Network IP: section of the output.


The Command-Line utilities discussed are useful for interacting on a host-by-host basis but are less useful to administrators managing large enterprises with hundreds or thousands of devices. Many commercial network management tools exist that use SNMP to periodically poll the health of these devices. These tools provide Graphical User Interfaces (GUI) and use SNMP requests for specific details. They can also set and receive SNMP Trap commands from network devices. Using automation and common SNMP configuration, administrators can identify network faults, availability issues, and monitor critical performance metrics. Two examples of commercial automated SNMP management solutions are from the companies SolarWinds and ManageEngine. Like most commercial SNMP management solutions, both have GUIs to browse the entire MIB for the various supported devices as well as the ability to show different visualizations of the states of the managed devices. Most attackers use CLI tools to interact with SNMP, so the commercial solutions are not discussed further in this course. 


SNMP Defense


While SNMP can be very useful for administrators, that same data can provide attackers a plethora of useful configuration information to further exploit and move within a network. If SNMP is not used or needed within a network, the best defense is to disable or remove the SNMP agents.


In networks that need to use SNMP, the following considerations need to be taken:
Ensure community strings used with version 1, 1c, or basic v3 (no authentication or privacy) have read-only access and NOT write access.
Ensure any community strings configured for write access use SNMPv3 with authentication.
Safeguard community strings — devices often store community strings in plain text.
Use Virtual Local Area Networks (VLAN) and firewall rules to limit SNMP traffic to networking devices and a set list of permitted management hosts.
Explicitly block UDP ports 161 and 162 not associated with management hosts.
Use IP Security (IPSec) to encrypt and protect SNMP traffic.


---------------------------------------------------------

SNMP Analysis in Kibana
Analyzing SNMP activity in a network can be accomplished using a Security Information and Event Management (SIEM) like Security Onion using Kibana. In this scenario, the Cyber Protection Team (CPT) has been tasked to assist local defenders of the City Hall network. Threat intelligence indicates attackers may be using SNMP to gain detailed network configuration details in order to gain access and laterally move within similar city networks. City Hall administrators requested assistance due to the discovery of a router configuration posted on GitHub that contained the device's SNMP community string by accident and was publicly accessible. Local defenders have provided the following overview:

IP address space: 172.35.0.0/16

Public IP address: 104.53.222.32

Edge firewall: 156.74.85.2

Demilitarized Zone (DMZ): 172.35.3.0/24 (Network Address Translation [NAT] from ch-edge-rtr to public IP address)

SNMP: simspace community string, but not used by City Hall network administrators

A Deployable Mobile Support System (DMSS) kit has been attached to the City Hall core router using the 199.63.64.0/24 subnet

Take note of the above information and use it to analyze any SNMP activity in the following tasks.

-----------------------------------------------

Analyzing the Results
﻿
![image](https://github.com/user-attachments/assets/1e021973-2894-4f1e-ac79-35869044b8c5)

As is seen in Figure 6.4-9, at least five IP addresses were seen receiving SNMP requests. In order to see the full list, use a visualization to see the full list.


Use the information from the scenario to identify SNMP activity that is suspicious.


![image](https://github.com/user-attachments/assets/326b05fb-03cb-499c-aeb0-e8c9ca66cd21)

![image](https://github.com/user-attachments/assets/0af9fd86-2c22-44c6-944f-56629fa74031)

--------------------------------------------------

SNMP Enumeration Analysis

Two IP addresses originated SNMP requests in the time period: 128.0.7.205 and 199.63.64.51 — but since 199.63.64.51 is within the DMSS subnet range, 128.0.7.205 is likely associated with an attacker. It is the only source that is external to the network.

![image](https://github.com/user-attachments/assets/3050664e-7d2a-415a-a4c1-4e266fb1484c)

There is significant activity from the 199.63.64.51 IP address, which is internal to the DMSS kit subnet. When activity like this is discovered by defenders, communication is required to deconflict with the rest of the team to ensure that the activity is legitimate. Activity that originates from within an expected legitimate enclave still requires validation to ensure the security tools used by defenders have not themselves been compromised. 


The CPT team leader confirms the activity originating from 199.63.64.51 was other members of the team performing a survey and analysis of specific devices — this source can be filtered out as legitimate activity. Similarly known, SNMP management IP addresses can be filtered out as a part of a playbook to identify SNMP activity that may be suspicious.

--------------------------------------------------

SNMP Mitigation
SNMP agents are not installed or started by default on most Windows Operating Systems (OS). For Windows OSs, SNMP runs as a service and can be seen in the Services control panel. Disabling the SNMP service is one method to mitigate risk due to SNMP. Changing the community strings and restricting what hosts can reach the SNMP service are other ways to mitigate SNMP on Windows OSs. Routers and other networking devices are all different, but references to SNMP in the configuration files indicate if the agents are running. Mitigating these devices varies and the documentation should be consulted in order to ensure the appropriate configuration changes are made. The following workflow walks through the mitigation of SNMP on a Windows server.


Workflow


1. Log in to the ch-dc1 VM using the following credentials:
Username: trainee
Password: CyberTraining1!



2. Open the Services control panel and scroll down to SNMP Service.

![image](https://github.com/user-attachments/assets/b4a8b19d-0bf9-45da-9613-ef9c1f99262d)

In this case, the SNMP Service — the agent — is installed and running. The management service that would receive SNMP traps — SNMP Trap — is not running.


3. Open the SNMP Service properties, and select the Security tab:

![image](https://github.com/user-attachments/assets/25ea3a0e-504c-4e21-9773-af12f3fae827)

Notice the simspace community string is listed with read-only rights, and this system is configured to Accept SNMP packets from any host. Limiting SNMP to management IP addresses only is one way to mitigate risk, as well as ensuring there are no write SNMP community strings. Configuring the SNMP agent to send Traps is made on the Traps tab. Microsoft has deprecated the use of SNMP in Windows OSs, so there is no native support for SNMPv3 with authentication. The use of Windows Management Instrumentation (WMI) or Windows Remote Management (WinRM) tools are the preferred and supported methods for obtaining the configuration and performance data of other systems using SNMP.


4. Select the General tab, stop the service, and set the Startup type to be Disabled.

![image](https://github.com/user-attachments/assets/d30a3296-73b3-4a84-b6df-621e9920f36c)

5. Apply the changes, and select OK. 


The same steps can be used to disable the SNMP Trap service. While there is less risk from leaving the SNMP Trap service enabled, if it is not being used, the best practice is to remove or disable any services not intended to be used to reduce the potential attack surface. Group Policy Objects (GPO) can also be created to ensure the SNMP service is disabled or removed across Windows domains.

-----------------------------------------------------


########## M6 L5 ############
######### Active Directory Enumeration ###########

AD Enumeration Overview
AD enumeration is used by adversaries to gain information about an AD environment that can help them further their attack. The adversary needs access to a domain account before they can perform AD enumeration. This activity falls under the Discovery (TA0007) tactic of the MITRE ATT&CK® matrix.

﻿

Adversaries use both third-party tools and built-in system tools for AD enumeration.

﻿

Third-Party Tools
﻿

Numerous third-party tools have powerful AD enumeration capabilities. Such tools include the following:

BloodHound uses graph theory to help adversaries or defenders find complex attack paths in AD that they can then exploit or harden. This tool was used in CDA-Basic to enumerate an AD environment.

PowerSploit is composed of PowerShell modules that can be used to assist adversaries in all phases of their attack.

PowerView is a specific module within PowerSploit that adversaries can use for network and Windows domain enumeration and exploitation.

Built-in System Tools
﻿

Adversaries may also use built-in system tools (i.e., they may live off the land). Such tools include the following:

Directory Service Query (DSQuery) is a command-line utility that queries the objects in AD by employing user-specified search criteria.

AD PowerShell Module is a suite of PowerShell cmdlets that allow a user to query AD objects with Windows PowerShell. Some cmdlets in this suite used to gather information about a directory are as follows:

Get-AdUser

Get-AdDomain

Get-AdComputer

Get-AdGroup

Get-AdGroupMember

Get-AdObject

NET commands can be accessed through a Command-Line Interface (CLI) and are primarily used to manage network resources. However, adversaries may use NET commands to enumerate users, shares, computers, groups, local groups, and other AD objects.

Windows Management Instrumentation Command-Line (WMIC) can be used by adversaries to enumerate hosts. WMIC provides a utility usable through a CLI to do this. WMIC can be used to get information on processes, user accounts, and groups.

Enumeration is one of the most important steps of an attack. If it is performed well, it can provide an adversary valuable insights into how an AD environment is configured. It can also allow an adversary to find misconfigurations that leave the environment vulnerable to further exploitation.

﻿

This lesson focuses on the third-party tools BloodHound and PowerSploit and the built-in system tool NET.exe due to their wide use among adversaries.

![image](https://github.com/user-attachments/assets/1eb6e532-d5ee-4700-86e6-5c4680feb7aa)


﻿--------------------------------------

 AD Review
AD is a database that contains information about objects on a network. Some of these objects are Organizational Units (OU), users, groups, computers, and Access Control Lists (ACL). Adversaries can query the objects to potentially find attack paths to follow to gain greater access.

﻿

CDA-Basic Modules 14 and 15 included AD concepts. Some of these concepts are summarized below.

﻿

AD Concepts
Directory: Stores all the information about objects.
Objects: References most items inside a directory (e.g., user, group, shared folder).
Domain: Stores directory objects.
Tree: Domain with the same root (vcch.lan, file.vcch.lan).
Forest: Group of trees connected by a trust relationship.
AD Directory Service Key Terms
Schema: The set of user-configured rules that govern objects and attributes in AD Directory Service (DS).
Global Catalog: The container for all objects in AD DS. For example, a name associated with a user or a computer is stored in the Global Catalog.
Query and Index Mechanism: This system allows users to find each other in AD. A good example is typing a recipient's name in a mail client and the mail client showing possible matches.
Replication Service: The replication service ensures that every Domain Controller (DC) on the network has the same Global Catalog and Schema.
Sites: Representations of the network topology, so AD DS knows which objects go together to optimize replication and indexing.
Lightweight Directory Access Protocol (LDAP): A vendor-agnostic, industry-standard application protocol that allows AD to communicate with other LDAP-enabled directory services across platforms. An example of its use is creating centralized management of AD users for validating access to various applications and services.
﻿

AD DS Services
Domain Services: The collection of software and processes that store information about the enterprise, including users and computers.
Certificate Services: This allows the domain controller to serve and authenticate digital certificates, signatures, and public-key cryptography.
Lightweight Directory Services: The foundation that supports LDAP.
Directory Federation Services: Provides Single Sign-On (SSO) authentication for multiple applications in the same session. SSO allows users to use only one set of credentials to log in to multiple applications.
Rights Management: The rules and configurations that control information rights and data access policies. The configurations defined using this service determine which users can access which files, folders, and applications.

----------------------------------------------

AD Enumeration: Living off the Land
Living off the land is when an adversary uses tools already present on a system rather than downloading additional tools. Living off the land is stealthier than use of third-party tools because the system tools are likely the same tools the internal Information Technology (IT) and Security teams use for their jobs daily. This means the activity has a chance to blend in with normal noise that the Security Operations Center (SOC) often flags as false positive.

﻿

As mentioned before, several tools enable living off the land to perform AD enumeration. These tools typically do similar things, and the adversary will use whatever is available on the system.

﻿

As an example, an adversary could grab a list of users in the Domain Admins group using any one of the below system tools and their associated commands:

﻿

DSQuery

dsquery group -name "Domain Admins" | dsget group -members
AD PowerShell Module

Get-ADGroupMember -Identity "Domain Admins" 
NET.exe

net group "Domain Admins" /domain
WMIC

wmic /NAMESPACE:\\root\directory\ldap PATH ds_group where "ds_samaccountname='Domain Admins'" Get ds_member /Value

![image](https://github.com/user-attachments/assets/12e6796d-a1ef-4530-9eb6-87803015861a)

------------------------------------------------------------
AD Enumeration with NET.exe
The CPT has been assigned to a mission to audit an AD environment. A domain account has been provided to the CPT to assist local defenders. Enumerate the AD environment and identify misconfigurations that an adversary may be able to take advantage of.

﻿![image](https://github.com/user-attachments/assets/1e09ff8f-dc42-43c5-97e4-d1db72b2a43d)

----------------------------------------

AD Enumeration: Third-Party Tools
Although living off the land can provide greater stealth, the more advanced capabilities provided by third-party tools are often necessary for an adversary to develop more efficient attacks.

﻿

This section focuses on the third-party tools PowerSploit/PowerView and BloodHound/SharpHound for performing AD enumeration.

﻿

PowerSploit/PowerView
﻿

PowerSploit is a post-exploitation framework of PowerShell modules that assists adversaries in execution, enumeration, persistence, exfiltration, lateral movement, and privilege escalation. PowerView is part of the PowerSploit Recon module and is the only element of PowerSploit this lesson covers.

﻿

To pull all the available commands for the Recon module, run the following command:


Get-Command -Module Recon
﻿

NOTE: This command can be used with any PowerShell module by replacing Recon with the module of interest.

﻿

Whereas NET.exe requires specifying the system to look for shares, PowerView can find all shares on the network without specifying the systems to check.


Find-DomainShare
﻿


PowerView is able to do this by using the Find-DomainComputer function to compile a list of domain computers and then uses Get-NetShare against the list of computers to check for available shares on each system. This can save an adversary valuable time if many systems are on the domain.

﻿

Additional find functions are listed below. Use Get-Command -Module Recon for a full list of commands.

Find-DomainUserLocation: Finds domain machines specific users are logged into.

Find-DomainProcess: Finds domain machines where specific processes are currently running.

Find-DomainUserEvent: Finds logon events on the current (or remote) domain for the specified users.

Find-DomainShare: Finds reachable shares on domain machines.

Find-InterestingDomainShareFile: Searches for files matching specific criteria on readable shares in the domain.

Find-LocalAdminAccess: Finds machines on the local domain where the current user has local administrator access.

Find-DomainLocalGroupMember: Enumerates the members of the specified local group on machines in the domain.

BloodHound/SharpHound
﻿

BloodHound is a powerful tool with unique functions that the tools discussed thus far do not have. BloodHound can perform such actions as listing all the Domain Admins but also more advanced functions, such as finding the shortest path to Domain Admins. In addition, BloodHound displays all its findings in an easy-to-read graph rather than a wall of text. This lesson does not delve deeply into the use of BloodHound, as it was covered in the CDA-Basic course, but it does discuss how to detect usage of BloodHound's collector SharpHound in later sections.

﻿

The list below provides all the pre-built analytics queries that come with a default BloodHound install. These queries can be found in the BloodHound interface after importing a SharpHound export.

Find All Domain Admins

Find Shortest Paths to Domain Admins

Find Principals with DCSync Rights

Users with Foreign Domain Group Membership

Groups with Foreign Domain Group Membership

Map Domain Trusts

Shortest Paths to Unconstrained Delegation Systems

Shortest Paths from Kerberoastable Users

Shortest Paths to Domain Admins from Kerberoastable Users

Shortest Path from Owned Principals

Shortest Path to Domain Admins from Owned Principals

Shortest Paths to High Value Targets

Find Computers Where Domain Users Are Local Admin

Find Computers Where Domain Users Can Read LAPS Passwords

Shortest Paths from Domain Users to High Value Targets

Find All Paths from Domain Users to High Value Targets

Find Workstations Where Domain Users Can RDP

Find Servers Where Domain Users Can RDP

Find Dangerous Rights for Domain Users Groups

Find Kerberoastable Members of High Value Groups

List All Kerberoastable Accounts

Find Kerberoastable Users with Most Privileges

Find Domain Admin Logons to Non-Domain Controllers

Find Computers with Unsupported Operating Systems

Find Authentication Service Response Message (AS-REP) Roastable Users (DontReqPreAuth)
﻿
![image](https://github.com/user-attachments/assets/5bafc240-cffd-4227-9db8-13feb545cf1f)

-----------------------------------------------

Enumeration with PowerSploit (PowerView)
This lab demonstrates use of PowerSploit to find information on shares, users, and groups.

﻿

The CPT has been assigned to a mission to audit an AD environment.  Access to a technician's desktop has been provided to allow the team to perform AD enumeration in an attempt to find misconfigurations before an adversary does.

﻿

Workflow

﻿

1. Log in to the ch-tech-1 VM using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open PowerShell.

﻿

3. Search the domain for shares.

PS C:\Users\trainee> Find-DomainShare
﻿

This command can require significant time to finish because it enumerates all the machines that have entries in AD.

﻿

NOTE: The order in which the systems are enumerated may differ from the screenshot.

﻿![image](https://github.com/user-attachments/assets/78d9a922-e5fa-4b78-85d7-386926e62c23)

PowerSploit/PowerView can use find cmdlets like Find-DomainShare to do the hard work of stringing commands together to complete a complex task. Find-DomainShare uses multiple commands to look for systems and check them for shares.


The search can be refined to return only shares to which the current account has read access and that exist in the vcch.lan domain.
PS C:\Users\trainee> Find-DomainShare -ComputerDomain vcch.lan -CheckShareAccess



The bkup share has been found on the ch-dc1 system, as it was in the NET.exe lab. Because this is the same share that was detected in the NET.exe lab, the contents of the user-list.txt file is provided below to save time.
helpdesk:p@ssw0rd
lewis:password!



4. Check the Domain Admins group to see if these users are members.
PS C:\Users\trainee> Get-NetGroup 'Domain Admins'


![image](https://github.com/user-attachments/assets/5cda04c9-f605-441f-8dfe-fde1da634908)

To check who is in the group, review the member list in the command output.


5. Look up more information on the users from the .txt file.
PS C:\Users\trainee> Get-NetUser helpdesk, lewis

![image](https://github.com/user-attachments/assets/1173098f-13cb-40ad-bcf6-2c4151c06335)

![image](https://github.com/user-attachments/assets/7142685a-8bc8-45b1-a7c8-4cf6c60cebc2)

This audit provided an example of how much more efficient third-party tools can be over built-in system tools. Specifically, PowerView's find commands automate much of the manual work an a  dversary would otherwise have to do.

![image](https://github.com/user-attachments/assets/538966a1-1986-4f36-826a-8b7a6c53550e)


-----------------------------------------

Hunting for AD Enumeration
AD enumeration can be detected using several methods. This section focuses on use of Windows Security logs, Sysmon, and PowerShell script block logs to detect living off the land activity performed using NET.exe and to detect such third-party tools as PowerView and SharpHound. 

﻿

NET.exe
﻿

To detect NET.exe activity, Security event ID 4688: A new process has been created or Sysmon ID 1: Process creation is used. These event codes show the exact command that was run by the adversary. Determination of malicious or normal activity is based largely on the type of account running a net group command. A non-admin account running a net group command to list all Domain Admins is quite suspicious, given that most users do not know how to do this. An admin running the command is much less suspicious, and more context would be needed to determine how malicious the activity is.

﻿

Another way to determine if NET.exe activity is suspicious is by examining its usage over time and creating a baseline. One red flag would be the observation that a certain user has not used the NET.exe command in the past 6 months but now they are enumerating Domain Admins and network shares. Time graphs can also be used to examine usage and determine if it is machine or human activity. Human activity is much more scattered than machine activity; machine activity usually has some semblance of structure to it. For example, if NET.exe is being run every hour, on the hour, automated machine activity — and perhaps an admin script — is likely occurring. This can be verified easily on a system by checking with the local admin or looking up the script or scheduled task that is triggering the activity.

﻿

The best tool is the analyst's mind. Get into the hacker's mindset, and filter everything analyzed through that lens.

﻿

In the labs that follow, this knowledge will be used to detect AD enumeration by running search queries in Security Onion.

﻿

PowerSploit/PowerView
﻿

PowerShell logs can be helpful when searching for PowerView activity. PowerShell Module logs (event ID 4103) and PowerShell Script Block logs (event ID 4104) can be used to gain valuable insights into an endpoint's PowerShell activity. PowerShell script block logging allows access to the full script being run, which can then be reverse engineered to understand what the adversary was doing. Such resources as Microsoft Ignite's articles on PowerShell provide more information on PowerShell logging, how to enable them, and how defenders can use them.

﻿

As discussed earlier, a baseline can be created to see what type of activity is normal. For example, most end users do not manually run PowerShell often. There may be cases where PowerShell is used as part of a login script, or used as part of expected normal activity — which can be excluded from analysis once identified as normal. Thus, searching for event codes 4103 and 4104 may return some spike in the timeline if a command like Find-DomainShare were run.

﻿

BloodHound/SharpHound
﻿

Multiple ways exist to detect SharpHound collection activity using client-side logs. SharpHound uses LDAP queries to perform the AD enumeration that collects the data to import into BloodHound for analysis. One way to detect SharpHound usage is to use Sysmon event ID 3 to look for several connections to TCP ports 389/636 (LDAP/LDAPS) and 445 (SMB). In addition, Sysmon event ID 18 can be used to look for several connections to named pipes srvsvc and lsass occurring at the same time as Sysmon event ID 3 events.

---------------------------------------------

Detecting NET.exe Usage
This lab covers techniques to detect AD enumeration performed with NET.exe.

﻿

The CPT has been assigned to a mission to hunt for AD enumeration using normal system tools. The time range is Oct 26, 2021 @ 14:00:00.000 → Oct 26, 2021 @ 15:00:00.000.

﻿

Workflow

﻿

1. Log in to the win-hunt VM using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open Chrome.

﻿

3. Select the Discover - Elastic bookmark.

﻿

4. Log in to Security Onion using the following credentials:

Username: trainee@jdmss.lan
Password: CyberTraining1!
﻿

5. Run an empty search across the time range Oct 26, 2021 @ 14:00:00.000 → Oct 26, 2021 @ 15:00:00.000.

﻿

The results (indicated in the green box shown below) show nearly 65,000 logs — far too many to manually sift through.

![image](https://github.com/user-attachments/assets/d75bdc24-b99d-4a3d-9f57-eec59f5b0cf1)

6. Narrow the results by searching for Sysmon Event Code 1, the event identification (ID) that shows a process being created.
event.code: 1



The results (shown below) have been reduced significantly, but more than 1,000 logs are still too many to manually sift through.


The time chart in Figure 6.5-14 clearly shows some machine activity every 30 minutes from about time 14:05 to time 14:35.


![image](https://github.com/user-attachments/assets/0041ecda-f42a-4b4c-a75a-9a20f4d39bb9)

7. To make the data easier to analyze, search for the following fields in the Search field names box on the left. (In Figure 6.5-15, host.name is in the Search field names box.) Once the fields are listed under Available fields (see Figure 6.5-15), select the plus sign to the right of each field's name to add the field as a column.
host.name
user.name
process.command_line

![image](https://github.com/user-attachments/assets/eede48b1-1206-48b5-b89d-bb44136332d4)

Once all the fields have been added, the results appear, as Figure 6.5-16 shows:

![image](https://github.com/user-attachments/assets/157a6fc4-4b54-4a11-af4b-fdd0e9d60204)

This makes analyzing logs much easier because it allows for quick inspection of the fields that are known to provide the most value during an investigation.


8. Adversaries use NET.exe for AD enumeration, so add a condition to the search so that it returns logs only where process.name is net.exe.
event.code: 1 AND process.name: net.exe


![image](https://github.com/user-attachments/assets/4d4e8ecd-2788-4a9d-8f8f-3b95ef9897ce)


Both CH-DEV-1.vcch.lan and ch-dc1.vcch.lan appear to have had net.exe activity in this time range. From the original search (see Figure 6.5-14), it was observed that there is some sort of machine activity running every 30 minutes, and the net.exe activity on ch-dc1.vcch.lan appears to fall into that machine activity. This machine activity should be reported to the IT team. However, an even more interesting activity is occurring on CH-DEV-1.vcch.lan. Trainee, a non-admin user, is running net commands to enumerate information about users, groups, and shares. It even appears that they attempted to gain access to a share called bkup on the DC. This needs to be reported right away.

![image](https://github.com/user-attachments/assets/b25cb4a7-e834-426a-be7b-866c0b444408)


---------------------------------------------------------------------------------------

Detecting PowerSploit/PowerView Usage
This lab covers techniques to detect AD enumeration performed with PowerSploit/PowerView.

﻿

The CPT has been assigned to a mission to hunt for AD enumeration using PowerSploit/PowerView. The time range used for this activity is Oct 27, 2021 @ 10:00:00.000 → Oct 27, 2021 @ 11:00:00.000.

﻿

Workflow

﻿

1. Log in to the win-hunt VM using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open Chrome.

﻿

3. Select the Discover - Elastic bookmark.

﻿

4. Log in to Security Onion using the following credentials:

Username: trainee@jdmss.lan
Password: CyberTraining1!
﻿

5. Search for all logs that fall within the time range Oct 27, 2021 @ 10:00:00.000 → Oct 27, 2021 @ 11:00:00.000.

﻿

![image](https://github.com/user-attachments/assets/3804ad13-5354-4119-979e-55e328c5cb39)


6. Because PowerSploit/PowerView uses PowerShell, focus on reviewing PowerShell logs. Filter the logs to show only PowerShell logs.
event.module: powershell


![image](https://github.com/user-attachments/assets/1d4f5fe9-c63a-40df-a591-eddc7eeae9f4)

7. Using the same steps used when detecting NET.exe usage earlier, add the following fields to make analyzing the logs easier:
host.name
user.name
powershell.command.name
file.directory
file.name
powershell.file.script_block_text
event.code
event.action


![image](https://github.com/user-attachments/assets/6d25bdc6-2319-4125-b8c6-c4e7a2765d99)

The results show more than 40,000 logs — far too many to sift through efficiently.


Use a visualization to see which PowerShell modules are being used in the environment.


8. Right-click the browser tab, and select Duplicate.

![image](https://github.com/user-attachments/assets/8d8a08a7-938e-4c71-bd7b-1de0e8da84b9)


9. On the duplicate tab, select the menu button in the top left corner, and then select Visualize Library.

![image](https://github.com/user-attachments/assets/58cc3357-d09e-4e57-9643-c088414c7fd2)

10. Select the Create visualization button in the top right corner of the User Interface (UI).

![image](https://github.com/user-attachments/assets/d8c14407-be26-438c-b465-b91bd35f2b59)

11. Select Lens.

![image](https://github.com/user-attachments/assets/59dcae19-e69a-4f28-989b-8168fb401c30)

12. Search for, and then drag and drop, the following fields into the center of the screen:
host.name.keyword
file.name.keyword

![image](https://github.com/user-attachments/assets/10730257-1cc6-47ef-9c46-7fce9ddec64a)

13. Select Table from the Chart Type drop-down menu (which has Bar vertical stacked as the default option).

![image](https://github.com/user-attachments/assets/168e2d7b-dc67-4441-a077-298711e2045a)

It appears that the Recon module and the PowerView script were used on ch-tech-1.

![image](https://github.com/user-attachments/assets/555ef922-8da2-4195-a988-726cca52c0d4)

14. Return to the Discover tab by selecting the original browser tab to the left of the duplicate tab created in Step 8.

![image](https://github.com/user-attachments/assets/49669609-8db7-4d0d-a3ec-16c52b3775f5)

15. Filter the logs to show only PowerShell activity on ch-tech-1.
host.name: "ch-tech-1.vcch.lan" AND event.module: "powershell"

![image](https://github.com/user-attachments/assets/f4e685ab-f0bd-42c1-a3b7-47b9fa100875)

Ensure the time column is in ascending order. It can be toggled by selecting the blue triangle next to the word Time. The triangle will point up when it is sorting in ascending order.


There are two similar spikes on the time chart.


16. Add a condition to the search query so only event codes 4103 and 4104 are returned. Event code 4103 is PowerShell module logs, and 4104 is PowerShell script block logs.
host.name: "ch-tech-1.vcch.lan" AND event.module: "powershell" AND event.code: (4103 OR 4104)

![image](https://github.com/user-attachments/assets/cfdace1f-8ae7-4785-9be2-eb87d32a0a8e)

17. Select the spike in the time chart located at 10:16.

![image](https://github.com/user-attachments/assets/5a729ecc-41b8-4683-9241-594bb78caec6)

It appears that Find-DomainShare was run on ch-tech-1. The logs show that entire functions are logged in powershell.file.script_block_text. These are the functions that Find-DomainShare kicked off. Those exact functions can be found in PowerSploit's recon module code on GitHub.


Notice similar logs in the second spike. It appears that Find-DomainShare was run twice on ch-tech-1. This should be reported right away.


-------------------------------------------------------------

Detecting BloodHound/SharpHound Usage
This lab uses Sysmon event ID 3 to detect SharpHound's initiation on a system.

﻿

The CPT has been assigned to a mission to hunt for AD enumeration. The team has received intel that an adversary known to target city government networks has used BloodHound/SharpHound in the past, so that will be the focus of the hunt. The time range used is Oct 27, 2021 @ 14:30:00.000 → Oct 27, 2021 @ 15:30:00.000.

﻿

Workflow

﻿

1. Log in to the win-hunt VM using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open Chrome.

﻿

3. Select the Discover - Elastic bookmark.

﻿

4. Log in to Security Onion using the following credentials (if needed):

Username: trainee@jdmss.lan
Password: CyberTraining1!
﻿

5. Add the following fields to the search, and set the time range to align with this hunt as Oct 27, 2021 @ 14:30:00.000 → Oct 27, 2021 @ 15:30:00.000.

host.name

user.name

event.code

event.action

source.ip

source.port

destination.ip

destination.port

process.executable

process.name

﻿![image](https://github.com/user-attachments/assets/9144f14e-1df6-4252-96e7-18ab809c681b)

6. Create a query to show only Sysmon event ID 3 network connection logs.
event.code: 3

![image](https://github.com/user-attachments/assets/56e7fee4-0a31-43ac-acf3-d7e246d0feef)

7. Narrow the search to look for logs where the destination port is 389 or 636 or 445.
event.code: "3" AND destination.port: ("389" OR "636" OR "445")



Check the process.name field to see the top process names in the results.


![image](https://github.com/user-attachments/assets/3353b054-afbe-4f44-be05-616783b46bb6)


SharpHound.exe constitutes 19% of the results.


8. Select the plus sign next to "19%" to see more information.

![image](https://github.com/user-attachments/assets/73bb3384-4e67-4020-b121-a08bd67d6254)


![image](https://github.com/user-attachments/assets/a6af7ed3-8193-42e7-8c76-e03d41691ba0)

There are 19 SharpHound logs, some with a destination port of 389 and some with a destination port of 445, as expected. Notice that process.executable provides the path where SharpHound was run on the system.


This activity on ch-tech-1 should be reported right away.


![image](https://github.com/user-attachments/assets/e3291d41-cdbc-4ef4-abda-045f43455508)


---------------------------------------------------------------

########## M7 L1 ############
######### Social Engineering ###########

Social Engineering | Overview
Social engineering is the exploitation of emotional and trust vulnerabilities already present in the human psyche. It can be performed through a variety of attack vectors, including in-person, voice, physical, virtual deception, and, most prevalently, email.

﻿

Social engineering is a tactic employed during the Reconnaissance and Exploitation phases of the attacker lifecycle.


![image](https://github.com/user-attachments/assets/014bf213-f362-4de7-adaf-66c9796a6c4f)

This tactic encompasses a variety of techniques, including:
Phishing
Media drops
Vishing
Smishing
Tailgating

Techniques


Phishing


Phishing is the most prevalent form of social engineering. This involves the use of email to elicit sensitive information from a victim or entice the victim's participation in an attack by downloading a malicious file that gives unauthorized access to a threat actor. 


Spear-phishing is a subset of this technique that employs targeting to craft a highly effective message that is designed to exploit a person in his or her unique context. For example, an individual will receive messages from a person of authority at her local bank or gym requesting personal information such as full name, birthdate, Social Security number, account information, or credit card numbers in order to resolve an important issue or offer an enticing deal. But this is in fact a social engineer who gathered information about the individual from social media posts and profiles or simple search engine results. 


Media Drops


One form of social engineering using physical media that has achieved great success historically is the strategic placement of electronic media — such as Universal Serial Bus (USB) drives — around a target work environment. These drives are loaded with malware that either achieves a specific effect on the mission partner network or provides some form of access to the threat actor when inserted into a drive in one of the network's computers. This technique plays on the human emotions of greed or curiosity, exploiting the assumption of a user who picks up the drive that they have just gained something for nothing or are just curious as to what is stored on the medium. 


Voice Phishing


Voice phishing (vishing) is an effective form of social engineering that makes use of human voice, particularly leveraging the human emotions of intimidation, pity, or pride to elicit victim cooperation in a threat actor's operations in a time-sensitive pressurized situation. This o ccurs when a n adversary attempts to manipulate a victim into disclosing sensitive information or giving them access to the victim's device over a phone call, such as when attackers pretend to call as an IRS employee during tax season. In that case, the attacker often uses fear or implied authority to pressure the target into giving them personal information or compensation. Vishing scams like this one often target older individuals, but anyone can fall for a vishing scam if they are not adequately trained.


Short Message Service Phishing


Short Message Service (SMS) phishing (smishing) is an application of the principles and techniques that have made phishing successful, but it is done through SMS/text messaging. 


![image](https://github.com/user-attachments/assets/a5055e4a-621d-4214-a3d2-f4a65e47f573)


Tailgating


Tailgating is a simplistic social engineering attack used to gain physical access to an unauthorized location. Tailgating is achieved by closely following an authorized user into the area without being noticed by the authorized user. An attacker may tailgate another individual by quickly sticking their foot or another object into the door right before the door is completely shut and locked. 


Piggybacking is exceptionally similar to tailgating. The main difference between the two is that, in a piggybacking scenario, the authorized user is aware and allows the other individual to piggyback off their credentials. An authorized user may feel compelled by kindness to hold a secure door open for a woman holding what appears to be heavy boxes or for a person claiming to be a new employee who has forgotten their access badge.

![image](https://github.com/user-attachments/assets/c32bdf8a-9026-424b-8dac-8e2a7a26f369)


--------------------------------------------------------------

Phishing Review | Common Attributes
Phishing emails tend to exhibit one or more of the following attributes:

Attack vector: This is commonly a link or attachment that leads the user to an attacker's code hosted on a webpage or a malicious file, which when downloaded and executed on a user's system gives an attacker remote access or performs a specific effect.

Unprofessional appearance: These include misspellings, poor grammar, and/or unprofessional or missing graphics.

Pretext: A scenario in which a social engineer places a user through a sense of urgency, or conversations or wording that employ the use of fear, authority, greed, or guilt to elicit an emotional response from the user, which leads to accomplishing an attacker's desired task.
This is hard to consistently identify but constitutes more of a common sense or gut feeling.

Information elicitation: An attempt to elicit personal information  — email, SSN, bank account numbers, etc. — either to gain valuable information directly or to put together a profile of a user that leads to account compromise.

Generic greeting, subjects, or salutations: The use of Hello, Dear Customer, or the lack of any greeting at all should immediately raise suspicion. Likewise, a generic signoff that does not indicate the sender or the lack of cryptographically signed origin within the mission partner organization may be evidence of spoofed addresses.

Source mismatch: Addresses do not match the purported organization.

The following example displays the attributes of an attack vector in the form of a malicious file, an unprofessional appearance in the lack of appropriate branding images, a generic greeting that does not identify the user, an attempt to gain personal information, and a social engineering pretext — the fear of losing access to financial data.


![image](https://github.com/user-attachments/assets/472fa197-fdd3-4355-acff-eb63af31e2d2)

This second example exhibits many of the same problems but uses better graphics and more professional language. However, the use of generic greetings, a social engineering pretext, and a malicious link (instead of attachment) betray this as yet another phishing attempt.

![image](https://github.com/user-attachments/assets/26c4aabd-675e-41ba-b038-cbb71563913e)

![image](https://github.com/user-attachments/assets/6a479774-6967-4416-8ead-8ae54fc51220)


-----------------------------------------------

Phishing Review | Identifying Phishing Messages
Understanding what constitutes phishing messages is important, but identifying them in practice and training others to do so is even more important. Use the knowledge gained in this lesson to identify phishing messages in a mission partner user's inbox. 


--------------------------------------------

Responding to Phishing Campaigns | Common Attributes
In addition to a suspicious message from the State Department, Karen also had an email supposedly reporting a security concern from Facebook. Other users in the mission partner organization have reported similar messages in their inboxes, so this is likely part of a larger phishing effort targeting this organization. Once a message is identified as likely part of a phishing campaign, it is essential to develop Indicators of Compromise (IOC) to identify other messages that may be circulating around the organization.

﻿--------------------------------------

 
Responding to Phishing Campaigns | Practical Analysis
Having identified socially engineered phishing messages and gathering several important IOCs regarding the phishing campaign that this is a part of, use a Security Information and Event Management (SIEM) system to locate Zeek logs of the suspicious email traffic. This skill is useful in identifying similar messages propagating through the organization.

--------------------------------------

Social Engineering Mitigations | Pyramid of Pain
The effects of social engineering can be mitigated through a combination of technical and educational means. Each type of mitigation represents a level of David Bianco's cybersecurity Pyramid of Pain.

![image](https://github.com/user-attachments/assets/90faa485-3045-4062-820f-a66ceeafb428)

The general idea is that some types of defense are easier to execute and stop, but with increasing sophistication and narrower focus, effective defenses require increasing amounts of work, resources, and comparable sophistication. 


Antivirus


One of the easiest mitigations to implement is simple signature-based detection and prevention, which is available through the installation and maintenance of antivirus software, such as Windows Defender. These applications simply use hash values or binary signatures of known malware to detect those files and prevent their execution. This is the lowest level of the Pyramid of Pain and solves the problem of even the most uninformed user opening a malicious file sent by a generic attacker who cannot afford or create more unique malware. 


Restrict Web Content


Employing basic URL or IP address-based blacklists or installing a web proxy that blocks the loading of malicious scripts is a next-level layer of protection and stops threats that continue to use the attack sources that have been detected, reported, and converted to threat intelligence. 


Heuristics


One example of the heuristic-based determination of messages as phishing emails is the NIST Phish Scale. This scale attempts to categorize messages according to a trustworthiness scoring that can automate the process of preventing phishing messages from reaching user inboxes. It examines certain cues as elements of the message that may indicate whether a message is suspicious or not.


The intended use of this sort of numerically based heuristic scale is to apply the calculations with a neuro-linguistic processing engine to highlight certain messages for review. The value of such a system is to reduce the burden and workload for human defenders, and in cases where the organizational appetite allows for it, messages with high enough scores can be discarded outright.


Error


These are cues relating to spelling and grammar errors and inconsistencies contained in the message. Considerations that the scale makes to determine likelihood are whether the message contains spelling or grammar errors, including mismatched plurality, or other inconsistencies.


Technical Indicator


These cues pertain to email addresses, hyperlinks, and attachments in the message. The presence of file attachments — especially an executable — scores highly, as do spoofed display names and URL hyperlinks that hide the true URL behind text. The scale also considers whether the domain name used in the email address and links looks similar to a legitimate entity's domain.


Visual Presentation Indicator


These are cues relating to branding, logos, design, and formatting. When there is no or minimal branding, out-of-date logo, or unprofessional design elements, and a lack of security indicators and icons that would otherwise be present, the Phish Scale dictates that these messages are scored highly.


Language and Content    


These are cues such as a generic greeting and lack of signer details or the use of time-sensitive pressure and threatening language. The scale examines the language of a message for indications of legal language with copyright or tax implications, distracting details not relevant to the content, requests for sensitive information such as PII, use of threats, sense of urgency to gain compliance, and lack of signer details.


Common Manipulation Tactics    


These are the use of humanitarian appeals, too-good-to-be-true offers, time-limited offers, poses as a friend, colleague, or authority figure, and so on. This scores whether the message makes appeals to help others in need, offer unlikely winnings or monetary offers, time-sensitive deals, mimics a plausible work process, package delivery, or poses as a known colleague.


User Training


Humans at the keyboard are always going to be the most important and most vulnerable line of defense against social engineering. Educating and empowering these users pays dividends far beyond installed scanners, filters, alerts, or firewalls — though these should always be employed and configured well.


Properly training users represent the top of the information security Pyramid of Pain. It is the hardest to do and requires proportionally more work than required to address any other threat, but if effective, it provides the greatest return on investment in the fight against savvy and malicious threat actors and their techniques for eliciting information and access.


Basic Phishing Prevention


As highlighted many times in this lesson, the entire goal of a social engineering attack is to elicit user cooperation, which includes divulging information, clicking links, and opening attachments. Therefore, the most basic skills that should be ingrained into all users are to inspect every URL before opening and to never open links or attachments from untrusted sources.


It is impossible to reasonably prevent junk mail from being opened at all, because many messages effectively pass modern junk mail scanners or contain convincing subject lines (e.g., your package has been lost/delivered), but preventing users from being twice beguiled by opening a malicious access point is the real goal of this sort of training. If an organization can effectively train these two fundamentals and educate its users on what attributes indicate trustworthiness, then the largest attack surface in modern computing systems is nullified.


Personally Identifiable Information


These are pieces of information that are unique to the individual or highly sensitive and should never be disclosed:
Social Security number
Driver's license number
Financial records
Medical records

It is important to note that some forms of information, such as work role title, assigned organization, and certifications, may not by themselves be PII or sensitive. The concatenation of all these data together can form a picture that identifies an individual in a critical role (such as database administrator) that may make them a target. The conglomeration of familial information, such as a mother's maiden name, and other personal information such as birthday, addresses, or graduating high school could create a source of valuable information that a threat actor could use to crack likely credentials.


Safeguarding PII


The following are effective means to prevent PII from falling into the wrong hands:
Do not email PII to a personal email account. 
Do not leave PII unattended on desks, printers, or copiers, and remember to secure it when away from your desk or leaving for the day. 
Use secure methodologies, such as encryption, to electronically transmit sensitive PII or store it on mobile computers, mediums, and other devices.
Lock or log off of unattended computer systems.
Never share account information with anyone, especially usernames or passwords.
Destroy sensitive paper PII by shredding or using burn bags.

![image](https://github.com/user-attachments/assets/909b07c2-452d-4c47-94ad-376890dbb364)

![image](https://github.com/user-attachments/assets/07425a24-282a-4e31-ab9d-52f07b208909)


-----------------------------------------












































































































































































































































































