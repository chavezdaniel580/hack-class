########## M6 L1 ############
######### Harvesting Credentials ###########

Introduction to Credential Harvesting
﻿
Credentials are used to access devices and systems on a given network. Credentials include user account names and passwords. According to MITRE ATT&CK Tactic Credential Access (TA0006), harvesting credentials consists of techniques for accessing, identifying, and stealing user account names and/or passwords. Techniques used to obtain credentials include keylogging, Man-in-the-Middle (MITM) attacks, phishing, and credential dumping. Specific techniques are detailed later in this lesson. The use of legitimate credentials gives adversaries access to systems, making them harder to detect, and provides the opportunity to create more accounts to help achieve their goals. 


Credential harvesting is a tactic in the Enterprise Framework from MITRE ATT&CK, as shown in Figure 6.1-1:

﻿![image](https://github.com/user-attachments/assets/138c5875-3617-47c0-8217-fe69b7edbcbf)

Credential harvesting is also included in the reconnaissance phase of the MITRE ATT&CK Framework. According to MITRE ATT&CK, "the reconnaissance phase consists of techniques used and data that adversaries gather that can be leveraged to aid or help coordinate future campaigns or attacks, which likely occur later within the MITRE ATT&CK Framework. The data collected during the reconnaissance phase can be collected in an active or passive manner and information may include data points related to target systems, users, architecture, devices, or infrastructure."


Active data collection occurs when the adversary has infiltrated the target network in an attempt to identify and leverage any vulnerabilities and collect information available. Comparatively, passive data collection is not as infiltrated in the target network. Passive data collection occurs when the adversary is not actively manipulating or searching on the target network, rather, the adversary may be listening or watching traffic.

---------------------------------------------------------------------------------------

Credential Harvesting Techniques 
Brute Force Attacks and Credential Harvesting
﻿

Credential harvesting is categorized under the MITRE ATT&CK technique for brute force attacks (T1110). Brute force attacks include techniques that can be used when the password portion of credential information is not known. Brute force includes the following sub-techniques:

![image](https://github.com/user-attachments/assets/2a0637e8-8856-4aa1-bd8f-70f785b0ef33)

Additional Credential Harvesting Techniques


Multiple credential harvesting techniques exist that do not fall under the brute force attack techniques. Below are the techniques:

![image](https://github.com/user-attachments/assets/d609ad4a-f817-4586-a590-12711c951842)

--------------------------------------------------------------------------

Defenses Against Credential Harvesting
The primary defense against credential harvesting is strong password management. Enforcing all password settings ensures that passwords are complex, changed frequently, and require two-factor authentication. Below are three strategies that should be implemented to prevent credential harvesting:

![image](https://github.com/user-attachments/assets/7a4890a9-c2e7-4cd7-bdb8-0517eae55e8a)

--------------------------------------------------------------------

Harvesting Credentials by Password Spraying | Part 1
﻿

Walk through the MITRE ATT&CK technique of password spraying, as seen from an adversarial perspective. A small dump of credentials was obtained through a successful phishing attack. Using the information from the dump, a small password spraying attack is conducted in an attempt to access the network. 

------------------------------------------------------------------

rotecting Credential Data from Harvesting
Walk through accessing the network's primary Domain Controller (DC) to configure and enforce strict password settings in an effort to prevent credential harvesting. 

﻿

Workflow

﻿

1. Log in to the ch-dc1 VM using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. The domain's password policy can be easily reviewed using PowerShell. To do so, select the Windows icon > Administrative Tools.

﻿

3. In the Administrative Tools window, select Windows PowerShell.

![image](https://github.com/user-attachments/assets/2a52cd98-5aa7-454c-8225-5ad721b8bad5)

. In the Windows PowerShell window, enter the following cmdlet:
PS C:\Users\trainee.vcch> Get-ADDefaultDomainPasswordPolicy



The following results are returned:

![image](https://github.com/user-attachments/assets/f8a6de3d-61ec-402d-997f-582a4aca35cf)

Below are relevant fields to the domain's password policy from the Windows PowerShell output:

![image](https://github.com/user-attachments/assets/287f05dd-26db-498d-8d85-ffa896149f62)

The current domain password policy is not secure to prevent brute force attacks. Currently, passwords are only required to be one character long, changed once every 365 days, and can be changed to a password that was previously used. These three fields create an environment that is extremely vulnerable. The next steps identify how to modify and harden the domain's password policy.


5.  Select the Windows icon > Administrative Tools. Select Group Policy Management:

![image](https://github.com/user-attachments/assets/d6024e91-5e9d-48fb-aae4-55918006a8e4)

The Group Policy Management window opens:

![image](https://github.com/user-attachments/assets/4b32d344-08ba-4d96-a1b8-238281f1f77e)

Navigate to Group Policy Management > Forest: vcch.lan > Domains > vcch.lan > Default Domain Policy:

![image](https://github.com/user-attachments/assets/82130082-96ad-4be3-b030-9d5f790fdc7b)

Right-click Default Domain Policy and select Edit... The Group Policy Management Editor appears:

![image](https://github.com/user-attachments/assets/f3c8f960-91fe-4395-aded-4c5bc2163b4f)

8. Navigate to Computer Configuration > Policies > Windows Settings > Security Settings > Account Policies > Password Policy:

![image](https://github.com/user-attachments/assets/f918aaab-df80-4555-b492-caecf49fb730)

The password policy for the Default Domain Policy is located here. 


Notice that the output from the cmdlet executed in step 4 reflects the Policy Settings located in the Group Policy Management Editor:

![image](https://github.com/user-attachments/assets/b78fce0a-44bd-453b-b067-a2311af53866)


The current password policy settings are not strong:
Only require one character long.
Changed once every 365 days.
Changed to a previously used password.

9. Right-click Enforce password history and select Properties.

![image](https://github.com/user-attachments/assets/cdf0cce1-cd75-40dd-829f-71f98ea5d8a4)

he Enforce password history Properties window appears:

![image](https://github.com/user-attachments/assets/2e627f4e-3462-48b0-b0d6-88c84dcc6f0c)


10. Ensure Define this policy setting is checked. Set the passwords remembered to 24: 

![image](https://github.com/user-attachments/assets/915150c7-7ab8-4852-961b-6510092a9787)

NOTE: The maximum number of passwords Windows can remember is 24. 


11. Select Apply > OK.


12. Right-click Maximum password age, select Properties, and repeat the instructions from step 9. Set the password expiration to 60 days. 


13. In the Suggested Value Changes dialog box, select OK. 

![image](https://github.com/user-attachments/assets/cace6aa6-7434-453c-8d3c-3b8696764c3c)

14.  Select Minimum password age and repeat the instructions from step 9; set the password expiration to 1 days. 


15.  Select Password must meet complexity requirements, enable Define this policy setting, and select Enabled. Select Apply > OK.


16.  Select Store password using reversible encryption, and ensure Define this policy setting is unchecked. Select Apply > OK.


The Group Policy Management Editor should look like the following:


![image](https://github.com/user-attachments/assets/15f982c6-fd8b-4b12-aa9f-0f422fb57a53)


he Password Policy for the Default Domain Policy has been modified to enforce password settings that harden the domain. The password settings create an environment that is more difficult for the adversary to perform an attack using a brute force tactic.


NOTE: When creating a new GPO, the final step is to link the GPO to AD containing the desired groups and machines.

-------------------------------------------------------------------------------

Configure a GPO

The Virtual City City Hall (VCCH) network is taking on some new roles to support the monitoring of security in the network. The new roles require some machines on the network to contain highly sensitive information. Access to the machines and the data is highly controlled and requires a secure policy regarding credentials. Configure a GPO titled Security Control to support new security roles.

﻿

Workflow

﻿

1. Log in to the VCCH's primary DC — ch-dc1 — using the following credentials:

Username: trainee
Password: CyberTraining1!

----------------------------------------------------------------

GPO Access and Configuration
﻿
![image](https://github.com/user-attachments/assets/3bd3831f-ddf1-4eba-add1-6da91846fbc3)

Figure 6.1-20

﻿

The Group Policy Management provides access to view and manage GPOs within a given domain. 
![image](https://github.com/user-attachments/assets/6f1e8904-d83f-4c61-9497-0cb656d82eab)

-----------------------------------------------------------------

GPOs in VCCH
﻿

Figure 6.1-21

﻿

The Group Policy Objects folder contains all the domain's current GPOs.

﻿

NOTE: The following steps continue from the previous task.

﻿

2. Create a new group policy object titled Security Control, and access the GPO's password policy settings.

![image](https://github.com/user-attachments/assets/3b5a90f5-2837-4818-a3af-7738ec133162)

-----------------------------------------------------

Password Policy Settings
The following path leads to the GPO's password policy setting: 

﻿

﻿![image](https://github.com/user-attachments/assets/4c2c444f-89a2-450d-8ec6-78fee39c128c)


Figure 6.1-22

﻿

NOTE: The following steps continue from the previous task.

﻿

3. Edit the newly created GPO to enforce the password settings provided below.

Enforce password history: 24

Maximum password age: 30

Minimum password age: 1

Minimum password length: 12

Password must meet complexity requirements: Enabled

![image](https://github.com/user-attachments/assets/5452a657-cf31-497b-b64e-0425f7e02dbe)


---------------------------------------------------------------------------------------------------

Configured GPO
The required changes are made to the GPO:

﻿![image](https://github.com/user-attachments/assets/ecd93a97-3e60-4ea7-a2f9-fdac74604334)

The final step to enforce the new GPO is to link it to AD.


NOTE: The following steps continue from the previous task.


4. Once Link an Existing GPO... and Security Control are selected, the newly created GPO is added to the group policy objects found under vcch.lan:

![image](https://github.com/user-attachments/assets/070b7be2-9847-4d0d-bfc9-64c1a9ac1033)

![image](https://github.com/user-attachments/assets/148e3d54-3d03-46d4-b8ad-57f29ac4ea71)

From this point, the domain administrator from within the security group manages the GPO. They add users and computers as needed to handle and view sensitive information. The established policies put the domain in a secure posture to defend against credential harvesting through password mismanagement. 

----------------------------------------


########## M6 L2 ############
######### Identifying Hosts and Services ###########

Host Identification and Scanning Refresher


![image](https://github.com/user-attachments/assets/2c81955e-17fd-4557-b42c-9e2d6aea67ca)

Host identification and scanning typically occur early on in the MITRE ATT&CK lifecycle and occur continuously during an attack campaign as the adversary continues to expand access. The purpose of host discovery is to figure out which hosts are accessible over the network. Some protocols a Cyber Defense Analyst (CDA) might encounter during host discovery are Address Resolution Protocol (ARP), Internet Control Message Protocol (ICMP), Domain Name System (DNS), and Transmission Control Protocol (TCP)/User Datagram Protocol (UDP) pings.


After the host is verified as accessible, the adversary proceeds to port scan the host(s). Port scanning is done to check which services are up and running. Upon receiving port scan results, the adversary can determine the host's purpose in the network (e.g., is it a web server, mail server). Recall that this is because port numbers typically correspond to specific services.


After the adversary gathers a list of open ports, and thus a list of services running on the host, they would proceed to conduct vulnerability scanning. Vulnerability scanning probes a service — or many services — and attempts to discover any weaknesses in configuration. Once the adversary discovers a vulnerability they can leverage, they launch an exploit, gaining access into their target system.


These are not hard and fast rules, and these actions do not have to occur sequentially or together at all. However, this sequence provides a logical progression on the avenues an adversary may take to gaining the requisite information in selecting the appropriate exploit. Knowing how the adversary functions enables a CDA to take opposing mitigating actions.

----------------------------------------------------------------------

Port Scanning



![image](https://github.com/user-attachments/assets/aa03cc0f-028a-4125-9f86-baad27e1d65a)

Port scanning is the technique of scanning hosts on a network for running services. The MITRE ATT&CK technique identifier for port scanning, known as network service scanning to MITRE, is T1049. Port scanning may or may not be preceded by host discovery.


Port scanning leverages two transport layer protocols:
Transmission Control Protocol (TCP)
User Datagram Protocol (UDP)

You should be familiar with these protocols from previous courses. It is more common to rely on TCP to conduct a port scan as UDP scans do not always return definitive results detailing if a port is open.


TCP Port Scan
TCP is a connection-orientated protocol — it relies on a three-way handshake to establish a connection. Recall that the client initiating the connection sends a packet with the Synchronize (SYN) flag set. The receiving server replies with a packet including the SYN/Acknowledge (ACK) flags, to which the client responds with a packet including the ACK flag set. This sequence establishes the connection. There are a few exceptions to this rule, such as Hypertext Transfer Protocol (HTTP) FAST GET, which sends data with the SYN packet, but these instances are outside the scope of this lesson. Port scanners exploit the requirement of the three-way handshake to determine if a port is open. If the client receives a SYN/ACK from the server, then this is all the information needed to surmise that the port is open. If a packet with a Reset (RST) flag is received, then the port is closed. If there is no response from the server, then port filtering is likely occurring somewhere in the network or on the server host, and the client is unable to determine if the port is open.


![image](https://github.com/user-attachments/assets/e60a8b26-d163-4dad-809b-e64b16f515b7)


UDP Port Scan
UDP is not connection-orientated. Packets are simply assigned an Internet Protocol (IP) and a port number and shipped off. There is no built-in mechanism in UDP that determines if the packet made it. The simplicity in UDP serves as a disadvantage while port scanning. If a response is received from the server, then you can definitively say that the UDP port is open. However, sending UDP packets at a host often returns no data if the port is open. This response would be no different if the port was filtered. If the port is closed, then an ICMP Port Unreachable message may be received, which can be generated by the server host or gateway. Other ICMP messages mean that the port is filtered.


![image](https://github.com/user-attachments/assets/03266c56-af2b-43fe-8060-678ae2fbb78d)

------------------------------------------------------------------------------------------------------------------------

Port Scanning Utilities
Netcat
﻿

Often called the TCP/IP Swiss Army knife, Netcat is a versatile tool that can be used for purposes such as a chat/messaging server, file transferrer, and, of course, port scanner. Netcat has a very small footprint and comes pre-installed on most Linux distributions and is easily installed on Windows. The preinstalled version of Netcat on several Linux versions is often different from the one you can build from source code. A common modification is the removal of the ability to execute programs due to the security implications; namely being able to remotely gain a shell. Figure 6.2-3 shows the help menu presented by Netcat.


![image](https://github.com/user-attachments/assets/6eddfeab-d379-4fa6-93b0-e24045da9598)


Telnet


Telnet is a protocol that allows remote logins to another system running a Telnet server. You should already be familiar with the security implications of using Telnet for remote administration; however, the Telnet client is still useful for port scanning and banner grabbing. The client comes preinstalled on several versions of Cisco Internetwork Operating System (IOS) and other routing Operating Systems (OS). Figure 6.2-4 shows usage options for Telnet.


![image](https://github.com/user-attachments/assets/3dc87a97-6c22-4a53-b80b-a5143fd1a50a)

--------------------------------------------------

Port Scanning and Banner Grabbing with Netcat
The resulting output from the previous command is shown below:

![image](https://github.com/user-attachments/assets/c7df9017-a6b2-4eff-9807-09e513442acf)

As detailed, SSH is open on this device. Now that the open port is verified, perform a banner grab to get more information on the service.


NOTE: The following steps continue from the previous task.


7. Run the nc command without the -z option on the open port to perform a banner grab:
(trainee@dmss-kali)-[~] $ nc -nvw 10 172.35.1.21 22



Depending on the service running or how the service is configured, the server may not always return a banner or data. This was seen in the first port scan against HTTP; even with the socket left open, the server sent no data. 

---------------------------------------------------------------

Port Scanning and Banner Grabbing with Telnet
From the output, it is evident that the version of SSH on the host is OpenSSH 5.5.

![image](https://github.com/user-attachments/assets/2a196057-02ac-44c4-95eb-7ca0b23ddda9)

Recall seeing a -u option for UDP mode with Netcat. This functionality does not work as expected and is not recommended for use as a port scanner. Netcat looks for an ICMP UDP port unreachable to determine if a port is closed. If the port is filtered or open, then the program states the port is open. As it stands, the messages returned from UDP scans are often unreliable and may confuse analysts. If nc must be used to port scan UDP ports, the most surefire way to assess if a port is open is if data is received from the server. This means the -z option is not possible.


Table 6.2-3 details the UDP Port States and the message received from Netcat:

![image](https://github.com/user-attachments/assets/92e6a1c8-33f7-4895-b473-178947acf074)

Telnet is a less versatile tool than Netcat, but the choice of tools is not always available in the environment. For example, many Cisco IOS devices may not have Netcat, but may have Telnet installed.

--------------------------------------------------

Nmap
Nmap is a popular free and open-source utility for network discovery and security auditing. It is a powerful tool that does much more than port scanning; many network and systems administrators use it for vulnerability scanning, network inventory, managing upgrading schedules, and more. Due to its popularity, Nmap is a well-documented utility. There are versions that support Windows, Linux, and macOS. Unlike Netcat however, Nmap does not come preinstalled on most OSs. Nmap also has a few sub-projects such as Ndiff and Zenmap. Ndiff compares two different Nmap scan results and reports differences. Zenmap is a Graphical User Interface (GUI)-based tool that allows the user to create and save scanning profiles.

﻿

There are six NMAP port states according to Nmap.org documentation:

﻿

Open
﻿

An application is actively accepting TCP connections or UDP packets on this port. Finding these is often the primary goal of port scanning. Security-minded people know that each open port is an avenue for attack. Attackers and pen-testers want to exploit the open ports, while administrators try to close or protect them with firewalls without thwarting legitimate users. Open ports are also interesting for non-security scans because they show services available for use on the network. Before getting too excited about an open port, note that it is possible that the application is protected with a TCP Daemon Wrapper (TCPD) or that the application itself is configured to only service approved client IP addresses. Such cases still leave more attack surface than a closed port.

﻿

Closed
﻿

A closed port is accessible (it receives and responds to Nmap probe packets), but there is no application listening on it. They can be helpful in showing that a host is online and using an IP address — host discovery or ping scanning — and as part of OS detection. Because closed ports are reachable, they may be worth scanning later in case some open up. Administrators may want to consider blocking such ports with a firewall so they appear in the filtered state.

﻿

Filtered
﻿

Nmap cannot determine whether the port is open because packet filtering prevents its probes from reaching the port. The filtering could be from a dedicated firewall device, router rules, or host-based firewall software. These ports frustrate attackers because they provide so little information. Sometimes they respond with ICMP error messages such as type 3 code 13 — destination unreachable: communication administratively prohibited — however, filters that simply drop probes without responding are far more common. This forces Nmap to retry several times in case the probe was dropped due to network congestion rather than filtering. This sort of filtering slows scans down dramatically.

﻿

Unfiltered
﻿

The unfiltered state means that a port is accessible, but Nmap is unable to determine whether it is open or closed. Only the ACK scan, which is used to map firewall rulesets, classifies ports into this state. Scanning unfiltered ports with other scan types such as Window scan, SYN scan, or FIN scan, may help resolve whether the port is open.

﻿

Open|Filtered
﻿

Nmap places ports in this state when it is unable to determine whether a port is open or filtered. This occurs for scan types in which open ports give no response. The lack of response could also mean that a packet filter dropped the probe or any response it elicited. So Nmap does not know for sure whether the port is open or being filtered. The UDP, IP protocol, FIN, NULL, and Xmas scans classify ports this way.

﻿

Closed|Filtered
﻿

This state is used when Nmap is unable to determine whether a port is closed or filtered. It is only used for the IP Identification (ID) Idle scan discussed in the TCP Idle Scan (-sI) section.

---------------------------------------------------------------------------------------

Service and OS Versioning
Nmap has a few options that allow for service, version, and OS identification. They are as follows:

-sV: Enables service and version detection. This is done by sending out a series of probes that elicit information.

-O: Enables OS detection. Nmap provides a best guess of what the underlying OS is based on TCP/IP Stack fingerprinting. Different OSs generally have different options set in their TCP/IP options which enables OS detection.

-------------------------------------------------------------

UDP Scan
Nmap has UDP scanning capabilities as well and requires superuser privileges to run. The -sU option denotes a UDP scan, and can be done in conjunction with other TCP scans.

---------------------------------------------------------------------

Nmap Operational Security
Port scanning involves hundreds, if not thousands, of packets depending on the scan options. IDSs and Intrusion Prevention Systems (IPS) easily pick up on this activity. Nmap comes with timing templates, which enable the penetration tester to reduce the odds of being caught. These range from the T0 option, which is the least likely to set off alerts, to T5, which is an extremely loud packet blaster. The TCP options set for each template can be seen in Table 6.2-4. Do not memorize this table, it simply gives some insight on what is done differently from T0 to T5.

![image](https://github.com/user-attachments/assets/ecb36fef-f078-45e9-a86d-280a9c59f708)

NOTE: Timing parameters in Table 6.2-4 are shown in milliseconds.


The author of the documentation states that if you have a decent broadband connection and are not worried about setting off an IDS/IPS, then T4 is a good template to use. Keep in mind that the templates on the lower end take more time to complete as they wait more time before sending out more packets, as seen by the scan delay. For example, the T2 template can take more than ten times longer than the T4 template.


-----------------------------------------------------------------------------

Port Scanning Recap
The takeaway is that there are a few different port scanning utilities available to CDAs. The three covered are Netcat, Telnet, and Nmap. Some options that may come in handy for a CDA are as follows:

﻿

Netcat
-n: Disable port and name resolution
-v: Verbose
-w: Wait timeout
-z: Zero data
Nmap
-p: Port specification
-Pn: Do not conduct host discovery
-sS: SYN Stealth
-sT: Connect
-sA: ACK scan
-sW: Window scan
-sF: FIN scan
-sN: Null scan
-sX: Xmas scan
-sM: Maimon scan
-sU: UDP scan
-T[0-5]: Timing template
-sV: Attempt service and version detection
-O: Detect the OS
From the defensive perspective, hosting services leave open ports on a system. These open ports increase the attack surface within the network and may enable adversaries to gain footholds within their targeted network. Disabling an unneeded service reduces the attack surface. Firewall devices may also protect against scanning attempts if a service is needed, though it may be possible to circumvent them. Test and validate firewall rules for the best mitigative results.

-----------------------------------------------------------------------------------------

Vulnerability Scanning
Vulnerability scans oftentimes follow port scans. For example, when a host is scanned and port 80 is determined to be up, the CDA might run Nikto, an open-source vulnerability scanner for assessing web servers. However, this is not always the case. Vulnerability scanners have become much more robust and may even incorporate port scanners. Vulnerability scanners — such as Assured Compliance Assessment Solution (ACAS) — are made to be more comprehensive. Vulnerability scanners fall underneath the reconnaissance tactic of MITRE ATT&CK under the technique ID T1595.002. The results of a vulnerability scanner may include the following:

Unwanted services running.
Default credentials in use.
Out-of-date software in need of hotfixes, patches, or updates.
Weak algorithm usage.
Insecure configurations.
Existing exploits for software.
Adversaries may use vulnerability scanners to delve into a host's weaknesses and find room for exploitation. Network defenders use vulnerability scanners to assess their network and locate mitigations that should be applied. Some services, such as web, are incredibly complex with a seemingly infinite number of configurations, software backends, etc. Vulnerability scanners dedicated to just scanning web services exist.

﻿

Vulnerability scans can be unauthenticated or authenticated. Unauthenticated scans pass no additional information to the scanner for a provided service. Authenticated scans provide information needed to log into services to gather configuration settings and assess a service more in-depth — past just the login page. Both have their uses; unauthenticated scans allow a CDA to see results as adversaries would see them, while authenticated scans enable the defender to gather more vulnerability information about a service. Both authenticated and unauthenticated scans should be evaluated for a complete picture.

﻿

Vulnerability scanners include the following:

ACAS: Also known as Nessus. ACAS is frequently used by CPTs and likely encountered as a CDA.
Nmap: Mentioned as a port scanner; however, it can function as a vulnerability scanner, especially with the Network Scripting Engine (NSE).
OpenVAS: Another full-featured vulnerability scanner.
Nikto: An open-source web vulnerability scanner. It specializes in finding web-based attacks such as Structured Query Language (SQL) injection and Cross-Site Scripting (XSS) vulnerabilities.
Burp Suite: Another web vulnerability scanner.
ACAS, Nmap NSE, and Nikto are covered more deeply in the following lab.

-----------------------------------------------------------------

Nmap Network Scripting Engine
Nmap NSE comes installed with several scripts designed to perform more in-depth vulnerability scanning. You can also write your own. Third-party scripts exist as well, but be cautious when running scripts downloaded off the internet as they could contain malicious code.

---------------------------------------------------------------------

Nikto
Nikto is a one-trick pony, but it does its one trick well. Nikto only scans web services, but it is a fantastic tool to use when encountering a web server. It is easy to install, easy to use, and capable of a fairly comprehensive scan in a relatively short amount of time. It is capable of identifying several vulnerabilities in the Open Web Application Security Project (OWASP) Top 10 such as security misconfiguration, cross site scripting, and injection.

﻿------------------------------------------------------------

 
ACAS Continued
By now, the ACAS scans should be done or close to done. As a brief refresher, recall that you ran a Basic Network Scan against the 172.35.2.0/24 subnet, which contains core services for this network. The results are shown in Figure 6.2-42:

![image](https://github.com/user-attachments/assets/4f990872-0893-4a7e-a9f9-ca2e2e197305)

There are three hosts in the subnet from the output, and most of the vulnerabilities are informational.

---------------------------------------------------------------

Detecting Scanners
Luckily for network defenders, port and vulnerability scanners are generally noisy. Depending on the scanning software and options selected while running, it can be easy to spot these scanning tools in traffic. Use Zeek logs to identify scanning activities in Kibana.

﻿----------------------------------------------------

 Detecting Adversaries Using Timing Templates
The trainee can tell it was a SYN Stealth because the maximum client packets was 2. This is indicative of a SYN and a RST. Figure 6.2-51 details one of the entries expanded, which alludes to this:

﻿
![image](https://github.com/user-attachments/assets/41546997-4cac-40d3-ae23-b09153baa91a)

﻿

Figure 6.2-51

﻿

Recall that Nmap has built-in timing templates that try to mask scanning attempts. In the following steps, observe a timing template of 0, also known as the paranoid timing template.

﻿--------------------------------------------------------------------------------------

Detecting Adversaries Using Vulnerability Scanners
Vulnerability scans are often preceded by port scans, depending on the tool. This is certainly the case for ACAS. In the next set of steps, observe an ACAS scan in traffic.

--------------------------------------------------------------------------------

Detecting ACAS
The scanning host is 199.63.64.104 as seen in the source.ip column. Notice that in this case, the connections have more packets than during a port scan. The last entry in this screenshot has 24 client packets and 42 server packets. This is because the scanning host actually connects to the server AND sends and receives data to attempt to identify services and vulnerabilities.

![image](https://github.com/user-attachments/assets/49d8cd2f-45c4-40a2-ab03-f0bcdf7fc65c)


A bonus is that ACAS also employs the user agent string Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0) when scanning web-based ports.


To summarize, a vulnerability scanner is generally preceded by a port scan but also has longer sessions due to actually sending and receiving data to the server to identify vulnerabilities.


ACAS does not necessarily have IDS evasion built in. ACAS does, however, have a low-bandwidth mode, which enables slower scans and makes them less detectable. This function is meant to be used over links with less throughput and reduces the number of hosts scanned at a time. Also, low-bandwidth mode slows down the scan if network congestion is detected. However, scans using low-bandwidth mode are still fairly obvious, though this may vary depending on the amount of network traffic. 

-----------------------------------------------------------------------------

Detecting Nikto Scans
Examine what Nikto scans look like in traffic.


-----------------------------------------------------

Detecting Scanners Recap
This lab showed what scanners may look like in traffic. The following was examined:

NMAP scans
ACAS scans
Nikto scans
A few potential IDS evasion techniques

-------------------------------------------------------

Source IP Address Solution
There were two datasets examined in this lesson to visualize abnormal traffic patterns. The first was viewing the Zeek connection log. However, this does not provide a useful picture.

![image](https://github.com/user-attachments/assets/04d14ef7-bc7d-4125-8ed5-b35f8e32b0eb)

This does not rule out Nmap scans with slower timing templates. Check the other dataset discussed in this lesson — the Zeek HTTP logs — before going down that rabbit hole.

![image](https://github.com/user-attachments/assets/d59156b8-a96f-41c1-9354-e08fcbaeaa23)

There is an abnormal number of web requests toward the end. Select the first spike. It seems evident that one host is responsible for most of this traffic.

![image](https://github.com/user-attachments/assets/3e754a03-a4b8-497a-a0a5-2a59f4af9702)

![image](https://github.com/user-attachments/assets/f1ba539b-e1b5-4328-bfe7-46ba439e4ec0)

During the spike, the one IP address is responsible for 92% of the traffic! The malicious actor in this case is 128.0.7.23.


---------------------------------------------------

Scan Type Solution
Both ACAS and Nikto have built-in web scanners. However, ACAS is more comprehensive as a scanner, and is usually preceded by a port scan.

![image](https://github.com/user-attachments/assets/81585003-881b-482d-aec2-681d26d738eb)


There does not seem to be evidence of port scanning based on the query for short sessions. However, the requested URIs do point toward Nikto's known behavior, which uses a dictionary to request several webpages.

![image](https://github.com/user-attachments/assets/3930f0b7-2993-446e-90a9-bcc63239b734)

Of the possible answers, Nikto is the best answer.

--------------------------------------

Evasion Techniques Solution
Upon examining the requested URIs in greater detail, it seems like the case of several letters is mixed.


![image](https://github.com/user-attachments/assets/7d71d142-9f43-4c55-ba85-074a567a9fe6)

Recall that Nikto may mangle the URLs slightly in an attempt to circumvent some IDS settings. This can be confirmed by viewing the Nikto help page.

![image](https://github.com/user-attachments/assets/1953e085-848c-4e48-b921-65d731a7eaad)

Congratulations! You have completed the practical exercise.

------------------------------------------------------------------

########## M6 L3 ############
######### Wireless Sniffing ###########

Wireless Networking Overview
Overview
﻿

The 802.11 family of radio protocols is commonly referred to as Wireless Fidelity (Wi-Fi). Wireless network traffic is sent over the 802.11 radio protocol, which spans Layer 1 (Physical Layer) and Layer 2 (Data Link Layer) of the Open Systems Interconnection (OSI) model. In Layer 1, the 802.11 defines the frequency (e.g., 2.4GHz and 5.0Ghz) and modulation, and in Layer 2, the protocol defines the device addressing. This family is subdivided into smaller protocols based on the frequency and rate of the data being transmitted. 

![image](https://github.com/user-attachments/assets/c7901432-5cb1-446d-9300-3538979b2b7b)

Wireless Access Points


Wireless Access Points (WAP) are wireless devices operating at layer 1 and layer 2, with some implementations providing additional layer 3 support, such as routing. They provide clients mobile access to network resources, point-to-point connectivity for Metropolitan Area Networks (MAN), and administrator connections to client devices over the 802.11 protocol. Each access point is located by its Service Set Identifier (SSID), though it is called an Extended SSID (ESSID) when multiple access points use the same SSID. The Media Access Control (MAC) address of the radio interface serving the network identified by a specified SSID is the Basic Service Set Identifier (BSSID) of that network. When a named network is administered by multiple access points, the ESSID consists of all BSSIDs serving the network. In such a case, it is possible to move from one room to another, change from one BSSID to another, but never change the ESSID of the network a device is connected to.


Channels


Channels are specific, narrower bands of the Radio Frequency (RF) spectrum over which a WAP operates. The numbers — 1 through 14 — in Figure 6.3-1 show the associated channels and 22 megahertz (MHz) overlapping RF bands used in 802.11 protocols.

![image](https://github.com/user-attachments/assets/71c9aa8d-919f-416d-99e4-36572b084202)


Types of Frames


In the 802.11 wireless protocol, a number of management frames are used for announcing, creating, and removing connections to the network. 


Beacon


Beacon frames are periodic announcements of wireless network information, sent over the RF channel on which the WAP operates. The WAP broadcasts information such as the SSID, device capability (e.g., encryption details), supported data rates, interval between beacon transmissions, and miscellaneous details used for establishing RF communication with the WAP.


Deauthentication Frame


The deauthentication frame is sent when one party in the connection wishes to terminate the connection. This disassociates a device from the access point, so any reassociation requires new authentication when encryption is employed. When sent, this frame includes a reason code for the termination, which may be Deauthenticated because sending station is leaving BSS or Disassociated due to Inactivity; there are more than 60 such codes. Most importantly, in certain types of wireless attacks, these deauthentication frames are spoofed by an attacker to force a client device off a network to either assume its place or to force reauthentication. Figure 6.3-2 shows the structure of an 802.11 management frame where the reason code is sent. See the additional resources for more information on the various types of deauthentication reasons.

![image](https://github.com/user-attachments/assets/85d4fa21-7c9d-4d48-8e4c-4f23e8877114)


--------------------------------------------------------------------------------

Wireless Sniffing | Overview
Overview
﻿

Wireless sniffing is a form of reconnaissance, potentially leading to host or even credential discovery in mission partner networks employing wireless technology.

﻿

MITRE defines this technique — both wired and wireless —  as the use of a network interface on a system to monitor or capture information sent over a wired or wireless connection and identifies it with the code T1040. This information may include authentication handshakes, name service resolution queries, service requests (revealing which services are active in a network), and a variety of metadata allowing the potential identification and fingerprinting of active hosts in the environment. 

﻿

This type of attack accomplishes information gathering for the threat adversary. There are a number of ways for this information to be gathered. 

﻿

Types
﻿

Wireless sniffing can be conducted either actively or passively. While the capture itself is always a passive action — it requires no interaction with other devices or services to capture — the amount and quality of the data can vary. 

﻿

Passive Sniffing
﻿

When an adversary's priorities are stealth and maintaining target network access, passive sniffing is the ideal route to follow. In this, the attacker does not interact with any targets, but simply takes advantage of wireless signals sent through a network and captures the packets that are being transmitted over the air.

﻿

Active Sniffing
﻿

When an adversary's priorities are information gathering, and stealth is an acceptable quality to risk, active sniffing allows for more potential data to be gathered. This type of sniffing is a combination of passive sniffing on one attacker machine and, on the same machine or, ideally — a separate one that is expendable. The injection of traffic leads to a breakdown in secure switching mechanisms or reliable authorities for name resolution or network access, leading to Man-in-the-Middle (MitM) access to data. This can allow the collection of traffic that would otherwise be encrypted.

﻿

Tradeoffs
﻿

The advantage of active sniffing is that the adversary gathers more valuable information. The cost is stealth, leading to potential discovery from network defenders. The advantage of passive sniffing is security of position, in that an attacker can quietly listen and remain undiscovered. The cost of passive sniffing is time. 

﻿

Goals
﻿

Threat adversaries employing wireless sniffing are attempting to acquire various types of information for use in follow-on exploitation, lateral movement, and privilege escalation. The following types of data can be obtained through analysis of raw Packet Captures (PCAP):

﻿

Host Information
﻿

The number, type, and names of various host and networking devices on the network are likely to be extracted from sniffing. The network communication contains various signatures such as Time to Live (TTL) numbers, Maximum Segment Size (MSS) values, or Transmission Control Protocol (TCP) window size, which contribute to an attacker's ability to passively identify the OSs of various hosts. If an attacker is able to capture traffic containing authentication traffic (e.g., Server Message Block (SMB) share access), then the available information includes hostnames, usernames, and service names on both ends of the exchange. If unencrypted, this collection can even include credentials.

﻿

Addressing
﻿

Sniffing also yields the IP addresses and MAC addresses of devices communicating on the same wireless network as the sniffing device. Only the MAC addresses of devices on the same Virtual Local Area Network (VLAN) are visible, but even this amount of segmentation is valuable knowledge to the attacker. Capturing and observing Address Resolution Protocol (ARP) requests and replies also aids in revealing this local VLAN architecture. 

﻿

Services
﻿

Even without running an active scan, a savvy threat adversary can determine which services are available in a wireless network by observing other devices accessing those service on common ports and over known protocols. This reveals not only whether services such as web, File Transfer Protocol (FTP), e-mail, network data storage, or others are running, but also on which specific devices and ports.

![image](https://github.com/user-attachments/assets/75dacd55-63d9-4f31-a98a-55c7b2c5cb46)

----------------------------------------------------------

Wireless Sniffing | Active Sniffing Techniques
Evil Twin Attack
﻿
Also known as the Rogue Access Point attack, this type of active technique augments wireless sniffing reconnaissance by capturing all sides of a conversation and proxying the traffic. This attack occurs when the threat adversary stands up an alternative WAP with the same SSID as the original legitimate access point. When an unwitting user believes that they are connecting to a known wireless network with the familiar SSID, all their requests are first sniffed and captured by the malicious device. This technique can be combined with DNS Cache Poisoning to direct users to malicious web domains where additional valuable data is sniffed. 

﻿

MAC Spoofing
﻿
MAC Spoofing is a useful technique for gaining access to a wireless network that is protected by a captive portal or some other form of network authentication that whitelists clients by MAC address. The attacker first alters their own machine's MAC address to emulate a known whitelisted device, then sends a stream of deauthentication packets to the target device so as to break the connection between that device and the access point on the client's end, thus stealing that network connection. Having achieved access to the network, the attacker can then continue in further reconnaissance, additional active sniffing measures, or continue passively sniffing traffic.

![image](https://github.com/user-attachments/assets/c1a06d22-7852-47d1-8e3d-32e3361aba2e)


-----------------------------------------------------------

Defenses Against Wireless Sniffing
The strongest defense against a Malicious Cyber Actor (MCA) eavesdropping on a mission partner's wireless communications is secure network implementation and administration. There are several key principles to consider when administering wireless networks.

﻿

Signal Strength
﻿
Since any device attempting to sniff a mission partner's wireless traffic must be able to receive the signals as they are transmitted from the WAP, reducing the coverage of the wireless network to only the necessary physical footprint of users that should access it is ideal. In this way, the wireless signals do not travel further than required. This signal strength is modulated by adjusting the power used by the transmitting WAP. A wireless signal that is too strong can lead to extended range that attacker may be able to access, for example from a coffee shop across the street.

﻿

Encryption
﻿
Encrypted communications is the bedrock on which the assurance of security is based. There have been several technologies developed since the advent of wireless networking to employ encryption to radio communications. These technologies have employed either stream ciphers, which encode plaintext messages bit-by-bit, or block ciphers, which encode data in fixed-size blocks to secure wireless traffic.

﻿

Wireless Encryption Protocol
﻿

Wireless Encryption Protocol (WEP) was the first attempt at securing wireless networks. Users realized that using a WAP in the clear caused gratuitous data loss to even non-savvy attackers. These attackers could connect to a network, turn on promiscuous mode, and steal login credentials, credit card numbers, and other private information. WEP was the first specification developed to encrypt wireless data and employs Rivest Cipher 4 (RC4) stream cipher encryption, though its use of the same key for all traffic has proven to be as insecure as transmitting in plaintext — an attacker needs fewer than 10 minutes of traffic monitoring to break the WEP key and read all captured traffic. This is largely due to the small Initialization Vector (IV) size of 24 bits. This random value serves as the starting point for the encryption of each individual frame and can easily be reused after a few hundred web requests in a crowded network. Once the adversary has two different frames with the same IV encrypted by the same static key, breaking the key is simple and the entirety of sniffed traffic is available to them. 

﻿

Wi-Fi Protected Access
﻿

When WEP was identified to be such a flawed standard, the wireless industry developed Wi-Fi Protected Access (WPA), which continues to employ the RC4 method for encryption, but instead applies that encryption in the stronger Temporal Key Integrity Protocol (TKIP). TKIP uses a larger keysize than WEP, a larger IV size, and employs a simple Message Integrity Check (MIC) to improve confidence in secure communication. Additionally, the key is dynamic — it changes for each packet, which solves another problem that WEP presented. The only way to potentially break WPA from sniffing the traffic is to capture the original authentication handshake and hope that the master key is small.

﻿

WPA2
﻿

In the second iteration of the WPA standard, the TKIP method was replaced with the Advanced Encryption Standard (AES)-based Counter Mode Cipher Block Chaining Message Authentication Code Protocol (CCMP). This encryption method employs the strongest accepted block cipher rather than the RC4 stream cipher and includes improved message integrity checking both encrypted and unencrypted data in communications.

﻿

When WPA2 is configured with a Pre-Shared Key (PSK), a single American Standard Code for Information Interchange (ASCII) password or passphrase is provided to the WAP and to any client devices that need to connect to it. This shared secret is only as strong as the trust in the users employing it. For this reason, this form of authentication is more commonly used in residential or public Wi-Fi environments, while 802.1x is preferred for enterprise networks.

﻿

Authentication
﻿

802.1x with Extensible Authentication Protocol – Transport Layer Security (EAP-TLS)
﻿

802.1x is a form of centralized network authentication in which a supplicant (client device) requests access to the network itself, then follows an authentication process that occurs at a dedicated authentication server, usually a Remote Authentication Dial-In User Service (RADIUS) server. In this model, the WAP is the authenticator device. This form of network authentication vastly increases the security of a wireless network obscuring all traffic behind encryption after the initial authentication handshake.

﻿

Authentication Handshake
﻿

When 802.1x authentication is not employed, authenticating to an access point utilizing WPA to communicate over the network is a four-step process. This process assumes the use of a master PSK. 

﻿

The master PSK can be used to create several derivative keys that are used in subsequent communications. It is important to understand these definitions of those subsequent keys:

Pairwise Master Key (PMK): The master key derived from the PSK for connections between a WAP and client device.
Pairwise Transit Key (PTK): The connection-specific key for all unicast communication between a WAP and client device.
Group Master Key (GMK): The master key derived from the PSK for broadcasts between a WAP and any client device.
Group Temporal Key (GTK): The connection-specific key for all multicast communication from a WAP.
ANonce: A connection-specific random value created by the WAP (authenticator).
SNonce: A connection-specific random value created by the client (supplicant).
Using these values, the temporal keys are created through a pseudorandom function that uses the PMK or GMK, ANonce, SNonce, client MAC address, and WAP MAC address. 

﻿

When the client initiates an authentication request, the following four-way handshake allows the exchange of the necessary keys.

﻿

1. The WAP provides the client with the ANonce used to create the PTK.

2. The client provides the WAP with the SNonce, encrypted with the PTK.

3. The WAP provides the client with the GTK, encrypted with the PTK.

4. The client confirms receipt of the GTK, encrypted with the PTK.

﻿

At this point, the client can encrypt and decrypt all unicast traffic with the PTK and encrypt and decrypt all multicast traffic with the GTK.

﻿

Virtual Private Networks
﻿

Virtual Private Networks (VPN) are a secure tunneling solution that allow encrypted access to trusted mission partner networks even when not physically connected to it. These solutions are essential for remote workers that may be using publicly available or even private wireless networks to access mission partner resources, because even if the rest of the infrastructure is secure, if a remote worker accesses sensitive material insecurely, then that material may be sniffed over the insecure wireless network.

![image](https://github.com/user-attachments/assets/1f829cf6-cefb-4443-b9a1-290072c93a84)

![image](https://github.com/user-attachments/assets/f06cb074-5582-46a9-b1a8-f8a044724e10)


-------------------------------------------------------------

Practical Defenses | Detecting Rogue Access Points

-------------------------------------------------------------

Practical Defenses | Detecting Rogue Access Points
Workflow

﻿

NOTE: The following steps continue from the previous task.

﻿

5. Observe that the device with BSSID 00:0f:66:05:a9:11 is transmitting wireless management packets with the same SSID PublicLibrary as the legitimate access point. 

﻿![image](https://github.com/user-attachments/assets/cf49eef3-b2ec-4da5-ab16-386575d45f3d)

This device is successfully emulating the legitimate PublicLibrary access point. Any device that connects to this rogue access point — even though they may experience uninterrupted service — are likely to have their entire communication captured by the attacker.

-----------------------------------------------

########## M6 L4 ############
######### SNMP Enumeration ###########
























































































































































