### CDAH-M21L1-Limit the Spread of Malicious Activity ###

Triage and Malware Analysis
An incident occurs. The adversary successfully infects the network and a host with malware. For cyber defenders, the next step is to navigate the aftermath through a triage process. The triage process involves identifying and confirming the cause of the incident and isolating hosts or devices infected by malware to prevent spreading. Malware analysis may occur during or after the triage process and may be conducted through a static or dynamic method.

﻿

Analysis Goals 
﻿

Malware analysis is the process of studying or examining a suspicious file or program to determine its functionality. Malware analysis attempts to answer the six primary questions displayed in Figure 21.1-1, below.

﻿
![image](https://github.com/user-attachments/assets/b58346f4-b4f9-450a-b8a7-fdbdab4b3d53)


Analysis Methods


Different methods are necessary to analyze the different types of malware available. Static analysis is suitable for situations where a dynamic analysis may not be feasible. Defenders also have the option to combine these two methods for a more robust analysis.


Static Analysis 


Static analysis of malware is the primary method used when the suspected malware cannot be safely executed in the environment. Static analysis involves examining a file or program to discover malicious content. Static analysis does not run the malware's code during the analysis. This type of analysis identifies Indicators of Compromise (IOC) and Tactics, Techniques, and Procedures (TTP) such as file names, Internet Protocol (IP) addresses, and domains.


Dynamic Analysis 


Dynamic analysis uses a closed environment, or sandbox, to run the malicious file or program. Dynamic analysis involves examining a file or program through execution to discover malicious content. 


Combined Analysis


It is also possible to combine the static and dynamic methods during malware analysis. Defenders combine methods by conducting the analysis in a sandbox environment. The analysis employs static analysis to search for and confirm IOCs while using dynamic analysis to execute a file or program.


Figure 21.1-2, below, highlights the key features of each type of analysis.

![image](https://github.com/user-attachments/assets/f661b049-66bc-49ed-ab81-fb544b8f2754)



---------------

Initial Examination
An initial examination initiates the malware analysis and triage process. The primary goal at this stage is to limit the spread of malware as quickly as possible. Rather than conducting a deep investigation into the incident, defenders focus on learning only what is necessary to carry out immediate action. During this examination, defenders attempt to validate an infection by collecting and analyzing known malicious activity. Any IOCs and known information is used to investigate hosts and confirm the malicious activity.  

﻿

Execute an Initial Examination 
﻿

Read the scenario below, then complete the lab steps in the Virtual Machine (VM) ls-wkstn-3. Find the answers to the upcoming series of questions to complete an initial examination of an infected host. 

﻿

Scenario 
﻿

Security analysts identified a malware infecting hosts within the organization. The Cyber Protection Team (CPT) is investigating a host, which they suspect was the target of the infection. The malware varies in name, but is frequently seen using hidden folders and the registry to maintain persistence. Table 21.1-1, below, presents the specific TTPs associated with the malware:

﻿
![image](https://github.com/user-attachments/assets/ac9de2e7-09f6-4666-aa01-5028acf4729f)




Using the information above, access and conduct an initial examination to provide an overview of malware on the host ls-wkstn-3. Use static analysis for any malware detected on the host. Any additional execution of the malware may spread and worsen the infection. 


Workflow


1. Log in to the VM ls-wkstn-3 using the following credentials:
Username: trainee
Password: CyberTraining1! 



2. Search for hidden files in each user's Documents folder by navigating to the following path:
C:\Users



3. Answer the next set of questions to start the initial examination.
dir /a:h
![image](https://github.com/user-attachments/assets/59a3991d-ae45-49b4-a224-30f77a4c32a0)
![image](https://github.com/user-attachments/assets/d0fd6de6-6644-4b36-b45d-e72025bbe3e5)
![image](https://github.com/user-attachments/assets/b950de8d-adb2-42c2-8171-f1172b1774f1)

------------------

Malware on the Host
The host ls-wkstn-3 is infected with the malware ShadySocket, which was hidden in the directory C:\Users\Public\Public Documents. The functionality and purpose of the malware is unclear. Often, hidden files are an easy tactic adversaries employ to avoid detection and keep the malware on the target host. Adversaries also attempt to maintain persistence on the host with additional TTPs. For example, the registry may be used to execute a program at host startup to ensure the program is running whenever the host is powered on. 

﻿

Explore Additional TTPs During an Initial Examination
﻿

Proceed with the examination by investigating the registry of host ls-wkstn-3.

﻿

Workflow
﻿

1. Search for suspicious entries pointing to the directory C:\Users\Public\Public Documents and the file ShadySocket.exe. 

﻿

2. Answer the next set of questions to continue the initial examination.


![image](https://github.com/user-attachments/assets/27080132-7d19-419b-88dc-5a4cb14c1fd1)


![image](https://github.com/user-attachments/assets/0fcdc918-e40f-47f5-8b5b-f48f5fbad677)

reg query HKLM /f "YourString" /s

![image](https://github.com/user-attachments/assets/6ea9168c-61ff-45b6-8c84-6ae56f54b088)


![image](https://github.com/user-attachments/assets/aafb0944-ae9f-4c68-ba5a-aeaafa4fd845)



-------------------------



Persistence on the Host
﻿

The registry for ls-wkstn-3 has a value for the malware ShadySocket located on the path HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run. The malware has a registry item named SecurityForMe, which points to the path of the file ShadySocket.exe. The registry item attempts to start the malware upon host startup to maintain persistence. 


﻿------------------------

 
Initial Examination Summary
﻿

The CPT discovered and provided an overview of the malware ShadySocket by conducting an initial examination on host ls-wkstn-3. ShadySocket infected the host and is hidden in the folder C:\Users\Public\Documents. Additionally, the malware created a new registry entry aimed at persistence. The registry entry directed the host to start ShadySocket.exe at startup.

﻿

This concludes the initial examination of malware on the host ls-wkstn-3.

-----------------


Mitigation
Mitigation strategies to limit the spread of malware vary based on the organization's environment, the size of the infection, and the functionality of the malware. Common approaches to mitigation involve removing host connectivity and powering down the host. These mitigation strategies only occur after all required evidence is gathered, this includes the collection of images of the host's hard drive and volatile memory.

﻿

Removing Host Connectivity
﻿

When host defenders discover malware, their first priority is to remove all communications between the infected host and the network. This prevents the malware from doing the following:

Communicating with other hosts or devices in the network.
Communicating with an adversary's external network or environment.
Spreading the infection.
Defenders can easily remove connectivity by either physically unplugging network cables from the host or by accessing the Command Line Interface (CLI) of the host and disabling network interfaces. Removing host connectivity allows defenders to continue the investigation and analysis processes. However, disabling networking interfaces is only feasible when accessing the infected host directly on the console. If the defender is accessing the host remotely, shutting down network interfaces will sever the defender's access to the system.

﻿

Powering Down Host
﻿

Powering down a host after discovering it has malware is an effective precaution when little to no information is known about the malware on the host. Defenders power down the hosts to achieve the following:

Ensure the malware is inactive.
Gain time to plan an approach for mitigation and investigation.
Mitigate any existing malware damage to the host.
Despite its advantages, powering down an infected system also prevents defenders from collecting volatile memory data that may be helpful for an investigation. Additionally, powering down the host often does not remove or permanently deactivate the malware. When the host is powered on again, the malware may continue functioning and carrying out the adversary's campaign. Powering down the host also delays ongoing dynamic investigation of malware on that system until the host can be imaged or safely powered on again, in a controlled manner.


-----------


Limit Malware Spread
Continue working in ls-wkstn-3, which is infected with the malware ShadySocket. Limit the spread of the malware by using the host's CLI to list and shutdown network interfaces. Confirm the host no longer has connectivity with any network. 

﻿

Workflow
﻿

1. Log in to the VM ls-wkstn-3 using the following credentials:

Username: trainee
Password: CyberTraining1! 
﻿

2. Right-click Windows Start on the toolbar and select Command Prompt (Admin).

﻿

3. Select Yes in the dialog box that displays the prompt Do you want to allow this app to make changes to your device? 

﻿

4. View network interfaces on the host by entering the following command:

netsh interface show interface        
﻿

The Microsoft CLI utility netsh allows users to display or modify host network configurations. The command netsh interface show interface returns the network interfaces and their statuses on the host. 

﻿

5. Disable the interface Ethernet1 by entering the following command:

netsh interface set interface Ethernet1 disable
﻿

6. Disable the interface Ethernet0 by entering the following command:

netsh interface set interface Ethernet0 disable
﻿

7. Answer the next question to confirm steps 5 and 6 have been completed successfully.


![image](https://github.com/user-attachments/assets/7dfdf4a8-3d0e-48f1-85d8-5419f2b0e5ee)

![image](https://github.com/user-attachments/assets/4cd281f6-ad9c-4551-9b01-b0a220a290fe)


------------------


Successful Prevention and Migration
Listing the network interfaces after completing the previous lab outputs the following:


Admin State    State          Type             Interface Name
-------------------------------------------------------------
Disabled       Disconnected   Dedicated        Ethernet1
Disabled       Disconnected   Dedicated        Ethernet0
﻿

The output confirms the interfaces have been disabled successfully. The Admin State for both interfaces Ethernet1 and Ethernet0 are listed as Disabled. The State for both interfaces is listed as Disconnected. This indicates that all connectivity on the host has been removed, which prevents the malware from spreading.

![image](https://github.com/user-attachments/assets/6577b7dc-2bf6-4f90-bf11-71eeae1392c6)
![image](https://github.com/user-attachments/assets/26bbb58c-147c-450b-9ada-d2d967d74b62)


-------------------
















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































