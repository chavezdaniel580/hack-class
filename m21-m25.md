### CDAH-M21L1-Limit the Spread of Malicious Activity ###

Triage and Malware Analysis
An incident occurs. The adversary successfully infects the network and a host with malware. For cyber defenders, the next step is to navigate the aftermath through a triage process. The triage process involves identifying and confirming the cause of the incident and isolating hosts or devices infected by malware to prevent spreading. Malware analysis may occur during or after the triage process and may be conducted through a static or dynamic method.

﻿

Analysis Goals 
﻿

Malware analysis is the process of studying or examining a suspicious file or program to determine its functionality. Malware analysis attempts to answer the six primary questions displayed in Figure 21.1-1, below.

﻿
![image](https://github.com/user-attachments/assets/b58346f4-b4f9-450a-b8a7-fdbdab4b3d53)


Analysis Methods


Different methods are necessary to analyze the different types of malware available. Static analysis is suitable for situations where a dynamic analysis may not be feasible. Defenders also have the option to combine these two methods for a more robust analysis.


Static Analysis 


Static analysis of malware is the primary method used when the suspected malware cannot be safely executed in the environment. Static analysis involves examining a file or program to discover malicious content. Static analysis does not run the malware's code during the analysis. This type of analysis identifies Indicators of Compromise (IOC) and Tactics, Techniques, and Procedures (TTP) such as file names, Internet Protocol (IP) addresses, and domains.


Dynamic Analysis 


Dynamic analysis uses a closed environment, or sandbox, to run the malicious file or program. Dynamic analysis involves examining a file or program through execution to discover malicious content. 


Combined Analysis


It is also possible to combine the static and dynamic methods during malware analysis. Defenders combine methods by conducting the analysis in a sandbox environment. The analysis employs static analysis to search for and confirm IOCs while using dynamic analysis to execute a file or program.


Figure 21.1-2, below, highlights the key features of each type of analysis.

![image](https://github.com/user-attachments/assets/f661b049-66bc-49ed-ab81-fb544b8f2754)



---------------

Initial Examination
An initial examination initiates the malware analysis and triage process. The primary goal at this stage is to limit the spread of malware as quickly as possible. Rather than conducting a deep investigation into the incident, defenders focus on learning only what is necessary to carry out immediate action. During this examination, defenders attempt to validate an infection by collecting and analyzing known malicious activity. Any IOCs and known information is used to investigate hosts and confirm the malicious activity.  

﻿

Execute an Initial Examination 
﻿

Read the scenario below, then complete the lab steps in the Virtual Machine (VM) ls-wkstn-3. Find the answers to the upcoming series of questions to complete an initial examination of an infected host. 

﻿

Scenario 
﻿

Security analysts identified a malware infecting hosts within the organization. The Cyber Protection Team (CPT) is investigating a host, which they suspect was the target of the infection. The malware varies in name, but is frequently seen using hidden folders and the registry to maintain persistence. Table 21.1-1, below, presents the specific TTPs associated with the malware:

﻿
![image](https://github.com/user-attachments/assets/ac9de2e7-09f6-4666-aa01-5028acf4729f)




Using the information above, access and conduct an initial examination to provide an overview of malware on the host ls-wkstn-3. Use static analysis for any malware detected on the host. Any additional execution of the malware may spread and worsen the infection. 


Workflow


1. Log in to the VM ls-wkstn-3 using the following credentials:
Username: trainee
Password: CyberTraining1! 



2. Search for hidden files in each user's Documents folder by navigating to the following path:
C:\Users



3. Answer the next set of questions to start the initial examination.
dir /a:h
![image](https://github.com/user-attachments/assets/59a3991d-ae45-49b4-a224-30f77a4c32a0)
![image](https://github.com/user-attachments/assets/d0fd6de6-6644-4b36-b45d-e72025bbe3e5)
![image](https://github.com/user-attachments/assets/b950de8d-adb2-42c2-8171-f1172b1774f1)

------------------

Malware on the Host
The host ls-wkstn-3 is infected with the malware ShadySocket, which was hidden in the directory C:\Users\Public\Public Documents. The functionality and purpose of the malware is unclear. Often, hidden files are an easy tactic adversaries employ to avoid detection and keep the malware on the target host. Adversaries also attempt to maintain persistence on the host with additional TTPs. For example, the registry may be used to execute a program at host startup to ensure the program is running whenever the host is powered on. 

﻿

Explore Additional TTPs During an Initial Examination
﻿

Proceed with the examination by investigating the registry of host ls-wkstn-3.

﻿

Workflow
﻿

1. Search for suspicious entries pointing to the directory C:\Users\Public\Public Documents and the file ShadySocket.exe. 

﻿

2. Answer the next set of questions to continue the initial examination.


![image](https://github.com/user-attachments/assets/27080132-7d19-419b-88dc-5a4cb14c1fd1)


![image](https://github.com/user-attachments/assets/0fcdc918-e40f-47f5-8b5b-f48f5fbad677)

reg query HKLM /f "YourString" /s

![image](https://github.com/user-attachments/assets/6ea9168c-61ff-45b6-8c84-6ae56f54b088)


![image](https://github.com/user-attachments/assets/aafb0944-ae9f-4c68-ba5a-aeaafa4fd845)



-------------------------



Persistence on the Host
﻿

The registry for ls-wkstn-3 has a value for the malware ShadySocket located on the path HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run. The malware has a registry item named SecurityForMe, which points to the path of the file ShadySocket.exe. The registry item attempts to start the malware upon host startup to maintain persistence. 


﻿------------------------

 
Initial Examination Summary
﻿

The CPT discovered and provided an overview of the malware ShadySocket by conducting an initial examination on host ls-wkstn-3. ShadySocket infected the host and is hidden in the folder C:\Users\Public\Documents. Additionally, the malware created a new registry entry aimed at persistence. The registry entry directed the host to start ShadySocket.exe at startup.

﻿

This concludes the initial examination of malware on the host ls-wkstn-3.

-----------------


Mitigation
Mitigation strategies to limit the spread of malware vary based on the organization's environment, the size of the infection, and the functionality of the malware. Common approaches to mitigation involve removing host connectivity and powering down the host. These mitigation strategies only occur after all required evidence is gathered, this includes the collection of images of the host's hard drive and volatile memory.

﻿

Removing Host Connectivity
﻿

When host defenders discover malware, their first priority is to remove all communications between the infected host and the network. This prevents the malware from doing the following:

Communicating with other hosts or devices in the network.
Communicating with an adversary's external network or environment.
Spreading the infection.
Defenders can easily remove connectivity by either physically unplugging network cables from the host or by accessing the Command Line Interface (CLI) of the host and disabling network interfaces. Removing host connectivity allows defenders to continue the investigation and analysis processes. However, disabling networking interfaces is only feasible when accessing the infected host directly on the console. If the defender is accessing the host remotely, shutting down network interfaces will sever the defender's access to the system.

﻿

Powering Down Host
﻿

Powering down a host after discovering it has malware is an effective precaution when little to no information is known about the malware on the host. Defenders power down the hosts to achieve the following:

Ensure the malware is inactive.
Gain time to plan an approach for mitigation and investigation.
Mitigate any existing malware damage to the host.
Despite its advantages, powering down an infected system also prevents defenders from collecting volatile memory data that may be helpful for an investigation. Additionally, powering down the host often does not remove or permanently deactivate the malware. When the host is powered on again, the malware may continue functioning and carrying out the adversary's campaign. Powering down the host also delays ongoing dynamic investigation of malware on that system until the host can be imaged or safely powered on again, in a controlled manner.


-----------


Limit Malware Spread
Continue working in ls-wkstn-3, which is infected with the malware ShadySocket. Limit the spread of the malware by using the host's CLI to list and shutdown network interfaces. Confirm the host no longer has connectivity with any network. 

﻿

Workflow
﻿

1. Log in to the VM ls-wkstn-3 using the following credentials:

Username: trainee
Password: CyberTraining1! 
﻿

2. Right-click Windows Start on the toolbar and select Command Prompt (Admin).

﻿

3. Select Yes in the dialog box that displays the prompt Do you want to allow this app to make changes to your device? 

﻿

4. View network interfaces on the host by entering the following command:

netsh interface show interface        
﻿

The Microsoft CLI utility netsh allows users to display or modify host network configurations. The command netsh interface show interface returns the network interfaces and their statuses on the host. 

﻿

5. Disable the interface Ethernet1 by entering the following command:

netsh interface set interface Ethernet1 disable
﻿

6. Disable the interface Ethernet0 by entering the following command:

netsh interface set interface Ethernet0 disable
﻿

7. Answer the next question to confirm steps 5 and 6 have been completed successfully.


![image](https://github.com/user-attachments/assets/7dfdf4a8-3d0e-48f1-85d8-5419f2b0e5ee)

![image](https://github.com/user-attachments/assets/4cd281f6-ad9c-4551-9b01-b0a220a290fe)


------------------


Successful Prevention and Migration
Listing the network interfaces after completing the previous lab outputs the following:


Admin State    State          Type             Interface Name
-------------------------------------------------------------
Disabled       Disconnected   Dedicated        Ethernet1
Disabled       Disconnected   Dedicated        Ethernet0
﻿

The output confirms the interfaces have been disabled successfully. The Admin State for both interfaces Ethernet1 and Ethernet0 are listed as Disabled. The State for both interfaces is listed as Disconnected. This indicates that all connectivity on the host has been removed, which prevents the malware from spreading.

![image](https://github.com/user-attachments/assets/6577b7dc-2bf6-4f90-bf11-71eeae1392c6)
![image](https://github.com/user-attachments/assets/26bbb58c-147c-450b-9ada-d2d967d74b62)


-------------------


### CDAH-M21L2-Preserve Malicious Artifacts ### 

Preserving Malware Artifacts
Malware has been discovered on a host within the network. The triage process has successfully contained the spread and ensured that all critical information and hosts are not compromised. The next step in the triage process is preservation. Malware preservation begins with identification of the malware itself and artifacts related to it. Malware artifacts include items located in files, directories, scripts, browser history items, scheduled tasks, and even the malicious software. Given their broad and inclusive nature, malware artifacts can be located anywhere on the host, requiring a keen eye and investigative mindset to accurately identify. Preservation may include more investigation, as the initial goal of triage is solely to stop the spread and mitigate damage, meaning more artifacts may persist on the host. 


---------------------


Discover Malware Artifacts
In the following lab, use the provided scenario to analyze an infected host and discover malware artifacts. 

﻿

Scenario 
﻿

A Cyber Protection Team (CPT) has been tasked with investigating hosts that have been infected by the ShadySockets malware. Triage of the ls-wkstn-3 host uncovered the following Indicators of Compromise (IOC):


![image](https://github.com/user-attachments/assets/4d5fdb09-82fc-4512-82e3-7f265d885750)


The triage process was completed quickly to stop the spread of the malware and mitigate damage to the host. Because the work was so rapidly done, more artifacts as a result of ShadySockets may persist on the host. 


Using the information above, access and analyze the infected ls-wkstn-3 host to discover malware artifacts.


Workflow


1. Log in to the Virtual Machine (VM) ls-wkstn-3 using the following credentials:

Username: trainee
Password: CyberTraining1! 



2. Review hidden files located in C:\Users\Public\Documents to confirm that the ShadySockets.exe malware exists on the host. Once the existence of the malicious executable is confirmed, review and analyze the rest of the C:\Users\Public directory.   


Use this workflow to answer the following questions.


![image](https://github.com/user-attachments/assets/dec3a31a-c30d-4f45-8ee3-f8e75990fe10)


![image](https://github.com/user-attachments/assets/f13f419d-db62-4d4e-983b-6b55e6de9719)


![image](https://github.com/user-attachments/assets/2a60d938-e56a-41c9-bd31-eebd1b2779aa)


----------------------

Context for Discovered Artifacts
Figure 21.2-1 shows the hidden and nonhidden files in the C:\Users\Public\Downloads directory:


![image](https://github.com/user-attachments/assets/d6f88a2d-0433-4ab7-86a8-cda6a1805fdf)


NOTE: By default, the file path shown in the address bar is the display name of the directory rather than its underlying directory path.


The nonhidden file, document.pdf, can potentially point to the initial cause of the infection. In this scenario, the document.pdf file is a malicious document. The user downloaded the document.pdf file from what they thought was a trusted source, and when the file was opened, it initiated malicious downloads and modifications to the host. The downloads and modifications are programmed to occur in the background, hidden and unknown to the user. 


Of the downloaded hidden files, Nmap and nmap-7.92-setup are aimed at conducting active reconnaissance on the network. The adversary may strategically place these on the victim host in an effort to identify other hosts and devices on the network and expand use of the malware and the campaign. The Enable-RDP file is a Windows PowerShell script, likely to enable Remote Desktop Protocol (RDP) on victim hosts that the adversary has infected with the malware. 


-------------------

Investigate Task Scheduler
Often, such scripts as Enable-RDP that are planted on the victim host are leveraged to enable settings or access critical information that provide functionality and payload to the adversary. Scripts automate otherwise tedious tasks and processes and can be scheduled to run outside the view of the user. For this reason, Task Scheduler must be investigated.

﻿

In Windows, Task Scheduler allows users to automatically perform routine tasks on a chosen computer. Task Scheduler monitors user-defined triggers, and when a trigger is activated, the user-defined tasks, or actions, are then completed on the host. Task Scheduler allows the actions to occur hidden, away from view of the user, making it an attractive application for the adversary to leverage.

﻿

Complete the steps in the following workflow to investigate Task Scheduler.

﻿

Workflow
﻿

1. Right-click the Windows icon located on the taskbar, select Control Panel, select Administrative Tools, and select Task Scheduler.

﻿

2. In the left pane of Task Scheduler, under Task Scheduler (Local), select Task Scheduler Library.

﻿

3. In the Task Scheduler Library, review the scheduler tasks, and look for actions that call for execution of the Enable-RDP script. 

﻿

Use this workflow to answer the following questions.


![image](https://github.com/user-attachments/assets/5e732e2b-579c-44cc-8579-94e3379fac7d)


![image](https://github.com/user-attachments/assets/65011985-16a9-451d-84c1-e07e3ce4b923)


![image](https://github.com/user-attachments/assets/bfbbd66b-9526-4520-8be4-d3ba5625973d)


-----------------

Artifacts Discovered
Through investigation and analysis of files and directories on the ls-wkstn-3 host, the CPT discovered and provided artifacts related to the ShadySockets malware. ShadySockets has infected the host, and related artifacts were found in the C:\Users\Public\Downloads folder. The artifacts included an application installation of the Nmap software, an exfiltration folder, a suspicious Portable Document Format (PDF) file, and a Windows PowerShell script. Additionally, the malware created a scheduled task, RDP, to ensure RDP was enabled on the host. These artifacts continue in the preservation process and require further analysis later in the investigation. 


-------------


Handling Malware Artifacts
Evidence is key to a criminal investigation, providing critical answers to the questions Who? What? When? Where? Why? and How? Cybersecurity evidence is no different from criminal evidence in this regard. Cybersecurity evidence holds vital information that must be preserved. Changes may alter the behavior of the malware, artifacts, or evidence that already exists on the host, compromising portions of the investigation. To handle malware evidence appropriately, Cyber Defense Analysts (CDA) must minimize making changes to the victim host. Although some changes are necessary to mitigate damage, such as removing network connectivity, limiting the amount of changes to the bare minimum is a priority.  

﻿

Evidence Integrity
﻿

Evidence integrity is the protection of evidence material from alteration, contamination, or deletion. Malware evidence can be easily tampered with or modified, and maintaining the integrity of the evidence is a critical task. Techniques and tools used must be aimed at accurately and efficiently collecting and storing evidence. 

﻿

One technique often used in a cybersecurity investigation is the collection of a forensic image. A forensic image is a direct copy of the host’s physical storage device, such as the Hard Disk Drive (HDD). A forensic image contains all files, directories, and space allocations (illustrated in Figure 21.2-2). In an ideal scenario, all investigative actions would occur on the forensic image rather than on the directory on the victim host. Using a forensic image achieves the goal of handling a malware-infected host, as CDAs are not changing or making direct contact with the host.


![image](https://github.com/user-attachments/assets/4213b04c-da2f-4306-90ba-1492a1fa66db)


Sometimes an investigation may require CDAs to complete tasks and actions directly on the victim host. Should work directly on the host be required, documentation of all activities through the use of Operation Notes (OPNOTES) is top priority. After completing significant tasks such as memory capture, endpoint analysis, or malware remediation, Forensic images should be created frequently, after such major tasks or actions as memory capture, malware remediation, or endpoint analysis are completed.


![image](https://github.com/user-attachments/assets/cb864b49-1f4e-4ee1-bff0-686f182c854d)



-----------------



Extracting Malware Artifacts
Extracting malware artifacts includes copying artifacts from the host machine for further investigation. Accurately extracting malware relies on deliberate actions and documentation. Any actions taken must be recorded so that the investigation is not confused with the injection. Methods of extraction have two goals: to accurately extract malicious artifacts and to preserve the organization’s OPSEC, meaning the sensitive information is not compromised in any way.


---------------


Hash Malware Artifacts
A hash algorithm provides a unique, fixed-length string for a piece of data or file. Hashing refers to the application of the hash algorithm to a file or folder at a given point in time. The output of hashing a file or folder, an alphanumeric string referred to as a hash value, is unique to the file or folder. If a file or folder is hashed again in the future and the new hash value is different from the original hash value, changes have occurred in the file or folder. Hashing a file or folder is an effective method to extract malicious samples in a manner that preserves OPSEC. The hash algorithm relies on a complex equation to derive the hash’s value. Numerous algorithms exist, such as Message Direct 5 (MD5) and Secure Hash Algorithm (SHA). Each algorithm is different; however, the overall goal is the same: to produce a hash value that maintains the integrity and security of the artifact. 

﻿

Windows PowerShell is a common tool for quickly and effectively hashing a file, using the Get-FileHash cmdlet. Get-FileHash by default uses the SHA256 algorithm, but it can be changed and defined by the user.

﻿

The following lab involves hashing ShadySockets malware artifacts. The ShadySockets malware was found on host ls-wkstn-3. The CPT collected an image of the infected host.

﻿

Hash Malware Artifacts | Part 1
﻿

Complete the steps in the following workflow to access the copy of the ls-wkstn-3 host infected with the ShadySockets malware and hash previously identified malware artifacts. 

﻿

Workflow
﻿

1. Log in to the VM ls-wkstn-3 using the following credentials:


Username: trainee
Password: CyberTraining1! 
﻿

2. Access a new Windows PowerShell terminal.

﻿

3. Within the terminal, navigate to C:\Users\Public\Downloads.

﻿

4. To view the nonhidden files contained in the C:\Users\Public\Downloads folder, run the following cmdlet:


ls
﻿

5. To view the hidden files contained in the C:\Users\Public\Downloads folder, run the following cmdlet:


ls -hidden
﻿

-hidden following the ls command ensures that all hidden files are displayed. 

﻿

6. Run the following cmdlet:


Get-FileHash .\document.pdf
﻿

Figure 21.2-3 displays the output returned from the cmdlet:

![image](https://github.com/user-attachments/assets/e0970d46-09bd-4ace-8841-578d26f886b8)

The hash is the result of the SHA256 algorithm for the document.pdf file. 


7. Run the following cmdlet:

Get-FileHash .\document.pdf -Algorithm MD5



Figure 21.2-4 displays the output returned from the cmdlet:

![image](https://github.com/user-attachments/assets/791c2603-818d-4353-aaad-b380189c74c1)



Using -Algorithm, users can define the hashing algorithm. Figure 21.2-4 shows the use of the MD5 hash for the document.pdf file.  


If the document.pdf file is manipulated or changed, the hash value is different from what is currently listed in Figure 21.2-3 and Figure 21.2-4. It is critical to hash all artifacts at the start of the investigative process and after any actions are taken on the host. The hash values must be recorded to preserve OPSEC and an accurate view of the investigative actions.

-------------

Hash Malware Artifacts | Part 2
Complete the steps in the following workflow to access the host infected with the ShadySockets malware and continue hashing previously identified malware artifacts. 

﻿

Workflow
﻿

1. Log in to the VM ls-wkstn-3 using the following credentials:


Username: trainee
Password: CyberTraining1! 
﻿

2. Hash the following artifacts by the given algorithm in Table 21.2-2:

﻿
![image](https://github.com/user-attachments/assets/82192edb-77c0-4ab2-9cee-e2cbc6a600af)


Table 21.2-2


3. Record the hash values of the artifacts to help in responding to the questions that follow.



![image](https://github.com/user-attachments/assets/ec4d1813-0c5c-4964-be87-9189eaa0337b)


![image](https://github.com/user-attachments/assets/b9f48afb-f5d6-486a-9416-e780e5735827)


![image](https://github.com/user-attachments/assets/6e502f3a-2185-4fa5-a64c-662a1dc5ebdb)


-------------------

### CDAH-M21L3-Investigate Malicious Software ###

Malware Investigation
An organization has identified a threat or potential breach, and its incident response plan has been put into action. The top priority during the response is mitigation of the threat and prevention of any damage to the organization’s hosts and devices. An additional priority is preservation and investigation of the malware and the mechanisms used to conduct the breach. Static analysis and dynamic analysis of the malware are needed to aid in the investigation. Malware analysis provides critical information that an organization can use to assess and modify its current cybersecurity defense posture. 

﻿

Malware Analysis 
﻿

The goal of malware analysis is to research and identify malware and malware artifacts in an effort to evolve defenses and protect the organization’s network. Malware analysis must seek to answer the following questions:

What was the attack vector used for the infection? 
What is the malware’s interactive behavior, what does it do, and what does it change?
What are the static properties (such as hashes, metadata, and embedded strings) of the malware?

Malware analysis may not always provide answers to each of the questions listed; unknowns may persist. However, malware analysis should strive to answer each question using the data and information available. At the end of the analysis, IOCs and TTPs should be summarized and identified. 


------------------


Investigation
Read the following scenario: 

﻿

A Cyber Protection Team (CPT) is tasked with analyzing a malware file discovered on an infected host, ls-wkstn-3, as part of a wide-scale network breach. The malware has been identified as a potentially malicious PDF file, Financial Report Q2.pdf, located on the path C:\Users\trainee\Desktop\CorporateQ2. Additionally, security analysts have identified email as the attack vector used by the threat actor to introduce the malware to the organization’s network.

﻿

Security analysts conducted research on similar malicious documents found in the organization. Table 21.3-1 provides the TTPs and associated notes:

﻿
![image](https://github.com/user-attachments/assets/7a089eed-9a50-473f-ac17-24356ab127b7)

Using the information above as well as information provided in upcoming tasks, perform a hands-on investigation of the malware to determine the malware’s specific TTPs.


Investigation | Part 1


Complete the steps in the following workflow to perform both static and dynamic analyses on the ls-wkstn-3 host. The ls-wkstn-3 host is located in a sandbox environment. The functionality of the malware on the host is largely unknown, and although dynamic analysis is included, unusual occurrences, such as connection attempts, dialog boxes, and error messages, may occur. 


Workflow


1. Log in to the Virtual Machine (VM) ls-wkstn-3 using the following credentials:

Username: trainee
Password: CyberTraining1! 



2. Confirm the location and existence of the Financial Report Q2.pdf and FR-Q2.exe files on the path C:\Users\trainee\Desktop\CorporateQ2.


3. Conduct static analysis of the Financial Report Q2.pdf and FR-Q2.exe files.


4. Open the Financial Report Q2.pdf file. Select Open when the warning dialog appears.


5. Conduct dynamic analysis of the Financial Report Q2.pdf and FR-Q2.exe files. 


Using this workflow, answer the questions that follow.

![image](https://github.com/user-attachments/assets/6391c442-53e4-4be2-9ec1-8ddede4ddafd)

command to find hidden .exe file

C:\>dir /a /s /b "C:\*updateCheck.exe"
![image](https://github.com/user-attachments/assets/fba1ae41-1026-4498-8a19-d1f945b12b6b)
![image](https://github.com/user-attachments/assets/e4116167-e1f5-4c39-b966-3c20156d1dde)

----------------

Investigation | Part 2
The Financial Report Q2.pdf file presented additional malware artifacts to the ls-wkstn-3 host. One of the artifacts found on the host is updateCheck.exe, an executable file located on the path C:\Users\trainee\AppData\Roaming. 

﻿

The executable file’s functionality is not known.

﻿

Workflow
﻿
1. Log in to the Virtual Machine (VM) ls-wkstn-3 using the following credentials:


Username: trainee
Password: CyberTraining1! 
﻿
﻿

2. Execute the updateCheck.exe file, and analyze the actions that occur.


![image](https://github.com/user-attachments/assets/19e19d0c-7592-45d3-8599-616e398ce573)


-------------

Investigation | Part 3
The updateCheck.exe file causes a dialog box to appear on the ls-wkstn-3 host. The dialog box indicates that “cdah has stopped working.” The alert is not a usual occurrence. It is possible the malware is attempting to complete a task, connection, or action. However, the attempt is not successful.


![image](https://github.com/user-attachments/assets/f919db99-2106-4b8d-bef3-1e89773b89a7)


-----------------


Investigation | Part 4
The appearance of the “cdah has stopped working” dialog box as a result of opening the updateCheck.exe file may point to some of the malware’s functionality. It is possible that the malware attempts to connect to internal or external hosts in an attempt to either widen the infection or deliver exfiltrated data from the compromised environment. 

﻿

Persistence
﻿

To persist on the host, malware often targets the host’s registry with the creation of key items. The key items allow the malware to start itself or additional artifacts when the host powers on. Common registry locations targeted by adversaries include the following:


HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce
HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce

Workflow
﻿

1. Log in to the Virtual Machine (VM) ls-wkstn-3 using the following credentials:


Username: trainee
Password: CyberTraining1! 
﻿
﻿

2. Review the common registry paths for any items that point to updateCheck.exe. 

![image](https://github.com/user-attachments/assets/37033355-fee3-4b0e-91de-e277d1d74564)

![image](https://github.com/user-attachments/assets/83aca0b5-1678-4e7a-b38a-fa7971ef769e)
![image](https://github.com/user-attachments/assets/ba0341db-fb72-4d55-a070-0e2656de27fd)

----------------------


Investigation Summary
Through the use of static and dynamic analyses, the CPT discovered the following regarding malware located on the ls-wkstn-3 host: 

A malicious PDF file sent via email as an attachment, Financial Report Q2.pdf, located on the path C:\Users\trainee\Desktop\CorporateQ2.

A hidden executable file, updateCheck.exe, located on the path C:\Users\trainee\AppData\Roaming.

An attempt by updateCheck.exe to make connections; the connections fail.

An Abobe entry in the HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run and HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run registry paths, aimed at maintaining persistence on the host. 

﻿
---------------

ATT&CK TTPs
MITRE ATT&CK® is a knowledge base of common adversarial attack TTPs used against Windows networks. Currently, the ATT&CK matrix (attached) includes 14 tactics, which cover the why (the objective for performing the action), and more than 180 techniques (with nearly 400 subtechniques), which state how the adversary is going to perform the action and what they hope to gain from it.

﻿

MITRE’s model reflects the various phases of an adversary’s attack lifecycle and the platforms they are known to target but is free from the rigidity of a linear attack chain. At a high level, the ATT&CK matrix is a behavioral model that consists of the following core components: 

Tactics: Short-term, tactical adversary goals during an attack (the columns in the ATT&CK matrix). 
Techniques: The means by which adversaries achieve tactical goals (the individual cells in the ATT&CK matrix). 
Documented adversary use of techniques and other metadata (linked to techniques): ATT&CK is not an exhaustive enumeration of attack vectors against software, but the documented operation can be used to contextualize the impact of an attack, the actors known to employ the technique, and other information.
The ATT&CK matrix can help define and associate characteristics of malware identified within hosts. Using the ATT&CK matrix, Cyber Defense Analysts (CDA) can view techniques and subtechniques that aid in further research of the malware and point to other events that may occur.  


-----------


Associate Malware with ATT&CK TTPs
During the initial investigation, the following items regarding malware were discovered: 


A malicious PDF file sent via email as an attachment, Financial Report Q2.pdf, located on the path C:\Users\trainee\Desktop\CorporateQ2.

A hidden executable file, updateCheck.exe, located on the path C:\Users\trainee\AppData\Roaming.

An attempt by updateCheck.exe to make connections; the connections fail.

An Abobe entry in the HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run and HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run registry paths. 


Using the information in the attached ATT&CK matrix, review the malware items obtained during the initial investigation. Associate each item with ATT&CK TTPs found in the matrix.

﻿![image](https://github.com/user-attachments/assets/448a7ded-9051-4fba-9c37-358572edc86a)
![image](https://github.com/user-attachments/assets/22a9db2c-6dd9-43be-a350-7bb2f03daa2b)
![image](https://github.com/user-attachments/assets/6ff80631-bdb2-4b74-a845-b10dda77d536)
![image](https://github.com/user-attachments/assets/bf2ec6b7-2448-45dd-947f-bf077ed19c99)



---------


ATT&CK TTP Summary
Each of the items regarding malware that were discovered during initial investigation has been associated with a TTP found in the ATT&CK matrix. Table 21.3-2 provides each item, its associated TTP, and the link to the associated TTP on the ATT&CK website: 



![image](https://github.com/user-attachments/assets/5497f3c5-01e9-4202-8610-d18e3ddfe585)



----------------

### CDAH-M21L4-Neutralize Malicious Software ###

Neutralizing and Removing Malware
Modern malware is sophisticated in its functionality and ability to evade initial detection as it traverses the entry control points of a network and endpoint anti-malware systems. Organizations often configure anti-malware systems to stop scanning analysis after a file has crossed the control point and is successfully in the environment. Organizations commonly do not employ constant monitoring of files and applications already accepted in the environment in favor of system performance and resource allocation. 

﻿

Once a breach has been detected, the incident response process starts. After the malware has been contained and triaged, the neutralize (clean) phase begins. The neutralize phase relies on analysts’ neutralizing threats without corrupting forensic artifacts. Tasks during this phase may include terminating malware processes, reinstalling Operating Systems (OS), or verifying malware removal, as illustrated in Figure 21.4-1. Malware complexity and organizational impact are factors that impact the decisions and strategies analysts take in this stage. 

﻿![image](https://github.com/user-attachments/assets/5de8358c-1af1-4e02-a543-6f15574a8a05)

Factors Affecting the Path for Malware Removal


Advanced malware attacks evade detection using complex techniques, such as sleep functionality, encryption, and polymorphic code, and these techniques change their identifiable features constantly. Additionally, malware can infect a system’s Unified Extensible Firmware Interface (UEFI). As a result, the malware is capable of surviving a system reboot, OS reinstallation, and a hard disk replacement. Advanced malware features can make the removal method unreliable in certain scenarios. The decision to remove malware is heavily dependent on the results from dynamic analysis in the investigative phase. 


Ideally, a system or host would be restored to an image in a known good state. Once the system or host is restored, hardening tasks would be applied to patch vulnerabilities and prevent a similar attack from occurring. Organizations must factor in the complexity of the system or hosts when deciding how to handle a malware infection. Rebuilding complex systems requires a large amount of resources, including access to the system, time, personnel, and money. In addition, the collateral damage from extended downtime to the Information Technology (IT) system and organization can be a catastrophic loss leading to mission failure.



---------------


Remove Malware
Scenario: Investigative Report
﻿

A Cyber Protection Team (CPT) investigation was previously completed, identifying suspicious internet traffic on ls-wkstn-3. ls-wkstn-3 is a host used by a financial purchasing agent that contains large amounts of financial account information and Personally Identifiable Information (PII). Hypertext Transfer Protocol Secure (HTTPS) traffic bound for geocities.com and yahoo.com was redirected to Internet Protocol (IP) address 210.210.210.2. This IP address is known to be part of the infrastructure used by the amateur threat actor group FranklinEdition. During the investigation, the CPT analysts reviewed Security Information and Event Management (SIEM) traffic and conducted host analysis. As a result, numerous pieces of information; artifacts; and Tactics, Techniques, and Procedures (TTP) were discovered, as shown in Table 21.4-1. Table 21.4-1 also contains each discovered TTP’s link to its associated technique in the MITRE ATT&CK® matrix. 


![image](https://github.com/user-attachments/assets/0749ebba-e9fe-46c7-845e-19e86a1b3873)


Clear Operation


Upon discovery of the artifacts in Table 21.4-1, a clear operation has been ordered. While clear operations are not commonly done by a CPT, the client has requested that the CPT aid in neutralizing the malicious software by removal of any remaining threat actor presence and restoring the system to a clean state. 


Remove Malware: Confirm Artifacts and Delete Persistence Mechanism


Complete the steps in the following workflow to start the operation; this includes confirming the existence of each artifact and deleting the persistence mechanism found in the registry.


Workflow


1. Log in to the Virtual Machine (VM) ls-wkstn-3 using the following credentials:

Username: trainee
Password: CyberTraining1! 



2. Access the registry and navigate to HKCU\Software\Microsoft\Windows\CurrentVersion\Run\Abobe.


3. Right-click the Abobe entry, and select Delete. 


By de leting th e Abobe entry, which points to the updateCheck.exe -dLp 443 -e cmd.exe command, the malware’s persistence mechanism is removed. The Abobe entry ran the updateChec k.exe with a shell listening on port 443, whic h  was executed whe n t he host was powered on. 



-------------

Remove Malware: Collect Hash Values
Complete the steps in the following workflow to continue the clear operation by collecting hash values of artifacts. 

﻿

Workflow
﻿


1. Open a Windows PowerShell terminal, and navigate to C:\Windows\System32\drivers\etc.

﻿

2. Enter the following command to hash the hosts file found in C:\Windows\System32\drivers\etc:


Get-FileHash .\hosts -Algorithm MD5
﻿

3. Record the hash value. The hash value ensures that the file remains uncorrupted. 

﻿

4. Continue the same process in Steps 1 through 3 to collect hash values for the files

C:\users\trainee\appdata\roaming\Q2 financials.zip and C:\users\trainee\appdata\roaming\updateCheck.exe.

﻿

Use this workflow to answer the following questions.
![image](https://github.com/user-attachments/assets/c0824bd4-2adc-4ee3-abac-6cf76f581e61)
![image](https://github.com/user-attachments/assets/6bbf68eb-eebc-4fa5-8257-af6191102725)
![image](https://github.com/user-attachments/assets/4d2f41ae-f118-480c-a7af-8c87dfd1ac35)



-----------


Remove Malware: Remove Malware Artifacts
Complete the steps in the following workflow to continue the clear operation by accessing and removing malware artifacts. 

﻿

Workflow
﻿


1. Navigate to C:\Windows\System32\drivers\etc within File Explorer.

﻿

2. Open the hosts file in Notepad as an Administrator. 

﻿

3. Modify the hosts file by removing the following lines, found at the bottom of the file:


210.210.210.2 www.geocities.com
220.210.210.2 www.yahoo.com
﻿

4. Select File and Save to save the hosts file. 

﻿

5. Navigate to C:\users\trainee\appdata\roaming\Q2 financials.zip.

﻿

6. Delete the Q2 financials.zip folder. 

﻿

7. Navigate to C:\users\trainee\appdata\roaming\updateCheck.exe.

﻿

8. Delete the updateCheck.exe file. 

﻿

9. Right-click Recycle Bin, and select Empty Recycle Bin.

﻿

10. Return to t he paths C:\u sers\trainee\appdata\roaming\Q2 financials.zip and C:\users\trainee\appdata\roaming\updateCheck.exe, an d verify that  each folder or file  has been remov ed.


---------------------

Mitigate Threats
The detailed forensic investigation identified three primary security issues that led to the successful exploitation via the malicious PDF file. Table 21.4-2 describes the security issues. The Information Assurance (IA) office has also provided updated software to resolve, harden, and mitigate the exploitable security issues. Previous analysts have placed the software in the IA Software folder on the path C:\Users\trainee\Desktop.

﻿![image](https://github.com/user-attachments/assets/f68d09aa-9788-46c6-b984-8e42612dd214)

A threat mitigation operation has been ordered. While implementing threat mitigations are not typically done by a CPT, the client has requested the CPT aid in threat mitigation that preserves the environment. This involves accessing ls-wkstn-3 and addressing each of the security issues in Table 21.4-2. 




Mitigate Threats: Update Adobe Reader and Windows 10


Complete the steps in the following workflow to update Adobe Reader and Windows 10.


Workflow


1. Log in to the VM ls-wkstn-3 using the following credentials:

Username: trainee
Password: CyberTraining1! 



2. Access the IA Software folder on the path C:\Users\trainee\Desktop.


3. Select AcroRdrDC2200220191_en_US. Select Yes when prompted with Do you want to allow this app to make changes to your device?


The Adobe Acrobat Reader DC - Setup dialog box appears.


4. Select Continue, and select Install when prompted. 


Adobe executes its installation process. Once complete, the dialog box indicates that the installation was successful.


The new version of Adobe is now used when accessing PDF files. The update provides critical patches that prevent the adversary from using the malicious PDF file technique against the host. 


5. Access the IA Software folder on the path C:\Users\trainee\Desktop.


6. Select Windows10.0-KB4023057-x64. Select Run when prompted Do you want to run this file?


Allow 1 to 2 minutes for the installation to complete. When the dialog box disappears, the installation is complete. 


-----------------


Mitigate Threats: Enable Windows Defender
Complete the steps in the following workflow to continue threat mitigation operations by accessing the registry and enabling Windows Defender.

﻿

Workflow
﻿

1. On the taskbar, right-click Windows, select Run, enter regedit, and select Enter. This opens Registry Editor. 

﻿

2. In Registry Editor, navigate to the path HKLM\SOFTWARE\Policies\Microsoft\Windows Defender.

﻿

3. Right-click DisableAntiSpyware, and select Delete. 

﻿

By selecting Delete, the entry to disable Windows Defender (DisableAntiSpyware) is removed from the registry. Removing the entry enables Windows Defender to run on the host. Windows Defender provides anti-malware and security protocols to protect the host.

﻿

4. On the taskbar, select Windows. In the Windows System folder, select Windows Defender. 

﻿

5. Within Windows Defender, select Start Now.    

﻿

Figure 21.4-1 shows Windows Defender successfully active and running on the host:

﻿![image](https://github.com/user-attachments/assets/5812c1af-cbec-47fc-832a-f3f420954ea1)


----------------

Mitigate Threats: Enable Connectivity
Complete the steps in the following workflow to complete threat mitigation operations, bringing the host back into the operating environment by enabling network connectivity. 

﻿

Workflow
﻿

1. Open a new command prompt as an Administrator. 

﻿

2. Run the following command:


netsh interface set interface Ethernet0 enable
﻿

3. Run the following command to verify that the network connectivity has been restored:


netsh interface show interface
﻿

The following output is returned:﻿


Admin State    State          Type             Interface Name
-------------------------------------------------------------

Enabled        Connected      Dedicated        Ethernet0
﻿


The output verifies that the host has been successfully returned to the environment — the final step in the threat mitigation operation. The host is free from malware and now includes updates to heavily used software as well as an active anti-malware program. The host can resume operations within the environment. 

![image](https://github.com/user-attachments/assets/29259ffa-4aff-4901-9843-ad32126bb13b)


--------------









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































